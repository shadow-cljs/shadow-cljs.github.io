<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="author" content="Thomas Heller and Tony Kay">
<title>Shadow CLJS User&#8217;s Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:initial}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px 0}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:.4em .75em 0 .75em;line-height:1;vertical-align:top}
.colist>table tr>td:first-of-type img{max-width:initial}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Shadow CLJS User&#8217;s Guide</h1>
<div class="details">
<span id="author" class="author">Thomas Heller and Tony Kay</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">Jan 10, 2018</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_high_level_overview">1.1. High-Level Overview</a></li>
<li><a href="#_basic_workflow">1.2. Basic Workflow</a>
<ul class="sectlevel3">
<li><a href="#_development_mode">1.2.1. Development Mode</a></li>
<li><a href="#_release_mode">1.2.2. Release Mode</a></li>
</ul>
</li>
<li><a href="#_important_concepts">1.3. Important Concepts</a>
<ul class="sectlevel3">
<li><a href="#_the_classpath">1.3.1. The Classpath</a></li>
<li><a href="#_server_mode">1.3.2. Server Mode</a></li>
<li><a href="#_repl">1.3.3. REPL</a></li>
</ul>
</li>
<li><a href="#_about_this_book">1.4. About this Book</a>
<ul class="sectlevel3">
<li><a href="#_work_in_progress">1.4.1. Work in Progress</a></li>
<li><a href="#_contributing">1.4.2. Contributing</a></li>
<li><a href="#_conventions_used">1.4.3. Conventions Used</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_installation">2. Installation</a>
<ul class="sectlevel2">
<li><a href="#_standalone_via_code_npm_code">2.1. Standalone via <code>npm</code></a></li>
<li><a href="#_library">2.2. Library</a></li>
</ul>
</li>
<li><a href="#_usage">3. Usage</a>
<ul class="sectlevel2">
<li><a href="#_command_line">3.1. Command Line</a>
<ul class="sectlevel3">
<li><a href="#server-mode">3.1.1. Server Mode</a></li>
</ul>
</li>
<li><a href="#_build_tool_integration">3.2. Build Tool Integration</a>
<ul class="sectlevel3">
<li><a href="#Leiningen">3.2.1. Leiningen</a></li>
<li><a href="#deps-edn">3.2.2. tools.deps / deps.edn</a></li>
<li><a href="#_boot">3.2.3. Boot</a></li>
</ul>
</li>
<li><a href="#_clojure_repl">3.3. Clojure REPL</a>
<ul class="sectlevel3">
<li><a href="#embedded">3.3.1. Embedded</a></li>
</ul>
</li>
<li><a href="#cljs-repl">3.4. ClojureScript REPL</a>
<ul class="sectlevel3">
<li><a href="#_node_repl">3.4.1. Node REPL</a></li>
</ul>
</li>
<li><a href="#clj-run">3.5. Running Clojure Code</a>
<ul class="sectlevel3">
<li><a href="#_calling_watch_via_clj_run">3.5.1. Calling watch via clj-run</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_configuration">4. Configuration</a>
<ul class="sectlevel2">
<li><a href="#_source_paths">4.1. Source Paths</a></li>
<li><a href="#_dependencies">4.2. Dependencies</a>
<ul class="sectlevel3">
<li><a href="#_clojure_script">4.2.1. Clojure(Script)</a></li>
<li><a href="#npm-install">4.2.2. JavaScript</a></li>
</ul>
</li>
<li><a href="#_server_options">4.3. Server Options</a>
<ul class="sectlevel3">
<li><a href="#nREPL">4.3.1. nREPL</a></li>
<li><a href="#_ssl">4.3.2. SSL</a></li>
<li><a href="#http">4.3.3. HTTP(S)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_build_configuration">5. Build Configuration</a>
<ul class="sectlevel2">
<li><a href="#_build_target">5.1. Build Target</a></li>
<li><a href="#devtools">5.2. Development Options</a>
<ul class="sectlevel3">
<li><a href="#_repl_2">5.2.1. REPL</a></li>
<li><a href="#_preloads">5.2.2. Preloads</a></li>
<li><a href="#_hot_code_reload">5.2.3. Hot Code Reload</a></li>
<li><a href="#_lifecycle_hooks">5.2.4. Lifecycle Hooks</a></li>
</ul>
</li>
<li><a href="#build-hooks">5.3. Build Hooks</a>
<ul class="sectlevel3">
<li><a href="#compile-stages">5.3.1. Compilation Stages</a></li>
</ul>
</li>
<li><a href="#_compiler_cache">5.4. Compiler Cache</a></li>
<li><a href="#closure-defines">5.5. Closure Defines</a></li>
<li><a href="#compiler-options">5.6. Compiler Options</a></li>
<li><a href="#_conditional_reading">5.7. Conditional Reading</a></li>
</ul>
</li>
<li><a href="#target-browser">6. Targeting the Browser</a>
<ul class="sectlevel2">
<li><a href="#_output_settings">6.1. Output Settings</a></li>
<li><a href="#_modules">6.2. Modules</a></li>
<li><a href="#CodeSplitting">6.3. Code Splitting</a>
<ul class="sectlevel3">
<li><a href="#_loading_code_dynamically">6.3.1. Loading code dynamically</a></li>
</ul>
</li>
<li><a href="#output-wrapper">6.4. Output Wrapper</a></li>
<li><a href="#_web_workers">6.5. Web Workers</a></li>
<li><a href="#NameHashing">6.6. Cacheable Output</a></li>
<li><a href="#BrowserManifest">6.7. Output Manifest</a></li>
<li><a href="#_development_support">6.8. Development Support</a>
<ul class="sectlevel3">
<li><a href="#hud">6.8.1. Heads-Up Display (HUD)</a></li>
<li><a href="#browser-http-server">6.8.2. HTTP Server</a></li>
<li><a href="#_css_reloading">6.8.3. CSS Reloading</a></li>
<li><a href="#_proxy_support">6.8.4. Proxy Support</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#target-node">7. Targeting node.js</a>
<ul class="sectlevel2">
<li><a href="#target-node-script">7.1. node.js Scripts</a>
<ul class="sectlevel3">
<li><a href="#_build_options">7.1.1. Build Options</a></li>
<li><a href="#NodeHotCodeReload">7.1.2. Hot Code Reload</a></li>
</ul>
</li>
<li><a href="#target-node-library">7.2. node.js Libraries</a>
<ul class="sectlevel3">
<li><a href="#_single_static_default_export">7.2.1. Single static "default" export</a></li>
<li><a href="#_multiple_static_named_exports">7.2.2. Multiple static named exports</a></li>
<li><a href="#_dynamic_exports">7.2.3. "Dynamic" exports</a></li>
<li><a href="#_full_example">7.2.4. Full Example</a></li>
</ul>
</li>
<li><a href="#_creating_code_npm_code_packages">7.3. Creating <code>npm</code> packages</a></li>
</ul>
</li>
<li><a href="#target-npm-module">8. Embedding in the JS Ecosystem&#8201;&#8212;&#8201;The <code>:npm-module</code> Target</a>
<ul class="sectlevel2">
<li><a href="#_convenience_mode">8.1. Convenience Mode</a></li>
<li><a href="#_explicit_configuration">8.2. Explicit Configuration</a></li>
<li><a href="#_working_with_optimizations">8.3. Working with Optimizations</a></li>
</ul>
</li>
<li><a href="#_testing">9. Testing</a>
<ul class="sectlevel2">
<li><a href="#target-node-test">9.1. Testing in node.js</a></li>
<li><a href="#target-browser-test">9.2. Testing in the Browser</a>
<ul class="sectlevel3">
<li><a href="#_generated_output_in_code_test_dir_code">9.2.1. Generated output in <code>:test-dir</code></a></li>
</ul>
</li>
<li><a href="#target-karma">9.3. Targeting Tests to Karma for Continuous Integration</a>
<ul class="sectlevel3">
<li><a href="#_installing_karma">9.3.1. Installing Karma</a></li>
<li><a href="#_the_build">9.3.2. The Build</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#js-deps">10. JavaScript Integration</a>
<ul class="sectlevel2">
<li><a href="#npm">10.1. NPM</a>
<ul class="sectlevel3">
<li><a href="#_using_npm_packages">10.1.1. Using npm packages</a></li>
<li><a href="#js-provider">10.1.2. Package Provider</a></li>
<li><a href="#js-resolve">10.1.3. Resolving Packages</a></li>
</ul>
</li>
<li><a href="#classpath-js">10.2. Dealing with .js Files</a>
<ul class="sectlevel3">
<li><a href="#_requiring_js">10.2.1. Requiring JS</a></li>
<li><a href="#_language_support">10.2.2. Language Support</a></li>
<li><a href="#_javascript_dialects">10.2.3. JavaScript Dialects</a></li>
<li><a href="#_access_cljs_from_js">10.2.4. Access CLJS from JS</a></li>
</ul>
</li>
<li><a href="#cljsjs">10.3. Migrating cljsjs.*</a>
<ul class="sectlevel3">
<li><a href="#_why_not_use_cljsjs">10.3.1. Why not use CLJSJS?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#release">11. Generating Production Code&#8201;&#8212;&#8201;All Targets</a>
<ul class="sectlevel2">
<li><a href="#_release_configuration">11.1. Release Configuration</a>
<ul class="sectlevel3">
<li><a href="#Optimization">11.1.1. Optimizations</a></li>
<li><a href="#_release_specific_vs_development_configuration">11.1.2. Release-Specific vs. Development Configuration</a></li>
</ul>
</li>
<li><a href="#externs">11.2. Externs</a>
<ul class="sectlevel3">
<li><a href="#infer-externs">11.2.1. Externs Inference</a></li>
<li><a href="#_manual_externs">11.2.2. Manual Externs</a></li>
<li><a href="#_simplified_externs">11.2.3. Simplified Externs</a></li>
</ul>
</li>
<li><a href="#_build_report">11.3. Build Report</a></li>
</ul>
</li>
<li><a href="#_editor_integration">12. Editor Integration</a>
<ul class="sectlevel2">
<li><a href="#_cursive">12.1. Cursive</a></li>
<li><a href="#cider">12.2. Emacs / CIDER</a>
<ul class="sectlevel3">
<li><a href="#_dependencies_2">12.2.1. Dependencies</a></li>
<li><a href="#_launch_the_server">12.2.2. Launch the server</a></li>
<li><a href="#_connect_to_cider_for_a_clojure_repl">12.2.3. Connect to CIDER for a Clojure REPL</a></li>
<li><a href="#_connect_the_javascript_environment">12.2.4. Connect the JavaScript environment</a></li>
<li><a href="#_launch_the_clojurescript_repl">12.2.5. Launch the ClojureScript REPL</a></li>
</ul>
</li>
<li><a href="#_proto_repl_atom">12.3. Proto REPL (Atom)</a></li>
<li><a href="#_calva_vs_code">12.4. Calva (VS Code)</a>
<ul class="sectlevel3">
<li><a href="#_dependencies_3">12.4.1. Dependencies</a></li>
<li><a href="#_connecting_calva_to_the_repls">12.4.2. Connecting Calva to the REPLs</a></li>
<li><a href="#_features">12.4.3. Features</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_what_to_do_when_things_don_t_work">13. What to do when things don’t work?</a></li>
<li><a href="#_hacking">14. Hacking</a>
<ul class="sectlevel2">
<li><a href="#_patching_libraries">14.1. Patching Libraries</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a><a class="link" href="#_introduction">1. Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> provides everything you need to compile your ClojureScript projects with a focus on simplicity and ease of use. The provided build targets abstract away most of the manual configuration so that you only have to configure the essentials for your build. Each target provides optimal defaults for each environment and get an optimized experience during development and in release builds.</p>
</div>
<div class="sect2">
<h3 id="_high_level_overview"><a class="anchor" href="#_high_level_overview"></a><a class="link" href="#_high_level_overview">1.1. High-Level Overview</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> is composed of 2 parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://clojars.org/thheller/shadow-cljs">shadow-cljs</a> Clojure library which handles all the actual work.</p>
</li>
<li>
<p>The <a href="https://www.npmjs.com/package/shadow-cljs">shadow-cljs</a> <code>npm</code> package which provides a convenient interface for running most of the build functionality directly from command line.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If desired you can easily integrate the <code>shadow-cljs</code> Clojure library into any other Clojure/JVM build tool (eg. <a href="https://leiningen.org/">leiningen</a> or the <a href="https://clojure.org/guides/deps_and_cli">Clojure CLI</a> tools).</p>
</div>
<div class="paragraph">
<p>It is recommended to use the <code>npm</code> package as that provides a more optimized development experience tailored towards CLJS development.</p>
</div>
</div>
<div class="sect2">
<h3 id="_basic_workflow"><a class="anchor" href="#_basic_workflow"></a><a class="link" href="#_basic_workflow">1.2. Basic Workflow</a></h3>
<div class="paragraph">
<p>When working with <code>shadow-cljs</code> you will be defining one or more builds in the <code>shadow-cljs.edn</code> configuration file. Each build will have a <code>:target</code> property which represents a configuration preset optimized for the target environment (eg. the Browser, a <code>node.js</code> application or a Chrome Extension).</p>
</div>
<div class="paragraph">
<p>Each build can either produce development or release output depending on the command used to trigger the compilation. The standard build commands are: <code>compile</code>, <code>watch</code> and <code>release</code>.</p>
</div>
<div class="sect3">
<h4 id="_development_mode"><a class="anchor" href="#_development_mode"></a><a class="link" href="#_development_mode">1.2.1. Development Mode</a></h4>
<div class="paragraph">
<p>You can either <code>compile</code> a development build once or run a <code>watch</code> process which will monitor your source files and re-compile them automatically (and live-reload the code if desired).</p>
</div>
<div class="paragraph">
<p>All development builds are optimized for the developer experience with fast feedback cycles and other features like a REPL to directly interact with your running code.</p>
</div>
<div class="paragraph">
<p>A development build should never be shipped publicly since they can become quite large and may only work on the machine they were compiled on depending on the <code>:target</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_release_mode"><a class="anchor" href="#_release_mode"></a><a class="link" href="#_release_mode">1.2.2. Release Mode</a></h4>
<div class="paragraph">
<p>Creating a <code>release</code> build will strip out all the development related code and finally run the code through the Closure Compiler. This is an optimizing Compiler for JavaScript which will significantly reduce the overall size of the code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_important_concepts"><a class="anchor" href="#_important_concepts"></a><a class="link" href="#_important_concepts">1.3. Important Concepts</a></h3>
<div class="paragraph">
<p>There are several important concepts that you should familiarize yourself with when using <code>shadow-cljs</code>. They are integral to understanding how everything fits together and how the tool works with your code.</p>
</div>
<div class="sect3">
<h4 id="_the_classpath"><a class="anchor" href="#_the_classpath"></a><a class="link" href="#_the_classpath">1.3.1. The Classpath</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> uses the Java Virtual Machine (JVM) and its "classpath" when working with files. This is a virtual filesystem composed of many classpath entries. Each entry is either</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A local filesystem directory, managed by <code>:source-paths</code> entry in the configuration.</p>
</li>
<li>
<p>Or a <code>.jar</code> file, representing Clojure(Script) or JVM libraries. These are compressed archives containing many files (basically just a <code>.zip</code> file). These are added by your <code>:dependencies</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the Clojure(Script) everything is namespaced and each name is expected to resolve to a file. If you have a <code>(ns demo.app)</code> namespace the compiler expects to find a <code>demo/app.cljs</code> (or <code>.cljc</code>) on the classpath. The classpath will be searched in order until it is found. Suppose you configured the <code>:source-paths ["src/main" "src/test"]</code> the compiler will first look for a <code>src/main/demo/app.cljs</code> and then <code>src/test/demo/app.cljs</code>. When the file is not found on any source path the JVM will begin looking into the <code>.jar</code> files on the classpath. When it finds a <code>demo/app.cljs</code> at the root of any of the libraries that file it will be used.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When a filename exists multiple times on the classpath then only the first one is used. Everything on the JVM and Clojure(Script) is namespaced to avoid such conflicts. Very similar to <code>npm</code> where each package must have a unique name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is therefore recommended to be very disciplined about the names you choose and properly namespacing everything. It may seem repetitive to always use <code>(ns your-company.components.foo)</code> over <code>(ns components.foo)</code> but it will save you from lot of headaches later on.</p>
</div>
<div class="paragraph">
<p>This is unlike <code>npm</code> where the package name itself is never used inside the package itself and only relative paths are used.</p>
</div>
</div>
<div class="sect3">
<h4 id="_server_mode"><a class="anchor" href="#_server_mode"></a><a class="link" href="#_server_mode">1.3.2. Server Mode</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> can be started in "server" mode which is required for long-running tasks such as <code>watch</code>. A <code>watch</code> will implicitly start the server instance if it is not already running. The server will provide the Websocket endpoint that builds will connect to as well as all the other endpoints for nREPL, Socket REPL and the development HTTP servers.</p>
</div>
<div class="paragraph">
<p>When using the <code>shadow-cljs</code> CLI interface all commands will re-use a running server instance JVM instead of starting a new JVM. This is substantially faster since start-up time can be quite slow.</p>
</div>
<div class="paragraph">
<p>Once the server is running however you only have to restart it whenever your <code>:dependencies</code> change and everything else can be done via the REPL.</p>
</div>
</div>
<div class="sect3">
<h4 id="_repl"><a class="anchor" href="#_repl"></a><a class="link" href="#_repl">1.3.3. REPL</a></h4>
<div class="paragraph">
<p>The REPL is at the heart of all Clojure(Script) development and every CLI command can also be used directly from the REPL as well. It is absolutely worth getting comfortable with the REPL even if the command line may seem more familiar.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_about_this_book"><a class="anchor" href="#_about_this_book"></a><a class="link" href="#_about_this_book">1.4. About this Book</a></h3>
<div class="sect3">
<h4 id="_work_in_progress"><a class="anchor" href="#_work_in_progress"></a><a class="link" href="#_work_in_progress">1.4.1. Work in Progress</a></h4>
<div class="paragraph">
<p>This is a work in progress. If you find an error, please submit a PR to fix it, or an issue with details of the problem.</p>
</div>
</div>
<div class="sect3">
<h4 id="_contributing"><a class="anchor" href="#_contributing"></a><a class="link" href="#_contributing">1.4.2. Contributing</a></h4>
<div class="paragraph">
<p>This source for this book is hosted on <a href="https://github.com/shadow-cljs/shadow-cljs.github.io">Github</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_conventions_used"><a class="anchor" href="#_conventions_used"></a><a class="link" href="#_conventions_used">1.4.3. Conventions Used</a></h4>
<div class="paragraph">
<p>There are many examples in this book. Most things used in these should be obvious from their context,
but to prevent misunderstanding it is important to know the author&#8217;s intentions.</p>
</div>
<div class="paragraph">
<p>When command-line examples are given we may include BASH comments (starting with <code>#</code>), and will
usually include the standard user UNIX prompt of <code>$</code> to indicate separation of the command
from its output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># A comment. This command lists files:
$ ls -l
shadow-cljs.edn
project.clj
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Many of the examples are of the configuration file for the compiler. This file contains an EDN map. Where we have already discussed required options we will often elide them for clarity. In this case we&#8217;ll usually include an ellipsis to indicate "content that is required but isn&#8217;t in our current focus":</p>
</div>
<div class="listingblock">
<div class="title">Example 1. Specify dependencies</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [[lib <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span>]]}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example 2. Add source paths</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows us to concisely include enough context to understand the nesting of the configuration of
interest:</p>
</div>
<div class="listingblock">
<div class="title">Example 3. Nested option</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:build-id</span> {<span class="keyword">..</span><span class="keyword">.</span>
                     <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">resources/public/js</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Code examples may be similarly shortened.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation"><a class="anchor" href="#_installation"></a><a class="link" href="#_installation">2. Installation</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standalone_via_code_npm_code"><a class="anchor" href="#_standalone_via_code_npm_code"></a><a class="link" href="#_standalone_via_code_npm_code">2.1. Standalone via <code>npm</code></a></h3>
<div class="paragraph">
<p>You will need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://nodejs.org"><code>node.js</code></a> (v6.0.0+, most recent version preferred)</p>
</li>
<li>
<p><a href="https://www.npmjs.com"><code>npm</code></a> or <a href="https://www.yarnpkg.com"><code>yarn</code></a></p>
</li>
<li>
<p>Java SDK (Version 8). <a href="http://openjdk.java.net/install/">OpenJDK</a> or <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">Oracle</a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">NPM</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ npm install --save-dev shadow-cljs
$ npm install -g shadow-cljs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Yarn</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ yarn add --dev shadow-cljs
$ yarn global add shadow-cljs</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_library"><a class="anchor" href="#_library"></a><a class="link" href="#_library">2.2. Library</a></h3>
<div class="paragraph">
<p>Although it is recommended to run the standalone version via <code>npm</code> you can also embed <code>shadow-cljs</code> into any other Clojure JVM tool (eg. <code>lein</code>, <code>boot</code>, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>The artifact can be found at:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://clojars.org/thheller/shadow-cljs"><img src="https://img.shields.io/clojars/v/thheller/shadow-cljs.svg" alt="shadow cljs"></a>
</div>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://github.com/thheller/shadow-cljs"><img src="https://img.shields.io/npm/v/shadow-cljs.svg" alt="shadow cljs"></a>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage"><a class="anchor" href="#_usage"></a><a class="link" href="#_usage">3. Usage</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> can be used in many different ways but the general workflow stays the same.</p>
</div>
<div class="paragraph">
<p>During development you have the option to <code>compile</code> a build once or run a <code>watch</code> worker which watches your source files for changes and re-compiles them automatically. When <a href="#devtools">enabled</a> the <code>watch</code> will also hot-reload your code and provide a REPL. During development the focus is on developer experience with fast feedback cycles. Development code should never be shipped to the public.</p>
</div>
<div class="paragraph">
<p>When it is time to get serious you create a <a href="#release"><code>release</code></a> build which creates an optimized build suitable for production. For this the <a href="https://developers.google.com/closure/compiler/">Closure Compiler</a> is used which applies some seriously <code>:advanced</code> optimizations to your code to create the most optimal output available. This may require some <a href="#externs">tuning</a> to work properly when using lots of interop with native JavaScript but works flawlessly for ClojureScript (and the code from the <a href="https://developers.google.com/closure/library/">Closure Library</a>).</p>
</div>
<div class="sect2">
<h3 id="_command_line"><a class="anchor" href="#_command_line"></a><a class="link" href="#_command_line">3.1. Command Line</a></h3>
<div class="paragraph">
<p>If <a href="#_installation">installed</a> globally, you can use the <code>shadow-cljs</code> command directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs help</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you prefer to only use the local <code>npm</code> install you can invoke it via <code>npx</code> or <code>yarn</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># npm
$ npx shadow-cljs help

# yarn
$ yarn shadow-cljs help

# manually
$ ./node_modules/.bin/shadow-cljs help</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Commonly used shadow-cljs commands during development</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># compile a build once and exit
$ shadow-cljs compile app

# compile and watch
$ shadow-cljs watch app

# connect to REPL for the build (available while watch is running)
$ shadow-cljs cljs-repl app

# connect to standalone node repl
$ shadow-cljs node-repl</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Running a release build optimized for production use.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs release app</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes you may run into some release issues due to <code>:advanced</code> compilation. These
commands can help track down the causes.</p>
</div>
<div class="listingblock">
<div class="title">Release debugging commands.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs check app
$ shadow-cljs release app --debug</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="server-mode"><a class="anchor" href="#server-mode"></a><a class="link" href="#server-mode">3.1.1. Server Mode</a></h4>
<div class="paragraph">
<p>A <code>shadow-cljs</code> command can be fairly slow to start. To improve this <code>shadow-cljs</code> can run in "server mode" which means that a dedicated process is started which all other commands can use to execute a lot faster since they won&#8217;t have to start a new JVM/Clojure instance.</p>
</div>
<div class="paragraph">
<p>Commands that do long-running things implicitly start a server instance (eg. <code>watch</code>) but it is often advisable to have
a dedicated server process running.</p>
</div>
<div class="paragraph">
<p>You can run the process in the foreground in a dedicated terminal. Use <code>CTRL+C</code> to terminate the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs server

# or (if you'd like REPL to control the server process)
$ shadow-cljs clj-repl</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also run the server in the background controlled via the common <code>start|stop|restart</code> functions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs start
$ shadow-cljs stop
$ shadow-cljs restart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once any server is running every other command will use that and run much faster.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_tool_integration"><a class="anchor" href="#_build_tool_integration"></a><a class="link" href="#_build_tool_integration">3.2. Build Tool Integration</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> can integrate with other Clojure tools since the primary distribution is just a <code>.jar</code> file available via <a href="https://clojars.org/thheller/shadow-cljs">Clojars</a>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
It is strongly recommended to use the standalone <code>shadow-cljs</code> version. The command does a lot of things to optimize the user experience (e.g. faster startup) which are not done by other tools. You&#8217;ll also save yourself a lot of headaches dealing with dependency conflicts and other related errors.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="Leiningen"><a class="anchor" href="#Leiningen"></a><a class="link" href="#Leiningen">3.2.1. Leiningen</a></h4>
<div class="paragraph">
<p>If you&#8217;d like to use <a href="https://leiningen.org/">Leiningen</a> for your build system (particularly if you use Cursive), the <code>shadow-cljs</code> command-line utility can be configured to use <code>lein</code> to run your commands. Enable this by adding a <code>:lein</code> entry to your <code>shadow-cljs.edn</code> config. With this setting, the <code>shadow-cljs</code> command will use <code>lein</code> to launch the JVM, ignoring any <code>:source-paths</code> and <code>:dependencies</code> in <code>shadow-cljs.edn</code>; relying instead on <code>lein</code> to set them from <code>project.clj</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:lein</span> <span class="predefined-constant">true</span>
 <span class="comment">; :source-paths and :dependencies are now ignored in this file</span>
 <span class="comment">; configure them via project.clj</span>
 <span class="symbol">:builds</span> { <span class="keyword">..</span><span class="keyword">.</span> }</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using <code>:lein</code> you must include the <a href="https://clojars.org/thheller/shadow-cljs">thheller/shadow-cljs</a> artifact in your <code>:dependencies</code> manually.</p>
</div>
<div class="listingblock">
<div class="title">Using a dedicated <code>lein</code> profile</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:lein</span> {<span class="symbol">:profile</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">+cljs</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">The <code>lein</code> command used by <code>shadow-cljs</code> as configured above</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">lein with-profile +cljs run -m shadow.cljs.devtools.cli ...</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_running_tasks_directly_from_leiningen"><a class="anchor" href="#_running_tasks_directly_from_leiningen"></a><a class="link" href="#_running_tasks_directly_from_leiningen">Running Tasks Directly From Leiningen</a></h5>
<div class="paragraph">
<p>You may also directly execute <code>shadow-cljs</code> commands via <code>lein</code> if you prefer to not use the <code>shadow-cljs</code> command itself. Most commands should work if you just replace <code>shadow-cljs &#8230;&#8203;</code> with <code>lein run -m shadow.cljs.devtools.cli &#8230;&#8203;</code>.</p>
</div>
<div class="paragraph">
<p>Some sample commands are listed below:</p>
</div>
<div class="listingblock">
<div class="title">Listing Options</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs help
# or
$ lein run -m shadow.cljs.devtools.cli help</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Start a dev mode build with a REPL and live-reload</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs watch build-id
# or
$ lein run -m shadow.cljs.devtools.cli watch build-id</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Just compile :dev mode once, no REPL or live-reload:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein run -m shadow.cljs.devtools.cli compile build-id</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Create a :release mode optimized build:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein run -m shadow.cljs.devtools.cli release build-id</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deps-edn"><a class="anchor" href="#deps-edn"></a><a class="link" href="#deps-edn">3.2.2. tools.deps / deps.edn</a></h4>
<div class="paragraph">
<p>The new <a href="https://clojure.org/guides/deps_and_cli">deps.edn</a> can also be used to manage your <code>:dependencies</code> and <code>:source-paths</code> instead of using the built-in methods or <code>lein</code>. All <code>shadow-cljs</code> commands will then be launched via the new <code>clojure</code> utility instead.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>tools.deps</code> is still changing quite frequently. Make sure you are using the latest version.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use this set the <code>:deps true</code> property in your config. It is also possible to configure which <code>deps.edn</code> aliases should be used.</p>
</div>
<div class="listingblock">
<div class="title">Example with :cljs alias</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:deps</span> {<span class="symbol">:aliases</span> [<span class="symbol">:cljs</span>]}
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may also specify <code>shadow-cljs -A:cljs &#8230;&#8203;</code> in the command line instead.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Aliases are only applied when a new instance/server is started. They do not apply when connecting to a running server.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_boot"><a class="anchor" href="#_boot"></a><a class="link" href="#_boot">3.2.3. Boot</a></h4>
<div class="paragraph">
<p>The authors have little Boot experience, so this chapter is in need of contributions. We understand
that Boot allows you to build your tool chain out of functions. Since <code>shadow-cljs</code> is a normal
JVM library, you can call functions within it to invoke tasks.</p>
</div>
<div class="paragraph">
<p>Some boot tasks are available here:
<a href="https://github.com/jgdavey/boot-shadow-cljs" class="bare">https://github.com/jgdavey/boot-shadow-cljs</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clojure_repl"><a class="anchor" href="#_clojure_repl"></a><a class="link" href="#_clojure_repl">3.3. Clojure REPL</a></h3>
<div class="paragraph">
<p>It is possible to use <code>shadow-cljs</code> entirely via a Clojure REPL. You can start a Clojure REPL via <code>shadow-cljs</code> itself or by any of the usual ways to get one (eg. <code>lein repl</code>, <code>clj</code>). If the <a href="https://clojars.org/thheller/shadow-cljs">thheller/shadow-cljs</a> artifact is on the classpath you are good to go.</p>
</div>
<div class="listingblock">
<div class="title">Lets start with the "easy" way.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-repl
...
shadow-cljs - REPL - see (help), :repl/quit to exit
[1:0]~shadow.user=&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>shadow.cljs.devtools.api</code> namespace has functions that map more or less 1:1 to the CLI counterparts.</p>
</div>
<div class="listingblock">
<div class="title">Example commands</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; shadow-cljs watch foo</span>
(shadow.cljs.devtools.api/watch <span class="symbol">:foo</span>)
<span class="comment">;; the shadow.user ns already has an alias for shadow.cljs.devtools.api</span>
(shadow/watch <span class="symbol">:foo</span>)
<span class="comment">;; shadow-cljs watch foo --verbose</span>
(shadow/watch <span class="symbol">:foo</span> {<span class="symbol">:verbose</span> <span class="predefined-constant">true</span>})
<span class="comment">;; shadow-cljs compile foo</span>
(shadow/compile <span class="symbol">:foo</span>)
<span class="comment">;; shadow-cljs release foo</span>
(shadow/release <span class="symbol">:foo</span>)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="embedded"><a class="anchor" href="#embedded"></a><a class="link" href="#embedded">3.3.1. Embedded</a></h4>
<div class="paragraph">
<p>When you are not using the <code>shadow-cljs clj-repl</code> but instead a REPL started by any other means you need to start the embedded server.</p>
</div>
<div class="listingblock">
<div class="title">Example using <code>lein repl</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein repl
nREPL server started on port 57098 on host 127.0.0.1 - nrepl://127.0.0.1:57098
REPL-y 0.3.7, nREPL 0.2.13
Clojure 1.9.0
...

user=&gt; (require '[shadow.cljs.devtools.server :as server])
nil
user=&gt; (server/start!)
...
:shadow.cljs.devtools.server/started
user=&gt; (require '[shadow.cljs.devtools.api :as shadow])
nil
user=&gt; (shadow/compile :foo)
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can stop the embedded server by running <code>(shadow.cljs.devtools.server/stop!)</code>. This will also stop all running build processes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cljs-repl"><a class="anchor" href="#cljs-repl"></a><a class="link" href="#cljs-repl">3.4. ClojureScript REPL</a></h3>
<div class="paragraph">
<p>Most <code>:target</code> configurations automatically inject the necessary code for a ClojureScript REPL. It should not require any additional configuration. For the CLJS REPL to work you need 2 things</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a running <code>watch</code> for your build</p>
</li>
<li>
<p>connect the JS runtime of the <code>:target</code>. Meaning if you are using the <code>:browser</code> target you need to open a Browser that has the generated JS loaded. For node.js builds that means running the <code>node</code> process.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once you have both you can connect to the CLJS REPL via the command line or from the Clojure REPL.</p>
</div>
<div class="listingblock">
<div class="title">CLI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs watch build-id
...

# different terminal
$ shadow-cljs cljs-repl build-id
shadow-cljs - connected to server
[3:1]~cljs.user=&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">REPL</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-repl
...
[2:0]~shadow.user=&gt; (shadow/watch :browser)
[:browser] Configuring build.
[:browser] Compiling ...
[:browser] Build completed. (341 files, 1 compiled, 0 warnings, 3,19s)
:watching
[2:0]~shadow.user=&gt; (shadow/repl :browser)
[2:1]~cljs.user=&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Type <code>:repl/quit</code> to exit the REPL. This will only exit the REPL, the <code>watch</code> will remain running.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You may run multiple <code>watch</code> "workers" in parallel and connect/disconnect to their REPLs at any given time.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">No connected runtime error.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">[3:1]~cljs.user=&gt; (js/alert &quot;foo&quot;)
There is no connected JS runtime.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you see this you need to open your App in the Browser or start the <code>node</code> process.</p>
</div>
<div class="sect3">
<h4 id="_node_repl"><a class="anchor" href="#_node_repl"></a><a class="link" href="#_node_repl">3.4.1. Node REPL</a></h4>
<div class="paragraph">
<p>The above REPLs were all coupled to a specific build where you are responsible for running the given <code>:target</code>. You may also launch an embedded <code>node</code> REPL where a process is started for you.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs node-repl</code></pre>
</div>
</div>
<div class="paragraph">
<p>This starts a blank CLJS REPL with an already connected <code>node</code> process.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you exit the Node REPL the <code>node</code> process is also killed!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>node-repl</code> lets you get started without any additional configuration. It has access to all your code via the usual means. Since it is not connected to any build it does not do any live-reloading.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clj-run"><a class="anchor" href="#clj-run"></a><a class="link" href="#clj-run">3.5. Running Clojure Code</a></h3>
<div class="paragraph">
<p>You can use the <code>shadow-cljs</code> CLI to call specific Clojure functions from the command line. This is useful when you want run some code before/after certain tasks. Suppose you wanted to <code>rsync</code> the output of your <code>release</code> build to a remote server.</p>
</div>
<div class="listingblock">
<div class="title">Example Clojure Namespace in <code>src/my/build.clj</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.build</span>
  (<span class="symbol">:require</span>
    [shadow.cljs.devtools.api <span class="symbol">:as</span> shadow]
    [clojure.java.shell <span class="symbol">:refer</span> (sh)]))

(<span class="keyword">defn</span> <span class="function">release</span> []
  (shadow/release <span class="symbol">:my-build</span>)
  (sh <span class="string"><span class="delimiter">&quot;</span><span class="content">rsync</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-arzt</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/output-dir</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">my@server.com:some/path</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Running the <code>release</code> function</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-run my.build/release
# or
$ shadow-cljs run my.build/release</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can pass arguments to the invoked functions via the command line.</p>
</div>
<div class="listingblock">
<div class="title">Using arguments via normal Clojure fn args</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">..</span><span class="keyword">.</span>
(<span class="keyword">defn</span> <span class="function">release</span> [server]
  (shadow/release <span class="symbol">:my-build</span>)
  (sh <span class="string"><span class="delimiter">&quot;</span><span class="content">rsync</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-arzt</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/output-dir</span><span class="delimiter">&quot;</span></span> server))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Passing the server from the command line</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-run my.build/release my@server.com:some/path</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The usual <code>(defn release [&amp; args])</code> structure also works if you want to parse the args with something like <a href="https://github.com/clojure/tools.cli">tools.cli</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You have access to the full power of Clojure here. You can build entire tools on top of this if you like. As a bonus everything you write this way is also directly available via the Clojure REPL.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When the <a href="#server-mode">server</a> is running the namespace will not be reloaded automatically, it will only be loaded once. It is recommended to do the development using a REPL and reload the file as usual (eg. <code>(require 'my.build :reload)</code>). You may also run <code>shadow-cljs clj-eval "(require 'my.build :reload)"</code> to reload manually from the command line.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_calling_watch_via_clj_run"><a class="anchor" href="#_calling_watch_via_clj_run"></a><a class="link" href="#_calling_watch_via_clj_run">3.5.1. Calling watch via clj-run</a></h4>
<div class="paragraph">
<p>By default the functions called by <code>clj-run</code> only have access to a minimal <code>shadow-cljs</code> runtime which is enough to run <code>compile</code>, <code>release</code> and any other Clojure functionality. The JVM will terminate when your function completes.</p>
</div>
<div class="paragraph">
<p>If you want to start a <code>watch</code> for a given build you need to declare that the function you are calling requires a full server. This will cause the process to stay alive until you explicitly call <code>(shadow.cljs.devtools.server/stop!)</code> or <code>CTRL+C</code> the process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.run</span>
  (<span class="symbol">:require</span> [shadow.cljs.devtools.api <span class="symbol">:as</span> shadow]))

<span class="comment">;; this fails because a full server instance is missing</span>
(<span class="keyword">defn</span> <span class="function">foo</span>
  [&amp; args]
  (shadow/watch <span class="symbol">:my-build</span>))

<span class="comment">;; this metadata will ensure that the server is started so watch works</span>
(<span class="keyword">defn</span> <span class="function">foo</span>
  {<span class="symbol">:shadow/requires-server</span> <span class="predefined-constant">true</span>}
  [&amp; args]
  (shadow/watch <span class="symbol">:my-build</span>))</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration"><a class="anchor" href="#_configuration"></a><a class="link" href="#_configuration">4. Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> is configured by a <code>shadow-cljs.edn</code> file in your project root directory. You can
create a default one by running <code>shadow-cljs init</code>. It should contain a map with some global
configuration and a <code>:builds</code> entry for all your builds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example config could look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span>
 [[reagent <span class="string"><span class="delimiter">&quot;</span><span class="content">0.8.0-alpha2</span><span class="delimiter">&quot;</span></span>]]

 <span class="symbol">:source-paths</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]

 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:entries</span> [my.app]}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file structure for this example should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── my
        └── app.cljs</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_source_paths"><a class="anchor" href="#_source_paths"></a><a class="link" href="#_source_paths">4.1. Source Paths</a></h3>
<div class="paragraph">
<p><code>:source-paths</code> configures your JVM classpath. The compiler will use this config to find Clojure(Script) source files (eg. <code>.cljs</code>).</p>
</div>
<div class="paragraph">
<p>It is fine to put everything into one source path but you can use multiple if you want to "group" source files in certain ways. It is useful if you want to keep your tests separate for example.</p>
</div>
<div class="listingblock">
<div class="title">Using multiple source paths</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">src/test</span><span class="delimiter">&quot;</span></span>]
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">File Structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── main
        └── my
            └── app.cljs
    └── test
        └── my
            └── app_test.cljs</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is not recommended to separate source files by extension (eg. <code>src/clj</code>, <code>src/cljs</code>, <code>src/cljc</code>). For some reason this is widely used in CLJS project templates but it just makes things harder to use.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dependencies"><a class="anchor" href="#_dependencies"></a><a class="link" href="#_dependencies">4.2. Dependencies</a></h3>
<div class="sect3">
<h4 id="_clojure_script"><a class="anchor" href="#_clojure_script"></a><a class="link" href="#_clojure_script">4.2.1. Clojure(Script)</a></h4>
<div class="paragraph">
<p>Your dependencies are managed via the <code>:dependencies</code> key at the root of the <code>shadow-cljs.edn</code> config file. They are declared in the same notation that other Clojure tools like <code>lein</code> or <code>boot</code> use.</p>
</div>
<div class="paragraph">
<p>Notice that the source path is <strong>only</strong> specified once in the entire configuration. The system will use namespace dependency graphs to determine what code is needed in the final output of any given build.</p>
</div>
</div>
<div class="sect3">
<h4 id="npm-install"><a class="anchor" href="#npm-install"></a><a class="link" href="#npm-install">4.2.2. JavaScript</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> integrates fully with the <a href="https://www.npmjs.com/"><code>npm</code></a> ecosystem to manage JavaScript dependencies.</p>
</div>
<div class="paragraph">
<p>You can use <code>npm</code> or <code>yarn</code> to manage your dependencies, please refer to their respective documentation.</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
npm
</td>
<td class="hdlist2">
<p><a href="https://docs.npmjs.com/" class="bare">https://docs.npmjs.com/</a></p>
</td>
</tr>
<tr>
<td class="hdlist1">
yarn
</td>
<td class="hdlist2">
<p><a href="https://yarnpkg.com/en/docs" class="bare">https://yarnpkg.com/en/docs</a></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both manage your dependencies via a <code>package.json</code> file in your project directory.  Almost every package available via <code>npm</code> will explain how to install it. Those instructions now apply to <code>shadow-cljs</code> as well.</p>
</div>
<div class="listingblock">
<div class="title">Installing a JavaScript package</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># npm
$ npm install the-thing

# yarn
$ yarn add the-thing</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nothing more is required. Dependencies will be added to the <code>package.json</code> file and this will be used to manage them.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If you don’t have a <code>package.json</code> yet run <code>npm init</code> from a command line.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_missing_js_dependency"><a class="anchor" href="#_missing_js_dependency"></a><a class="link" href="#_missing_js_dependency">Missing JS Dependency?</a></h5>
<div class="paragraph">
<p>You might run into errors related to missing JS dependencies. Most ClojureScript libraries do not yet declare the <code>npm</code> packages they use since they still expect to use <a href="#cljsjs">CLJSJS</a>. We want to use <code>npm</code> directly which means you must manually install the <code>npm</code> packages until libraries properly declare the <code>:npm-deps</code> themselves.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">The required JS dependency &quot;react&quot; is not available, it was required by ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that you should <code>npm install react</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
In the case of <code>react</code> you probably need these 3 packages: <code>npm install react react-dom create-react-class</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_server_options"><a class="anchor" href="#_server_options"></a><a class="link" href="#_server_options">4.3. Server Options</a></h3>
<div class="paragraph">
<p>This section is for other options that configure the <code>shadow-cljs</code> server instance. They are optional.</p>
</div>
<div class="sect3">
<h4 id="nREPL"><a class="anchor" href="#nREPL"></a><a class="link" href="#nREPL">4.3.1. nREPL</a></h4>
<div class="paragraph">
<p>The <code>shadow-cljs</code> <a href="#server-mode">server</a> provides a nREPL server via TCP. If you look at the startup message you&#8217;ll see the port of nREPL, and the port will also be stored in <code>target/shadow-cljs/nrepl.port</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs watch dev
shadow-cljs - HTTP server for &quot;:app&quot; available at http://localhost:8020
shadow-cljs - server running at http://0.0.0.0:9630
shadow-cljs - nrepl running at /0.0.0.0:9462
shadow-cljs - watching build :app
[:app] Configuring build.
[:app] Compiling ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure the port and additional middleware with <code>shadow-cljs.edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:nrepl</span> {<span class="symbol">:port</span> <span class="integer">9000</span>
         <span class="symbol">:middleware</span> []} <span class="comment">; optional list of namespace-qualified symbols</span>
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the popular middleware <a href="https://github.com/clojure-emacs/cider-nrepl">cider-nrepl</a> is found on the classpath (e.g. it&#8217;s included in <code>:dependencies</code>), it will be used automatically. No additional configuration required.</p>
</div>
<div class="paragraph">
<p>You may configure the namespace you start in when connecting by setting <code>:init-ns</code> in the <code>:nrepl</code> options. It defaults to <code>shadow.user</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:nrepl</span> {<span class="symbol">:init-ns</span> my.repl}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_nrepl_usage"><a class="anchor" href="#_nrepl_usage"></a><a class="link" href="#_nrepl_usage">nREPL Usage</a></h5>
<div class="paragraph">
<p>When connecting to the nREPL server the connection always starts out as a Clojure REPL. Switching to a CLJS REPL works similarly to the <a href="#cljs-repl">non-nREPL version</a>. First the <code>watch</code> for the given build needs to be started and then we need to select this build to switch the current nREPL session to that build. After selecting the build everything will be eval&#8217;d in ClojureScript instead of Clojure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="repl">(shadow/watch :the-build)
(shadow/nrepl-select :the-build)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Use <code>:cljs/quit</code> to return to Clojure.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_embedded_nrepl_server"><a class="anchor" href="#_embedded_nrepl_server"></a><a class="link" href="#_embedded_nrepl_server">Embedded nREPL Server</a></h5>
<div class="paragraph">
<p>When you use <code>shadow-cljs</code> embedded in other tools that provide their own nREPL server (eg. <code>lein</code>) you need to configure the <code>shadow-cljs</code> middleware. Otherwise you won&#8217;t be able to switch between CLJ and CLJS REPLs.</p>
</div>
<div class="listingblock">
<div class="title">Example Leiningen <code>project.clj</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject my-amazing-project <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:repl-options</span>
  {<span class="symbol">:init-ns</span> shadow.user <span class="comment">;; or any of your choosing</span>
   <span class="symbol">:nrepl-middleware</span>
   [shadow.cljs.devtools.server.nrepl/cljs-load-file
    shadow.cljs.devtools.server.nrepl/cljs-eval
    shadow.cljs.devtools.server.nrepl/cljs-select
    <span class="comment">;; required by some tools, not by shadow-cljs.</span>
    cemerick.piggieback/wrap-cljs-repl]}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You still need to start the <a href="#embedded">embedded server</a> manually before using the CLJS REPL.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ssl"><a class="anchor" href="#_ssl"></a><a class="link" href="#_ssl">4.3.2. SSL</a></h4>
<div class="paragraph">
<p>The <code>shadow-cljs</code> HTTP servers support SSL. It requires a Java Keystore that provides a matching private key and certificate.</p>
</div>
<div class="listingblock">
<div class="title"><code>shadow-cljs.edn</code> with SSL configured</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:ssl</span> {<span class="symbol">:keystore</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">ssl/keystore.jks</span><span class="delimiter">&quot;</span></span>
       <span class="symbol">:password</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">shadow-cljs</span><span class="delimiter">&quot;</span></span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above are the defaults so if you want to use those it is fine to just set <code>:ssl {}</code>.</p>
</div>
<div class="paragraph">
<p>You can create a Keystore using the java <code>keytool</code> command. Creating a trusted self-signed certificate is also possible but somewhat complicated.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://gist.github.com/jchandra74/36d5f8d0e11960dd8f80260801109ab0">OpenSSL</a> instructions for Linux and Windows (via WSL)</p>
</li>
<li>
<p><a href="https://certsimple.com/blog/localhost-ssl-fix">macOS</a> instructions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The created <code>Certificates.p12</code> (macOS) or <code>localhost.pfx</code> (Linux, Windows) file can be turned into the required <code>keystore.jks</code> via the <code>keytool</code> utility.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ keytool -importkeystore -destkeystore keystore.jks -srcstoretype PKCS12 -srckeystore localhost.pfx</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You must generate the Certificate with a SAN (Subject Alternative Name) for "localhost" (or whichever host you want to use). SAN is required to get Chrome to trust the Certificate and now show warnings. The password used when exporting must match the password assigned to the Keystore.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="http"><a class="anchor" href="#http"></a><a class="link" href="#http">4.3.3. HTTP(S)</a></h4>
<div class="paragraph">
<p>The <code>shadow-cljs</code> server starts one primary HTTP server. It is used by the builds to connect the Hot Reload and REPL clients via websocket. By default it listens on Port 9630. If that Port is in use it will increment by one and attempt again until an open Port is found.</p>
</div>
<div class="listingblock">
<div class="title">Startup message indicating the Port used</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">shadow-cljs - server running at http://0.0.0.0:9630</code></pre>
</div>
</div>
<div class="paragraph">
<p>When <code>:ssl</code> is configured the server will be available via <code>https://</code> instead.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The server automatically supports HTTP/2 when using <code>:ssl</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The UI served by this server is still in development so the main purpose of this HTTP server currently is serving the websockets.</p>
</div>
<div class="paragraph">
<p>If you prefer to set your own port instead you can do this via the <code>:http</code> config.</p>
</div>
<div class="listingblock">
<div class="title"><code>shadow-cljs.edn</code> with <code>:http</code> config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:http</span> {<span class="symbol">:port</span> <span class="integer">12345</span>
        <span class="symbol">:host</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">my.machine.local</span><span class="delimiter">&quot;</span></span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:ssl</code> switches the server to server <code>https://</code> only. If you want to keep the <code>http://</code> version you can configure a separate <code>:ssl-port</code> as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:http</span> {<span class="symbol">:port</span> <span class="integer">12345</span>
        <span class="symbol">:ssl-port</span> <span class="integer">23456</span>
        <span class="symbol">:host</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_configuration"><a class="anchor" href="#_build_configuration"></a><a class="link" href="#_build_configuration">5. Build Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs.edn</code> will also need a <code>:builds</code> section. Builds should be a map of builds <strong>keyed</strong> by build ID:</p>
</div>
<div class="listingblock">
<div class="title">A configuration file with a build map.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [[some-library <span class="string"><span class="delimiter">&quot;</span><span class="content">1.2.1</span><span class="delimiter">&quot;</span></span>] <span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>   {<span class="symbol">:target</span>     <span class="symbol">:browser</span>
          <span class="keyword">..</span><span class="keyword">.</span> browser-specific options <span class="keyword">..</span><span class="keyword">.</span>}
  <span class="symbol">:tests</span> {<span class="symbol">:target</span> <span class="symbol">:karma</span>
          <span class="keyword">..</span><span class="keyword">.</span> karma-specific options <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each build describes artifacts that the compiler will build. The build target is an extensible feature of <code>shadow-cljs</code>, and the compiler comes with quite a few of them already.</p>
</div>
<div class="sect2">
<h3 id="_build_target"><a class="anchor" href="#_build_target"></a><a class="link" href="#_build_target">5.1. Build Target</a></h3>
<div class="paragraph">
<p>Each build in <code>shadow-cljs</code> must define a <code>:target</code> which defines where you intend your code to be executed. There are default built-ins for the <a href="#target-browser">browser</a> and <a href="#target-node"><code>node.js</code></a>. They all share the basic concept of having <code>:dev</code> and <code>:release</code> modes. <code>:dev</code> mode provides all the usual development goodies like fast compilation, live code reloading and a REPL. <code>:release</code> mode will produce optimized output intended for production.</p>
</div>
<div class="paragraph">
<p>Targets are covered in separate chapters.</p>
</div>
<div class="paragraph">
<p>Here are some of them:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><a href="#target-browser"><code>:browser</code></a></dt>
<dd>
<p>Output code suitable for running in a web browser.</p>
</dd>
<dt><a href="#target-bootstrap"><code>:bootstrap</code></a></dt>
<dd>
<p>Output code suitable for running in bootstrapped cljs environment.</p>
</dd>
<dt><a href="#target-browser-test"><code>:browser-test</code></a></dt>
<dd>
<p>Scan for tests to determine required files, and output tests suitable for running in the browser.</p>
</dd>
<dt><a href="#target-karma"><code>:karma</code></a></dt>
<dd>
<p>Scan for tests to determine required files, and output karma-runner compatible tests. See <a href="http://karma-runner.github.io/2.0/index.html">Karma</a>.</p>
</dd>
<dt><a href="#target-node-library"><code>:node-library</code></a></dt>
<dd>
<p>Output code suitable for use as a node library.</p>
</dd>
<dt><a href="#target-node-script"><code>:node-script</code></a></dt>
<dd>
<p>Output code suitable for use as a node script.</p>
</dd>
<dt><a href="#target-npm-module"><code>:npm-module</code></a></dt>
<dd>
<p>Output code suitable for use as an NPM module.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Each target is covered in more detail in its own chapter since the remaining build options vary on
the target you select.</p>
</div>
</div>
<div class="sect2">
<h3 id="devtools"><a class="anchor" href="#devtools"></a><a class="link" href="#devtools">5.2. Development Options</a></h3>
<div class="paragraph">
<p>Each build <code>:target</code> typically provides some development support. They are grouped under the <code>:devtools</code> key for each <code>:build</code>.</p>
</div>
<div class="sect3">
<h4 id="_repl_2"><a class="anchor" href="#_repl_2"></a><a class="link" href="#_repl_2">5.2.1. REPL</a></h4>
<div class="paragraph">
<p>When running <code>watch</code> code for the REPL is injected automatically and usually does not require additional configuration. Currently there is one config option that allows configuring which namespace the REPL will start in. It defaults to <code>cljs.user</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:repl-init-ns</span> my.app
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preloads"><a class="anchor" href="#_preloads"></a><a class="link" href="#_preloads">5.2.2. Preloads</a></h4>
<div class="paragraph">
<p>As a developer most of your time is spent in development mode. You&#8217;re probably familiar with tools like <code>figwheel</code>,
<code>boot-reload</code>, and <code>devtools</code>. It&#8217;s almost certain that you want one or more of these in your builds.</p>
</div>
<div class="paragraph">
<p>Preloads are used to force certain namespaces into the front of your generated Javascript. This is
generally used to inject tools and instrumentation before the application actually loads and runs. The
preloads option is simply a list of namespaces in the <code>:devtools</code>/<code>:preloads</code> section of
<code>shadow-cljs-edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:preloads</span> [fulcro.inspect.preload]
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Since version 2.0.130 shadow-cljs automatically adds <code>cljs-devtools</code> to the preloads in
<code>watch</code> and <code>compile</code> if they are on the classpath. All you need to do is make sure <code>binaryage/devtools</code> is in your
<code>dependencies</code> list. (Note, <strong>not</strong> binaryage/<strong>cljs-</strong>devtools.)
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_hot_code_reload"><a class="anchor" href="#_hot_code_reload"></a><a class="link" href="#_hot_code_reload">5.2.3. Hot Code Reload</a></h4>
<div class="paragraph">
<p>The React and ClojureScript ecosystems combine to make this kind of thing super useful. The <code>shadow-cljs</code>
system includes everything you need to do your hot code reload, without needing to resort to external tools.</p>
</div>
<div class="paragraph">
<p>In order to use it you simply run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">shadow-cljs watch build-id</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lifecycle_hooks"><a class="anchor" href="#_lifecycle_hooks"></a><a class="link" href="#_lifecycle_hooks">5.2.4. Lifecycle Hooks</a></h4>
<div class="paragraph">
<p>You can configure the compiler to run functions just before hot code reload brings in updated code, and just after. These are useful for stopping/starting things that would otherwise close over old code.</p>
</div>
<div class="paragraph">
<p>These can be configured via the <code>:devtools</code> section in your build config or directly in your code via metadata tags.</p>
</div>
<div class="sect4">
<h5 id="_metadata"><a class="anchor" href="#_metadata"></a><a class="link" href="#_metadata">Metadata</a></h5>
<div class="paragraph">
<p>You can set certain metadata on normal CLJS <code>defn</code> vars to inform the compiler that these functions should be called at a certain time when live reloading.</p>
</div>
<div class="listingblock">
<div class="title">hook config via metadata</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>)

(<span class="keyword">defn</span> ^<span class="symbol">:dev/before-load</span> stop []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defn</span> ^<span class="symbol">:dev/after-load</span> start []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would call <code>my.app/stop</code> before loading any new code and <code>my.app/start</code> when all new code was loaded. You can tag multiple functions like this and they will be called in dependency order of their namespaces.</p>
</div>
<div class="paragraph">
<p>There are also async variants of these in case you need to do some async work that should complete before proceeding with the reload process.</p>
</div>
<div class="listingblock">
<div class="title">async hooks example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>)

(<span class="keyword">defn</span> ^<span class="symbol">:dev/before-load-async</span> stop [done]
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop</span><span class="delimiter">&quot;</span></span>)
  (js/setTimeout
    (<span class="keyword">fn</span> []
      (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop complete</span><span class="delimiter">&quot;</span></span>)
      (done)))

(<span class="keyword">defn</span> ^<span class="symbol">:dev/after-load-async</span> start [done]
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span>)
  (js/setTimeout
    (<span class="keyword">fn</span> []
      (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">start complete</span><span class="delimiter">&quot;</span></span>)
      (done)))</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The functions will receive one callback function that must be called when their work is completed. If the callback function is not called the reload process will not proceed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to tag namespaces with metadata so they will never be reloaded even if they are recompiled.</p>
</div>
<div class="listingblock">
<div class="title">non-reloadable ns</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> ^<span class="symbol">:dev/once</span> my.thing)

(js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">will only execute once</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_config"><a class="anchor" href="#_config"></a><a class="link" href="#_config">Config</a></h5>
<div class="paragraph">
<p>In addition to the metadata you can configure the lifecycle hooks via <code>shadow-cljs.edn</code>.</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:before-load</code></dt>
<dd>
<p>A symbol (with namespace) of a function to run just before refreshing
files that have been recompiled.  This function <strong>must</strong> by synchronous in nature.</p>
</dd>
<dt><code>:before-load-async</code></dt>
<dd>
<p>A symbol (with namespace) of a function <code>(fn [done])</code> to run just before refreshing. This function can do async processing, but <strong>must</strong> call <code>(done)</code> to indicate it is complete.</p>
</dd>
<dt><code>:after-load</code></dt>
<dd>
<p>A symbol (with namespace) of a function to run after hot code reload is complete.</p>
</dd>
<dt><code>:after-load-async</code></dt>
<dd>
<p>A symbol (with namespace) of a function <code>(fn [done])</code> to run after hot code reload is complete. This function can do async processing, but <strong>must</strong> call <code>(done)</code> to indicate it is complete.</p>
</dd>
<dt><code>:autoload</code></dt>
<dd>
<p>A boolean controlling whether code should be hot loaded. Implicitly set to <code>true</code> if either of the callbacks is set. Always enabled for the <code>:browser</code> target by default, set to <code>false</code> to disable.</p>
</dd>
<dt><code>:ignore-warnings</code></dt>
<dd>
<p>A boolean controlling whether code with warnings should be reloaded. Defaults to <code>false</code>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">A sample of lifecycle hooks.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:before-load</span>  my.app/stop
                   <span class="symbol">:after-load</span>   my.app/start
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If neither <code>:after-load</code> nor <code>:before-load</code> are set the compiler will only attempt to hot reload the code in the <code>:browser</code> target. If you still want hot reloading but don&#8217;t need any of the callbacks you can set <code>:autoload true</code> instead.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="build-hooks"><a class="anchor" href="#build-hooks"></a><a class="link" href="#build-hooks">5.3. Build Hooks</a></h3>
<div class="paragraph">
<p>It is sometimes desirable to execute some custom code at a specific stage in the compilation pipeline. <code>:build-hooks</code> let you declare which functions should be called and they have full access to the build state at that time. This is quite powerful and opens up many possible tool options.</p>
</div>
<div class="paragraph">
<p>They are configured per build under the <code>:build-hooks</code> key</p>
</div>
<div class="listingblock">
<div class="title">Exampe :build-hooks</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:build-hooks</span>
        [(my.util/hook <span class="integer">1</span> <span class="integer">2</span> <span class="integer">3</span>)]
        <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example hook code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.util</span>)

(<span class="keyword">defn</span> <span class="function">hook</span>
  {<span class="symbol">:shadow.build/stage</span> <span class="symbol">:flush</span>}
  [build-state &amp; args]
  (<span class="keyword">prn</span> [<span class="symbol">:hello-world</span> args])
  build-state)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example would call <code>(my.util/hook build-state 1 2 3)</code> after the build completed the <code>:flush</code> <a href="#compilation-stages">stage</a> (ie. written to disk). The example would print <code>[:hello-world (1 2 3)]</code> but please do something more useful in actual hooks.</p>
</div>
<div class="paragraph">
<p>The hook is a just a normal <strong>Clojure</strong> function with some additional metadata. The <code>{:shadow.build/stage :flush}</code> metadata informs the compiler to call this hook for <code>:flush</code> only. You may instead configure <code>{:shadow.build/stages #{:configure :flush}}</code> if the hook should be called after multiple stages. At least one configured stage is required since the hook otherwise would never do anything.</p>
</div>
<div class="paragraph">
<p>All build hooks will the called after the <code>:target</code> work is done. They will receive the <code>build-state</code> (a clojure map with all the current build data) as their first argument and <strong>must</strong> return this <code>build-state</code> modified or unmodified. When using multiple stages you can add additional data to the <code>build-state</code> that later stages can see. It is strongly advised to use namespaced keys only to ensure not accidentally breaking the entire build.</p>
</div>
<div class="paragraph">
<p>The <code>build-state</code> has some important entries which might be useful for your hooks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:shadow.build/build-id</code> - the id of the current build (eg. <code>:app</code>)</p>
</li>
<li>
<p><code>:shadow.build/mode</code> - <code>:dev</code> or <code>:release</code></p>
</li>
<li>
<p><code>:shadow.build/stage</code> - the current stage</p>
</li>
<li>
<p><code>:shadow.build/config</code> - the build config. You can either store config data for the hook in the build config directly or pass it as arguments in the hook itself</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
With a running <code>watch</code> all hooks will be called repeatedly for each build. Avoid doing too much work as they can considerably impact your build performance.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="compile-stages"><a class="anchor" href="#compile-stages"></a><a class="link" href="#compile-stages">5.3.1. Compilation Stages</a></h4>
<div class="paragraph">
<p>The possible stages the <code>:build-hooks</code> can use are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:configure</code> - initial <code>:target</code> specific configuration</p>
</li>
<li>
<p><code>:compile-prepare</code> - called before any compilation is done</p>
</li>
<li>
<p><code>:compile-finish</code> - called after all compilation finishes</p>
</li>
<li>
<p><code>:optimize-prepare</code> - called before running the Closure Compiler optimization phase (<code>:release</code> only)</p>
</li>
<li>
<p><code>:optimize-finish</code> - called after Closure is done (<code>:release</code> only)</p>
</li>
<li>
<p><code>:flush</code> - called after everything was flushed to disk</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With a running <code>watch</code> the <code>:configure</code> is only called once. Any of the others may be called
again (in order) for each re-compile. The <code>build-state</code> will be re-used until the build config changes at which point it will be thrown away and a fresh one will be created.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compiler_cache"><a class="anchor" href="#_compiler_cache"></a><a class="link" href="#_compiler_cache">5.4. Compiler Cache</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> will cache all compilation results by default. The cache is invalidated whenever anything relevant to the individual source files changes (eg. changed compiler setting, changed dependencies, etc.). This greatly improves the developer experience since incremental compilation will be <strong>much</strong> faster than starting from scratch.</p>
</div>
<div class="paragraph">
<p>Invalidating the cache however can not always be done reliably if you are using a lot of macros with side-effects (reading files, storing things outside the compiler state, etc.). In those cases you might need to disable caching entirely.</p>
</div>
<div class="paragraph">
<p>Namespaces that are known to include side-effecting macros can be blocked from caching. They won&#8217;t be cached themselves and namespaces requiring them will not be cached as well. The <a href="https://github.com/cerner/clara-rules">clara-rules</a> library has side-effecting macros and is blocked by default. You can specify which namespaces to block globally via the <code>:cache-blockers</code> configuration. It expects a set of namespace symbols.</p>
</div>
<div class="listingblock">
<div class="title">clara.rules cache blocking example (this is done by default)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:cache-blockers</span> #{clara.rules}
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition you can control how much caching is done more broadly via the <code>:build-options</code> <code>:cache-level</code> entry. The supported options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:all</code>
</td>
<td class="hdlist2">
<p>The default, all CLJS files are cached</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:jars</code>
</td>
<td class="hdlist2">
<p>Only caches files from libraries, ie. source files in <code>.jar</code> files</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:off</code>
</td>
<td class="hdlist2">
<p>Does not cache any CLJS compilation results (by far the slowest option)</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Compiling without Cache</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:build-options</span>
   {<span class="symbol">:cache-level</span> <span class="symbol">:off</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cache files are stored in a dedicated directory for each build so the cache is never shared between builds. A build with the id <code>:app</code> will have the <code>:dev</code> cache in the directory:</p>
</div>
<div class="listingblock">
<div class="title">Cache location for <code>cljs/core.cljs</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">target/shadow-cljs/builds/app/dev/ana/cljs/core.cljs.cache.transit.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:cache-root</code> setting defaults to <code>target/shadow-cljs</code> and controls where ALL cache files will be written. It can only be configured globally, not per build.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:cache-root</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">.shadow-cljs</span><span class="delimiter">&quot;</span></span>
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}

<span class="comment">;; cache then goes to</span>
<span class="comment">;; .shadow-cljs/builds/app/dev/ana/cljs/core.cljs.cache.transit.json</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:cache-root</code> is always resolved relative to the project directory. You can also specify absolute paths (eg. <code>/tmp/shadow-cljs</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="closure-defines"><a class="anchor" href="#closure-defines"></a><a class="link" href="#closure-defines">5.5. Closure Defines</a></h3>
<div class="paragraph">
<p>The Closure Library &amp; Compiler allow you to define variables that are essentially compile time constants. You can use these to configure certain features of your build. Since the Closure compiler treats these as constants when running <code>:advanced</code> optimizations they are fully supported in the Dead-Code-Elimination passes and can be used to remove certain parts of the code that should not be included in <code>release</code> builds.</p>
</div>
<div class="paragraph">
<p>You can define them in your code</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">your.app</span>)

(goog-define VERBOSE <span class="predefined-constant">false</span>)

(<span class="keyword">when</span> VERBOSE
  (<span class="keyword">println</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines the <code>your.app/VERBOSE</code> variable as <code>false</code> by default. This will cause the <code>println</code> to be removed in <code>:advanced</code> compilation. You can toggle this to <code>true</code> via the <code>:closure-defines</code> options which will enable the <code>println</code>. This can either be done for development only or always.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:modules</span> {<span class="symbol">:app</span> {<span class="symbol">:entries</span> [your.app]}}
   <span class="comment">;; to enable in development only</span>
   <span class="symbol">:dev</span> {<span class="symbol">:closure-defines</span> {your.app/VERBOSE <span class="predefined-constant">true</span>}}
   <span class="comment">;; to enable always</span>
   <span class="symbol">:closure-defines</span> {your.app/VERBOSE <span class="predefined-constant">true</span>}
   <span class="comment">;; you may also enable it for release as well</span>
   <span class="symbol">:release</span> {<span class="symbol">:closure-defines</span> {your.app/VERBOSE <span class="predefined-constant">true</span>}}
   }}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
It is generally safer to use the "disabled" variant as the default since it makes things less likely to be included in a <code>release</code> build when they shouldn&#8217;t be. Forgetting to set a <code>:closure-defines</code> variable should almost always result in less code being used not more.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Closure Defines from the Closure Library</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>goog.DEBUG</code>: The Closure Library uses this for many development features. <code>shadow-cljs</code> automatically sets this to <code>false</code> for <code>release</code> builds.</p>
</li>
<li>
<p><code>goog.LOCALE</code> can be used to configure certain localization features like <code>goog.i18n.DateTimeFormat</code>. It accepts a standard locale string and defaults to <code>en</code>. Pretty much all locales are supported, see <a href="https://github.com/google/closure-library/blob/master/closure/goog/i18n/datetimesymbols.js">here</a> and <a href="https://github.com/google/closure-library/blob/master/closure/goog/i18n/datetimesymbolsext.js">here</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="compiler-options"><a class="anchor" href="#compiler-options"></a><a class="link" href="#compiler-options">5.6. Compiler Options</a></h3>
<div class="paragraph">
<p>The CLJS compiler supports several options to influence how some code is generated. For the most part <code>shadow-cljs</code> will pick some good defaults for each <code>:target</code> but you might occasionally want to change some of them.</p>
</div>
<div class="paragraph">
<p>These are all grouped under the <code>:compiler-options</code> key in your build config.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:fn-invoke-direct</span> <span class="predefined-constant">true</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the standard ClojureScript <a href="https://clojurescript.org/reference/compiler-options">Compiler Options</a> are either enabled by default or do not apply. So very few of them actually have an effect. A lot of them are also specific to certain <code>:target</code> types and do not apply universally (e.g. <code>:compiler-options {:output-wrapper true}</code> is only relevant for <code>:target :browser</code>).</p>
</div>
<div class="paragraph">
<p>Currently supported options include</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:optimizations</code> supports <code>:advanced</code>, <code>:simple</code> or <code>:whitespace</code>, defaults to <code>:advanced</code>. <code>:none</code> is the default for development and cannot be set manually. <code>release</code> with <code>:none</code> won&#8217;t work.</p>
</li>
<li>
<p><code>:infer-externs</code> <code>:all</code>, <code>:auto</code>, <code>true</code> or <code>false</code>, defaults to <code>true</code></p>
</li>
<li>
<p><code>:static-fns</code> (Boolean) defaults to <code>true</code></p>
</li>
<li>
<p><code>:fn-invoke-direct</code> (Boolean) defaults to <code>false</code></p>
</li>
<li>
<p><code>:elide-asserts</code> (Boolean) default to <code>false</code> in development and <code>true</code> in <code>release</code> builds</p>
</li>
<li>
<p><code>:pretty-print</code> and <code>:pseudo-names</code> default to <code>false</code>. You can use <code>shadow-cljs release app --debug</code> to enable both temporarily without touching your config. This is very useful when running into problem with <code>release</code> builds</p>
</li>
<li>
<p><code>:source-map</code> (Boolean) defaults to <code>true</code> during development, <code>false</code> for <code>release</code>.</p>
</li>
<li>
<p><code>:externs</code> vector of paths, defaults to <code>[]</code></p>
</li>
<li>
<p><code>:checked-arrays</code> (Boolean), defaults to <code>false</code></p>
</li>
<li>
<p><code>:language-in</code> and <code>:language-out</code></p>
</li>
<li>
<p><code>:anon-fn-naming-policy</code></p>
</li>
<li>
<p><code>:rename-prefix</code> and <code>:rename-prefix-namespace</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Unsupported or non-applicable Options</strong></p>
</div>
<div class="paragraph">
<p>Options that don&#8217;t have any effect at all include</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:verbose</code> is controlled by running <code>shadow-cljs compile app --verbose</code> not in the build config.</p>
</li>
<li>
<p><code>:foreign-libs</code> and <code>:libs</code></p>
</li>
<li>
<p><code>:stable-names</code> always enabled, cannot be disabled</p>
</li>
<li>
<p><code>:install-deps</code></p>
</li>
<li>
<p><code>:source-map-path</code>, <code>:source-asset-path</code> and <code>:source-map-timestamp</code></p>
</li>
<li>
<p><code>:cache-analysis</code> always enabled, cannot be disabled.</p>
</li>
<li>
<p><code>:recompile-dependents</code></p>
</li>
<li>
<p><code>:preamble</code></p>
</li>
<li>
<p><code>:hashbang</code> (the <code>:node-script</code> target supports this, others don&#8217;t)</p>
</li>
<li>
<p><code>:compiler-stats</code> use <code>--verbose</code> to get detailed information instead</p>
</li>
<li>
<p><code>:optimize-constants</code> always done for <code>release</code> builds, cannot be disabled</p>
</li>
<li>
<p><code>:parallel-build</code> always enabled</p>
</li>
<li>
<p><code>:aot-cache</code></p>
</li>
<li>
<p><code>:package-json-resolution</code> see <a href="#js-resolve">:js-options :resolve</a> instead</p>
</li>
<li>
<p><code>:watch-fn</code></p>
</li>
<li>
<p><code>:process-shim</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_conditional_reading"><a class="anchor" href="#_conditional_reading"></a><a class="link" href="#_conditional_reading">5.7. Conditional Reading</a></h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
This feature only works in <code>shadow-cljs</code>. It was officially <a href="https://dev.clojure.org/jira/browse/CLJS-2396">rejected</a> by the ClojureScript project. It will still compile fine in CLJS but only the official branches work (e.g. <code>:cljs</code>). It might still be <a href="https://groups.google.com/d/msg/clojure-dev/8YJJM8lJuQs/hR5_vUZPCQAJ">supported</a> one day but as of now it is not.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> lets you configure additional reader features in <code>.cljc</code> files. By default you can only use reader conditionals to generate separate code for <code>:clj</code>, <code>:cljs</code> or <code>:cljr</code>. In many CLJS builds however it is also desirable to select which code is generated based on your <code>:target</code>.</p>
</div>
<div class="paragraph">
<p>Example: Some <code>npm</code> packages only work when targeting the <code>:browser</code>, but you may have a <code>ns</code> that you also want to use in a <code>:node-script</code> build. This might happen frequently when trying to use Server-Side Rendering (SSR) with your React App. <code>codemirror</code> is one such package.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.awesome.component</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">codemirror</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> CodeMirror]))

<span class="comment">;; suppose you create a CodeMirror instance on some React :ref</span>
(<span class="keyword">defn</span> <span class="function">init-cm</span> [dom-node]
  (<span class="keyword">let</span> [cm (CodeMirror/fromTextArea dom-node <span class="error">#</span>js {<span class="keyword">..</span><span class="keyword">.</span>})]
    <span class="keyword">..</span><span class="keyword">.</span>))

<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This namespace will compile fine for both builds (<code>:node-script</code> and <code>:browser</code>) but when trying to run the <code>:node-script</code> it will fail since the <code>codemirror</code> package tries to access the DOM. Since <code>react-dom/server</code> does not use refs the <code>init-cm</code> function will never be called anyways.</p>
</div>
<div class="paragraph">
<p>While you can use <a href="#closure-defines">:closure-defines</a> to conditionally compile away the <code>init-cm</code> fn you can not use it to get rid of the extra <code>:require</code>. Reader conditionals let you do this easily.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.awesome.component</span>
 (<span class="symbol">:require</span>
   [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]
   <span class="comment">;; NOTE: The order here matters. Only the first applicable</span>
   <span class="comment">;; branch is used. If :cljs is used first it will still be</span>
   <span class="comment">;; taken by the :server build</span>
   <span class="error">#</span>?@(<span class="symbol">:node</span> [[]]
       <span class="symbol">:cljs</span> [[<span class="string"><span class="delimiter">&quot;</span><span class="content">codemirror</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> CodeMirror]])))

<span class="error">#</span>?(<span class="symbol">:node</span>
   (<span class="keyword">defn</span> <span class="function">init-cm</span> [dom-node] <span class="keyword">..</span><span class="keyword">.</span>))

<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>:reader-features</code> config examples</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 <span class="comment">;; app build configured normally, no adjustments required</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>}
  <span class="comment">;; for the server we add the :node reader feature</span>
  <span class="comment">;; it will then be used instead of the default :cljs</span>
  <span class="symbol">:server</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="symbol">:compiler-options</span>
   {<span class="symbol">:reader-features</span> #{<span class="symbol">:node</span>}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:server</code> build will then no longer have the <code>codemirror</code> require and the <code>init-cm</code> function is removed. Becoming only</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.awesome.component</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]))

<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
This feature is only available in <code>.cljc</code> files and will fail in <code>.cljs</code> files.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="target-browser"><a class="anchor" href="#target-browser"></a><a class="link" href="#target-browser">6. Targeting the Browser</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>:browser</code> target produces output intended to run in a Browser environment. During development it supports live code reloading, REPL, CSS reloading. The <code>release</code> output will be minified by the Closure Compiler with <code>:advanced</code> optimizations.</p>
</div>
<div class="paragraph">
<p>A basic browser configuration looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]

 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/assets/app/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/assets/app/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:entries</span> [my.app]}}}]}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_output_settings"><a class="anchor" href="#_output_settings"></a><a class="link" href="#_output_settings">6.1. Output Settings</a></h3>
<div class="paragraph">
<p>The browser target outputs a lot of files, and a directory is needed for them all. You&#8217;ll need to serve
these assets with some kind of server, and the Javascript loading code needs to know the server-centric
path to these assets. The options you need to specify are:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:output-dir</code></dt>
<dd>
<p>The directory to use for all compiler output.</p>
</dd>
<dt><code>:asset-path</code></dt>
<dd>
<p>The relative path from <strong>web server&#8217;s root</strong> to the resources in <code>:output-dir</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Your entry point javascript file and all related JS files will appear in <code>:output-dir</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Each build requires its own :output-dir, you may not put multiple builds into the same directory.
This directory should also be exclusively owned by the build. There should be no other files in there.
While <code>shadow-cljs</code> won&#8217;t delete anything it is safer to leave it alone. Compilation
creates many more files than just the main entry point javascript file during development:
source maps, original sources, and generated sources.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>:asset-path</code> is a prefix that gets added to the paths of module loading code inside of the
generated javascript. It allows you to output your javascript module to a particular subdirectory
of your web server&#8217;s root. The dynamic loading during development (hot code reload) and production
(code splitting) need this to correctly locate files.</p>
</div>
<div class="paragraph">
<p>Locating your generated files in a directory and asset path like this make it so that other assets
(images, css, etc.) can easily co-exist on the same server without accidental collisions.</p>
</div>
<div class="paragraph">
<p>For example: if your web server will serve the folder <code>public/x</code> when asked for the URI <code>/x</code>,
and your <code>output-dir</code> for a module is <code>public/assets/app/js</code> then your asset-path should be <code>/assets/app/js</code>.
You are not required to use an absolute asset path, but it is highly recommended.</p>
</div>
</div>
<div class="sect2">
<h3 id="_modules"><a class="anchor" href="#_modules"></a><a class="link" href="#_modules">6.2. Modules</a></h3>
<div class="paragraph">
<p>Modules configure how the compiled sources are bundled together and how the final <code>.js</code> are generated. Each Module declares a list of Entry Namespace and from that dependency graph is built. When using multiple Modules the code is split so that the maximum amount of code is moved to the outer edges of the graph. The goal is to minimize the amount of code the browser has to load initially and loading the rest on-demand.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Don&#8217;t worry too much about :modules in the beginning. Start with one and split them later.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>:modules</code> section of the config is always a map keyed by module ID. The module ID is also used
to generate the Javascript filename. Module <code>:main</code> will generate <code>main.js</code> in <code>:output-dir</code>.</p>
</div>
<div class="paragraph">
<p>The available options in a module are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:entries</code>
</td>
<td class="hdlist2">
<p>The namespaces that serve as the root nodes of the dependency graph for the output code of this module.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:depends-on</code>
</td>
<td class="hdlist2">
<p>The names of other modules that must be loaded in order for this one to have everything it needs.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:prepend</code>
</td>
<td class="hdlist2">
<p>String content that will be prepended to the js output. Useful for comments, copyright notice, etc.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:append</code>
</td>
<td class="hdlist2">
<p>String content that will be appended to the js output. Useful for comments, copyright notice, etc.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:prepend-js</code>
</td>
<td class="hdlist2">
<p>A string to prepend to the module output containing valid javascript that will be run through Closure optimizer.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:append-js</code>
</td>
<td class="hdlist2">
<p>A string to append to the module output containing valid javascript that will be run through Closure optimizer.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows a minimum module configuration:</p>
</div>
<div class="listingblock">
<div class="title">Example :browser config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:entries</span> [my.app.main]}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> will follow the dependency graph from the root set of code entry points in the <code>:entries</code>
to find everything needed to actually compile and include in the output. Namespaces that are not required will not be included.</p>
</div>
<div class="paragraph">
<p>The above config will create a <code>public/js/main.js</code> file. During development there will be an additional <code>public/js/cljs-runtime</code> directory with lots of files. This directory is not required for <code>release</code> builds.</p>
</div>
</div>
<div class="sect2">
<h3 id="CodeSplitting"><a class="anchor" href="#CodeSplitting"></a><a class="link" href="#CodeSplitting">6.3. Code Splitting</a></h3>
<div class="paragraph">
<p>Declaring more than one Module requires a tiny bit of additional static configuration so the Compiler can figure out how the Modules are related to each other and how you will be loading them later.</p>
</div>
<div class="paragraph">
<p>In addition to <code>:entries</code> you&#8217;ll need to declare which module depends on which (via <code>:depends-on</code>). How you structure this is entirely up to your needs and there is no one-size-fits-all solution unfortunately.</p>
</div>
<div class="paragraph">
<p>Say you have a traditional website with actual different pages.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>www.acme.com</code> - serving the homepage</p>
</li>
<li>
<p><code>www.acme.com/login</code> - serving the login form</p>
</li>
<li>
<p><code>www.acme.com/protected</code> - protected section that is only available once the user is logged in</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One good configuration for this would be to have one common module that is shared between all the pages. Then one for each page.</p>
</div>
<div class="listingblock">
<div class="title">Example config with multiple <code>:modules</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
 <span class="symbol">:modules</span>
 {<span class="symbol">:shared</span>
  {<span class="symbol">:entries</span> [my.app.common]}
  <span class="symbol">:home</span>
  {<span class="symbol">:entries</span> [my.app.home]
   <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}
  <span class="symbol">:login</span>
  {<span class="symbol">:entries</span> [my.app.login]
   <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}
  <span class="symbol">:protected</span>
  {<span class="symbol">:entries</span> [my.app.protected]
   <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can leave the <code>:entries</code> of the <code>:shared</code> module empty to let the compiler figure out which namespaces are shared between the other modules.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Generated file structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
└── public
    └── js
        ├── shared.js
        ├── home.js
        ├── login.js
        └── protected.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>In your HTML for the Homepage you&#8217;d then always include the <code>shared.js</code> on each page and the others conditionally depending on which page the user is on.</p>
</div>
<div class="listingblock">
<div class="title">HTML for the <code>/login</code> page</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/js/shared.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/js/login.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The <code>.js</code> files must be included in the correct order. The <a href="#BrowserManifest"><code>manifest.edn</code></a> can help with this.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_loading_code_dynamically"><a class="anchor" href="#_loading_code_dynamically"></a><a class="link" href="#_loading_code_dynamically">6.3.1. Loading code dynamically</a></h4>
<div class="paragraph">
<p>These days Single-Page-Apps (SPA) are becoming more popular and they work similarly only that instead of letting the Server decide which JS to include to Client does it by itself.</p>
</div>
<div class="sect4">
<h5 id="_using_shadow_cljs_s_built_in_loader_support"><a class="anchor" href="#_using_shadow_cljs_s_built_in_loader_support"></a><a class="link" href="#_using_shadow_cljs_s_built_in_loader_support">Using shadow-cljs&#8217;s built-in Loader Support</a></h5>
<div class="paragraph">
<p>The compiler supports generating the required data for using the <code>shadow.loader</code> utility namespace. It exposes a simple interface to let you load modules on-demand at runtime.</p>
</div>
<div class="paragraph">
<p>You only need to add <code>:module-loader true</code> to your build config. The loader will always be injected into the default module (the one everything else depends on).</p>
</div>
<div class="paragraph">
<p>At runtime you may use the <code>shadow.loader</code> namespace to load modules. You may also load a module eagerly by just using a <code>&lt;script&gt;</code> tag in your page.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:module-loader</span> <span class="predefined-constant">true</span>
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you had the following for your main entry point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span> [shadow.loader <span class="symbol">:as</span> loader]))

(<span class="keyword">defn</span> <span class="function">fn-to-call-on-load</span> []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">extra loaded</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defn</span> <span class="function">fn-to-call-on-error</span> []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">extra load failed</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the following expressions can be used for loading code:</p>
</div>
<div class="listingblock">
<div class="title">Loading a module</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; load returns a goog.async.Deferred, and can be used like a promise</span>
(<span class="keyword">-&gt;</span> (loader/load <span class="string"><span class="delimiter">&quot;</span><span class="content">extra</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">.</span>then fn-to-call-on-load fn-to-call-on-error))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Loading many modules</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; must be a JS array, also returns goog.async.Deferred</span>
(loader/load-many <span class="error">#</span>js [<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Including a callback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(loader/with-module <span class="string"><span class="delimiter">&quot;</span><span class="content">extra</span><span class="delimiter">&quot;</span></span> fn-to-call-on-load)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check if a module is loaded using <code>(loaded? "module-name")</code>.</p>
</div>
<div class="sect5">
<h6 id="_loader_costs"><a class="anchor" href="#_loader_costs"></a><a class="link" href="#_loader_costs">Loader Costs</a></h6>
<div class="paragraph">
<p>Using the loader is very lightweight. It has a few dependencies which you may not be otherwise using. In practice using <code>:module-loader true</code> adds about 8KB gzip&#8217;d to the default module. This will vary depending on how much of <code>goog.net</code> and <code>goog.events</code> you are already using, and what level of optimization you use for your release builds.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_using_the_standard_clojurescript_api"><a class="anchor" href="#_using_the_standard_clojurescript_api"></a><a class="link" href="#_using_the_standard_clojurescript_api">Using the Standard ClojureScript API</a></h5>
<div class="paragraph">
<p>The generated code is capable of using the standard ClojureScript <code>cljs.loader</code> API. See the
<a href="https://clojurescript.org/news/2017-07-10-code-splitting">documentation</a> on the ClojureScript
website for instructions.</p>
</div>
<div class="paragraph">
<p>The advantage of using the standard API is that your code will play well with others. This
may be of particular importance to library authors. The disadvantage is that the dynamic module
loading API in the standard distribution is currently somewhat less easy-to-use than the
support in <code>shadow-cljs</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="output-wrapper"><a class="anchor" href="#output-wrapper"></a><a class="link" href="#output-wrapper">6.4. Output Wrapper</a></h3>
<div class="paragraph">
<p><strong>Release builds only</strong>: The code generated by the Closure Compiler <code>:advanced</code> compilation will create a lot of global variables which has the potential to create conflicts with other JS running in your page. To isolate the created variables the code can be wrapped in an anonymous function to the variables only apply in that scope.</p>
</div>
<div class="paragraph">
<p><code>release</code> builds for <code>:browser</code> with only one <code>:modules</code> are wrapped in <code>(function(){&lt;the-code&gt;}).call(this);</code> by default. So no global variables are created.</p>
</div>
<div class="paragraph">
<p>When using multiple <code>:modules</code> (a.k.a <a href="#CodeSplitting">code splitting</a>) this is not enabled by default since each module must be able to access the variables created by the modules it depends on. The Closure Compiler supports an additional option to enable the use of an output wrapper in combination with multiple <code>:modules</code> named <code>:rename-prefix-namespace</code>. This will cause the Compiler to scope all "global" variables used by the build into one actual global variable. By default this is set to <code>:rename-prefix-namespace "$APP"</code> when <code>:output-wrapper</code> is set to <code>true</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:target</span> <span class="symbol">:browser</span>
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:compiler-options</span>
  {<span class="symbol">:output-wrapper</span> <span class="predefined-constant">true</span>
   <span class="symbol">:rename-prefix-namespace</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">MY_APP</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will only create the <code>MY_APP</code> global variable. Since every "global" variable will now be prefixed by <code>MY_APP.</code> (e.g. <code>MY_APP.a</code> instead of just <code>a</code>) the code size can go up substantially. It is important to keep this short. Browser compression (e.g. <code>gzip</code>) helps reduce the overhead of the extra code but depending on the amount of global variables in your build this can still produce a noticeable increase.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Note that the created variable isn&#8217;t actually useful directly. It will contain a lot of munged/minified properties. All exported (eg. <code>^:export</code>) variables will still be exported into the global scope and are not affect by this setting. The setting only serves to limit the amount of global variables created, nothing else. Do not use it directly.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_web_workers"><a class="anchor" href="#_web_workers"></a><a class="link" href="#_web_workers">6.5. Web Workers</a></h3>
<div class="paragraph">
<p>The <code>:modules</code> configuration may also be used to generate files intended to be used as a Web Workers.
You may declare any module (except the default) as a Web Worker by setting <code>:web-worker true</code>. The
generated file will contain some additional bootstrap code which will load its dependencies
automatically. The way <code>:modules</code> work also ensures that code used only by the worker will also only
be in the final file for the worker. Each worker should have a dedicated CLJS namespace.</p>
</div>
<div class="listingblock">
<div class="title">An example of generating a web worker script</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
    {<span class="symbol">:target</span> <span class="symbol">:browser</span>
     <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
     <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
     <span class="keyword">..</span><span class="keyword">.</span>
     <span class="symbol">:modules</span> {<span class="symbol">:main</span>   {<span class="symbol">:entries</span> [my.app]}
               <span class="symbol">:extra</span>  {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}
               <span class="symbol">:worker</span> {<span class="symbol">:entries</span> [my.app.worker]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}
                        <span class="symbol">:web-worker</span> <span class="predefined-constant">true</span>}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration will generate <code>worker.js</code> which you can use to start the Web Worker.
It will have all code from the <code>:main</code> module available (but not <code>:extra</code>). The code in the
<code>my.app.worker</code> namespace will only ever execute in the worker. Worker generation happens in
both development and release modes.</p>
</div>
<div class="listingblock">
<div class="title">Sample echo worker</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app.worker</span>)

(js/self.addEventListener <span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>
  (<span class="keyword">fn</span> [^js e]
    (js/postMessage (<span class="keyword">..</span> e -data))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample using the worker</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>)

(<span class="keyword">let</span> [worker (js/Worker. <span class="string"><span class="delimiter">&quot;</span><span class="content">/js/worker.js</span><span class="delimiter">&quot;</span></span>))]
  (<span class="keyword">..</span> worker (addEventListener (<span class="keyword">fn</span> [e] (js/console.log e))))
  (<span class="keyword">..</span> worker (postMessage <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Hot code reload does not support reloading code in the worker while it is running.
I suggest shutting down all workers using the <code>:devtools :before-load</code> function and restarting it
in the <code>:after-load</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="NameHashing"><a class="anchor" href="#NameHashing"></a><a class="link" href="#NameHashing">6.6. Cacheable Output</a></h3>
<div class="paragraph">
<p>In a web setting it is desirable to cache <code>.js</code> files for a very long time to avoid extra request. It is common
practice the generate a unique name for the <code>.js</code> file for every released version. This changes the URL used to
access it and thereby is safe to cache forever.</p>
</div>
<div class="paragraph">
<p>You can add <code>:module-hash-names true</code> to your build config to automatically create a MD5
signature for each generated output module file. That means that a <code>:main</code> module will generate
a <code>main.&lt;md5hash&gt;.js</code> instead of just the default <code>main.js</code>.</p>
</div>
<div class="paragraph">
<p><code>:module-hash-names true</code> will include the full 32-length md5 hash, if you prefer a shorter version you can specify a
number between 1-32 instead (eg. <code>:module-hash-names 8</code>). Be aware that shortening the hash may increase the chances
of generating conflicts. I recommend using the full hash.</p>
</div>
<div class="listingblock">
<div class="title">Example :module-hash-names config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
      <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
      <span class="symbol">:module-hash-names</span> <span class="predefined-constant">true</span>
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of generating <code>main.js</code> it will now generate <code>main.&lt;hash&gt;.js</code> in the <code>:output-dir</code>.</p>
</div>
<div class="paragraph">
<p>Since the filename can change with every release it gets a little bit more complicated to include them
in your HTML. The <a href="#BrowserManifest">Output Manifest</a> can help with that.</p>
</div>
</div>
<div class="sect2">
<h3 id="BrowserManifest"><a class="anchor" href="#BrowserManifest"></a><a class="link" href="#BrowserManifest">6.7. Output Manifest</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> generates a <code>manifest.edn</code> file in the configured <code>:output-dir</code>.
This file contains a description of the module config together with an extra <code>:output-name</code> property which
maps the original module name to actual filename (important when using the <code>:module-hash-names</code> feature).</p>
</div>
<div class="listingblock">
<div class="title">Sample output of manifest.edn when using hashed filenames.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[{<span class="symbol">:module-id</span> <span class="symbol">:common</span>,
  <span class="symbol">:name</span> <span class="symbol">:common</span>,
  <span class="symbol">:output-name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">common.15D142F7841E2838B46283EA558634EE.js</span><span class="delimiter">&quot;</span></span>,
  <span class="symbol">:entries</span> [<span class="keyword">..</span><span class="keyword">.</span>],
  <span class="symbol">:depends-on</span> #{},
  <span class="symbol">:sources</span> [<span class="keyword">..</span><span class="keyword">.</span>]}
 {<span class="symbol">:module-id</span> <span class="symbol">:page-a</span>,
  <span class="symbol">:name</span> <span class="symbol">:page-a</span>,
  <span class="symbol">:output-name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">page-a.D8844E305644135CBD5CBCF7E359168A.js</span><span class="delimiter">&quot;</span></span>,
  <span class="symbol">:entries</span> [<span class="keyword">..</span><span class="keyword">.</span>],
  <span class="symbol">:depends-on</span> #{<span class="symbol">:common</span>},
  <span class="symbol">:sources</span> [<span class="keyword">..</span><span class="keyword">.</span>]}
 <span class="keyword">..</span><span class="keyword">.</span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The manifest contains all <code>:modules</code> sorted in dependency order. You can use it to map the <code>:module-id</code> back to the
actual generated filename.</p>
</div>
<div class="paragraph">
<p>Development builds also produce this file and you may check if for modifications to
know when a new build completed. <code>:module-hash-names</code> does not apply during development so you&#8217;ll get the usual
filenames.</p>
</div>
<div class="paragraph">
<p>You can configure the name of the generated manifest file via the <code>:build-options :manifest-name</code> entry. It defaults to
<code>manifest.edn</code>. If you configure a filename with <code>.json</code> ending the output will be JSON instead of EDN. The file will
be relative to the configured <code>:output-dir</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example manifest.json config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:build-options</span> {<span class="symbol">:manifest-name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">manifest.json</span><span class="delimiter">&quot;</span></span>}
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_development_support"><a class="anchor" href="#_development_support"></a><a class="link" href="#_development_support">6.8. Development Support</a></h3>
<div class="paragraph">
<p>The <code>:devtools</code> section of the configuration for <code>:browser</code> supports a few additional
options for configuring an optional dev-time HTTP server for a build and CSS reloading.</p>
</div>
<div class="sect3">
<h4 id="hud"><a class="anchor" href="#hud"></a><a class="link" href="#hud">6.8.1. Heads-Up Display (HUD)</a></h4>
<div class="paragraph">
<p>The <code>:browser</code> target now uses a HUD to display a loading indicator when a build is started. It will also display warnings and errors if there are any.</p>
</div>
<div class="paragraph">
<p>You can disable this by setting <code>:hud false</code> in the <code>:devtools</code> section.</p>
</div>
<div class="sect4">
<h5 id="_opening_files"><a class="anchor" href="#_opening_files"></a><a class="link" href="#_opening_files">Opening Files</a></h5>
<div class="paragraph">
<p>Warnings include a link to source location which can be clicked to open the file in your editor. For this a little bit of config is required.</p>
</div>
<div class="paragraph">
<p>You can either configure this in your <code>shadow-cljs.edn</code> config for the project or globally in your home directory under <code>~/.shadow-cljs/config.edn</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code>:open-file-command</code> configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:open-file-command</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">idea</span><span class="delimiter">&quot;</span></span> <span class="symbol">:pwd</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">--line</span><span class="delimiter">&quot;</span></span> <span class="symbol">:line</span> <span class="symbol">:file</span>]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:open-file-command</code> expects a vector representing a very simple DSL. Strings are kept as they are and keyword are replaced by their respective values. A nested vector can be used in case you need to combine multiple params, using <code>clojure.core/format</code> style pattern.</p>
</div>
<div class="paragraph">
<p>The above example would execute</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ idea /path/to/project-root --line 3 /path/to/project-root/srv/main/demo/foo.cljs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>emacsclient</code> example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:open-file-command</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">emacsclient</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-n</span><span class="delimiter">&quot;</span></span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">+%s:%s</span><span class="delimiter">&quot;</span></span> <span class="symbol">:line</span> <span class="symbol">:column</span>] <span class="symbol">:file</span>]}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ emacsclient -n +3:1 /path/to/project-root/srv/main/demo/foo.cljs</code></pre>
</div>
</div>
<div class="paragraph">
<p>The available replacement variables are:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:pwd</code></dt>
<dd>
<p>Process Working Directory (aka project root)</p>
</dd>
<dt><code>:file</code></dt>
<dd>
<p>Absolute File Path</p>
</dd>
<dt><code>:line</code></dt>
<dd>
<p>Line Number of Warning/Error</p>
</dd>
<dt><code>:column</code></dt>
<dd>
<p>Column Number</p>
</dd>
<dt><code>:wsl-file</code></dt>
<dd>
<p>Translated WSL file path. Useful when running <code>shadow-cljs</code> via WSL Bash. Translates a <code>/mnt/c/Users/someone/code/project/src/main/demo/foo.cljs</code> path into <code>C:\Users...</code></p>
</dd>
<dt><code>:wsl-pwd</code></dt>
<dd>
<p>Translated <code>:pwd</code></p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="browser-http-server"><a class="anchor" href="#browser-http-server"></a><a class="link" href="#browser-http-server">6.8.2. HTTP Server</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> can provide a basic HTTP server for your build. By default it will serve all static files from the configured <code>:http-root</code> directory, and fall back to <code>index.html</code> when a resource is not found (this is what you typically want when developing an application which uses browser push state).</p>
</div>
<div class="paragraph">
<p>The server supports the following options:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:http-root</code></dt>
<dd>
<p>The disk path from which to serve root filesystem requests. If not supplied,
no disk files are served.</p>
</dd>
<dt><code>:http-port</code></dt>
<dd>
<p>The port to serve from.</p>
</dd>
<dt><code>:http-host</code></dt>
<dd>
<p>Optional. The hostname to listen on. Defaults to localhost.</p>
</dd>
<dt><code>:http-resource-root</code></dt>
<dd>
<p>Optional. A path relative to classpath from which resources can be served.
If not supplied, no resources are served.</p>
</dd>
<dt><code>:http-handler</code></dt>
<dd>
<p>Optional. A namespace (as a symbol). A <code>(fn [req] resp)</code> that is used
if a resource is not found for the given request. Defaults to <code>shadow.http.push-state/handle</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following two options only apply when using the default, built-in handler:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>:push-state/headers</code></dt>
<dd>
<p>(optional) A map of HTTP headers to respond with. Defaults to <code>text/html</code> standard headers.</p>
</dd>
<dt class="hdlist1"><code>:push-state/index</code></dt>
<dd>
<p>(optional) The file to serve. Defaults to <code>index.html</code>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Typical HTTP config serving the "public" directory under <a href="http://localhost:8080" class="bare">http://localhost:8080</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 {<span class="symbol">:builds</span>
  {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
         <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
         <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
         <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:entries</span> [my.app]}}
         <span class="keyword">..</span><span class="keyword">.</span>
         <span class="symbol">:devtools</span> {<span class="symbol">:http-root</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:http-port</span> <span class="integer">8080</span>}}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>public/index.html</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="doctype">&lt;!doctype html&gt;</span>
<span class="tag">&lt;html&gt;</span>
<span class="tag">&lt;body&gt;</span>
<span class="tag">&lt;h1&gt;</span>Hello World<span class="tag">&lt;/h1&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/js/main.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_css_reloading"><a class="anchor" href="#_css_reloading"></a><a class="link" href="#_css_reloading">6.8.3. CSS Reloading</a></h4>
<div class="paragraph">
<p>The Browser devtools can also reload CSS for you. This is enabled by default and in most cases requires no additional
configuration when you are using the built-in HTTP dev server.</p>
</div>
<div class="paragraph">
<p>The server will watch the configured <code>:http-root</code> and notify the client about file updates. If a <code>.css</code> file is linked
with an absolute path it will be reloaded on change. Relative paths are currently not supported.</p>
</div>
<div class="listingblock">
<div class="title">Example HTML snippet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;link</span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/css/main.css</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Hiccup since we aren&#8217;t savages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[<span class="symbol">:link</span> {<span class="symbol">:rel</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/css/main.css</span><span class="delimiter">&quot;</span></span>}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will cause an update if the file <code>&lt;:http-root&gt;/css/main.css</code> is changed.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> currently provides no support for directly compiling CSS but the usual tools will work and should
be run separately. Just make sure the output is generated into the correct places.</p>
</div>
<div class="paragraph">
<p>When you are not using the built-in HTTP Server you can specify <code>:watch-dir</code> instead which should be a path to the
document root used to serve your content.</p>
</div>
<div class="listingblock">
<div class="title">Example :watch-dir config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
    {<span class="symbol">:builds</span>
      {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
             <span class="symbol">:devtools</span> {<span class="symbol">:watch-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}}}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_proxy_support"><a class="anchor" href="#_proxy_support"></a><a class="link" href="#_proxy_support">6.8.4. Proxy Support</a></h4>
<div class="paragraph">
<p>By default the devtools client will attempt to connect to the <code>shadow-cljs</code> process via the configured <a href="#http">HTTP server</a> (usually <code>localhost</code>). If you are using a reverse proxy to serve your HTML that might not be possible. You can set <code>:devtools-url</code> to configure which URL to use.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:before-load</span>  my.app/stop
                   <span class="symbol">:after-load</span>   my.app/start
                   <span class="symbol">:devtools-url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://some.host/shadow-cljs</span><span class="delimiter">&quot;</span></span>
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> will then use the <code>:devtools-url</code> as the base when making requests. It is not the final URL so you must ensure that all requests starting with the path you configured (eg. <code>/shadow-cljs/*</code>) are forwarded to the host <code>shadow-cljs</code> is running on.</p>
</div>
<div class="listingblock">
<div class="title">Incoming Request to Proxy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">https://some.host/shadow-cljs/ws/foo/bar?asdf</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">must forward to</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">http<span class="symbol">://localhost</span><span class="error">:</span><span class="integer">9630</span>/foo/bar?asdf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client will make WebSocket request as well as normal XHR requests to load files. Ensure that your proxy properly upgrades WebSockets.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The requests must be forwarded to the main <a href="#http">HTTP server</a>, not the one configured in the build itself.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="target-node"><a class="anchor" href="#target-node"></a><a class="link" href="#target-node">7. Targeting node.js</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is built-in support for generating code that is intended to be used as a stand-alone
script, and also for code that is intended to be used as a library. See the
section on <a href="#CommonConfig">common configuration</a> for the base settings needed in
a configuration file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The optimizations in node at the time of this writing default to <code>:simple</code>.
You can use the normal configuration options to set the <a href="#Optimization">optimization level</a>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="target-node-script"><a class="anchor" href="#target-node-script"></a><a class="link" href="#target-node-script">7.1. node.js Scripts</a></h3>
<div class="paragraph">
<p>The <code>:target :node-script</code> produces single-file stand-alone output that can be run using <code>node.js</code>.
The code is just ClojureScript, and an entry point is easy to define:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.script</span>)

(<span class="keyword">defn</span> <span class="function">main</span> [&amp; cli-args]
  (<span class="keyword">prn</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_build_options"><a class="anchor" href="#_build_options"></a><a class="link" href="#_build_options">7.1.1. Build Options</a></h4>
<div class="paragraph">
<p>You will need the same basic <a href="#CommonConfig">main configuration</a> as in other targets (like
<code>:source-paths</code>), but you&#8217;ll need some node-specific build target options:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:main</code>
</td>
<td class="hdlist2">
<p>(required). The namespace-qualified symbol of your script&#8217;s entry point function.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>(required). The path and filename for the generated script.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>(optional). The path for supporting files in development mode. Defaults to a cache directory.</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Sample node script build</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:script</span>
            {<span class="symbol">:id</span>        <span class="symbol">:script</span>
             <span class="symbol">:target</span>    <span class="symbol">:node-script</span>
             <span class="symbol">:main</span>      demo.script/main
             <span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out/demo-script/script.js</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When compiled this results in a standalone <code>out/demo-script/script.js</code> file intended to be called
via <code>node script.js &lt;command line args&gt;</code>. When run it will call <code>(demo.script/main &lt;command line args&gt;)</code>
function on startup. This only ever produces the file specified in <code>:output-to</code>. Any other support files
(e.g. for development mode) are written to a temporary support directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="NodeHotCodeReload"><a class="anchor" href="#NodeHotCodeReload"></a><a class="link" href="#NodeHotCodeReload">7.1.2. Hot Code Reload</a></h4>
<div class="paragraph">
<p>You will often write scripts that run as servers or some other long-running process. Hot code reload can
be quite useful when working with these, and it is simple to set up:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add start/stop callback functions.</p>
</li>
<li>
<p>Configure the build use those hooks.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here is an example http server in node:</p>
</div>
<div class="listingblock">
<div class="title">Sample node script with start/stop hooks for hot code reload.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.script</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> http]))

(<span class="keyword">defn</span> <span class="function">request-handler</span> [req res]
  (<span class="keyword">.</span>end res <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>))

<span class="comment">; a place to hang onto the server so we can stop/start it</span>
(<span class="keyword">defonce</span> <span class="function">server-ref</span>
  (volatile! <span class="predefined-constant">nil</span>))

(<span class="keyword">defn</span> <span class="function">main</span> [&amp; args]
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">starting server</span><span class="delimiter">&quot;</span></span>)
  (<span class="keyword">let</span> [server (http/createServer #(request-handler %1 %2))]

    (<span class="keyword">.</span>listen server <span class="integer">3000</span>
      (<span class="keyword">fn</span> [err]
        (<span class="keyword">if</span> err
          (js/console.error <span class="string"><span class="delimiter">&quot;</span><span class="content">server start failed</span><span class="delimiter">&quot;</span></span>)
          (js/console.info <span class="string"><span class="delimiter">&quot;</span><span class="content">http server running</span><span class="delimiter">&quot;</span></span>))
        ))

    (vreset! server-ref server)))

(<span class="keyword">defn</span> <span class="function">start</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Hook to start. Also used as a hook for hot code reload.</span><span class="delimiter">&quot;</span></span>
  []
  (js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">start called</span><span class="delimiter">&quot;</span></span>)
  (main))

(<span class="keyword">defn</span> <span class="function">stop</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Hot code reload hook to shut down resources so hot code reload can work</span><span class="delimiter">&quot;</span></span>
  [done]
  (js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">stop called</span><span class="delimiter">&quot;</span></span>)
  (when-some [srv @server-ref]
    (<span class="keyword">.</span>close srv
      (<span class="keyword">fn</span> [err]
        (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop completed</span><span class="delimiter">&quot;</span></span> err)
        (done)))))

(js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">__filename</span><span class="delimiter">&quot;</span></span> js/__filename)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The associated configuration is (<code>shadow-cljs.edn</code>):</p>
</div>
<div class="listingblock">
<div class="title">Adding hooks for hot code reload.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   { <span class="symbol">:script</span> {<span class="keyword">..</span><span class="keyword">.</span> as before

              <span class="comment">; add in reload hooks</span>
              <span class="symbol">:devtools</span> {<span class="symbol">:before-load-async</span> demo.script/stop
                         <span class="symbol">:after-load</span> demo.script/start}}}}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Many libraries hide state or do actions that prevent hot code reloading from working well. There
is nothing the compiler can do to improve this since it has no idea what those libraries are doing.
Hot code reload will only work well in situations where you can cleanly "stop" and "restart" the
artifacts used.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="target-node-library"><a class="anchor" href="#target-node-library"></a><a class="link" href="#target-node-library">7.2. node.js Libraries</a></h3>
<div class="paragraph">
<p>The <code>:target :node-library</code> emits code that can be used (via <code>require</code>) as a standard node library, and is
useful for publishing your code for re-use as a compiled Javascript artifact.</p>
</div>
<div class="paragraph">
<p>As with other modes the <a href="#CommonConfig">main configuration options</a> apply and must be set.
The target-specific options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p>Use :node-library</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>(required). The path and filename for the generated library.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>(optional). The path for supporting files in development mode. Defaults to a cache directory.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The hot code reload story is similar to <a href="#NodeHotCodeReload">the script target</a>, but may not work as well
since it cannot as easily control all of the code that is loaded.</p>
</div>
<div class="paragraph">
<p>Controlling what code is actually exported is done via one of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:exports</code> -  a map of keyword to fully qualified symbols</p>
</li>
<li>
<p><code>:exports-var</code> - a fully qualified symbol</p>
</li>
<li>
<p><code>:exports-fn</code> - a fully qualified symbol</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_single_static_default_export"><a class="anchor" href="#_single_static_default_export"></a><a class="link" href="#_single_static_default_export">7.2.1. Single static "default" export</a></h4>
<div class="paragraph">
<p><code>:exports-var</code> will just return whatever is declared under that var. It can point to a <code>defn</code> or normal <code>def</code>.</p>
</div>
<div class="listingblock">
<div class="title">Build config using <code>:exports-var</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:lib</span> {<span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">lib.js</span><span class="delimiter">&quot;</span></span>
                <span class="symbol">:exports-var</span> demo.ns/f
                <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example CLJS</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.ns</span>)

(<span class="keyword">defn</span> <span class="function">f</span> [<span class="keyword">..</span><span class="keyword">.</span>] <span class="keyword">..</span><span class="keyword">.</span>)
<span class="comment">;; OR</span>
(<span class="keyword">def</span> <span class="function">f</span> <span class="error">#</span>js {<span class="symbol">:foo</span> <span class="keyword">..</span><span class="keyword">.</span>})</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Consuming the generated code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ node
&gt; var f = require(2'./lib.js');
f(); // the actual demo.ns/f function</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is effectively generating <code>module.exports = demo.ns.f;</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_multiple_static_named_exports"><a class="anchor" href="#_multiple_static_named_exports"></a><a class="link" href="#_multiple_static_named_exports">7.2.2. Multiple static named exports</a></h4>
<div class="listingblock">
<div class="title">Build configuration with multiple exports</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:lib</span> {<span class="symbol">:exports</span> {<span class="symbol">:g</span>       demo.ns/f
                          <span class="symbol">:h</span>       other.ns/thing
                          <span class="symbol">:ns/ok?</span>  another.ns/ok?}
                <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The keyword is used as the name of the entry in the exported object. <strong>No munging is done</strong> to this keyword name
(but namespaces are dropped). So, the above example maps cljs <code>f</code> to <code>g</code>, etc.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ node
&gt; var lib = require('./lib.js');
lib.g(); // call demo-ns/f
lib[&quot;ok?&quot;](); // call another-ns/ok?</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can achieve the exact same thing by using <code>:exports-var</code> pointing to a <code>def</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">exports</span> <span class="error">#</span>js {<span class="symbol">:g</span> f
                  <span class="keyword">..</span><span class="keyword">.</span>})</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_exports"><a class="anchor" href="#_dynamic_exports"></a><a class="link" href="#_dynamic_exports">7.2.3. "Dynamic" exports</a></h4>
<div class="paragraph">
<p>In addition you may specify <code>:exports-fn</code> as a fully qualified symbol. This should point to a function with no arguments which should return a JS object (or function). This function will only ever be called ONCE as <code>node</code> caches the return value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.ns</span>
  (<span class="symbol">:require</span> [demo.other <span class="symbol">:as</span> other]))

(<span class="keyword">defn</span> <span class="function">generate-exports</span> []
  <span class="error">#</span>js {<span class="symbol">:hello</span> hello
       <span class="symbol">:foo</span> other/foo})</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:lib</span> {<span class="symbol">:exports-fn</span> demo.ns/generate-exports
                <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The exports config automatically tracks exported symbols and passes them on to the optimization stage. This means that anything listed in <code>:exports</code> will not be renamed by Google Closure optimizations.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_full_example"><a class="anchor" href="#_full_example"></a><a class="link" href="#_full_example">7.2.4. Full Example</a></h4>
<div class="paragraph">
<p>The example below creates a <code>lib.js</code> file intended to be consumed via the normal Node <code>require</code> mechanism.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.lib</span>)

(<span class="keyword">defn</span> <span class="function">hello</span> []
  (<span class="keyword">prn</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
  <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The build configuration would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:library</span> {<span class="symbol">:target</span>    <span class="symbol">:node-library</span>
                    <span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out/demo-library/lib.js</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:exports</span>   {<span class="symbol">:hello</span> demo.lib/hello}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the runtime use is as you would expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ cd out/demo-library
$ node
<span class="keyword">&gt;</span> <span class="keyword">var</span> x <span class="keyword">=</span> <span class="keyword">require</span>('<span class="keyword">.</span>/lib')<span class="comment">;</span>
undefined
<span class="keyword">&gt;</span> x.hello()
hello
'hello'</code></pre>
</div>
</div>
<div class="paragraph">
<p>As <code>:node-script</code> this will only create the file specified in <code>:output-to</code>. The <code>:exports</code> map maps CLJS vars to the name they should be exported to.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Development mode has the <a href="#NodeModes">same setup</a> as for node scripts (extra dependencies).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_code_npm_code_packages"><a class="anchor" href="#_creating_code_npm_code_packages"></a><a class="link" href="#_creating_code_npm_code_packages">7.3. Creating <code>npm</code> packages</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="target-npm-module"><a class="anchor" href="#target-npm-module"></a><a class="link" href="#target-npm-module">8. Embedding in the JS Ecosystem&#8201;&#8212;&#8201;The <code>:npm-module</code> Target</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is an additional target that is intended to help you use <code>shadow-cljs</code> as <strong>part</strong> of
a project and provide seamless integration with existing JS tools (eg. webpack, browserify, babel,
create-react-app, &#8230;&#8203;) with as little configuration as possible.</p>
</div>
<div class="paragraph">
<p>It can be configured like other targets, but since it is meant to work in the JS ecosystem it
comes with a convenience mode that makes such integration easier.</p>
</div>
<div class="sect2">
<h3 id="_convenience_mode"><a class="anchor" href="#_convenience_mode"></a><a class="link" href="#_convenience_mode">8.1. Convenience Mode</a></h3>
<div class="paragraph">
<p>This target is meant to be as easy to access as possible, and does not actually require a specific
build in the config. You still need a non-empty config file, but the default one from
<code>shadow-cljs init</code> will do.</p>
</div>
<div class="paragraph">
<p>ClojureScript organizes files into namespaces which means that a <code>demo.foo</code> namespace should be inside a
<code>src/demo/foo.cljs</code> file. Where <code>src</code> is the default source path the shadow-cljs tool (see <a href="#CommonConfig">main configuration</a>).</p>
</div>
<div class="paragraph">
<p>If you have this file in <code>src/demo</code>:</p>
</div>
<div class="listingblock">
<div class="title">Sample source for <code>foo.cljs</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.foo</span>)

(<span class="keyword">defn</span> <span class="function">hello</span> [who]
  (<span class="keyword">str</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello, </span><span class="delimiter">&quot;</span></span> who <span class="string"><span class="delimiter">&quot;</span><span class="content">!</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>you can compile it (and any others) via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs compile npm
[:npm] Build completed. (16 files, 5 compiled, 0 warnings, 7.91s)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated exports will be named <code>shadow-cljs/</code> with the CLJS namespace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="predefined">$</span> node
&gt; <span class="keyword">var</span> x = require(<span class="string"><span class="delimiter">&quot;</span><span class="content">shadow-cljs/demo.foo</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-constant">undefined</span>
&gt; x.hello(<span class="string"><span class="delimiter">&quot;</span><span class="content">JS</span><span class="delimiter">&quot;</span></span>)
<span class="string"><span class="delimiter">'</span><span class="content">Hello, JS!</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Watching with incremental compile is as simple as running <code>shadow-cljs watch npm</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_explicit_configuration"><a class="anchor" href="#_explicit_configuration"></a><a class="link" href="#_explicit_configuration">8.2. Explicit Configuration</a></h3>
<div class="paragraph">
<p>You can also treat <code>:npm-module</code> on the same footing with your other builds: give it explicit
configuration. This allows you to also customize the code generation options. Of course
you will configure the <a href="#CommonConfig">main configuration</a> as in all targets. The target-specific
options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p>Use :npm-module</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>The path for supporting files in development mode.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:entries</code>
</td>
<td class="hdlist2">
<p>(optional) A vector of namespaces to include. Everything from these will be included.
Defaults to everything it can find.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use an <code>:output-dir</code> like <code>"node_modules/shadow-cljs"</code> you can access them by using <code>require("shadow-cljs/demo.foo")</code>. When using something not in <code>node_modules</code> you must include them using a relative path. With <code>:output-dir "out"</code> that would be <code>require("./out/demo.foo")</code> from your project root.</p>
</div>
<div class="paragraph">
<p>If you plan to distribute code on NPM, then you may want to use the <a href="#NodeLibrary"><code>:node-library</code> target</a> instead since it allows for a finer level of control over exports and optimization.</p>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_optimizations"><a class="anchor" href="#_working_with_optimizations"></a><a class="link" href="#_working_with_optimizations">8.3. Working with Optimizations</a></h3>
<div class="paragraph">
<p>Unlike the <code>:node-library</code> target, the module target does not know what you want to call the
symbols you&#8217;re exporting, so it just exports them as-is. If you use advanced compilation, then everything
will get a minified munged name!</p>
</div>
<div class="paragraph">
<p>This is easy to remedy, simply add <code>:export</code> metadata on any symbols that you want to preserve:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> ^<span class="symbol">:export</span> my-constant <span class="float">5.662</span>)
(<span class="keyword">defn</span> ^<span class="symbol">:export</span> my-function [] <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a standard annotation that is understood by ClojureScript and prevents Google Closure from
renaming an artifact.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing"><a class="anchor" href="#_testing"></a><a class="link" href="#_testing">9. Testing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> provides a few ultility targets to make building tests a little easier.</p>
</div>
<div class="paragraph">
<p>All test targets generate a test runner and automatically add all namespaces matching the configurable <code>:ns-regexp</code>. The default test runners were built for <code>cljs.test</code> but you can create custom runners if you prefer to use other test frameworks.</p>
</div>
<div class="paragraph">
<p>The default <code>:ns-regexp</code> is <code>"-test$"</code>, so your first test could look like:</p>
</div>
<div class="listingblock">
<div class="title">File: <code>src/test/demo/app_test.cljs</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.app-test</span>
  (<span class="symbol">:require</span> [cljs.test <span class="symbol">:refer</span> (deftest is)]))

(deftest a-failing-test
  (is (<span class="keyword">=</span> <span class="integer">1</span> <span class="integer">2</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the Clojure world it is common to keep test files in their own source paths so the above example assumes you have configured <code>:source-paths ["src/main" "src/test"]</code> in your <code>shadow-cljs.edn</code> config. Your usual app code goes into <code>src/main</code> and the tests go into <code>src/test</code>. This however is optional and it is totally fine to keep everything in <code>src</code> and just use <code>:source-paths ["src"]</code>.</p>
</div>
<div class="sect2">
<h3 id="target-node-test"><a class="anchor" href="#target-node-test"></a><a class="link" href="#target-node-test">9.1. Testing in node.js</a></h3>
<div class="paragraph">
<p>This target will create a test runner including all test namespaces matching the given regular expression.</p>
</div>
<div class="paragraph">
<p>The relevant configuration options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p><code>:node-test</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>The final output file that will be used to run tests.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:ns-regexp</code>
</td>
<td class="hdlist2">
<p>(optional) A regular expression matching namespaces against project files. This only scans files, and will not scan jars. Defaults to <code>"-test$"</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:autorun</code>
</td>
<td class="hdlist2">
<p>(boolean, optional) Run the tests via <code>node</code> when a build completes. This is mostly meant to be used in combination with <code>watch</code>. The <code>node</code> process exit code will not be returned and that would have to forcefully kill the running JVM.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:main</code>
</td>
<td class="hdlist2">
<p>(qualified symbol, optional) Function called on startup to run the tests, defaults to <code>shadow.test.node/main</code> which runs tests using <code>cljs.test</code>.</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Test config matching all <code>*-spec</code> namespaces</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:test</span>
  {<span class="symbol">:target</span>    <span class="symbol">:node-test</span>
   <span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out/node-tests.js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:ns-regexp</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-spec$</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:autorun</span>   <span class="predefined-constant">true</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:node-test</code> target only generates the test file. You can run it via <code>node</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs compile test
# or
$ shadow-cljs release test

# run tests manually, :autorun will do this automatically
$ node out/node-tests.js

# compile &amp; test combined
$ shadow-cljs compile test &amp;&amp; node out/node-tests.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>node</code> process exit code will be set to <code>0</code> when successful and <code>1</code> on any failures.</p>
</div>
</div>
<div class="sect2">
<h3 id="target-browser-test"><a class="anchor" href="#target-browser-test"></a><a class="link" href="#target-browser-test">9.2. Testing in the Browser</a></h3>
<div class="paragraph">
<p>This target is meant for gathering up namespaces that contain tests (based on a filename pattern match),
and triggering a test runner. It contains a built-in runner that will automatically scan for <code>cljs.test</code>
tests and run them.</p>
</div>
<div class="paragraph">
<p>The relevant configuration options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p><code>:browser-test</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:test-dir</code>
</td>
<td class="hdlist2">
<p>A folder in which to output files. See below.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:ns-regexp</code>
</td>
<td class="hdlist2">
<p>(optional) A regular expression matching namespaces against project files. This only scans files, and
will not scan jars. Defaults to "-test$".</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:runner-ns</code>
</td>
<td class="hdlist2">
<p>(optional) A namespace that can contain a start, stop, and init function. Defaults to
<code>shadow.test.browser</code>.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The normal <code>:devtools</code> options are supported, so you will usually create an http server to serve the files.
In general you will need a config that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:test</span>     {<span class="symbol">:target</span>    <span class="symbol">:browser-test</span>
                     <span class="symbol">:test-dir</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">resources/public/js/test</span><span class="delimiter">&quot;</span></span>
                     <span class="symbol">:ns-regexp</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-spec$</span><span class="delimiter">&quot;</span></span>
                     <span class="symbol">:runner-ns</span> tests.client-test-main
                     <span class="symbol">:devtools</span>  {<span class="symbol">:http-port</span>          <span class="integer">8021</span>
                                 <span class="symbol">:http-root</span>          <span class="string"><span class="delimiter">&quot;</span><span class="content">resources/public/js/test</span><span class="delimiter">&quot;</span></span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that the test directory will have the index.html, and a js folder.</p>
</div>
<div class="paragraph">
<p>If you choose to supply a custom <code>:runner-ns</code>, it might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">tests.client-test-main</span>)

(<span class="keyword">defn</span> <span class="function">start</span> []
  <span class="keyword">..</span><span class="keyword">.</span> run the tests.<span class="keyword">..</span>)

(<span class="keyword">defn</span> <span class="function">stop</span> [done]
  <span class="comment">; tests can be async. You must call done so that the runner knows you actually finished</span>
  (done))

(<span class="keyword">defn</span> ^<span class="symbol">:export</span> init []
  (start))</code></pre>
</div>
</div>
<div class="paragraph">
<p>It just has <code>init</code>, <code>start</code>, <code>stop</code> methods. <code>init</code> will be called once on startup, <code>stop</code> will be called before any code is reloaded and <code>start</code> will be called after all code was reloaded.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<code>:runner-ns</code> is optional, just leave it out to use the default.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_generated_output_in_code_test_dir_code"><a class="anchor" href="#_generated_output_in_code_test_dir_code"></a><a class="link" href="#_generated_output_in_code_test_dir_code">9.2.1. Generated output in <code>:test-dir</code></a></h4>
<div class="paragraph">
<p>The output includes two primary artifacts in your <code>test-dir</code> folder:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>index.html</code> - If and only if there was not already an <code>index.html</code> file present. By default the generated
file loads the tests and runs <code>init</code> in the <code>:runner-ns</code>. You may edit or add a custom version that will
not be overwritten.</p>
</li>
<li>
<p><code>js/test.js</code> - The Javascript tests. The tests will always have this name. The entries for the module are
auto-generated.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="target-karma"><a class="anchor" href="#target-karma"></a><a class="link" href="#target-karma">9.3. Targeting Tests to Karma for Continuous Integration</a></h3>
<div class="paragraph">
<p>When you want to run your CLJS tests against a browser on some kind of CI server you&#8217;ll need to
be able to run the tests from a command line and get back a status code. Karma is a well-known
and supported test runner that can do this for you, and <code>shadow-cljs</code> includes a target that
can add the appropriate wrappers around your tests so they will work in it.</p>
</div>
<div class="sect3">
<h4 id="_installing_karma"><a class="anchor" href="#_installing_karma"></a><a class="link" href="#_installing_karma">9.3.1. Installing Karma</a></h4>
<div class="paragraph">
<p>See their <a href="http://karma-runner.github.io">website</a> for full instructions. You&#8217;ll typically need
something like this is your <code>package.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">CITests</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Testing</span><span class="delimiter">&quot;</span></span>,
  <span class="error">.</span><span class="error">.</span><span class="error">.</span>
  <span class="key"><span class="delimiter">&quot;</span><span class="content">devDependencies</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">karma</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^2.0.0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">karma-chrome-launcher</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^2.2.0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">karma-cljs-test</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^0.1.0</span><span class="delimiter">&quot;</span></span>,
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">license</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">MIT</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, you need Karma, a browser launcher, and the cljs-test integration.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_build"><a class="anchor" href="#_the_build"></a><a class="link" href="#_the_build">9.3.2. The Build</a></h4>
<div class="paragraph">
<p>The build options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p><code>:karma</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>A path/filename for the js file.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:ns-regexp</code>
</td>
<td class="hdlist2">
<p>(optional) A regex to match the test namespaces, defaults to "-test$</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So you might have something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:ci</span>
  {<span class="symbol">:target</span> <span class="symbol">:karma</span>
   <span class="symbol">:output-to</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">target/ci.js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:ns-regexp</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">-spec$</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You also need a <code>karma.conf.js</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">module.<span class="function">exports</span> = <span class="keyword">function</span> (config) {
    config.set({
        <span class="key">browsers</span>: [<span class="string"><span class="delimiter">'</span><span class="content">ChromeHeadless</span><span class="delimiter">'</span></span>],
        <span class="comment">// The directory where the output file lives</span>
        <span class="key">basePath</span>: <span class="string"><span class="delimiter">'</span><span class="content">target</span><span class="delimiter">'</span></span>,
        <span class="comment">// The file itself</span>
        <span class="key">files</span>: [<span class="string"><span class="delimiter">'</span><span class="content">ci.js</span><span class="delimiter">'</span></span>],
        <span class="key">frameworks</span>: [<span class="string"><span class="delimiter">'</span><span class="content">cljs-test</span><span class="delimiter">'</span></span>],
        <span class="key">plugins</span>: [<span class="string"><span class="delimiter">'</span><span class="content">karma-cljs-test</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">karma-chrome-launcher</span><span class="delimiter">'</span></span>],
        <span class="key">colors</span>: <span class="predefined-constant">true</span>,
        <span class="key">logLevel</span>: config.LOG_INFO,
        <span class="key">client</span>: {
            <span class="key">args</span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">shadow.test.karma.init</span><span class="delimiter">&quot;</span></span>],
            <span class="key">singleRun</span>: <span class="predefined-constant">true</span>
        }
    })
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>then you can run the tests as follows (assuming you&#8217;ve installed global executables of the tools):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs compile ci
$ karma start --single-run
12 01 2018 01:19:24.222:INFO [karma]: Karma v2.0.0 server started at http://0.0.0.0:9876/
12 01 2018 01:19:24.224:INFO [launcher]: Launching browser ChromeHeadless with unlimited concurrency
12 01 2018 01:19:24.231:INFO [launcher]: Starting browser ChromeHeadless
12 01 2018 01:19:24.478:INFO [HeadlessChrome 0.0.0 (Mac OS X 10.12.6)]: Connected on socket TcfrjxVKmx7xN6enAAAA with id 85554456
LOG: 'Testing boo.sample-spec'
HeadlessChrome 0.0.0 (Mac OS X 10.12.6): Executed 1 of 1 SUCCESS (0.007 secs / 0.002 secs)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="js-deps"><a class="anchor" href="#js-deps"></a><a class="link" href="#js-deps">10. JavaScript Integration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="npm"><a class="anchor" href="#npm"></a><a class="link" href="#npm">10.1. NPM</a></h3>
<div class="paragraph">
<p><a href="https://www.npmjs.com/">npm</a> has come the de-facto standard package manager for JavaScript. Almost all JS libraries can be found there and shadow-cljs provides seamless integration for accessing those packages.</p>
</div>
<div class="sect3">
<h4 id="_using_npm_packages"><a class="anchor" href="#_using_npm_packages"></a><a class="link" href="#_using_npm_packages">10.1.1. Using npm packages</a></h4>
<div class="paragraph">
<p>Most npm packages will also include some instructions on how to use the actual code. The “old” CommonJS style just has require calls which translate directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="keyword">var</span> react = require(<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whatever "string" parameter is used when calling require we transfer to the <code>:require</code> as-is. The <code>:as</code> alias is up to you. Once we have that we can use the code like any other CLJS namespace!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(react/createElement <span class="string"><span class="delimiter">&quot;</span><span class="content">div</span><span class="delimiter">&quot;</span></span> <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>shadow-cljs</code>: <strong>always use the <code>ns</code> form and whatever <code>:as</code> alias you provided.</strong> You may also use <code>:refer</code> and <code>:rename</code>. This is different than what <code>:foreign-libs</code>/CLJSJS does where you include the thing in the namespace but then used a global <code>js/Thing</code> in your code.</p>
</div>
<div class="paragraph">
<p>Some packages just export a single function which you can call directly by
using <code>(:require ["thing" :as thing])</code> and then <code>(thing)</code>.</p>
</div>
<div class="paragraph">
<p>More recently some packages started using ES6 <code>import</code> statements in their examples. Those also translate pretty much 1:1 with one slight difference related to default exports.</p>
</div>
<div class="paragraph">
<p>The following table can be used for translation:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. ES6 Import to CLJS Require</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ES6 Import</th>
<th class="tableblock halign-left valign-top">CLJS Require</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import defaultExport from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :default defaultExport])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import * as name from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :as name])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import { export } from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :refer (export)])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import { export as alias } from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :rename {export alias}])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import { export1 , export2 } from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :refer (export1 export2)])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import { export1 , export2 as alias2 , [&#8230;&#8203;] } from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :refer (export1) :rename {export2 alias2}])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import defaultExport, { export [ , [&#8230;&#8203;] ] } from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :refer (export) :default defaultExport])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import defaultExport, * as name from "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name" :as name :default defaultExport])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>import "module-name";</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>(:require ["module-name"])</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Notice that previously we were stuck using bundled code which included a lot of code we didn’t actually need. Now we&#8217;re in a better situation:
Some libraries are also packaged in ways  ways that allow you to include only the parts you need, leading to much less code in your final build.</p>
</div>
<div class="paragraph">
<p><code>react-virtualized</code> is a great example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="comment">// You can import any component you want as a named export from 'react-virtualized', eg</span>
<span class="reserved">import</span> { Column, Table } from <span class="string"><span class="delimiter">'</span><span class="content">react-virtualized</span><span class="delimiter">'</span></span>

<span class="comment">// But if you only use a few react-virtualized components,</span>
<span class="comment">// And you're concerned about increasing your application's bundle size,</span>
<span class="comment">// You can directly import only the components you need, like so:</span>
<span class="reserved">import</span> AutoSizer from <span class="string"><span class="delimiter">'</span><span class="content">react-virtualized/dist/commonjs/AutoSizer</span><span class="delimiter">'</span></span>
<span class="reserved">import</span> List from <span class="string"><span class="delimiter">'</span><span class="content">react-virtualized/dist/commonjs/List</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With our improved support we we can easily translate this to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my-ns</span>
  <span class="comment">;; all</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-virtualized</span><span class="delimiter">&quot;</span></span> <span class="symbol">:refer</span> (Column Table)])
  <span class="comment">;; OR one by one</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-virtualized/dist/commonjs/AutoSizer</span><span class="delimiter">&quot;</span></span> <span class="symbol">:default</span> virtual-auto-sizer]
            [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-virtualized/dist/commonjs/List</span><span class="delimiter">&quot;</span></span> <span class="symbol">:default</span> virtual-list]))</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_about_default_exports"><a class="anchor" href="#_about_default_exports"></a><a class="link" href="#_about_default_exports">About :default Exports</a></h5>
<div class="paragraph">
<p>The <code>:default</code> option is currently only available in <code>shadow-cljs</code>, you can
<a href="https://dev.clojure.org/jira/browse/CLJS-2376">vote here</a> to hopefully make it standard. You can always use <code>:as alias</code> and then call <code>alias/default</code> if you prefer to stay compatible with standard CLJS in the meantime.</p>
</div>
<div class="paragraph">
<p>Default exports are a new addition in ECMAScript Modules and do not exist in CommonJS code. Sometimes you will see examples of <code>import Foo from "something"</code> when the code is actually CommonJS code. In theses cases <code>(:require ["something" :default Foo])</code> will not work and <code>(:require ["something" :as Foo])</code> must be used instead.</p>
</div>
<div class="paragraph">
<p>If a <code>:require</code> does not seem to work properly it is recommended to try looking at it in the REPL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs browser-repl (<span class="keyword">or</span> node-repl)
<span class="keyword">..</span><span class="keyword">.</span>
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; (<span class="keyword">require</span> '[<span class="string"><span class="delimiter">&quot;</span><span class="content">react-tooltip</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> x])
<span class="predefined-constant">nil</span>
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; x
<span class="error">#</span>object[e]
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; (goog/typeOf x)
<span class="string"><span class="delimiter">&quot;</span><span class="content">function</span><span class="delimiter">&quot;</span></span>
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; (js/console.dir x)
<span class="predefined-constant">nil</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since printing arbitrary JS objects is not always useful (as seen above) you can use <code>(js/console.dir x)</code> instead to get a more useful reprensentation in the browser console. <code>goog/typeOf</code> may also be useful at times. Since the above example shows <code>"function"</code> using <code>:default</code> would not work since <code>:default</code> basically is just syntax sugar for <code>x/default</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="js-provider"><a class="anchor" href="#js-provider"></a><a class="link" href="#js-provider">10.1.2. Package Provider</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> supports several different ways to include <code>npm</code> packages into your build. They are configurable via the <code>:js-options :js-provider</code> setting. Each <code>:target</code> usually sets the one appropriate for your build most often you won&#8217;t need to touch this setting.</p>
</div>
<div class="paragraph">
<p>Currently there are 3 supported JS Providers:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:require</code></dt>
<dd>
<p>Maps directly to the JS <code>require("thing")</code> function call. It is the default for all <code>node.js</code> targets since it can resolve <code>require</code> natively at runtime. The included JS is not processed in any way.</p>
</dd>
<dt><code>:shadow</code></dt>
<dd>
<p>Resolves the JS via <code>node_modules</code> and includes a minified version of each referenced file in the build. It is the default for the <code>:browser</code> target. <code>node_modules</code> sources do not go through <code>:advanced</code> compilation.</p>
</dd>
<dt><code>:closure</code></dt>
<dd>
<p>Resolves similarly to <code>:shadow</code> but attempts to process all included files via the Closure Compiler CommonJS/ES6 rewrite facilities. They will also be processed via <code>:advanced</code> compilation.</p>
</dd>
</dl>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title"><code>:shadow</code> vs <code>:closure</code></div>
<div class="paragraph">
<p>Ideally we want to use <code>:closure</code> as our primary JS Provider since that will run the entire application through <code>:advanced</code> giving us the most optimized output. In practice however lots of code available via <code>npm</code> is not compatible with the aggressive optimizations that <code>:advanced</code> compilation does. They either fail to compile at all or expose subtle bugs at runtime that are very hard to identify.</p>
</div>
<div class="paragraph">
<p><code>:shadow</code> is sort of a stopgap solution that only processes code via <code>:simple</code> and achieves much more reliable support while still getting reasonably optimized code. The output is comparable (or often better) to what other tools like <code>webpack</code> generate.</p>
</div>
<div class="paragraph">
<p>Until support in Closure gets more reliable <code>:shadow</code> is the recommend JS Provider for <code>:browser</code> builds.</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example config for using <code>:closure</code> in a <code>:browser</code> build.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span> {<span class="symbol">:js-provider</span> <span class="symbol">:closure</span>}
   }}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="js-resolve"><a class="anchor" href="#js-resolve"></a><a class="link" href="#js-resolve">10.1.3. Resolving Packages</a></h4>
<div class="paragraph">
<p>By default <code>shadow-cljs</code> will resolve all <code>(:require ["thing" :as x])</code> requires following the <code>npm</code> convention. This means it will look at <code>&lt;project&gt;/node_modules/thing/package.json</code> and follow the code from there. To customize how this works <code>shadow-cljs</code> exposes a <code>:resolve</code> config option that lets you override how things are resolved.</p>
</div>
<div class="sect4">
<h5 id="js-resolve-global"><a class="anchor" href="#js-resolve-global"></a><a class="link" href="#js-resolve-global">Using a CDN</a></h5>
<div class="paragraph">
<p>Say you already have React included in your page via a CDN. You could just start using <code>js/React</code> again but we stopped doing that for a good reason. Instead you can continue to use <code>(:require ["react" :as react])</code> but configure how "react" resolves!</p>
</div>
<div class="paragraph">
<p>Here is a sample <code>shadow-cljs.edn</code> config for such a build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span>
   {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:global</span>
                       <span class="symbol">:global</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">React</span><span class="delimiter">&quot;</span></span>}}}}

  <span class="symbol">:server</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:app</code> build will now use the global <code>React</code> instance while the <code>:server</code> build continues using the "react" npm package! No need to fiddle with the code to make this work.</p>
</div>
</div>
<div class="sect4">
<h5 id="js-resolve-npm"><a class="anchor" href="#js-resolve-npm"></a><a class="link" href="#js-resolve-npm">Redirecting “require”</a></h5>
<div class="paragraph">
<p>Sometimes you wan&#8217;t more control over which <code>npm</code> package is actually used depending on your build. You can "redirect" certain requires from your build config without changing the code. This is often useful if you either don&#8217;t have access to the sources using such packages or you just want to change it for one build.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span>
   {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:npm</span>
                       <span class="symbol">:require</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">preact-compat</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="js-resolve-limitations"><a class="anchor" href="#js-resolve-limitations"></a><a class="link" href="#js-resolve-limitations">Limitations</a></h5>
<div class="paragraph">
<p>The <code>:shadow-js</code> and <code>:closure</code> have full control over <code>:resolve</code> and everything mentioned above works without any downsides. The <code>:js-provider :require</code> however is more limited. Only the initial require can be influenced since the standard <code>require</code> is in control after that. This means it is not possible to influence what a package might <code>require</code> internally. It is therefore not recommended to be used with targets that use <code>require</code> directly (eg. <code>:node-script</code>).</p>
</div>
<div class="listingblock">
<div class="title">Redirecting "react" to "preact"</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span>
   {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:npm</span>
                       <span class="symbol">:require</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">preact-compat</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example use of react-table</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-table</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> rt]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above works fine in the Browser since every <code>"react"</code> require will be replaced, including the <code>"react"</code> require <code>"react-table"</code> has internally. For <code>:js-provider :require</code> however a <code>require("react-table")</code> will be emitted and <code>node</code> will be in control how that is resolved. Meaning that it will resolve it to the standard <code>"react"</code> and not the <code>"preact"</code> we had configured.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="classpath-js"><a class="anchor" href="#classpath-js"></a><a class="link" href="#classpath-js">10.2. Dealing with .js Files</a></h3>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>DANGER: This feature is an experiment!</strong> It is currently only supported in <code>shadow-cljs</code> and other CLJS tools will yell at you if you attempt to use it. Use at your own risk. The feature was initially rejected from CLJS core but I think it is useful and should not have been <a href="https://dev.clojure.org/jira/browse/CLJS-2061?focusedCommentId=46191&amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-46191">dismissed</a> without further discussion.</p>
</div>
<div class="paragraph">
<p>CLJS has an alternate <a href="https://clojurescript.org/guides/javascript-modules">implementation</a> which in turn is not supported by <code>shadow-cljs</code>. I found this implementation to be lacking in certain aspects so I opted for the different solution. Happy to discuss the pros/cons of both approaches though.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We covered how <a href="#npm">npm</a> packages are used but you may be working on a codebase that already has lots of plain JavaScript and you don&#8217;t want to rewrite everything in ClojureScript just yet. <code>shadow-cljs</code> provides 100% full interop between JavaScript and ClojureScript. Which means your JS can use your CLJS and CLJS can use your JS.</p>
</div>
<div class="paragraph">
<p>There are only a few conventions you need to follow in order for this to work reliably but chances are that you are already doing that anyways.</p>
</div>
<div class="sect3">
<h4 id="_requiring_js"><a class="anchor" href="#_requiring_js"></a><a class="link" href="#_requiring_js">10.2.1. Requiring JS</a></h4>
<div class="paragraph">
<p>We already covered how <code>npm</code> packages are accessed by their name but on the classpath we access <code>.js</code> files by either a full path or relative to the current namespace.</p>
</div>
<div class="listingblock">
<div class="title">Loading JS from the classpath</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.app</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">/some-library/components/foo</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> foo]
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">./bar</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> bar <span class="symbol">:refer</span> (myComponent)]))</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
For string requires the extension <code>.js</code> will be added automatically but you can specify the extension if you prefer. Note that currently only <code>.js</code> is supported though.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Absolute requires like <code>/some-library/components/foo</code> mean that the compiler will look for a <code>some-library/components/foo.js</code> on the classpath; unlike <code>node</code> which would attempt to load the file from the local filesystem. The same classpath rules apply so the file may either be in your <code>:source-paths</code> or in some third-party <code>.jar</code> library you are using.</p>
</div>
<div class="paragraph">
<p>Relative requires are resolved by first looking at the current namespace and then resolving a relative path from that name. In the above example we are in <code>demo/app.cljs</code> to the <code>./bar</code> require resolves to <code>demo/bar.js</code>, so it is identical to <code>(:require ["/demo/bar"])</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The files must not be physically located in the same directory. The lookup for the file appears on the classpath instead. This is unlike node which expects relative requires to always resolve to physical files.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example File Structure with Separate Paths</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── main
        └── demo
            └── app.cljs
    └── js
        └── demo
            └── bar.js</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_language_support"><a class="anchor" href="#_language_support"></a><a class="link" href="#_language_support">10.2.2. Language Support</a></h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
It is expected that the classpath only contains JavaScript that can be consumed without any pre-processing by the Compiler. <code>npm</code> has a very similar convention.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Closure Compiler is used for processing all JavaScript found on the classpath using its <code>ECMASCRIPT_NEXT</code> language setting. What exactly this setting means is not well documented but it mostly represents the next generation JavaScript code which might not even be supported by most browsers yet. ES6 is very well supported as well as most ES7 features. Similarly to standard CLJS this will be compiled down to ES5 with polyfills when required.</p>
</div>
</div>
<div class="sect3">
<h4 id="_javascript_dialects"><a class="anchor" href="#_javascript_dialects"></a><a class="link" href="#_javascript_dialects">10.2.3. JavaScript Dialects</a></h4>
<div class="paragraph">
<p>Since there are many popular JavaScript dialects (JSX, CoffeeScript, etc) that are not directly parsable by the Closure Compiler we need to pre-process them before putting them onto the classpath. <a href="https://babeljs.io/">babel</a> is commonly used in the JavaScript world so we are going to use <code>babel</code> to process <code>.jsx</code> files as an example here.</p>
</div>
<div class="listingblock">
<div class="title">Example shadow-cljs.edn Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">src/gen</span><span class="delimiter">&quot;</span></span>]
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example File Structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── main
        └── demo
            └── app.cljs
    └── js
        ├── .babelrc
        └── demo
            └── bar.jsx</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Notice how <code>src/js</code> is not added to <code>:source-paths</code> which means it will not be on the classpath.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">src/js/demo/bar.jsx</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="jsx">import React from &quot;react&quot;;

function myComponent() {
  return &lt;h1&gt;JSX!&lt;/h1&gt;;
}

export { myComponent };</code></pre>
</div>
</div>
<div class="paragraph">
<p>We run <a href="https://babeljs.io/docs/usage/cli/">babel</a> to convert the files and write them to the configured <code>src/gen</code> directory. Which directory you use it up to you. I prefer <code>src/gen</code> for generated files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ babel src/js --out-dir src/gen
# or during development
$ babel src/js --out-dir src/gen --watch</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>babel</code> itself is configured via the <code>src/js/.babelrc</code>. See the official <a href="https://babeljs.io/docs/plugins/transform-react-jsx/">example for JSX</a>.</p>
</div>
<div class="listingblock">
<div class="title">JSX minimal .babelrc</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">plugins</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">transform-react-jsx</span><span class="delimiter">&quot;</span></span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once <code>babel</code> writes the <code>src/gen/demo/bar.js</code> it will be available to use via ClojureScript and will even be hot loaded just like your ClojureScript sources.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>shadow-cljs</code> currently does not provide any support for running those transformation steps. Please use the standard tools (eg. <code>babel</code>, <code>coffeescript</code>, etc.) directly until it does.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_access_cljs_from_js"><a class="anchor" href="#_access_cljs_from_js"></a><a class="link" href="#_access_cljs_from_js">10.2.4. Access CLJS from JS</a></h4>
<div class="paragraph">
<p>The JS sources can access all your ClojureScript (and the Closure Library) directly by importing their namespaces with a <code>goog:</code> prefix which the Compiler will rewrite to expose the namespace as the default ES6 export.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">import</span> cljs, { <span class="keyword">keyword</span> } from <span class="string"><span class="delimiter">&quot;</span><span class="content">goog:cljs.core</span><span class="delimiter">&quot;</span></span><span class="comment">;</span>

// construct {<span class="symbol">:foo</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>} in JS
cljs.array_map(<span class="keyword">keyword</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)<span class="comment">;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The <code>goog:</code> prefix currently only works for ES6 file. <code>require("goog:cljs.core")</code> does not work.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cljsjs"><a class="anchor" href="#cljsjs"></a><a class="link" href="#cljsjs">10.3. Migrating cljsjs.*</a></h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>CLJSJS is an effort to package Javascript libraries to be able to use them from within ClojureScript.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Since <code>shadow-cljs</code> can access <a href="#npm">npm packages</a> directly we do not need to rely on re-packaged <a href="https://github.com/cljsjs/packages">CLJSJS</a> packages.</p>
</div>
<div class="paragraph">
<p>However many CLJS libraries are still using CLJSJS packages and they would break with <code>shadow-cljs</code> since it doesn&#8217;t support those anymore. It is however very easy to mimick those <code>cljsjs</code> namespaces since they are mostly build from <code>npm</code> packages anyways. It just requires one shim file that maps the <code>cljsjs.thing</code> back to its original <code>npm</code> package and exposes the expected global variable.</p>
</div>
<div class="paragraph">
<p>For React this requires a file like <code>src/cljsjs/react.cljs</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">cljsjs.react</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]
            [<span class="string"><span class="delimiter">&quot;</span><span class="content">create-react-class</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> crc]))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(js/goog.object.set react <span class="string"><span class="delimiter">&quot;</span><span class="content">createClass</span><span class="delimiter">&quot;</span></span> crc)
(js/goog.exportSymbol <span class="string"><span class="delimiter">&quot;</span><span class="content">React</span><span class="delimiter">&quot;</span></span> react)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since this would be tedious for everyone to do manually I created the <a href="https://github.com/thheller/shadow-cljsjs"><code>shadow-cljsjs</code></a>
library which provides just that. It does not include every package but I’ll keep adding
them and contributions are very welcome as well.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>shadow-cljsjs</code> library only provides the shim files. You’ll still need to
<code>npm install</code> the actual packages yourself.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_why_not_use_cljsjs"><a class="anchor" href="#_why_not_use_cljsjs"></a><a class="link" href="#_why_not_use_cljsjs">10.3.1. Why not use CLJSJS?</a></h4>
<div class="paragraph">
<p>CLJSJS packages basically just take the package from <code>npm</code> and put them into a <code>.jar</code> and re-publish them via <a href="https://clojars.org">clojars</a>. As a bonus they often bundle Externs. The compiler otherwise does nothing with these files and only prepends them to the generated output.</p>
</div>
<div class="paragraph">
<p>This was very useful when we had no access to <code>npm</code> directly but has certain issues since not all packages are easily combined with others. A package might rely on <code>react</code> but instead of expressing this via <code>npm</code> <a href="https://github.com/cljsjs/packages/tree/master/material-ui">they</a> bundle their own <code>react</code>. If you are not careful you could end up including 2 different <code>react</code> versions in your build which may lead to very confusing errors or at the very least increase the build size substantially.</p>
</div>
<div class="paragraph">
<p>Apart from that not every <code>npm</code> package is available via CLJSJS and keeping the package versions in sync requires manual work, which means packages are often out of date.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> does not support CLJSJS at all to avoid conflicts in your code. One library might attempt to use the "old" <code>cljsjs.react</code> while another uses the newer <code>(:require ["react"])</code> directly. This would again lead to 2 versions of <code>react</code> on your page again.</p>
</div>
<div class="paragraph">
<p>So the only thing we are missing are the bundled Externs. In many instances these are not required due to improved <a href="#infer-externs">externs inference</a>. Often those Externs are generated using third-party tools which means they are not totally accurate anyways.</p>
</div>
<div class="paragraph">
<p>Conclusion: Use <a href="#npm">npm</a> directly. Use <a href="#infer-externs">:infer-externs auto</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="release"><a class="anchor" href="#release"></a><a class="link" href="#release">11. Generating Production Code&#8201;&#8212;&#8201;All Targets</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Development mode always outputs individual files for each namespace so that they can be hot loaded
in isolation. When you&#8217;re ready to deploy code to a real server you want to run the Closure Compiler
on it to generate a single minified result for each <a href="#_modules">module</a>.</p>
</div>
<div class="paragraph">
<p>By default the release mode output file should just be a drop-in replacements for the
development mode file: there is no difference in the way you include them in your HTML. You
may use <a href="#NameHashing">filename hashing</a> to improve caching characteristics on browser targets.</p>
</div>
<div class="listingblock">
<div class="title">Generating Minified Output</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs release build-id</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_release_configuration"><a class="anchor" href="#_release_configuration"></a><a class="link" href="#_release_configuration">11.1. Release Configuration</a></h3>
<div class="paragraph">
<p>Usually you won&#8217;t need to add any extra configuration to create a release version for your build. The default config already captures everything necessary and should only require extra configuration if you want to override the defaults.</p>
</div>
<div class="paragraph">
<p>Each <code>:target</code> already provides good defaults optimized for each platform so you&#8217;ll have less to worry about.</p>
</div>
<div class="sect3">
<h4 id="Optimization"><a class="anchor" href="#Optimization"></a><a class="link" href="#Optimization">11.1.1. Optimizations</a></h4>
<div class="paragraph">
<p>You can choose the optimization level using the <code>:compiler-options</code> section of the configuration:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You do not usually need to set <code>:optimizations</code> since the <code>:target</code> already sets it to an appropriate level.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>:optimizations</code> only apply when using the <code>release</code> command. Development builds are never optimized by the Closure Compiler. Development builds are always set to <code>:none</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:build</span>
   {<span class="symbol">:build-id</span>
     {<span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:compiler-options</span> {<span class="symbol">:optimizations</span> <span class="symbol">:simple</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://developers.google.com/closure/compiler/docs/compilation_levels">the Closure compiler&#8217;s documentation</a>
for more information on available optimization levels.</p>
</div>
</div>
<div class="sect3">
<h4 id="_release_specific_vs_development_configuration"><a class="anchor" href="#_release_specific_vs_development_configuration"></a><a class="link" href="#_release_specific_vs_development_configuration">11.1.2. Release-Specific vs. Development Configuration</a></h4>
<div class="paragraph">
<p>If you wish to have separate configuration values in a build when running a release build then you
can override settings by including a <code>:dev</code> and/or <code>:release</code> section in the build section:</p>
</div>
<div class="listingblock">
<div class="title">Example <code>shadow-cljs.edn</code> build config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dependencies</span> []
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span> {<span class="symbol">:base</span> {<span class="symbol">:entries</span> [my.app.core]}}

   <span class="comment">;; Here is some dev-specific config</span>
   <span class="symbol">:dev</span> {<span class="symbol">:compiler-options</span> {<span class="symbol">:devcards</span> <span class="predefined-constant">true</span>}}

   <span class="comment">;; Here is some production config</span>
   <span class="symbol">:release</span> {<span class="symbol">:compiler-options</span> {<span class="symbol">:optimizations</span> <span class="symbol">:simple</span>}}}}}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="externs"><a class="anchor" href="#externs"></a><a class="link" href="#externs">11.2. Externs</a></h3>
<div class="paragraph">
<p>Since we want builds to be fully optimized by the Closure Compiler <code>:advanced</code> compilation we need to deal with <a href="https://developers.google.com/closure/compiler/docs/api-tutorial3">Externs</a>. Externs represent pieces of code that are not included when doing <code>:advanced</code> compilation. <code>:advanced</code> works by doing whole program optimizations but some code we just won&#8217;t be able to include so Externs inform the Compiler about this code. Without Externs the Compiler may rename or remove some code that it shouldn&#8217;t.</p>
</div>
<div class="paragraph">
<p>Typically all JS Dependencies are foreign and won&#8217;t be passed through <code>:advanced</code> and thus require Externs.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Externs are only required for <code>:advanced</code>, they are not required in <code>:simple</code> mode.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="infer-externs"><a class="anchor" href="#infer-externs"></a><a class="link" href="#infer-externs">11.2.1. Externs Inference</a></h4>
<div class="paragraph">
<p>To help deal with Externs the <code>shadow-cljs</code> compiler provides enhanced externs inference which can be enabled by setting <code>:infer-externs :auto</code> for your build.</p>
</div>
<div class="listingblock">
<div class="title">Example Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:infer-externs</span> <span class="symbol">:auto</span>}
   }}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>:auto</code> the compiler will perform additional checks at compile time for your files only. It won&#8217;t warn you about possible externs issues in library code. <code>:all</code> will enable it for everthing but be aware that you may get a lot of warnings.</p>
</div>
<div class="paragraph">
<p>When enabled you&#8217;ll get warnings whenever the Compiler cannot figure out whether you are working with JS or CLJS code.</p>
</div>
<div class="listingblock">
<div class="title">Example Code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [x]
  (<span class="keyword">.</span>baz x))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Warning</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">------ WARNING #1 --------------------------------------------------------------
 File: ~/project/src/demo/thing.cljs:23:3
--------------------------------------------------------------------------------
  21 |
  22 | (defn wrap-baz [x]
  23 |   (.baz x))
---------^----------------------------------------------------------------------
 Cannot infer target type in expression (. x baz)
--------------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>:advanced</code> the compiler will be renaming <code>.baz</code> to something "shorter" and Externs inform the Compiler that this is an external property that should not be renamed.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> can generate the appropriate externs if you add a typehint to the object you are performing native interop on.</p>
</div>
<div class="listingblock">
<div class="title">Type-hint to help externs generation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [x]
  (<span class="keyword">.</span>baz ^js x))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>^js</code> typehint will cause the compiler to generate proper externs and the warning will go away. The property is now safe from renaming.</p>
</div>
<div class="listingblock">
<div class="title">Multiple interop calls</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [x]
  (<span class="keyword">.</span>foo ^js x)
  (<span class="keyword">.</span>baz ^js x))</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can get tedious to annotate every single interop call so you can annotate the variable binding itself. It will be used in the entire scope for this variable. Externs for both calls will still be generated.</p>
</div>
<div class="listingblock">
<div class="title">Annotate <code>x</code> directly</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [^js x]
  (<span class="keyword">.</span>foo x)
  (<span class="keyword">.</span>baz x))</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Don&#8217;t annotate everything with <code>^js</code>. Sometimes you may be doing interop on CLJS or ClosureJS objects. Those do not require externs. If you are certain you are working with a CLJS Object prefer using the <code>^clj</code> hint.
 It is not the end of the world when using <code>^js</code> incorrectly but it may affect some optimizations when a variable is not renamed when it could be.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Calls on globals do not require a typehint when using direct <code>js/</code> calls.</p>
</div>
<div class="listingblock">
<div class="title">No hint required, externs inferred automatically</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(js/Some.Thing.coolFunction)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calls on <code>:require</code> bindings are also inferred automatically.</p>
</div>
<div class="listingblock">
<div class="title">No hint required for <code>:as</code> and <code>:refer</code> bindings</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react <span class="symbol">:refer</span> (createElement)]))

(react/createElement <span class="string"><span class="delimiter">&quot;</span><span class="content">div</span><span class="delimiter">&quot;</span></span> <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)
(createElement <span class="string"><span class="delimiter">&quot;</span><span class="content">div</span><span class="delimiter">&quot;</span></span> <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_manual_externs"><a class="anchor" href="#_manual_externs"></a><a class="link" href="#_manual_externs">11.2.2. Manual Externs</a></h4>
<div class="paragraph">
<p>Some libraries provide Externs as separate <code>.js</code> files. You can include them into your build via the <code>:externs</code> compiler options.</p>
</div>
<div class="listingblock">
<div class="title">Manual Externs Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:externs</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/externs.js</span><span class="delimiter">&quot;</span></span> <span class="keyword">..</span><span class="keyword">.</span>]}
   }}}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The compiler looks for files relative to the project root first. It will also attempt to load them from the classpath if no file is found.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_simplified_externs"><a class="anchor" href="#_simplified_externs"></a><a class="link" href="#_simplified_externs">11.2.3. Simplified Externs</a></h4>
<div class="paragraph">
<p>Writing Externs by hand can be challenging and <code>shadow-cljs</code> provides a way to write a more convenient way to write them. In combination with <code>shadow-cljs check &lt;your-build&gt;</code> you can quickly add the missing Externs.</p>
</div>
<div class="paragraph">
<p>Start by creating a <code>externs/&lt;your-build&gt;.txt</code>, so build <code>:app</code> would be <code>externs/app.txt</code>. In that file each line should be one word specifying a JS property that should not be renamed. Global variables should be prefixed by <code>global:</code></p>
</div>
<div class="listingblock">
<div class="title">Example externs/app.txt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="error">#</span> this is a <span class="keyword">comment</span>
foo
bar
global<span class="symbol">:SomeGlobalVariable</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the compiler will stop renaming <code>something.foo()</code>, <code>something.bar()</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_report"><a class="anchor" href="#_build_report"></a><a class="link" href="#_build_report">11.3. Build Report</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> can generate a detailed report for your <code>release</code> builds which includes a detailed breakdown of the included sources and how much they each contributed to the overall size.</p>
</div>
<div class="paragraph">
<p>A sample report can be found <a href="https://code.thheller.com/demos/build-report/huge.html">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ npx shadow-cljs run shadow.cljs.build-report &lt;build-id&gt; &lt;path/to/output.html&gt;
# example
$ npx shadow-cljs run shadow.cljs.build-report app report.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will generate a <code>report.html</code> in the project directory for the <code>:app</code> build.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The generated <code>report.html</code> is entirely self-contained and includes all the required data/js/css. No other external sources are required.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_editor_integration"><a class="anchor" href="#_editor_integration"></a><a class="link" href="#_editor_integration">12. Editor Integration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Unfortunately most editors these days expect you to work with the Leiningen <code>project.clj</code> setup so you might need to use the <a href="#Leiningen">Leiningen integration</a> for them to work properly.</p>
</div>
<div class="sect2">
<h3 id="_cursive"><a class="anchor" href="#_cursive"></a><a class="link" href="#_cursive">12.1. Cursive</a></h3>
<div class="paragraph">
<p>Cursive does not currently support resolving dependencies via <code>shadow-cljs.edn</code>. You can run <code>shadow-cljs pom</code> to generate a <code>pom.xml</code> and import that using the IntelliJ.</p>
</div>
<div class="paragraph">
<p>Alternatively you can create a dummy <code>project.clj</code> or use the full <a href="#Leiningen">Leiningen integration</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject your/project <span class="string"><span class="delimiter">&quot;</span><span class="content">0.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="symbol">:dependencies</span>
  [[thheller/shadow-cljs <span class="string"><span class="delimiter">&quot;</span><span class="content">X.Y.Z</span><span class="delimiter">&quot;</span></span>]]

  <span class="symbol">:source-paths</span>
  [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can run <code>npx shadow-cljs server</code> inside the Terminal provided by IntelliJ and use <code>Clojure REPL &#8594; Remote</code> Run Configuration to connect to the provided <a href="#nREPL">nREPL server</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="cider"><a class="anchor" href="#cider"></a><a class="link" href="#cider">12.2. Emacs / CIDER</a></h3>
<div class="paragraph">
<p>This section is written for CIDER version 0.18.0 and above. Ensure your Emacs environment has this version of the <code>cider</code> package or later. Refer to the <a href="http://cider.readthedocs.io/en/latest/">CIDER documentation</a> for full installation details.</p>
</div>
<div class="sect3">
<h4 id="_dependencies_2"><a class="anchor" href="#_dependencies_2"></a><a class="link" href="#_dependencies_2">12.2.1. Dependencies</a></h4>
<div class="paragraph">
<p>Many of CIDER&#8217;s features require corresponding middleware running in the server. Add CIDER&#8217;s nREPL middleware to the <code>:dependencies</code> entry of <code>shadow-cljs.edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[cider/cider-nrepl <span class="string"><span class="delimiter">&quot;</span><span class="content">0.18.0</span><span class="delimiter">&quot;</span></span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you instead don&#8217;t want to pollute your project files, you can add an alias to the global <code>$HOME/.clojure/deps.edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">..</span><span class="keyword">.</span>
<span class="symbol">:aliases</span> {<span class="symbol">:nrepl</span> {<span class="symbol">:extra-deps</span> {cider/cider-nrepl {<span class="symbol">:mvn/version</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">0.18.0</span><span class="delimiter">&quot;</span></span>}}}
<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_launch_the_server"><a class="anchor" href="#_launch_the_server"></a><a class="link" href="#_launch_the_server">12.2.2. Launch the server</a></h4>
<div class="paragraph">
<p>Launch the <code>shadow-cljs</code> server with a build target.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Launching with the <code>app</code> build target:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs watch app</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Look at the startup message for the nREPL port (or see <a href="#nREPL">nREPL</a> for further details):</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>The message to look for will be similar to this one, the port in this case is <code>9462</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">shadow-cljs <span class="keyword">-</span> nrepl running at /0.<span class="float">0.0</span><span class="keyword">.</span><span class="integer">0</span><span class="error">:</span><span class="integer">9462</span></code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>You can include <code>deps.edn</code> aliases with the -A command line parameter</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs watch app -A:nrepl</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_connect_to_cider_for_a_clojure_repl"><a class="anchor" href="#_connect_to_cider_for_a_clojure_repl"></a><a class="link" href="#_connect_to_cider_for_a_clojure_repl">12.2.3. Connect to CIDER for a Clojure REPL</a></h4>
<div class="paragraph">
<p>In Emacs, connect to the running nREPL server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">M-x cider-connect</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter the connection details:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">Host:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter <code>localhost</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">Port for localhost:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter the nREPL port of the shadow-cljs and CIDER will connect to it, displaying a new <code>cider-repl</code> buffer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">shadow.user&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_connect_the_javascript_environment"><a class="anchor" href="#_connect_the_javascript_environment"></a><a class="link" href="#_connect_the_javascript_environment">12.2.4. Connect the JavaScript environment</a></h4>
<div class="paragraph">
<p>If you haven&#8217;t already done so, connect a JavaScript runtime to the shadow-cljs server. For example, for browser development, browse to <code><a href="http://localhost:8080" class="bare">http://localhost:8080</a></code>.</p>
</div>
<div class="paragraph">
<p>In the <code>cider-repl</code> buffer, you should see a message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">JS runtime connected.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_launch_the_clojurescript_repl"><a class="anchor" href="#_launch_the_clojurescript_repl"></a><a class="link" href="#_launch_the_clojurescript_repl">12.2.5. Launch the ClojureScript REPL</a></h4>
<div class="paragraph">
<p>Launch the ClojureScript REPL alongside the Clojure REPL connection. Make sure you are in the <code>cider-repl</code> buffer so that Emacs knows which connection to use.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">M-x cider-create-sibling-cljs-repl</code></pre>
</div>
</div>
<div class="paragraph">
<p>CIDER will prompt you for the type of ClojureScript REPL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">Select ClojureScript REPL type:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter <code>shadow</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">Select shadow-cljs build:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter the name of your build target, for example, <code>app</code>.</p>
</div>
<div class="paragraph">
<p>Emacs should now open a new nREPL connection to the <code>shadow-cljs</code> server of its sibling, bootstrapping into a ClojureScript REPL environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">shadow.user&gt; To quit, type: :cljs/quit
[:selected :app]
cljs.repl&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now be able to eval ClojureScript, jump to the definitions of vars (with <code>cider-find-var</code>) and much more.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For example, to display an alert in the browser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">cljs.repl&gt; (js/alert &quot;Jurassic Park!&quot;)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_proto_repl_atom"><a class="anchor" href="#_proto_repl_atom"></a><a class="link" href="#_proto_repl_atom">12.3. Proto REPL (Atom)</a></h3>
<div class="paragraph">
<p>Proto REPL is mostly intended for Clojure development so most features do not work for ClojureScript. It is however possible to use it for simple evals.</p>
</div>
<div class="paragraph">
<p>You need to setup a couple of things to get it working.</p>
</div>
<div class="paragraph">
<p>1)  Create a <code>user.clj</code> in on of your <code>:source-paths</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"> (<span class="keyword">ns</span> <span class="namespace">user</span>)

 (<span class="keyword">defn</span> <span class="function">reset</span> [])</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file must define the <code>user/reset</code> fn since Proto REPL will call that when connecting. If <code>user/reset</code> is not found it will call <code>tools.namespace</code> which destroys the running <code>shadow-cljs</code> server. We don&#8217;t want that. You could do something here but we don&#8217;t need to do anything for CLJS.</p>
</div>
<div class="paragraph">
<p>2) add <code>[proto-repl "0.3.1"]</code> to your <code>:dependencies</code>.</p>
</div>
<div class="paragraph">
<p>3) Configure a fixed <a href="#nREPL">nREPL port</a></p>
</div>
<div class="paragraph">
<p>4) Start <code>shadow-cljs server</code> or <code>shadow-cljs watch your-build</code>.</p>
</div>
<div class="paragraph">
<p>5) Run the Atom Command <code>Proto Repl: Remote Nrepl Connection</code> connect to <code>localhost</code> and the port you configured</p>
</div>
<div class="paragraph">
<p>6) Eval <code>(shadow.cljs.devtools.api/watch :your-build)</code> (if you used <code>server</code> in 4)</p>
</div>
<div class="paragraph">
<p>7) Eval <code>(shadow.cljs.devtools.api/nrepl-select :your-build)</code>. The REPL connection is now in CLJS mode, meaning that everything you eval will be eval&#8217;d in JS. You can eval <code>:repl/quit</code> to get back to Clojure Mode. If you get <code>[:no-worker :browser]</code> you need to start the <code>watch</code> first.</p>
</div>
<div class="paragraph">
<p>8) Before you can eval CLJS you need to connect your client (eg. your Browser when building a <code>:browser</code> App).</p>
</div>
<div class="paragraph">
<p>9) Eval some JS, eg. <code>(js/alert "foo")</code>. If you get <code>There is no connected JS runtime</code> the client is not connected properly. Otherwise the Browser should show an alert.</p>
</div>
</div>
<div class="sect2">
<h3 id="_calva_vs_code"><a class="anchor" href="#_calva_vs_code"></a><a class="link" href="#_calva_vs_code">12.4. Calva (VS Code)</a></h3>
<div class="paragraph">
<p>(Only tested with <code>browser</code> targets so far. Probably works with other targets too.)</p>
</div>
<div class="sect3">
<h4 id="_dependencies_3"><a class="anchor" href="#_dependencies_3"></a><a class="link" href="#_dependencies_3">12.4.1. Dependencies</a></h4>
<div class="paragraph">
<p>You need VS Code and install the <a href="https://marketplace.visualstudio.com/items?itemName=cospaia.clojure4vscode#overview">Calva</a> extension.</p>
</div>
<div class="paragraph">
<p>Since Calva uses nRepl and Cider you need to include this dependency in <code>shadow-cljs.edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[cider/cider-nrepl <span class="string"><span class="delimiter">&quot;</span><span class="content">0.16.0</span><span class="delimiter">&quot;</span></span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> will inject the required <code>cider-nrepl</code> middleware once it sees this dependency.</p>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_calva_to_the_repls"><a class="anchor" href="#_connecting_calva_to_the_repls"></a><a class="link" href="#_connecting_calva_to_the_repls">12.4.2. Connecting Calva to the REPLs</a></h4>
<div class="paragraph">
<p>Once that is done start your shadow app. (Using whatever build instead of <code>app</code>.):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs watch app</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the app is loaded in the browser, and you see <code>JS runime connected</code> in the terminal where you started the app, Calva can connect to its repl. Open the project in VS Code and Calva will by default try to auto connect and prompt you with a list of builds read from <code>shadow-cljs.edn</code>. Select the right one (<code>:app</code> in this example) and Calva&#8217;s Clojure and Clojurescript support is activated.</p>
</div>
<div class="paragraph">
<p>(If you already have the project open in VS Code when you start the app, issue the <code>clojure4vscode: connect</code> command.)</p>
</div>
</div>
<div class="sect3">
<h4 id="_features"><a class="anchor" href="#_features"></a><a class="link" href="#_features">12.4.3. Features</a></h4>
<div class="paragraph">
<p>Some of the things you can now do:</p>
</div>
<div class="sect4">
<h5 id="_intellisence_and_stuff"><a class="anchor" href="#_intellisence_and_stuff"></a><a class="link" href="#_intellisence_and_stuff">Intellisence and stuff</a></h5>
<div class="ulist">
<ul>
<li>
<p>Peek at definitions on hover.</p>
</li>
<li>
<p>Get auto completion help.</p>
</li>
<li>
<p>Navigate to definitions (<code>cmd-click</code> on Mac, might be <code>ctrl-click</code> on Windows and Linux).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_evaluation_of_the_file_forms_and_selection"><a class="anchor" href="#_evaluation_of_the_file_forms_and_selection"></a><a class="link" href="#_evaluation_of_the_file_forms_and_selection">Evaluation of the file, forms and selection</a></h5>
<div class="ulist">
<ul>
<li>
<p>Evaluate the file: <code>ctrl+alt+v enter</code> (This is done automatically one opening files.)</p>
</li>
<li>
<p>Evaluate inline: <code>ctrl+alt+v e</code></p>
</li>
<li>
<p>Evaluate and replace them in the editor: <code>ctrl+alt+v r</code></p>
</li>
<li>
<p>Pretty print evaluation resuls: <code>ctrl+alt+v p</code></p>
</li>
<li>
<p>Send forms to the integrated terminal repls for evaluation: <code>ctrl+alt+v alt+e</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_run_tests"><a class="anchor" href="#_run_tests"></a><a class="link" href="#_run_tests">Run tests</a></h5>
<div class="ulist">
<ul>
<li>
<p>Run namespace tests: <code>ctrl+alt+v t</code></p>
</li>
<li>
<p>Run all tests: <code>ctrl+alt+v shift+t</code> (Really clunky in large projects so far.)</p>
</li>
<li>
<p>Rerun previously failing tests: <code>ctrl+alt+v ctrl+t</code></p>
</li>
<li>
<p>Test failures are marked in the explorer and editors and listed in the Problem tab for easy access.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_terminal_repls"><a class="anchor" href="#_terminal_repls"></a><a class="link" href="#_terminal_repls">Terminal repls</a></h5>
<div class="ulist">
<ul>
<li>
<p>Show repl terminal: <code>ctrl+alt+v z</code></p>
</li>
<li>
<p>Switch namespace in terminal repl to that of the currently open file: <code>ctrl+alt+v n</code></p>
</li>
<li>
<p>Load current file and switch namespace in: <code>ctrl+alt+v alt+n</code></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_cljc_files"><a class="anchor" href="#_cljc_files"></a><a class="link" href="#_cljc_files">Cljc files</a></h5>
<div class="ulist">
<ul>
<li>
<p>Switch between Clojure and Clojurescript repl <code>ctrl+alt+v alt+c</code> (or click the green <code>cljc/clj</code> button in the status bar). This determines both which repl is backing the editor and what terminal repl is being accessed, see above.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_to_do_when_things_don_t_work"><a class="anchor" href="#_what_to_do_when_things_don_t_work"></a><a class="link" href="#_what_to_do_when_things_don_t_work">13. What to do when things don’t work?</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since the JS world is still evolving rapidly and not everyone is using the same way to write and
distribute code there are some things <code>shadow-cljs</code> cannot work around automatically. These
can usually be solved with custom <code>:resolve</code> configs, but there may also be bugs or oversights.</p>
</div>
<div class="paragraph">
<p>If you cannot resolve such an issue with the instructions in this chapter, then try asking on the
<a href="https://clojurians.slack.com/messages/C6N245JGG"><code>#shadow-cljs</code> Slack channel</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hacking"><a class="anchor" href="#_hacking"></a><a class="link" href="#_hacking">14. Hacking</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_patching_libraries"><a class="anchor" href="#_patching_libraries"></a><a class="link" href="#_patching_libraries">14.1. Patching Libraries</a></h3>
<div class="paragraph">
<p>The <code>shadow-cljs</code> compiler ensures that things on your source paths are compiled first, overriding files from JARs. This means that you can copy a source file from a library, patch it, and include it in your own source directory.</p>
</div>
<div class="paragraph">
<p>This is a convenient way to test out fixes (even to <code>shadow-cljs</code> itself!) without having to clone
that project and understand its setup, build, etc.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2018-10-12 22:38:32 EDT
</div>
</div>
</body>
</html>