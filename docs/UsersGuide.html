<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<meta name="author" content="Thomas Heller and Tony Kay">
<title>Shadow CLJS User&#8217;s Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Shadow CLJS User&#8217;s Guide</h1>
<div class="details">
<span id="author" class="author">Thomas Heller and Tony Kay</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">Jan 10, 2018</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_high_level_overview">1.1. High-Level Overview</a></li>
<li><a href="#_basic_workflow">1.2. Basic Workflow</a>
<ul class="sectlevel3">
<li><a href="#_development_mode">1.2.1. Development Mode</a></li>
<li><a href="#_release_mode">1.2.2. Release Mode</a></li>
</ul>
</li>
<li><a href="#_important_concepts">1.3. Important Concepts</a>
<ul class="sectlevel3">
<li><a href="#_the_classpath">1.3.1. The Classpath</a></li>
<li><a href="#_server_mode">1.3.2. Server Mode</a></li>
<li><a href="#_repl">1.3.3. REPL</a></li>
</ul>
</li>
<li><a href="#_about_this_book">1.4. About this Book</a>
<ul class="sectlevel3">
<li><a href="#_work_in_progress">1.4.1. Work in Progress</a></li>
<li><a href="#_contributing">1.4.2. Contributing</a></li>
<li><a href="#_conventions_used">1.4.3. Conventions Used</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_installation">2. Installation</a>
<ul class="sectlevel2">
<li><a href="#_standalone_via_npm">2.1. Standalone via <code>npm</code></a></li>
<li><a href="#_library">2.2. Library</a></li>
</ul>
</li>
<li><a href="#_usage">3. Usage</a>
<ul class="sectlevel2">
<li><a href="#_command_line">3.1. Command Line</a>
<ul class="sectlevel3">
<li><a href="#server-mode">3.1.1. Server Mode</a></li>
</ul>
</li>
<li><a href="#_build_tool_integration">3.2. Build Tool Integration</a>
<ul class="sectlevel3">
<li><a href="#Leiningen">3.2.1. Leiningen</a></li>
<li><a href="#deps-edn">3.2.2. tools.deps / deps.edn</a></li>
<li><a href="#_boot">3.2.3. Boot</a></li>
</ul>
</li>
<li><a href="#clj-run">3.3. Running Clojure Code</a>
<ul class="sectlevel3">
<li><a href="#_calling_watch_via_clj_run">3.3.1. Calling watch via clj-run</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_repl_2">4. REPL</a>
<ul class="sectlevel2">
<li><a href="#_clojurescript_repl">4.1. ClojureScript REPL</a>
<ul class="sectlevel3">
<li><a href="#node-repl">4.1.1. Node REPL</a></li>
<li><a href="#browser-repl">4.1.2. Browser REPL</a></li>
<li><a href="#build-repl">4.1.3. Build-specific REPL</a></li>
</ul>
</li>
<li><a href="#_clojure_repl">4.2. Clojure REPL</a>
<ul class="sectlevel3">
<li><a href="#embedded">4.2.1. Embedded</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#config">5. Configuration</a>
<ul class="sectlevel2">
<li><a href="#source-paths">5.1. Source Paths</a></li>
<li><a href="#_dependencies">5.2. Dependencies</a>
<ul class="sectlevel3">
<li><a href="#_clojurescript">5.2.1. Clojure(Script)</a></li>
<li><a href="#npm-install">5.2.2. JavaScript</a></li>
</ul>
</li>
<li><a href="#user-config">5.3. User Configuration</a></li>
<li><a href="#_server_options">5.4. Server Options</a>
<ul class="sectlevel3">
<li><a href="#nREPL">5.4.1. nREPL</a></li>
<li><a href="#socket-repl">5.4.2. Socket REPL</a></li>
<li><a href="#_ssl">5.4.3. SSL</a></li>
<li><a href="#http">5.4.4. Primary HTTP(S)</a></li>
<li><a href="#dev-http">5.4.5. Development HTTP(S)</a></li>
</ul>
</li>
<li><a href="#jvm-opts">5.5. JVM Configuration</a></li>
</ul>
</li>
<li><a href="#_build_configuration">6. Build Configuration</a>
<ul class="sectlevel2">
<li><a href="#_build_target">6.1. Build Target</a></li>
<li><a href="#devtools">6.2. Development Options</a>
<ul class="sectlevel3">
<li><a href="#_repl_3">6.2.1. REPL</a></li>
<li><a href="#_preloads">6.2.2. Preloads</a></li>
<li><a href="#_hot_code_reload">6.2.3. Hot Code Reload</a></li>
<li><a href="#_lifecycle_hooks">6.2.4. Lifecycle Hooks</a></li>
</ul>
</li>
<li><a href="#build-hooks">6.3. Build Hooks</a>
<ul class="sectlevel3">
<li><a href="#compile-stages">6.3.1. Compilation Stages</a></li>
</ul>
</li>
<li><a href="#_compiler_cache">6.4. Compiler Cache</a></li>
<li><a href="#closure-defines">6.5. Closure Defines</a></li>
<li><a href="#compiler-options">6.6. Compiler Options</a>
<ul class="sectlevel3">
<li><a href="#warnigs-as-errors">6.6.1. Warnings as Errors</a></li>
</ul>
</li>
<li><a href="#_output_language_options">6.7. Output Language Options</a></li>
<li><a href="#_conditional_reading">6.8. Conditional Reading</a></li>
<li><a href="#config-merge">6.9. Overriding from the CLI</a></li>
<li><a href="#shadow-env">6.10. Using Environment Variables</a></li>
<li><a href="#build-target-defaults">6.11. Build and Target defaults</a></li>
</ul>
</li>
<li><a href="#target-browser">7. Targeting the Browser</a>
<ul class="sectlevel2">
<li><a href="#_output_settings">7.1. Output Settings</a></li>
<li><a href="#_modules">7.2. Modules</a></li>
<li><a href="#CodeSplitting">7.3. Code Splitting</a>
<ul class="sectlevel3">
<li><a href="#_loading_code_dynamically">7.3.1. Loading code dynamically</a></li>
</ul>
</li>
<li><a href="#output-wrapper">7.4. Output Wrapper</a></li>
<li><a href="#_web_workers">7.5. Web Workers</a></li>
<li><a href="#_cacheable_output">7.6. Cacheable Output</a>
<ul class="sectlevel3">
<li><a href="#release-version">7.6.1. Release Versions</a></li>
<li><a href="#NameHashing">7.6.2. Filenames with Fingerprint-Hash</a></li>
</ul>
</li>
<li><a href="#BrowserManifest">7.7. Output Manifest</a></li>
<li><a href="#_development_support">7.8. Development Support</a>
<ul class="sectlevel3">
<li><a href="#hud">7.8.1. Heads-Up Display (HUD)</a></li>
<li><a href="#_css_reloading">7.8.2. CSS Reloading</a></li>
<li><a href="#proxy-support">7.8.3. Proxy Support</a></li>
</ul>
</li>
<li><a href="#js-provider-external">7.9. Using External JS Bundlers</a>
<ul class="sectlevel3">
<li><a href="#_js_tree_shaking">7.9.1. JS Tree Shaking</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#target-esm">8. Targeting JavaScript Modules</a>
<ul class="sectlevel2">
<li><a href="#_module_configuration">8.1. Module Configuration</a>
<ul class="sectlevel3">
<li><a href="#_module_exports">8.1.1. Module Exports</a></li>
</ul>
</li>
<li><a href="#_module_splitting">8.2. Module Splitting</a></li>
<li><a href="#_dynamic_module_import">8.3. Dynamic Module Import</a></li>
<li><a href="#_third_party_tool_integration">8.4. Third Party Tool Integration</a></li>
</ul>
</li>
<li><a href="#target-react-native">9. Targeting React Native</a>
<ul class="sectlevel2">
<li><a href="#_react_native">9.1. React Native</a></li>
<li><a href="#_expo">9.2. Expo</a></li>
<li><a href="#_hot_code_reload_2">9.3. Hot Code Reload</a></li>
</ul>
</li>
<li><a href="#target-node">10. Targeting node.js</a>
<ul class="sectlevel2">
<li><a href="#target-node-script">10.1. node.js Scripts</a>
<ul class="sectlevel3">
<li><a href="#_build_options">10.1.1. Build Options</a></li>
<li><a href="#NodeHotCodeReload">10.1.2. Hot Code Reload</a></li>
</ul>
</li>
<li><a href="#target-node-library">10.2. node.js Libraries</a>
<ul class="sectlevel3">
<li><a href="#_single_static_default_export">10.2.1. Single static "default" export</a></li>
<li><a href="#_multiple_static_named_exports">10.2.2. Multiple static named exports</a></li>
<li><a href="#_dynamic_exports">10.2.3. "Dynamic" exports</a></li>
<li><a href="#_full_example">10.2.4. Full Example</a></li>
</ul>
</li>
<li><a href="#_creating_npm_packages">10.3. Creating <code>npm</code> packages</a></li>
</ul>
</li>
<li><a href="#target-npm-module">11. Embedding in the JS Ecosystem&#8201;&#8212;&#8201;The <code>:npm-module</code> Target</a>
<ul class="sectlevel2">
<li><a href="#_working_with_optimizations">11.1. Working with Optimizations</a></li>
</ul>
</li>
<li><a href="#_testing">12. Testing</a>
<ul class="sectlevel2">
<li><a href="#target-node-test">12.1. Testing in node.js</a></li>
<li><a href="#target-browser-test">12.2. Testing in the Browser</a>
<ul class="sectlevel3">
<li><a href="#_generated_output_in_test_dir">12.2.1. Generated output in <code>:test-dir</code></a></li>
</ul>
</li>
<li><a href="#target-karma">12.3. Targeting Tests to Karma for Continuous Integration</a>
<ul class="sectlevel3">
<li><a href="#_installing_karma">12.3.1. Installing Karma</a></li>
<li><a href="#_the_build">12.3.2. The Build</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#js-deps">13. JavaScript Integration</a>
<ul class="sectlevel2">
<li><a href="#npm">13.1. NPM</a>
<ul class="sectlevel3">
<li><a href="#_using_npm_packages">13.1.1. Using npm packages</a></li>
<li><a href="#js-provider">13.1.2. Package Provider</a></li>
<li><a href="#js-entry-keys">13.1.3. CommonJS vs ESM</a></li>
<li><a href="#js-resolve">13.1.4. Resolving Packages</a></li>
<li><a href="#alt-node-modules">13.1.5. Alternate Modules Directories</a></li>
</ul>
</li>
<li><a href="#classpath-js">13.2. Dealing with .js Files</a>
<ul class="sectlevel3">
<li><a href="#_requiring_js">13.2.1. Requiring JS</a></li>
<li><a href="#_language_support">13.2.2. Language Support</a></li>
<li><a href="#_javascript_dialects">13.2.3. JavaScript Dialects</a></li>
<li><a href="#_access_cljs_from_js">13.2.4. Access CLJS from JS</a></li>
</ul>
</li>
<li><a href="#cljsjs">13.3. Migrating cljsjs.*</a>
<ul class="sectlevel3">
<li><a href="#_why_not_use_cljsjs">13.3.1. Why not use CLJSJS?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#release">14. Generating Production Code&#8201;&#8212;&#8201;All Targets</a>
<ul class="sectlevel2">
<li><a href="#_release_configuration">14.1. Release Configuration</a>
<ul class="sectlevel3">
<li><a href="#Optimization">14.1.1. Optimizations</a></li>
<li><a href="#_release_specific_vs_development_configuration">14.1.2. Release-Specific vs. Development Configuration</a></li>
</ul>
</li>
<li><a href="#externs">14.2. Externs</a>
<ul class="sectlevel3">
<li><a href="#infer-externs">14.2.1. Externs Inference</a></li>
<li><a href="#_manual_externs">14.2.2. Manual Externs</a></li>
<li><a href="#_simplified_externs">14.2.3. Simplified Externs</a></li>
</ul>
</li>
<li><a href="#build-report">14.3. Build Report</a></li>
</ul>
</li>
<li><a href="#_editor_integration">15. Editor Integration</a>
<ul class="sectlevel2">
<li><a href="#_cursive">15.1. Cursive</a></li>
<li><a href="#cider">15.2. Emacs / CIDER</a>
<ul class="sectlevel3">
<li><a href="#_launch_the_clojurescript_repl">15.2.1. Launch the ClojureScript REPL</a></li>
<li><a href="#_simplify_startup_with_dir_local">15.2.2. Simplify startup with dir-local</a></li>
<li><a href="#_using_deps_edn_with_custom_repl_intialization">15.2.3. Using deps.edn with custom repl intialization.</a></li>
</ul>
</li>
<li><a href="#_proto_repl_atom">15.3. Proto REPL (Atom)</a></li>
<li><a href="#_chlorine_atom">15.4. Chlorine (Atom)</a></li>
<li><a href="#_calva_vs_code">15.5. Calva (VS Code)</a>
<ul class="sectlevel3">
<li><a href="#_dependencies_2">15.5.1. Dependencies</a></li>
<li><a href="#_start_the_repl">15.5.2. Start the REPL</a></li>
<li><a href="#_connecting_calva_to_the_build">15.5.3. Connecting Calva to the build</a></li>
</ul>
</li>
<li><a href="#_fireplace_vim_vimneovim">15.6. Fireplace.vim (Vim/Neovim)</a>
<ul class="sectlevel3">
<li><a href="#_dependencies_3">15.6.1. Dependencies</a></li>
<li><a href="#_preparing_the_app">15.6.2. Preparing the app</a></li>
<li><a href="#_connecting_fireplace_vim_to_repl_server">15.6.3. Connecting Fireplace.vim to REPL Server</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_troubleshooting">16. Troubleshooting</a>
<ul class="sectlevel2">
<li><a href="#failed-to-load">16.1. Startup Errors</a>
<ul class="sectlevel3">
<li><a href="#_deps_edn_tools_deps">16.1.1. deps.edn / tools.deps</a></li>
<li><a href="#_project_clj_leiningen">16.1.2. project.clj / Leiningen</a></li>
</ul>
</li>
<li><a href="#repl-troubleshooting">16.2. REPL</a>
<ul class="sectlevel3">
<li><a href="#cljs-repl-anatomy">16.2.1. Anatomy of the CLJS REPL</a></li>
<li><a href="#_javascript_runtimes">16.2.2. JavaScript Runtimes</a></li>
<li><a href="#missing-js-runtime">16.2.3. Missing JS runtime</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#publish">17. Publishing Libraries</a>
<ul class="sectlevel2">
<li><a href="#publish-lein">17.1. Leiningen</a>
<ul class="sectlevel3">
<li><a href="#_disable_jar_signing">17.1.1. Disable JAR Signing</a></li>
<li><a href="#_keep_your_jar_clean">17.1.2. Keep your JAR clean</a></li>
</ul>
</li>
<li><a href="#publish-deps-cljs">17.2. Declaring JS dependencies</a></li>
</ul>
</li>
<li><a href="#_what_to_do_when_things_dont_work">18. What to do when things don’t work?</a></li>
<li><a href="#_hacking">19. Hacking</a>
<ul class="sectlevel2">
<li><a href="#_patching_libraries">19.1. Patching Libraries</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a><a class="link" href="#_introduction">1. Introduction</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> provides everything you need to compile your ClojureScript projects with a focus on simplicity and ease of use. The provided build targets abstract away most of the manual configuration so that you only have to configure the essentials for your build. Each target provides optimal defaults for each environment and get an optimized experience during development and in release builds.</p>
</div>
<div class="sect2">
<h3 id="_high_level_overview"><a class="anchor" href="#_high_level_overview"></a><a class="link" href="#_high_level_overview">1.1. High-Level Overview</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> is composed of 2 parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://clojars.org/thheller/shadow-cljs">shadow-cljs</a> Clojure library which handles all the actual work.</p>
</li>
<li>
<p>The <a href="https://www.npmjs.com/package/shadow-cljs">shadow-cljs</a> <code>npm</code> package which provides a convenient interface for running most of the build functionality directly from command line.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If desired you can easily integrate the <code>shadow-cljs</code> Clojure library into any other Clojure/JVM build tool (eg. <a href="https://leiningen.org/">leiningen</a> or the <a href="https://clojure.org/guides/deps_and_cli">Clojure CLI</a> tools).</p>
</div>
<div class="paragraph">
<p>It is recommended to use the <code>npm</code> package as that provides a more optimized development experience tailored towards CLJS development.</p>
</div>
</div>
<div class="sect2">
<h3 id="_basic_workflow"><a class="anchor" href="#_basic_workflow"></a><a class="link" href="#_basic_workflow">1.2. Basic Workflow</a></h3>
<div class="paragraph">
<p>When working with <code>shadow-cljs</code> you will be defining one or more builds in the <code>shadow-cljs.edn</code> configuration file. Each build will have a <code>:target</code> property which represents a configuration preset optimized for the target environment (eg. the Browser, a <code>node.js</code> application or a Chrome Extension).</p>
</div>
<div class="paragraph">
<p>Each build can either produce development or release output depending on the command used to trigger the compilation. The standard build commands are: <code>compile</code>, <code>watch</code> and <code>release</code>.</p>
</div>
<div class="sect3">
<h4 id="_development_mode"><a class="anchor" href="#_development_mode"></a><a class="link" href="#_development_mode">1.2.1. Development Mode</a></h4>
<div class="paragraph">
<p>You can either <code>compile</code> a development build once or run a <code>watch</code> process which will monitor your source files and re-compile them automatically (and live-reload the code if desired).</p>
</div>
<div class="paragraph">
<p>All development builds are optimized for the developer experience with fast feedback cycles and other features like a REPL to directly interact with your running code.</p>
</div>
<div class="paragraph">
<p>A development build should never be shipped publicly since they can become quite large and may only work on the machine they were compiled on depending on the <code>:target</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_release_mode"><a class="anchor" href="#_release_mode"></a><a class="link" href="#_release_mode">1.2.2. Release Mode</a></h4>
<div class="paragraph">
<p>Creating a <code>release</code> build will strip out all the development related code and finally run the code through the Closure Compiler. This is an optimizing Compiler for JavaScript which will significantly reduce the overall size of the code.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_important_concepts"><a class="anchor" href="#_important_concepts"></a><a class="link" href="#_important_concepts">1.3. Important Concepts</a></h3>
<div class="paragraph">
<p>There are several important concepts that you should familiarize yourself with when using <code>shadow-cljs</code>. They are integral to understanding how everything fits together and how the tool works with your code.</p>
</div>
<div class="sect3">
<h4 id="_the_classpath"><a class="anchor" href="#_the_classpath"></a><a class="link" href="#_the_classpath">1.3.1. The Classpath</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> uses the Java Virtual Machine (JVM) and its "classpath" when working with files. This is a virtual filesystem composed of many classpath entries. Each entry is either</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A local filesystem directory, managed by <code>:source-paths</code> entry in the configuration.</p>
</li>
<li>
<p>Or a <code>.jar</code> file, representing Clojure(Script) or JVM libraries. These are compressed archives containing many files (basically just a <code>.zip</code> file). These are added by your <code>:dependencies</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the Clojure(Script) everything is namespaced and each name is expected to resolve to a file. If you have a <code>(ns demo.app)</code> namespace the compiler expects to find a <code>demo/app.cljs</code> (or <code>.cljc</code>) on the classpath. The classpath will be searched in order until it is found. Suppose you configured the <code>:source-paths ["src/main" "src/test"]</code> the compiler will first look for a <code>src/main/demo/app.cljs</code> and then <code>src/test/demo/app.cljs</code>. When the file is not found on any source path the JVM will begin looking into the <code>.jar</code> files on the classpath. When it finds a <code>demo/app.cljs</code> at the root of any of the libraries that file it will be used.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When a filename exists multiple times on the classpath then only the first one is used. Everything on the JVM and Clojure(Script) is namespaced to avoid such conflicts. Very similar to <code>npm</code> where each package must have a unique name.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is therefore recommended to be very disciplined about the names you choose and about properly namespacing everything. It may seem repetitive to always use <code>(ns your-company.components.foo)</code> over <code>(ns components.foo)</code> but it will save you from lot of headaches later on.</p>
</div>
<div class="paragraph">
<p>This is unlike <code>npm</code> where the package name itself is never used inside the package itself and only relative paths are used.</p>
</div>
</div>
<div class="sect3">
<h4 id="_server_mode"><a class="anchor" href="#_server_mode"></a><a class="link" href="#_server_mode">1.3.2. Server Mode</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> can be started in "server" mode which is required for long-running tasks such as <code>watch</code>. A <code>watch</code> will implicitly start the server instance if it is not already running. The server will provide the Websocket endpoint that builds will connect to as well as all the other endpoints for nREPL, Socket REPL and the development HTTP servers.</p>
</div>
<div class="paragraph">
<p>When using the <code>shadow-cljs</code> CLI all commands will re-use a running server instance JVM instead of starting a new JVM. This is substantially faster since start-up time can be quite slow.</p>
</div>
<div class="paragraph">
<p>Once the server is running however you only have to restart it whenever your <code>:dependencies</code> change and everything else can be done via the REPL.</p>
</div>
</div>
<div class="sect3">
<h4 id="_repl"><a class="anchor" href="#_repl"></a><a class="link" href="#_repl">1.3.3. REPL</a></h4>
<div class="paragraph">
<p>The REPL is at the heart of all Clojure(Script) development and every CLI command can also be used directly from the REPL as well. It is absolutely worth getting comfortable with the REPL even if the command line may seem more familiar.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_about_this_book"><a class="anchor" href="#_about_this_book"></a><a class="link" href="#_about_this_book">1.4. About this Book</a></h3>
<div class="sect3">
<h4 id="_work_in_progress"><a class="anchor" href="#_work_in_progress"></a><a class="link" href="#_work_in_progress">1.4.1. Work in Progress</a></h4>
<div class="paragraph">
<p>This is a work in progress. If you find an error, please submit a PR to fix it, or an issue with details of the problem.</p>
</div>
</div>
<div class="sect3">
<h4 id="_contributing"><a class="anchor" href="#_contributing"></a><a class="link" href="#_contributing">1.4.2. Contributing</a></h4>
<div class="paragraph">
<p>This source for this book is hosted on <a href="https://github.com/shadow-cljs/shadow-cljs.github.io">Github</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_conventions_used"><a class="anchor" href="#_conventions_used"></a><a class="link" href="#_conventions_used">1.4.3. Conventions Used</a></h4>
<div class="paragraph">
<p>There are many examples in this book. Most things used in these should be obvious from their context,
but to prevent misunderstanding it is important to know the author&#8217;s intentions.</p>
</div>
<div class="paragraph">
<p>When command-line examples are given we may include BASH comments (starting with <code>#</code>), and will
usually include the standard user UNIX prompt of <code>$</code> to indicate separation of the command
from its output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># A comment. This command lists files:
$ ls -l
shadow-cljs.edn
project.clj
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Many of the examples are of the configuration file for the compiler. This file contains an EDN map. Where we have already discussed required options we will often elide them for clarity. In this case we&#8217;ll usually include an ellipsis to indicate "content that is required but isn&#8217;t in our current focus":</p>
</div>
<div class="listingblock">
<div class="title">Example 1. Specify dependencies</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [[lib <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0</span><span class="delimiter">&quot;</span></span>]]}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example 2. Add source paths</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows us to concisely include enough context to understand the nesting of the configuration of
interest:</p>
</div>
<div class="listingblock">
<div class="title">Example 3. Nested option</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:build-id</span> {<span class="keyword">..</span><span class="keyword">.</span>
                     <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">resources/public/js</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Code examples may be similarly shortened.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation"><a class="anchor" href="#_installation"></a><a class="link" href="#_installation">2. Installation</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_standalone_via_npm"><a class="anchor" href="#_standalone_via_npm"></a><a class="link" href="#_standalone_via_npm">2.1. Standalone via <code>npm</code></a></h3>
<div class="paragraph">
<p>You will need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://nodejs.org">node.js</a> (v6.0.0+, most recent version preferred)</p>
</li>
<li>
<p><a href="https://www.npmjs.com">npm</a> (comes with <code>node</code> by default) or <a href="https://www.yarnpkg.com">yarn</a></p>
</li>
<li>
<p>Any Java SDK (Version 11 or higher, LTS release recommended). <a href="https://adoptium.net/" class="bare">https://adoptium.net/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In your project directory you&#8217;ll need a <code>package.json</code>. If you do not have one yet you can create one by running <code>npm init -y</code>. If you don&#8217;t have a project directory yet consider creating it by running</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ npx create-cljs-project my-project</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create all the necessary basic files and you can skip the following commands.</p>
</div>
<div class="paragraph">
<p>If you have a <code>package.json</code> already and just want to add <code>shadow-cljs</code> run</p>
</div>
<div class="listingblock">
<div class="title">NPM</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ npm install --save-dev shadow-cljs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Yarn</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ yarn add --dev shadow-cljs</code></pre>
</div>
</div>
<div class="paragraph">
<p>For convenience, you can run <code>npm install -g shadow-cljs</code> or <code>yarn global add shadow-cljs</code>. This will let you run the <code>shadow-cljs</code> command directly later. There should always be a shadow-cljs version installed in your project, the global install is optional.</p>
</div>
</div>
<div class="sect2">
<h3 id="_library"><a class="anchor" href="#_library"></a><a class="link" href="#_library">2.2. Library</a></h3>
<div class="paragraph">
<p>Although it is recommended to run the standalone version via <code>npm</code> you can also embed <code>shadow-cljs</code> into any other Clojure JVM tool (eg. <code>lein</code>, <code>boot</code>, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>The artifact can be found at:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://clojars.org/thheller/shadow-cljs"><img src="https://img.shields.io/clojars/v/thheller/shadow-cljs.svg" alt="shadow cljs"></a>
</div>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://github.com/thheller/shadow-cljs"><img src="https://img.shields.io/npm/v/shadow-cljs.svg" alt="shadow cljs"></a>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage"><a class="anchor" href="#_usage"></a><a class="link" href="#_usage">3. Usage</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> can be used in many different ways but the general workflow stays the same.</p>
</div>
<div class="paragraph">
<p>During development you have the option to <code>compile</code> a build once or run a <code>watch</code> worker which watches your source files for changes and re-compiles them automatically. When <a href="#devtools">enabled</a> the <code>watch</code> will also hot-reload your code and provide a REPL. During development the focus is on developer experience with fast feedback cycles. Development code should never be shipped to the public.</p>
</div>
<div class="paragraph">
<p>When it is time to get serious you create a <a href="#release"><code>release</code></a> build which creates an optimized build suitable for production. For this the <a href="https://developers.google.com/closure/compiler/">Closure Compiler</a> is used which applies some seriously <code>:advanced</code> optimizations to your code to create the most optimal output available. This may require some <a href="#externs">tuning</a> to work properly when using lots of interop with native JavaScript but works flawlessly for ClojureScript (and the code from the <a href="https://developers.google.com/closure/library/">Closure Library</a>).</p>
</div>
<div class="sect2">
<h3 id="_command_line"><a class="anchor" href="#_command_line"></a><a class="link" href="#_command_line">3.1. Command Line</a></h3>
<div class="paragraph">
<p>If <a href="#_installation">installed</a> globally, you can use the <code>shadow-cljs</code> command directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs help</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you prefer to only use the local <code>npm</code> install you can invoke it via <code>npx</code> or <code>yarn</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># npm
$ npx shadow-cljs help

# yarn
$ yarn shadow-cljs help

# manually
$ ./node_modules/.bin/shadow-cljs help</code></pre>
</div>
</div>
<div class="paragraph">
<p>The guide will assume there is a global install to keep examples short but this is not required.</p>
</div>
<div class="listingblock">
<div class="title">Commonly used shadow-cljs commands during development</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># compile a build once and exit
$ shadow-cljs compile app

# compile and watch
$ shadow-cljs watch app

# connect to REPL for the build (available while watch is running)
$ shadow-cljs cljs-repl app

# connect to standalone node repl
$ shadow-cljs node-repl</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Running a release build optimized for production use.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs release app</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes you may run into some release issues due to <code>:advanced</code> compilation. These
commands can help track down the causes.</p>
</div>
<div class="listingblock">
<div class="title">Release debugging commands.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs check app
$ shadow-cljs release app --debug</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="server-mode"><a class="anchor" href="#server-mode"></a><a class="link" href="#server-mode">3.1.1. Server Mode</a></h4>
<div class="paragraph">
<p>A <code>shadow-cljs</code> command can be fairly slow to start. To improve this <code>shadow-cljs</code> can run in "server mode" which means that a dedicated process is started which all other commands can use to execute a lot faster since they won&#8217;t have to start a new JVM/Clojure instance.</p>
</div>
<div class="paragraph">
<p>Commands that do long-running things implicitly start a server instance (eg. <code>watch</code>) but it is often advisable to have
a dedicated server process running.</p>
</div>
<div class="paragraph">
<p>You can run the process in the foreground in a dedicated terminal. Use <code>CTRL+C</code> to terminate the server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs server

# or (if you'd like REPL to control the server process)
$ shadow-cljs clj-repl</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also run the server in the background controlled via the common <code>start|stop|restart</code> functions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs start
$ shadow-cljs stop
$ shadow-cljs restart</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once any server is running every other command will use that and run much faster.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_tool_integration"><a class="anchor" href="#_build_tool_integration"></a><a class="link" href="#_build_tool_integration">3.2. Build Tool Integration</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> can integrate with other Clojure tools since the primary distribution is just a <code>.jar</code> file available via <a href="https://clojars.org/thheller/shadow-cljs">Clojars</a>. By default your <code>:dependencies</code> are managed via <code>shadow-cljs.edn</code> but you can use other builds tools to manage your dependencies as well.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
It is strongly recommended to use the standalone <code>shadow-cljs</code> version. The command does a lot of things to optimize the user experience (e.g. faster startup) which are not done by other tools. You&#8217;ll also save yourself a lot of headaches dealing with dependency conflicts and other related errors.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="Leiningen"><a class="anchor" href="#Leiningen"></a><a class="link" href="#Leiningen">3.2.1. Leiningen</a></h4>
<div class="paragraph">
<p>If you&#8217;d like to use <a href="https://leiningen.org/">Leiningen</a> to manage your dependencies, you can do so by adding a <code>:lein</code> entry to your <code>shadow-cljs.edn</code> config. With this setting, the <code>shadow-cljs</code> command will use <code>lein</code> to launch the JVM, ignoring any <code>:source-paths</code> and <code>:dependencies</code> in <code>shadow-cljs.edn</code>; relying instead on <code>lein</code> to set them from <code>project.clj</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:lein</span> <span class="predefined-constant">true</span>
 <span class="comment">; :source-paths and :dependencies are now ignored in this file</span>
 <span class="comment">; configure them via project.clj</span>
 <span class="symbol">:builds</span> { <span class="keyword">..</span><span class="keyword">.</span> }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Using a dedicated <code>lein</code> profile</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:lein</span> {<span class="symbol">:profile</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">+cljs</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample project.clj</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject my-awesome-project
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:profiles</span>
  {<span class="symbol">:cljs</span>
   {<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/cljs</span><span class="delimiter">&quot;</span></span>]
    <span class="symbol">:dependencies</span> [[thheller/shadow-cljs <span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>]
                   [reagent <span class="string"><span class="delimiter">&quot;</span><span class="content">0.8.1</span><span class="delimiter">&quot;</span></span>]]}})</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using <code>project.clj</code> to manage your <code>:dependencies</code> you must manually include the <a href="https://clojars.org/thheller/shadow-cljs">thheller/shadow-cljs</a> artifact in your <code>:dependencies</code> (directly or in a profile).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When you are running into weird Java Stackstraces when starting <code>shadow-cljs</code> or trying compile builds you may have a dependency conflict. It is very important that <code>shadow-cljs</code> is used with proper matching <code>org.clojure/clojurescript</code> and <code>closure-compiler</code> versions. You can check via <code>lein deps :tree</code> and the required versions are listed on <a href="https://clojars.org/thheller/shadow-cljs">clojars</a> (on the right side).
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_running_tasks_directly_from_leiningen"><a class="anchor" href="#_running_tasks_directly_from_leiningen"></a><a class="link" href="#_running_tasks_directly_from_leiningen">Running Tasks Directly From Leiningen</a></h5>
<div class="paragraph">
<p>You may also directly execute <code>shadow-cljs</code> commands via <code>lein</code> if you prefer to not use the <code>shadow-cljs</code> command itself.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
It is recommended to still use the <code>shadow-cljs</code> command to run commands since that will take full advantage of a running server mode instance. This will run commands substantially faster than launching additional JVMs when using <code>lein</code> directly.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Just compile :dev mode once, no REPL or live-reload:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein run -m shadow.cljs.devtools.cli compile build-id</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Create a :release mode optimized build:</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein run -m shadow.cljs.devtools.cli release build-id</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="deps-edn"><a class="anchor" href="#deps-edn"></a><a class="link" href="#deps-edn">3.2.2. tools.deps / deps.edn</a></h4>
<div class="paragraph">
<p>The new <a href="https://clojure.org/guides/deps_and_cli">deps.edn</a> can also be used to manage your <code>:dependencies</code> and <code>:source-paths</code> instead of using the built-in methods or <code>lein</code>. All <code>shadow-cljs</code> commands will then be launched via the new <code>clojure</code> utility instead.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>tools.deps</code> is still changing quite frequently. Make sure you are using the latest version.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use this set the <code>:deps true</code> property in your config. It is also possible to configure which <code>deps.edn</code> aliases should be used.</p>
</div>
<div class="paragraph">
<p>You must add the <code>thheller/shadow-cljs</code> artifact to your <code>deps.edn</code> manually.</p>
</div>
<div class="listingblock">
<div class="title">Simple <code>shadow-cljs.edn</code> example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:deps</span> <span class="predefined-constant">true</span>
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Simple <code>deps.edn</code> example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:deps</span> {thheller/shadow-cljs {<span class="symbol">:mvn/version</span> &lt;latest&gt;}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>shadow-cljs.edn</code> with :cljs alias</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:deps</span> {<span class="symbol">:aliases</span> [<span class="symbol">:cljs</span>]}
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example <code>deps.edn</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:deps</span> {<span class="keyword">..</span><span class="keyword">.</span>}
 <span class="symbol">:aliases</span>
 {<span class="symbol">:cljs</span>
  {<span class="symbol">:extra-deps</span> {thheller/shadow-cljs {<span class="symbol">:mvn/version</span> &lt;latest&gt;}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running with <code>clj</code> directly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:deps</span> {<span class="keyword">..</span><span class="keyword">.</span>}
 <span class="symbol">:aliases</span>
 {<span class="symbol">:shadow-cljs</span>
  {<span class="symbol">:extra-deps</span> {thheller/shadow-cljs {<span class="symbol">:mvn/version</span> &lt;latest&gt;}}
   <span class="symbol">:main-opts</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">-m</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">shadow.cljs.devtools.cli</span><span class="delimiter">&quot;</span></span>]}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">clj -A<span class="symbol">:shadow-cljs</span> watch app</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may also specify additional aliases via the command line using <code>-A</code>, eg. <code>shadow-cljs -A:foo:bar &#8230;&#8203;</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Aliases are only applied when a new instance/server is started. They do not apply when connecting to a running server using the <code>shadow-cljs</code> command. Running via <code>clj</code> will always start a new JVM and does not support server-mode.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_boot"><a class="anchor" href="#_boot"></a><a class="link" href="#_boot">3.2.3. Boot</a></h4>
<div class="paragraph">
<p>The authors have little Boot experience, so this chapter is in need of contributions. We understand
that Boot allows you to build your tool chain out of functions. Since <code>shadow-cljs</code> is a normal
JVM library, you can call functions within it to invoke tasks.</p>
</div>
<div class="paragraph">
<p>Some boot tasks are available here:
<a href="https://github.com/jgdavey/boot-shadow-cljs" class="bare">https://github.com/jgdavey/boot-shadow-cljs</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clj-run"><a class="anchor" href="#clj-run"></a><a class="link" href="#clj-run">3.3. Running Clojure Code</a></h3>
<div class="paragraph">
<p>You can use the <code>shadow-cljs</code> CLI to call specific Clojure functions from the command line. This is useful when you want to run some code before/after certain tasks. Suppose you wanted to <code>rsync</code> the output of your <code>release</code> build to a remote server.</p>
</div>
<div class="listingblock">
<div class="title">Example Clojure Namespace in <code>src/my/build.clj</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.build</span>
  (<span class="symbol">:require</span>
    [shadow.cljs.devtools.api <span class="symbol">:as</span> shadow]
    [clojure.java.shell <span class="symbol">:refer</span> (sh)]))

(<span class="keyword">defn</span> <span class="function">release</span> []
  (shadow/release <span class="symbol">:my-build</span>)
  (sh <span class="string"><span class="delimiter">&quot;</span><span class="content">rsync</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-arzt</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/output-dir</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">my@server.com:some/path</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Running the <code>release</code> function</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-run my.build/release
# or
$ shadow-cljs run my.build/release</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can pass arguments to the invoked functions via the command line.</p>
</div>
<div class="listingblock">
<div class="title">Using arguments via normal Clojure fn args</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">..</span><span class="keyword">.</span>
(<span class="keyword">defn</span> <span class="function">release</span> [server]
  (shadow/release <span class="symbol">:my-build</span>)
  (sh <span class="string"><span class="delimiter">&quot;</span><span class="content">rsync</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-arzt</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/output-dir</span><span class="delimiter">&quot;</span></span> server))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Passing the server from the command line</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-run my.build/release my@server.com:some/path</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The usual <code>(defn release [&amp; args])</code> structure also works if you want to parse the args with something like <a href="https://github.com/clojure/tools.cli">tools.cli</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You have access to the full power of Clojure here. You can build entire tools on top of this if you like. As a bonus everything you write this way is also directly available via the Clojure REPL.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When the <a href="#server-mode">server</a> is running the namespace will not be reloaded automatically, it will only be loaded once. It is recommended to do the development using a REPL and reload the file as usual (eg. <code>(require 'my.build :reload)</code>). You may also run <code>shadow-cljs clj-eval "(require 'my.build :reload)"</code> to reload manually from the command line.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_calling_watch_via_clj_run"><a class="anchor" href="#_calling_watch_via_clj_run"></a><a class="link" href="#_calling_watch_via_clj_run">3.3.1. Calling watch via clj-run</a></h4>
<div class="paragraph">
<p>By default the functions called by <code>clj-run</code> only have access to a minimal <code>shadow-cljs</code> runtime which is enough to run <code>compile</code>, <code>release</code> and any other Clojure functionality. The JVM will terminate when your function completes.</p>
</div>
<div class="paragraph">
<p>If you want to start a <code>watch</code> for a given build you need to declare that the function you are calling requires a full server. This will cause the process to stay alive until you explicitly call <code>(shadow.cljs.devtools.server/stop!)</code> or <code>CTRL+C</code> the process.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.run</span>
  (<span class="symbol">:require</span> [shadow.cljs.devtools.api <span class="symbol">:as</span> shadow]))

<span class="comment">;; this fails because a full server instance is missing</span>
(<span class="keyword">defn</span> <span class="function">foo</span>
  [&amp; args]
  (shadow/watch <span class="symbol">:my-build</span>))

<span class="comment">;; this metadata will ensure that the server is started so watch works</span>
(<span class="keyword">defn</span> <span class="function">foo</span>
  {<span class="symbol">:shadow/requires-server</span> <span class="predefined-constant">true</span>}
  [&amp; args]
  (shadow/watch <span class="symbol">:my-build</span>))</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_repl_2"><a class="anchor" href="#_repl_2"></a><a class="link" href="#_repl_2">4. REPL</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The REPL is a very powerful tool to have when working with Clojure(Script) code. <code>shadow-cljs</code> provides several built-in variants that let you get started quickly as well as variants that are integrated into your standard builds.</p>
</div>
<div class="paragraph">
<p>When you quickly want to test out some code the built-in REPLs should be enough. If you need more complex setups that also do stuff on their own it is best to use an actual build.</p>
</div>
<div class="sect2">
<h3 id="_clojurescript_repl"><a class="anchor" href="#_clojurescript_repl"></a><a class="link" href="#_clojurescript_repl">4.1. ClojureScript REPL</a></h3>
<div class="paragraph">
<p>By default you can choose between a <code>node-repl</code> and a <code>browser-repl</code>. They both work similarly and the differentiating factor is that one runs in a managed <code>node.js</code> process while the others opens a Browser Window that will be used to eval the actual code.</p>
</div>
<div class="sect3">
<h4 id="node-repl"><a class="anchor" href="#node-repl"></a><a class="link" href="#node-repl">4.1.1. Node REPL</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs node-repl</code></pre>
</div>
</div>
<div class="paragraph">
<p>This starts a blank CLJS REPL with an already connected <code>node</code> process.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you exit the Node REPL the <code>node</code> process is also killed!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>node-repl</code> lets you get started without any additional configuration. It has access to all your code via the usual means, ie. <code>(require '[your.core :as x])</code>. Since it is not connected to any build it does not do any automatic rebuilding of code when your files change and does not provide hot-reload.</p>
</div>
</div>
<div class="sect3">
<h4 id="browser-repl"><a class="anchor" href="#browser-repl"></a><a class="link" href="#browser-repl">4.1.2. Browser REPL</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs browser-repl</code></pre>
</div>
</div>
<div class="paragraph">
<p>This starts a blank CLJS REPL and will open an associated Browser window where the code will execute. Besides running in the Browser this has all the same functionality as the above <code>node-repl</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you close the Browser window the REPL will stop working.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="build-repl"><a class="anchor" href="#build-repl"></a><a class="link" href="#build-repl">4.1.3. Build-specific REPL</a></h4>
<div class="paragraph">
<p><code>node-repl</code> and <code>browser-repl</code> work without any specific build configuration. That means they&#8217;ll only do whatever you tell them to do but nothing on their own.</p>
</div>
<div class="paragraph">
<p>If you want to build a specific thing you should configure a build using one of the provided build-targets. Most of them automatically inject the necessary code for a ClojureScript REPL. It should not require any additional configuration. For the build CLJS REPL to work you need 2 things</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>a running <code>watch</code> for your build</p>
</li>
<li>
<p>connect the JS runtime of the <code>:target</code>. Meaning if you are using the <code>:browser</code> target you need to open a Browser that has the generated JS loaded. For node.js builds that means running the <code>node</code> process.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once you have both you can connect to the CLJS REPL via the command line or from the Clojure REPL.</p>
</div>
<div class="listingblock">
<div class="title">CLI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs watch build-id
...

# different terminal
$ shadow-cljs cljs-repl build-id
shadow-cljs - connected to server
[3:1]~cljs.user=&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">REPL</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-repl
...
[2:0]~shadow.user=&gt; (shadow/watch :browser)
[:browser] Configuring build.
[:browser] Compiling ...
[:browser] Build completed. (341 files, 1 compiled, 0 warnings, 3,19s)
:watching
[2:0]~shadow.user=&gt; (shadow/repl :browser)
[2:1]~cljs.user=&gt;</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Type <code>:repl/quit</code> to exit the REPL. This will only exit the REPL, the <code>watch</code> will remain running.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You may run multiple <code>watch</code> "workers" in parallel and connect/disconnect to their REPLs at any given time.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">No connected runtime error.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">[3:1]~cljs.user=&gt; (js/alert &quot;foo&quot;)
There is no connected JS runtime.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you see this you need to open your App in the Browser or start the <code>node</code> process.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_clojure_repl"><a class="anchor" href="#_clojure_repl"></a><a class="link" href="#_clojure_repl">4.2. Clojure REPL</a></h3>
<div class="paragraph">
<p>A Clojure REPL is also provided in addition to the provided ClojureScript REPLs. This is can be used to control the <code>shadow-cljs</code> process and run all other build commands through it. You can start with a Clojure REPL and then upgrade it to a CLJS REPL at any point (and switch back).</p>
</div>
<div class="listingblock">
<div class="title">Running from the CLI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs clj-repl
...
shadow-cljs - REPL - see (help), :repl/quit to exit
[1:0]~shadow.user=&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>shadow.cljs.devtools.api</code> namespace has functions that map more or less 1:1 to the CLI counterparts. It is aliased as <code>shadow</code> by default.</p>
</div>
<div class="listingblock">
<div class="title">Example commands</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; shadow-cljs watch foo</span>
(shadow.cljs.devtools.api/watch <span class="symbol">:foo</span>)
<span class="comment">;; this is identical, due to the provided ns alias</span>
(shadow/watch <span class="symbol">:foo</span>)
<span class="comment">;; shadow-cljs watch foo --verbose</span>
(shadow/watch <span class="symbol">:foo</span> {<span class="symbol">:verbose</span> <span class="predefined-constant">true</span>})
<span class="comment">;; shadow-cljs compile foo</span>
(shadow/compile <span class="symbol">:foo</span>)
<span class="comment">;; shadow-cljs release foo</span>
(shadow/release <span class="symbol">:foo</span>)

<span class="comment">;; shadow-cljs browser-repl</span>
(shadow/browser-repl)
<span class="comment">;; shadow-cljs node-repl</span>
(shadow/node-repl)
<span class="comment">;; shadow-cljs cljs-repl foo</span>
(shadow/repl <span class="symbol">:foo</span>)

<span class="comment">;; Once you are in a CLJS REPL you can use</span>
<span class="symbol">:repl/quit</span>
<span class="comment">;; or</span>
<span class="symbol">:cljs/quit</span>
<span class="comment">;; to drop back down to CLJ.</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="embedded"><a class="anchor" href="#embedded"></a><a class="link" href="#embedded">4.2.1. Embedded</a></h4>
<div class="paragraph">
<p>It is also possible to use <code>shadow-cljs</code> entirely from within any other CLJ process. As long as the <code>thheller/shadow-cljs</code> artifact was loaded on the classpath you are good to go.</p>
</div>
<div class="listingblock">
<div class="title">Example using <code>lein repl</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lein repl
nREPL server started on port 57098 on host 127.0.0.1 - nrepl://127.0.0.1:57098
REPL-y 0.4.3, nREPL 0.6.0
Clojure 1.10.0
...

user=&gt; (require '[shadow.cljs.devtools.server :as server])
nil
user=&gt; (server/start!)
...
:shadow.cljs.devtools.server/started
user=&gt; (require '[shadow.cljs.devtools.api :as shadow])
nil
user=&gt; (shadow/compile :foo)
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can stop the embedded server by running <code>(shadow.cljs.devtools.server/stop!)</code>. This will also stop all running build processes.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you want to switch to a CLJS REPL this may require additional setup in the tool you used to start the server in. Since <code>lein</code> will default to using nREPL it will require configuring additional nREPL <code>:middleware</code>. When using <code>clj</code> you are good to go since it doesn&#8217;t use nREPL.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="config"><a class="anchor" href="#config"></a><a class="link" href="#config">5. Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> is configured by a <code>shadow-cljs.edn</code> file in your project root directory. You can
create a default one by running <code>shadow-cljs init</code>. It should contain a map with some global
configuration and a <code>:builds</code> entry for all your builds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example config could look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span>
 [[reagent <span class="string"><span class="delimiter">&quot;</span><span class="content">0.8.0-alpha2</span><span class="delimiter">&quot;</span></span>]]

 <span class="symbol">:source-paths</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]

 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:entries</span> [my.app]}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file structure for this example should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── my
        └── app.cljs</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="source-paths"><a class="anchor" href="#source-paths"></a><a class="link" href="#source-paths">5.1. Source Paths</a></h3>
<div class="paragraph">
<p><code>:source-paths</code> configures your JVM classpath. The compiler will use this config to find Clojure(Script) source files (eg. <code>.cljs</code>).</p>
</div>
<div class="paragraph">
<p>It is fine to put everything into one source path but you can use multiple if you want to "group" source files in certain ways. It is useful if you want to keep your tests separate for example.</p>
</div>
<div class="listingblock">
<div class="title">Using multiple source paths</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">src/test</span><span class="delimiter">&quot;</span></span>]
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">File Structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── main
        └── my
            └── app.cljs
    └── test
        └── my
            └── app_test.cljs</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is not recommended to separate source files by extension (eg. <code>src/clj</code>, <code>src/cljs</code>, <code>src/cljc</code>). For some reason this is widely used in CLJS project templates but it just makes things harder to use.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dependencies"><a class="anchor" href="#_dependencies"></a><a class="link" href="#_dependencies">5.2. Dependencies</a></h3>
<div class="sect3">
<h4 id="_clojurescript"><a class="anchor" href="#_clojurescript"></a><a class="link" href="#_clojurescript">5.2.1. Clojure(Script)</a></h4>
<div class="paragraph">
<p>Your dependencies are managed via the <code>:dependencies</code> key at the root of the <code>shadow-cljs.edn</code> config file. They are declared in the same notation that other Clojure tools like <code>lein</code> or <code>boot</code> use.</p>
</div>
<div class="paragraph">
<p>Each dependency is written as a vector using <code>[library-name "version-string"]</code> nested in one outer vector.</p>
</div>
<div class="listingblock">
<div class="title">Example :dependencies</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dependencies</span> [[reagent <span class="string"><span class="delimiter">&quot;</span><span class="content">0.9.1</span><span class="delimiter">&quot;</span></span>]]
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the source path is <strong>only</strong> specified once in the entire configuration. The system will use namespace dependency graphs to determine what code is needed in the final output of any given build.</p>
</div>
</div>
<div class="sect3">
<h4 id="npm-install"><a class="anchor" href="#npm-install"></a><a class="link" href="#npm-install">5.2.2. JavaScript</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> integrates fully with the <a href="https://www.npmjs.com/"><code>npm</code></a> ecosystem to manage JavaScript dependencies.</p>
</div>
<div class="paragraph">
<p>You can use <code>npm</code> or <code>yarn</code> to manage your dependencies, please refer to their respective documentation.</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
npm
</td>
<td class="hdlist2">
<p><a href="https://docs.npmjs.com/" class="bare">https://docs.npmjs.com/</a></p>
</td>
</tr>
<tr>
<td class="hdlist1">
yarn
</td>
<td class="hdlist2">
<p><a href="https://yarnpkg.com/en/docs" class="bare">https://yarnpkg.com/en/docs</a></p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both manage your dependencies via a <code>package.json</code> file in your project directory.  Almost every package available via <code>npm</code> will explain how to install it. Those instructions now apply to <code>shadow-cljs</code> as well.</p>
</div>
<div class="listingblock">
<div class="title">Installing a JavaScript package</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># npm
$ npm install the-thing

# yarn
$ yarn add the-thing</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nothing more is required. Dependencies will be added to the <code>package.json</code> file and this will be used to manage them.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If you don’t have a <code>package.json</code> yet run <code>npm init</code> from a command line.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_missing_js_dependency"><a class="anchor" href="#_missing_js_dependency"></a><a class="link" href="#_missing_js_dependency">Missing JS Dependency?</a></h5>
<div class="paragraph">
<p>You might run into errors related to missing JS dependencies. Most ClojureScript libraries do not yet declare the <code>npm</code> packages they use since they still expect to use <a href="#cljsjs">CLJSJS</a>. We want to use <code>npm</code> directly which means you must manually install the <code>npm</code> packages until libraries properly declare the <code>:npm-deps</code> themselves.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">The required JS dependency &quot;react&quot; is not available, it was required by ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that you should <code>npm install react</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
In the case of <code>react</code> you probably need these 3 packages: <code>npm install react react-dom create-react-class</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="user-config"><a class="anchor" href="#user-config"></a><a class="link" href="#user-config">5.3. User Configuration</a></h3>
<div class="paragraph">
<p>Most configuration will be done in the projects themselves via <code>shadow-cljs.edn</code> but some config may be user-dependent. Tools like <a href="https://docs.cider.mx">CIDER</a> may require the additional <code>cider-nrepl</code> dependency which would be useless for a different team member using Cursive when adding that dependency via <code>shadow-cljs.edn</code>.</p>
</div>
<div class="paragraph">
<p>A restricted set of config options can be added to <code>~/.shadow-cljs/config.edn</code> which will then apply to all projects built on this users machine.</p>
</div>
<div class="paragraph">
<p>Adding dependencies is allowed via the usual <code>:dependencies</code> key. Note that dependencies added here will apply to ALL projects. Keep them to a minimum and only put tool related dependencies here. Everything that is relevant to a build should remain in <code>shadow-cljs.edn</code> as otherwise things may not compile for other users. These dependencies will automatically be added when using <code>deps.edn</code> or <code>lein</code> as well.</p>
</div>
<div class="listingblock">
<div class="title">Example ~/.shadow-cljs/config.edn</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span>
 [[cider/cider-nrepl <span class="string"><span class="delimiter">&quot;</span><span class="content">0.21.1</span><span class="delimiter">&quot;</span></span>]]}
<span class="comment">;; this version may be out of date, check whichever is available</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When using <code>deps.edn</code> to resolve dependencies you may sometimes want to activate additional aliases. This can be done via <code>:deps-aliases</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; shadow-cljs.edn in project</span>
{<span class="symbol">:deps</span> {<span class="symbol">:aliases</span> [<span class="symbol">:cljs</span>]}}

<span class="comment">;; ~/.shadow-cljs/config.edn</span>
{<span class="symbol">:deps-aliases</span> [<span class="symbol">:cider</span>]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will make the <code>shadow-cljs</code> command use the <code>[:cider :cljs]</code> aliases in projects using <code>deps.edn</code>. This might be useful if you have an additional <code>:cider</code> alias in your <code>~/.clojure/deps.edn</code>.</p>
</div>
<div class="paragraph">
<p>By default the <code>shadow-cljs</code> server-mode will launch an embedded nREPL server which you might not need. You can disable this by setting <code>:nrepl false</code> in user config.</p>
</div>
<div class="paragraph">
<p>The only other currently accepted value in the user config is the <a href="#open-file-command">:open-file-command</a>. No other options are currently have any effect.</p>
</div>
</div>
<div class="sect2">
<h3 id="_server_options"><a class="anchor" href="#_server_options"></a><a class="link" href="#_server_options">5.4. Server Options</a></h3>
<div class="paragraph">
<p>This section is for other options that configure the <code>shadow-cljs</code> server instance. They are optional.</p>
</div>
<div class="sect3">
<h4 id="nREPL"><a class="anchor" href="#nREPL"></a><a class="link" href="#nREPL">5.4.1. nREPL</a></h4>
<div class="paragraph">
<p>The <code>shadow-cljs</code> <a href="#server-mode">server</a> provides a <a href="https://nrepl.org">nREPL</a> server via TCP. If you look at the startup message you&#8217;ll see the port of nREPL, and the port will also be stored in <code>target/shadow-cljs/nrepl.port</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs watch app
shadow-cljs - HTTP server available at http://localhost:8600
shadow-cljs - server version: &lt;version&gt; running at http://localhost:9630
shadow-cljs - nREPL server started on port 64967
shadow-cljs - watching build :app
[:app] Configuring build.
[:app] Compiling ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure the port and additional middleware with <code>shadow-cljs.edn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:nrepl</span> {<span class="symbol">:port</span> <span class="integer">9000</span>
         <span class="symbol">:middleware</span> []} <span class="comment">; optional list of namespace-qualified symbols</span>
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default global config file in <code>~/.nrepl/nrepl.edn</code> or the local <code>.nrepl.edn</code> will also be loaded on startup and can be used to configure <code>:middleware</code>.</p>
</div>
<div class="paragraph">
<p>If the popular middleware <a href="https://github.com/clojure-emacs/cider-nrepl">cider-nrepl</a> is found on the classpath (e.g. it&#8217;s included in <code>:dependencies</code>), it will be used automatically. No additional configuration required. This can be disabled by setting <code>:nrepl {:cider false}</code>.</p>
</div>
<div class="paragraph">
<p>You may configure the namespace you start in when connecting by setting <code>:init-ns</code> in the <code>:nrepl</code> options. It defaults to <code>shadow.user</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:nrepl</span> {<span class="symbol">:init-ns</span> my.repl}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The nREPL server can be disabled by setting <code>:nrepl false</code>.</p>
</div>
<div class="sect4">
<h5 id="_nrepl_usage"><a class="anchor" href="#_nrepl_usage"></a><a class="link" href="#_nrepl_usage">nREPL Usage</a></h5>
<div class="paragraph">
<p>When connecting to the nREPL server the connection always starts out as a Clojure REPL. Switching to a CLJS REPL works similarly to the <a href="#cljs-repl">non-nREPL version</a>. First the <code>watch</code> for the given build needs to be started and then we need to select this build to switch the current nREPL session to that build. After selecting the build everything will be eval&#8217;d in ClojureScript instead of Clojure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="repl">(shadow/watch :the-build)
(shadow/repl :the-build)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Use <code>:cljs/quit</code> to return to Clojure.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_embedded_nrepl_server"><a class="anchor" href="#_embedded_nrepl_server"></a><a class="link" href="#_embedded_nrepl_server">Embedded nREPL Server</a></h5>
<div class="paragraph">
<p>When you use <code>shadow-cljs</code> embedded in other tools that provide their own nREPL server (eg. <code>lein</code>) you need to configure the <code>shadow-cljs</code> middleware. Otherwise you won&#8217;t be able to switch between CLJ and CLJS REPLs.</p>
</div>
<div class="listingblock">
<div class="title">Example Leiningen <code>project.clj</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject my-amazing-project <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:repl-options</span>
  {<span class="symbol">:init-ns</span> shadow.user <span class="comment">;; or any of your choosing</span>
   <span class="symbol">:nrepl-middleware</span>
   [shadow.cljs.devtools.server.nrepl/middleware]}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You still need to start the <a href="#embedded">embedded server</a> manually before using the CLJS REPL.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="socket-repl"><a class="anchor" href="#socket-repl"></a><a class="link" href="#socket-repl">5.4.2. Socket REPL</a></h4>
<div class="paragraph">
<p>A Clojure Socket REPL is started automatically in server-mode and uses a random port by default. Tools can find the port it was started under by checking <code>.shadow-cljs/socket-repl.port</code> which will contain the port number.</p>
</div>
<div class="paragraph">
<p>You can also set a fixed port by via <code>shadow-cljs.edn</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:socket-repl</span>
 {<span class="symbol">:port</span> <span class="integer">9000</span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Socket REPL can be disabled by setting <code>:socket-repl false</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ssl"><a class="anchor" href="#_ssl"></a><a class="link" href="#_ssl">5.4.3. SSL</a></h4>
<div class="paragraph">
<p>The <code>shadow-cljs</code> HTTP servers support SSL. It requires a Java Keystore that provides a matching private key and certificate.</p>
</div>
<div class="listingblock">
<div class="title"><code>shadow-cljs.edn</code> with SSL configured</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:ssl</span> {<span class="symbol">:keystore</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">ssl/keystore.jks</span><span class="delimiter">&quot;</span></span>
       <span class="symbol">:password</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">shadow-cljs</span><span class="delimiter">&quot;</span></span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above are the defaults so if you want to use those it is fine to just set <code>:ssl {}</code>.</p>
</div>
<div class="paragraph">
<p>You can create a Keystore using the java <code>keytool</code> command. Creating a trusted self-signed certificate is also possible but somewhat complicated.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://gist.github.com/jchandra74/36d5f8d0e11960dd8f80260801109ab0">OpenSSL</a> instructions for Linux and Windows (via WSL)</p>
</li>
<li>
<p><a href="https://certsimple.com/blog/localhost-ssl-fix">macOS</a> instructions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The created <code>Certificates.p12</code> (macOS) or <code>localhost.pfx</code> (Linux, Windows) file can be turned into the required <code>keystore.jks</code> via the <code>keytool</code> utility.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ keytool -importkeystore -destkeystore keystore.jks -srcstoretype PKCS12 -srckeystore localhost.pfx</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You must generate the Certificate with a SAN (Subject Alternative Name) for "localhost" (or whichever host you want to use). SAN is required to get Chrome to trust the Certificate and not show warnings. The password used when exporting must match the password assigned to the Keystore.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="http"><a class="anchor" href="#http"></a><a class="link" href="#http">5.4.4. Primary HTTP(S)</a></h4>
<div class="paragraph">
<p>The <code>shadow-cljs</code> server starts one primary HTTP server. It is used to serve the UI and websockets used for Hot Reload and REPL clients. By default it listens on Port 9630. If that Port is in use it will increment by one and attempt again until an open Port is found.</p>
</div>
<div class="listingblock">
<div class="title">Startup message indicating the Port used</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">shadow-cljs - server running at http://0.0.0.0:9630</code></pre>
</div>
</div>
<div class="paragraph">
<p>When <code>:ssl</code> is configured the server will be available via <code>https://</code> instead.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The server automatically supports HTTP/2 when using <code>:ssl</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you prefer to set your own port instead you can do this via the <code>:http</code> config.</p>
</div>
<div class="listingblock">
<div class="title"><code>shadow-cljs.edn</code> with <code>:http</code> config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:http</span> {<span class="symbol">:port</span> <span class="integer">12345</span>
        <span class="symbol">:host</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">my.machine.local</span><span class="delimiter">&quot;</span></span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:ssl</code> switches the server to server <code>https://</code> only. If you want to keep the <code>http://</code> version you can configure a separate <code>:ssl-port</code> as well.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:http</span> {<span class="symbol">:port</span> <span class="integer">12345</span>
        <span class="symbol">:ssl-port</span> <span class="integer">23456</span>
        <span class="symbol">:host</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dev-http"><a class="anchor" href="#dev-http"></a><a class="link" href="#dev-http">5.4.5. Development HTTP(S)</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> can provide additional basic HTTP servers via the <code>:dev-http</code> config entry. By default these will serve all static files from the configured paths, and fall back to <code>index.html</code> when a resource is not found (this is what you typically want when developing an application which uses browser push state).</p>
</div>
<div class="paragraph">
<p>These servers are started automatically when <code>shadow-cljs</code> is running in server mode. They are not specific to any build and can be used to serve files for multiple builds as long as a unique <code>:output-dir</code> is used for each.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">IMPORTANT</dt>
<dd>
<p>These are just generic web servers that server static files. They are not required for any live-reload or REPL logic. Any webserver will do, these are just provided for convenience.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">Basic example serving the <code>public</code> directory via <code><a href="http://localhost:8000" class="bare">http://localhost:8000</a></code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:dev-http</code> expects a map of <code>port-number</code> to <code>config</code>. The <code>config</code> supports several shortcuts for the most common scenarios.</p>
</div>
<div class="listingblock">
<div class="title">Serve directory from filesystem root</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Serve from classpath root</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:public</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would attempt to find a request to <code>/index.html</code> via <code>public/index.html</code> on the classpath. Which may include files in <code>.jar</code> files.</p>
</div>
<div class="listingblock">
<div class="title">Serve from multiple roots</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:dev-http</span> {<span class="integer">8000</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">b</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:c</span><span class="delimiter">&quot;</span></span>]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would first attempt to find <code>&lt;project-root&gt;/a/index.html</code> then <code>&lt;project-root&gt;/b/index.html</code> then <code>c/index.html</code> on the classpath. If nothing is found the default handler will be called.</p>
</div>
<div class="paragraph">
<p>The longer config version expects a map and the supported options are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>:root</code></dt>
<dd>
<p>(String) The path from which to serve requests. Paths starting with <code>classpath:</code> will serve from the classpath instead of the filesystem. All filesystem paths are relative to the project root.</p>
</dd>
<dt class="hdlist1"><code>:roots</code></dt>
<dd>
<p>(Vector of Strings) If you need multiple root paths, use instead of <code>:root</code>.</p>
</dd>
<dt class="hdlist1"><code>:ssl-port</code></dt>
<dd>
<p>When <code>:ssl</code> is configured use this port for ssl connections and server normal HTTP on the regular port. If <code>:ssl-port</code> is not set but <code>:ssl</code> is configured the default port will only server SSL requests.</p>
</dd>
<dt class="hdlist1"><code>:host</code></dt>
<dd>
<p>Optional. The hostname to listen on. Defaults to localhost.</p>
</dd>
<dt class="hdlist1"><code>:handler</code></dt>
<dd>
<p>Optional. A fully qualified symbol. A <code>(defn handler [req] resp)</code> that is used
if a resource is not found for the given request. Defaults to <code>shadow.http.push-state/handle</code> (this handler will only respond to requests with <code>Accept: text/html</code> header.)</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The following two options only apply when using the default, built-in handler and typically do not need to be changed:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>:push-state/headers</code></dt>
<dd>
<p>(optional) A map of HTTP headers to respond with. Defaults to <code>text/html</code> standard headers.</p>
</dd>
<dt class="hdlist1"><code>:push-state/index</code></dt>
<dd>
<p>(optional) The file to serve. Defaults to <code>index.html</code>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:dev-http</span>
 {<span class="integer">8080</span> {<span class="symbol">:root</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:handler</span> my.app/handler}}}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="dev-http-proxy"><a class="anchor" href="#dev-http-proxy"></a><a class="link" href="#dev-http-proxy">Reverse Proxy Support</a></h5>
<div class="paragraph">
<p>By default the dev server will attempt to serve requests locally but sometimes you may want to use an external web server to serve requests (eg. API request). This can be configured via <code>:proxy-url</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:dev-http</span>
 {<span class="integer">8000</span>
  {<span class="symbol">:root</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:proxy-url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://some.host</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A request going to <code><a href="http://localhost:8000/api/foo" class="bare">http://localhost:8000/api/foo</a></code> will serve the content returned by <code><a href="https://some.host/api/foo" class="bare">https://some.host/api/foo</a></code> instead. All request that do not have a local file will be served by the proxied server.</p>
</div>
<div class="paragraph">
<p>Additional optional Options to configure the connection handling are:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:proxy-rewrite-host-header</code></dt>
<dd>
<p>boolean, defaults to true. Determines whether the original Host header will be used or the one from the <code>:proxy-url</code>. <code>localhost</code> vs <code>some.host</code> using the example above.</p>
</dd>
<dt><code>:proxy-reuse-x-forwarded</code></dt>
<dd>
<p>boolean, defaults to false. Configures if the proxy should add itself to <code>X-Forwarded-For</code> list or start a new one.</p>
</dd>
<dt><code>:proxy-max-connection-retries</code></dt>
<dd>
<p>int, defaults to 1.</p>
</dd>
<dt><code>:proxy-max-request-time</code></dt>
<dd>
<p>ms as int, defaults to 30000. 30sec request timeout.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jvm-opts"><a class="anchor" href="#jvm-opts"></a><a class="link" href="#jvm-opts">5.5. JVM Configuration</a></h3>
<div class="paragraph">
<p>When <code>shadow-cljs.edn</code> is used in charge of starting the JVM you can configure additional command line arguments to be passed directly to the JVM. For example you may want to decrease or increase the amount of RAM used by shadow-cljs.</p>
</div>
<div class="paragraph">
<p>This is done by configuring <code>:jvm-opts</code> at the root of <code>shadow-cljs.edn</code> expecting a vector of strings.</p>
</div>
<div class="listingblock">
<div class="title">Example limited RAM use to 1GB</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:jvm-opts</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">-Xmx1G</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The arguments that can be passed to the JVM vary depending on the version but you can find an example list <a href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html">here</a>. Please note that assigning too little or too much RAM can degrade performance. The defaults are usually good enough.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
When using <code>deps.edn</code> or <code>project.clj</code> the <code>:jvm-opts</code> need to be configured there.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_configuration"><a class="anchor" href="#_build_configuration"></a><a class="link" href="#_build_configuration">6. Build Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs.edn</code> will also need a <code>:builds</code> section. Builds should be a map of builds <strong>keyed</strong> by build ID:</p>
</div>
<div class="listingblock">
<div class="title">A configuration file with a build map.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [[some-library <span class="string"><span class="delimiter">&quot;</span><span class="content">1.2.1</span><span class="delimiter">&quot;</span></span>] <span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>   {<span class="symbol">:target</span>     <span class="symbol">:browser</span>
          <span class="keyword">..</span><span class="keyword">.</span> browser-specific options <span class="keyword">..</span><span class="keyword">.</span>}
  <span class="symbol">:tests</span> {<span class="symbol">:target</span> <span class="symbol">:karma</span>
          <span class="keyword">..</span><span class="keyword">.</span> karma-specific options <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each build describes artifacts that the compiler will build. The build target is an extensible feature of <code>shadow-cljs</code>, and the compiler comes with quite a few of them already.</p>
</div>
<div class="sect2">
<h3 id="_build_target"><a class="anchor" href="#_build_target"></a><a class="link" href="#_build_target">6.1. Build Target</a></h3>
<div class="paragraph">
<p>Each build in <code>shadow-cljs</code> must define a <code>:target</code> which defines where you intend your code to be executed. There are default built-ins for the <a href="#target-browser">browser</a> and <a href="#target-node"><code>node.js</code></a>. They all share the basic concept of having <code>:dev</code> and <code>:release</code> modes. <code>:dev</code> mode provides all the usual development goodies like fast compilation, live code reloading and a REPL. <code>:release</code> mode will produce optimized output intended for production.</p>
</div>
<div class="paragraph">
<p>Targets are covered in separate chapters.</p>
</div>
<div class="paragraph">
<p>Here are some of them:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><a href="#target-browser"><code>:browser</code></a></dt>
<dd>
<p>Output code suitable for running in a web browser.</p>
</dd>
<dt><a href="#target-bootstrap"><code>:bootstrap</code></a></dt>
<dd>
<p>Output code suitable for running in bootstrapped cljs environment.</p>
</dd>
<dt><a href="#target-browser-test"><code>:browser-test</code></a></dt>
<dd>
<p>Scan for tests to determine required files, and output tests suitable for running in the browser.</p>
</dd>
<dt><a href="#target-karma"><code>:karma</code></a></dt>
<dd>
<p>Scan for tests to determine required files, and output karma-runner compatible tests. See <a href="http://karma-runner.github.io/2.0/index.html">Karma</a>.</p>
</dd>
<dt><a href="#target-node-library"><code>:node-library</code></a></dt>
<dd>
<p>Output code suitable for use as a node library.</p>
</dd>
<dt><a href="#target-node-script"><code>:node-script</code></a></dt>
<dd>
<p>Output code suitable for use as a node script.</p>
</dd>
<dt><a href="#target-npm-module"><code>:npm-module</code></a></dt>
<dd>
<p>Output code suitable for use as an NPM module.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Each target is covered in more detail in its own chapter since the remaining build options vary on
the target you select.</p>
</div>
</div>
<div class="sect2">
<h3 id="devtools"><a class="anchor" href="#devtools"></a><a class="link" href="#devtools">6.2. Development Options</a></h3>
<div class="paragraph">
<p>Each build <code>:target</code> typically provides some development support. They are grouped under the <code>:devtools</code> key for each <code>:build</code>.</p>
</div>
<div class="sect3">
<h4 id="_repl_3"><a class="anchor" href="#_repl_3"></a><a class="link" href="#_repl_3">6.2.1. REPL</a></h4>
<div class="paragraph">
<p>When running <code>watch</code> code for the REPL is injected automatically and usually does not require additional configuration. Additional options are available to control REPL behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:repl-init-ns</code> allows configuring which namespace the REPL will start in. It defaults to <code>cljs.user</code>.</p>
</li>
<li>
<p><code>:repl-pprint</code> makes the REPL use <code>cljs.pprint</code> instead of the regular <code>pr-str</code> when printing eval results. Defaults to false.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:repl-init-ns</span> my.app
                   <span class="symbol">:repl-pprint</span> <span class="predefined-constant">true</span>
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preloads"><a class="anchor" href="#_preloads"></a><a class="link" href="#_preloads">6.2.2. Preloads</a></h4>
<div class="paragraph">
<p>As a developer most of your time is spent in development mode. You&#8217;re probably familiar with tools like <code>figwheel</code>,
<code>boot-reload</code>, and <code>devtools</code>. It&#8217;s almost certain that you want one or more of these in your builds.</p>
</div>
<div class="paragraph">
<p>Preloads are used to force certain namespaces into the front of your generated Javascript. This is
generally used to inject tools and instrumentation before the application actually loads and runs. The
preloads option is simply a list of namespaces either in the <code>:devtools</code>/<code>:preloads</code> section of
<code>shadow-cljs.edn</code> or within the <code>:preloads</code> key of a specific module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:preloads</span> [fulcro.inspect.preload]
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example to only include the preloads within a main module during development, and not in a web worker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="keyword">..</span><span class="keyword">.</span>
                         <span class="symbol">:preloads</span>
                         [com.fulcrologic.fulcro.inspect.preload
                          com.fulcrologic.fulcro.inspect.dom-picker-preload]
                         <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}
                  <span class="symbol">:shared</span> {<span class="symbol">:entries</span> []}
                  <span class="symbol">:web-worker</span> {<span class="keyword">..</span><span class="keyword">.</span>
                    <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}
                    <span class="symbol">:web-worker</span> <span class="predefined-constant">true</span>}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:preloads</code> are only applied to development builds and will not be applied to release builds.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Since version 2.0.130 shadow-cljs automatically adds <code>cljs-devtools</code> to the preloads in
<code>watch</code> and <code>compile</code> if they are on the classpath. All you need to do is make sure <code>binaryage/devtools</code> is in your
<code>dependencies</code> list. (Note, <strong>not</strong> binaryage/<strong>cljs-</strong>devtools.) If you don&#8217;t want to have <code>cljs-devtools</code> in
specific targets, you can suppress this by adding <code>:console-support false</code> to the <code>:devtools</code> section of
those targets.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_hot_code_reload"><a class="anchor" href="#_hot_code_reload"></a><a class="link" href="#_hot_code_reload">6.2.3. Hot Code Reload</a></h4>
<div class="paragraph">
<p>The React and ClojureScript ecosystems combine to make this kind of thing super useful. The <code>shadow-cljs</code>
system includes everything you need to do your hot code reload, without needing to resort to external tools.</p>
</div>
<div class="paragraph">
<p>In order to use it you simply run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">shadow-cljs watch build-id</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="reload-strategy"><a class="anchor" href="#reload-strategy"></a><a class="link" href="#reload-strategy">Hot Reload of Transitive Dependents</a></h5>
<div class="paragraph">
<p>By default, compiled files and files explicitly requiring those are reloaded. This approach may not be sufficient eg. during development for <code>:react-native</code> target. To reload also all transitive dependents, use <code>:reload-strategy</code> option with value <code>:full</code> as follows:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
This may become slow for larger apps, only use it if you really need it.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:react-native</span>
   <span class="symbol">:init-fn</span> some.app/init
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">app</span><span class="delimiter">&quot;</span></span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:devtools</span>
   {<span class="symbol">:reload-strategy</span> <span class="symbol">:full</span>}}}}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lifecycle_hooks"><a class="anchor" href="#_lifecycle_hooks"></a><a class="link" href="#_lifecycle_hooks">6.2.4. Lifecycle Hooks</a></h4>
<div class="paragraph">
<p>You can configure the compiler to run functions just before hot code reload brings in updated code, and just after. These are useful for stopping/starting things that would otherwise close over old code.</p>
</div>
<div class="paragraph">
<p>These can be configured via the <code>:devtools</code> section in your build config or directly in your code via metadata tags.</p>
</div>
<div class="sect4">
<h5 id="_metadata"><a class="anchor" href="#_metadata"></a><a class="link" href="#_metadata">Metadata</a></h5>
<div class="paragraph">
<p>You can set certain metadata on normal CLJS <code>defn</code> vars to inform the compiler that these functions should be called at a certain time when live reloading.</p>
</div>
<div class="listingblock">
<div class="title">hook config via metadata</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>)

(<span class="keyword">defn</span> ^<span class="symbol">:dev/before-load</span> stop []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defn</span> ^<span class="symbol">:dev/after-load</span> start []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would call <code>my.app/stop</code> before loading any new code and <code>my.app/start</code> when all new code was loaded. You can tag multiple functions like this and they will be called in dependency order of their namespaces.</p>
</div>
<div class="paragraph">
<p>There are also async variants of these in case you need to do some async work that should complete before proceeding with the reload process.</p>
</div>
<div class="listingblock">
<div class="title">async hooks example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>)

(<span class="keyword">defn</span> ^<span class="symbol">:dev/before-load-async</span> stop [done]
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop</span><span class="delimiter">&quot;</span></span>)
  (js/setTimeout
    (<span class="keyword">fn</span> []
      (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop complete</span><span class="delimiter">&quot;</span></span>)
      (done)))

(<span class="keyword">defn</span> ^<span class="symbol">:dev/after-load-async</span> start [done]
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span>)
  (js/setTimeout
    (<span class="keyword">fn</span> []
      (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">start complete</span><span class="delimiter">&quot;</span></span>)
      (done)))</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The functions will receive one callback function that must be called when their work is completed. If the callback function is not called the reload process will not proceed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to tag namespaces with metadata so they will never be reloaded even if they are recompiled.</p>
</div>
<div class="listingblock">
<div class="title">A non-reloadable ns</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> ^<span class="symbol">:dev/once</span> my.thing)

(js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">will only execute once</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Namespaces can also be tagged to always reload.</p>
</div>
<div class="listingblock">
<div class="title">An always-reloadable ns</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> ^<span class="symbol">:dev/always</span> my.thing)

(js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">will execute on every code change</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_config"><a class="anchor" href="#_config"></a><a class="link" href="#_config">Config</a></h5>
<div class="paragraph">
<p>In addition to the metadata you can configure the lifecycle hooks via <code>shadow-cljs.edn</code>.</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:before-load</code></dt>
<dd>
<p>A symbol (with namespace) of a function to run just before refreshing
files that have been recompiled.  This function <strong>must</strong> be synchronous in nature.</p>
</dd>
<dt><code>:before-load-async</code></dt>
<dd>
<p>A symbol (with namespace) of a function <code>(fn [done])</code> to run just before refreshing. This function can do async processing, but <strong>must</strong> call <code>(done)</code> to indicate it is complete.</p>
</dd>
<dt><code>:after-load</code></dt>
<dd>
<p>A symbol (with namespace) of a function to run after hot code reload is complete.</p>
</dd>
<dt><code>:after-load-async</code></dt>
<dd>
<p>A symbol (with namespace) of a function <code>(fn [done])</code> to run after hot code reload is complete. This function can do async processing, but <strong>must</strong> call <code>(done)</code> to indicate it is complete.</p>
</dd>
<dt><code>:autoload</code></dt>
<dd>
<p>A boolean controlling whether code should be hot loaded. Implicitly set to <code>true</code> if either of the callbacks is set. Always enabled for the <code>:browser</code> target by default, set to <code>false</code> to disable.</p>
</dd>
<dt><code>:ignore-warnings</code></dt>
<dd>
<p>A boolean controlling whether code with warnings should be reloaded. Defaults to <code>false</code>.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="title">A sample of lifecycle hooks.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:before-load</span>  my.app/stop
                   <span class="symbol">:after-load</span>   my.app/start
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Hooks cannot be declared in the <code>cljs.user</code> namespace. Hooks are only used if the namespace containing them is actually included in the build. If you use an extra namespace make sure to include it via <code>:preloads</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If neither <code>:after-load</code> nor <code>:before-load</code> are set the compiler will only attempt to hot reload the code in the <code>:browser</code> target. If you still want hot reloading but don&#8217;t need any of the callbacks you can set <code>:autoload true</code> instead.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="build-hooks"><a class="anchor" href="#build-hooks"></a><a class="link" href="#build-hooks">6.3. Build Hooks</a></h3>
<div class="paragraph">
<p>It is sometimes desirable to execute some custom code at a specific stage in the compilation pipeline. <code>:build-hooks</code> let you declare which functions should be called and they have full access to the build state at that time. This is quite powerful and opens up many possible tool options.</p>
</div>
<div class="paragraph">
<p>They are configured per build under the <code>:build-hooks</code> key</p>
</div>
<div class="listingblock">
<div class="title">Exampe :build-hooks</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:build-hooks</span>
        [(my.util/hook <span class="integer">1</span> <span class="integer">2</span> <span class="integer">3</span>)]
        <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example hook code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.util</span>)

(<span class="keyword">defn</span> <span class="function">hook</span>
  {<span class="symbol">:shadow.build/stage</span> <span class="symbol">:flush</span>}
  [build-state &amp; args]
  (<span class="keyword">prn</span> [<span class="symbol">:hello-world</span> args])
  build-state)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example would call <code>(my.util/hook build-state 1 2 3)</code> after the build completed the <code>:flush</code> <a href="#compilation-stages">stage</a> (ie. written to disk). The example would print <code>[:hello-world (1 2 3)]</code> but please do something more useful in actual hooks.</p>
</div>
<div class="paragraph">
<p>The hook is a just a normal <strong>Clojure</strong> function with some additional metadata. The <code>{:shadow.build/stage :flush}</code> metadata informs the compiler to call this hook for <code>:flush</code> only. You may instead configure <code>{:shadow.build/stages #{:configure :flush}}</code> if the hook should be called after multiple stages. At least one configured stage is required since the hook otherwise would never do anything.</p>
</div>
<div class="paragraph">
<p>All build hooks will be called after the <code>:target</code> work is done. They will receive the <code>build-state</code> (a clojure map with all the current build data) as their first argument and <strong>must</strong> return this <code>build-state</code> modified or unmodified. When using multiple stages you can add additional data to the <code>build-state</code> that later stages can see. It is strongly advised to use namespaced keys only to ensure not accidentally breaking the entire build.</p>
</div>
<div class="paragraph">
<p>The <code>build-state</code> has some important entries which might be useful for your hooks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:shadow.build/build-id</code> - the id of the current build (eg. <code>:app</code>)</p>
</li>
<li>
<p><code>:shadow.build/mode</code> - <code>:dev</code> or <code>:release</code></p>
</li>
<li>
<p><code>:shadow.build/stage</code> - the current stage</p>
</li>
<li>
<p><code>:shadow.build/config</code> - the build config. You can either store config data for the hook in the build config directly or pass it as arguments in the hook itself</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
With a running <code>watch</code> all hooks will be called repeatedly for each build. Avoid doing too much work as they can considerably impact your build performance.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="compile-stages"><a class="anchor" href="#compile-stages"></a><a class="link" href="#compile-stages">6.3.1. Compilation Stages</a></h4>
<div class="paragraph">
<p>The possible stages the <code>:build-hooks</code> can use are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:configure</code> - initial <code>:target</code> specific configuration</p>
</li>
<li>
<p><code>:compile-prepare</code> - called before any compilation is done</p>
</li>
<li>
<p><code>:compile-finish</code> - called after all compilation finishes</p>
</li>
<li>
<p><code>:optimize-prepare</code> - called before running the Closure Compiler optimization phase (<code>:release</code> only)</p>
</li>
<li>
<p><code>:optimize-finish</code> - called after Closure is done (<code>:release</code> only)</p>
</li>
<li>
<p><code>:flush</code> - called after everything was flushed to disk</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With a running <code>watch</code> the <code>:configure</code> is only called once. Any of the others may be called
again (in order) for each re-compile. The <code>build-state</code> will be re-used until the build config changes at which point it will be thrown away and a fresh one will be created.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compiler_cache"><a class="anchor" href="#_compiler_cache"></a><a class="link" href="#_compiler_cache">6.4. Compiler Cache</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> will cache all compilation results by default. The cache is invalidated whenever anything relevant to the individual source files changes (eg. changed compiler setting, changed dependencies, etc.). This greatly improves the developer experience since incremental compilation will be <strong>much</strong> faster than starting from scratch.</p>
</div>
<div class="paragraph">
<p>Invalidating the cache however can not always be done reliably if you are using a lot of macros with side-effects (reading files, storing things outside the compiler state, etc.). In those cases you might need to disable caching entirely.</p>
</div>
<div class="paragraph">
<p>Namespaces that are known to include side-effecting macros can be blocked from caching. They won&#8217;t be cached themselves and namespaces requiring them will not be cached as well. The <a href="https://github.com/cerner/clara-rules">clara-rules</a> library has side-effecting macros and is blocked by default. You can specify which namespaces to block globally via the <code>:cache-blockers</code> configuration. It expects a set of namespace symbols.</p>
</div>
<div class="listingblock">
<div class="title">clara.rules cache blocking example (this is done by default)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:cache-blockers</span> #{clara.rules}
 <span class="symbol">:builds</span> {<span class="keyword">..</span><span class="keyword">.</span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition you can control how much caching is done more broadly via the <code>:build-options</code> <code>:cache-level</code> entry. The supported options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:all</code>
</td>
<td class="hdlist2">
<p>The default, all CLJS files are cached</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:jars</code>
</td>
<td class="hdlist2">
<p>Only caches files from libraries, ie. source files in <code>.jar</code> files</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:off</code>
</td>
<td class="hdlist2">
<p>Does not cache any CLJS compilation results (by far the slowest option)</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Compiling without Cache</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:build-options</span>
   {<span class="symbol">:cache-level</span> <span class="symbol">:off</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cache files are stored in a dedicated directory for each build so the cache is never shared between builds. A build with the id <code>:app</code> will have the <code>:dev</code> cache in the directory:</p>
</div>
<div class="listingblock">
<div class="title">Cache location for <code>cljs/core.cljs</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">target/shadow-cljs/builds/app/dev/ana/cljs/core.cljs.cache.transit.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:cache-root</code> setting defaults to <code>target/shadow-cljs</code> and controls where ALL cache files will be written. It can only be configured globally, not per build.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:cache-root</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">.shadow-cljs</span><span class="delimiter">&quot;</span></span>
 <span class="symbol">:builds</span> <span class="keyword">..</span><span class="keyword">.</span>}

<span class="comment">;; cache then goes to</span>
<span class="comment">;; .shadow-cljs/builds/app/dev/ana/cljs/core.cljs.cache.transit.json</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:cache-root</code> is always resolved relative to the project directory. You can also specify absolute paths (eg. <code>/tmp/shadow-cljs</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="closure-defines"><a class="anchor" href="#closure-defines"></a><a class="link" href="#closure-defines">6.5. Closure Defines</a></h3>
<div class="paragraph">
<p>The Closure Library &amp; Compiler allow you to define variables that are essentially compile time constants. You can use these to configure certain features of your build. Since the Closure compiler treats these as constants when running <code>:advanced</code> optimizations they are fully supported in the Dead-Code-Elimination passes and can be used to remove certain parts of the code that should not be included in <code>release</code> builds.</p>
</div>
<div class="paragraph">
<p>You can define them in your code</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">your.app</span>)

(goog-define VERBOSE <span class="predefined-constant">false</span>)

(<span class="keyword">when</span> VERBOSE
  (<span class="keyword">println</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines the <code>your.app/VERBOSE</code> variable as <code>false</code> by default. This will cause the <code>println</code> to be removed in <code>:advanced</code> compilation. You can toggle this to <code>true</code> via the <code>:closure-defines</code> options which will enable the <code>println</code>. This can either be done for development only or always.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:modules</span> {<span class="symbol">:app</span> {<span class="symbol">:entries</span> [your.app]}}
   <span class="comment">;; to enable in development only</span>
   <span class="symbol">:dev</span> {<span class="symbol">:closure-defines</span> {your.app/VERBOSE <span class="predefined-constant">true</span>}}
   <span class="comment">;; to enable always</span>
   <span class="symbol">:closure-defines</span> {your.app/VERBOSE <span class="predefined-constant">true</span>}
   <span class="comment">;; you may also enable it for release as well</span>
   <span class="symbol">:release</span> {<span class="symbol">:closure-defines</span> {your.app/VERBOSE <span class="predefined-constant">true</span>}}
   }}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
It is generally safer to use the "disabled" variant as the default since it makes things less likely to be included in a <code>release</code> build when they shouldn&#8217;t be. Forgetting to set a <code>:closure-defines</code> variable should almost always result in less code being used not more.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Closure Defines from the Closure Library</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>goog.DEBUG</code>: The Closure Library uses this for many development features. <code>shadow-cljs</code> automatically sets this to <code>false</code> for <code>release</code> builds.</p>
</li>
<li>
<p><code>goog.LOCALE</code> can be used to configure certain localization features like <code>goog.i18n.DateTimeFormat</code>. It accepts a standard locale string and defaults to <code>en</code>. Pretty much all locales are supported, see <a href="https://github.com/google/closure-library/blob/master/closure/goog/i18n/datetimesymbols.js">here</a> and <a href="https://github.com/google/closure-library/blob/master/closure/goog/i18n/datetimesymbolsext.js">here</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="compiler-options"><a class="anchor" href="#compiler-options"></a><a class="link" href="#compiler-options">6.6. Compiler Options</a></h3>
<div class="paragraph">
<p>The CLJS compiler supports several options to influence how some code is generated. For the most part <code>shadow-cljs</code> will pick some good defaults for each <code>:target</code> but you might occasionally want to change some of them.</p>
</div>
<div class="paragraph">
<p>These are all grouped under the <code>:compiler-options</code> key in your build config.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:fn-invoke-direct</span> <span class="predefined-constant">true</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the standard ClojureScript <a href="https://clojurescript.org/reference/compiler-options">Compiler Options</a> are either enabled by default or do not apply. So very few of them actually have an effect. A lot of them are also specific to certain <code>:target</code> types and do not apply universally (e.g. <code>:compiler-options {:output-wrapper true}</code> is only relevant for <code>:target :browser</code>).</p>
</div>
<div class="paragraph">
<p>Currently supported options include</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:optimizations</code> supports <code>:advanced</code>, <code>:simple</code> or <code>:whitespace</code>, defaults to <code>:advanced</code>. <code>:none</code> is the default for development and cannot be set manually. <code>release</code> with <code>:none</code> won&#8217;t work.</p>
</li>
<li>
<p><code>:infer-externs</code> <code>:all</code>, <code>:auto</code>, <code>true</code> or <code>false</code>, defaults to <code>:auto</code></p>
</li>
<li>
<p><code>:static-fns</code> (Boolean) defaults to <code>true</code></p>
</li>
<li>
<p><code>:fn-invoke-direct</code> (Boolean) defaults to <code>false</code></p>
</li>
<li>
<p><code>:elide-asserts</code> (Boolean) default to <code>false</code> in development and <code>true</code> in <code>release</code> builds</p>
</li>
<li>
<p><code>:pretty-print</code> and <code>:pseudo-names</code> default to <code>false</code>. You can use <code>shadow-cljs release app --debug</code> to enable both temporarily without touching your config. This is very useful when running into problem with <code>release</code> builds</p>
</li>
<li>
<p><code>:source-map</code> (Boolean) defaults to <code>true</code> during development, <code>false</code> for <code>release</code>.</p>
</li>
<li>
<p><code>:source-map-include-sources-content</code> (Boolean) defaults to <code>true</code> and decides whether source maps should contains their sources in the <code>.map</code> files directly.</p>
</li>
<li>
<p><code>:source-map-detail-level</code> <code>:all</code> or <code>:symbols</code> (<code>:symbols</code> reduces overall size a bit but also a bit less accurate)</p>
</li>
<li>
<p><code>:externs</code> vector of paths, defaults to <code>[]</code></p>
</li>
<li>
<p><code>:checked-arrays</code> (Boolean), defaults to <code>false</code></p>
</li>
<li>
<p><code>:anon-fn-naming-policy</code></p>
</li>
<li>
<p><code>:rename-prefix</code> and <code>:rename-prefix-namespace</code></p>
</li>
<li>
<p><code>:warnings</code> as a map of <code>{warning-type true|false}</code>, eg. <code>:warnings {:undeclared-var false}</code> to turn off specific warnings.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Unsupported or non-applicable Options</strong></p>
</div>
<div class="paragraph">
<p>Options that don&#8217;t have any effect at all include</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:verbose</code> is controlled by running <code>shadow-cljs compile app --verbose</code> not in the build config.</p>
</li>
<li>
<p><code>:foreign-libs</code> and <code>:libs</code></p>
</li>
<li>
<p><code>:stable-names</code> always enabled, cannot be disabled</p>
</li>
<li>
<p><code>:install-deps</code></p>
</li>
<li>
<p><code>:source-map-path</code>, <code>:source-asset-path</code> and <code>:source-map-timestamp</code></p>
</li>
<li>
<p><code>:cache-analysis</code> always enabled, cannot be disabled.</p>
</li>
<li>
<p><code>:recompile-dependents</code></p>
</li>
<li>
<p><code>:preamble</code></p>
</li>
<li>
<p><code>:hashbang</code> (the <code>:node-script</code> target supports this, others don&#8217;t)</p>
</li>
<li>
<p><code>:compiler-stats</code> use <code>--verbose</code> to get detailed information instead</p>
</li>
<li>
<p><code>:optimize-constants</code> always done for <code>release</code> builds, cannot be disabled</p>
</li>
<li>
<p><code>:parallel-build</code> always enabled</p>
</li>
<li>
<p><code>:aot-cache</code></p>
</li>
<li>
<p><code>:package-json-resolution</code> see <a href="#js-resolve">:js-options :resolve</a> instead</p>
</li>
<li>
<p><code>:watch-fn</code></p>
</li>
<li>
<p><code>:process-shim</code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="warnigs-as-errors"><a class="anchor" href="#warnigs-as-errors"></a><a class="link" href="#warnigs-as-errors">6.6.1. Warnings as Errors</a></h4>
<div class="paragraph">
<p>It is sometimes desireable to fail a build with warnings rather than continuing with the build (eg. in CI envs). You can use the <code>:warnings-as-errors</code> compiler options to customize how that is handled.</p>
</div>
<div class="listingblock">
<div class="title">Treat all warnings as errors</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:warnings-as-errors</span> <span class="predefined-constant">true</span>}}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Only throw certain warnings</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:warnings-as-errors</span> #{<span class="symbol">:undeclared-var</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A set of possible warning-type keywords can be found <a href="https://github.com/clojure/clojurescript/blob/5ad96a8b3ae2e3616a19715ba9ba2471a36933a2/src/main/clojure/cljs/analyzer.cljc#L124-L163">here</a>.</p>
</div>
<div class="listingblock">
<div class="title">Only throw for certain namespaces</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:warnings-as-errors</span> {<span class="symbol">:ignore</span> #{some.ns some.library.*}
                                           <span class="symbol">:warnings-types</span> #{<span class="symbol">:undeclared-var</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:ignore</code> takes a set of symbols refering to namespaces. Either direct matches or <code>.*</code> wildcards are allowed. <code>:warning-types</code> has the same functionality as above, not specifying it means all warnings will throw except the ignored namespaces.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_output_language_options"><a class="anchor" href="#_output_language_options"></a><a class="link" href="#_output_language_options">6.7. Output Language Options</a></h3>
<div class="paragraph">
<p>By default the generated JS output will be compatible with ES6 and all "newer" features will be transpiled to compatible code using polyfills. This is currently the safest default and supports most browsers in active use (including IE10+).</p>
</div>
<div class="paragraph">
<p>You can select other output options if you only care about more modern environments and want to keep the original code without replacements (eg. <code>node</code>, Chrome Extensions, &#8230;&#8203;)</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Note that this mostly affects imported JS code from <a href="#npm">npm</a> or <code>.js</code> files from the <a href="#classpath-js">classpath</a>. CLJS will currently only generate ES5 output and is not affected by setting higher options.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can configure this via the <code>:output-feature-set</code> in <code>:compiler-options</code>. The older <code>:language-out</code> option should not be used as <code>:output-feature-set</code> replaced it.</p>
</div>
<div class="paragraph">
<p>Supported options are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:bare-minimum</code></p>
</li>
<li>
<p><code>:es3</code></p>
</li>
<li>
<p><code>:es5</code></p>
</li>
<li>
<p><code>:es6</code> - <code>class</code>, <code>const</code>, <code>let</code>, &#8230;&#8203;</p>
</li>
<li>
<p><code>:es7</code> - exponent <code>**</code> operator</p>
</li>
<li>
<p><code>:es8</code> - <code>async/await</code>, <code>generators</code>, shared memory and atomics</p>
</li>
<li>
<p><code>:es2018</code> - async iteration, <code>Promise.finally</code>, several <code>RegExp</code> features, spread syntax in object literals</p>
</li>
<li>
<p><code>:es2019</code></p>
</li>
<li>
<p><code>:es2020</code> - <code>AsyncIterator</code>, <code>BigInt</code>, <code>??</code> operator, dynamic imports</p>
</li>
<li>
<p><code>:es-next</code> - all the features the Closure Compiler currently supports</p>
</li>
<li>
<p><code>:browser-2020</code> - <code>:es2019</code> minus several RegExp features</p>
</li>
<li>
<p><code>:browser-2021</code> - <code>:es2020</code> minus RegExp Unicode properties</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:script</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="symbol">:main</span> foo.bar/main
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:output-feature-set</span> <span class="symbol">:es7</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Documentation on these options is a bit sparse and is mostly documented in the code <a href="https://github.com/google/closure-compiler/blob/master/src/com/google/javascript/jscomp/parsing/parser/FeatureSet.java">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conditional_reading"><a class="anchor" href="#_conditional_reading"></a><a class="link" href="#_conditional_reading">6.8. Conditional Reading</a></h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
This feature only works in <code>shadow-cljs</code>. It was officially <a href="https://dev.clojure.org/jira/browse/CLJS-2396">rejected</a> by the ClojureScript project. It will still compile fine in CLJS but only the official branches work (e.g. <code>:cljs</code>). It might still be <a href="https://groups.google.com/d/msg/clojure-dev/8YJJM8lJuQs/hR5_vUZPCQAJ">supported</a> one day but as of now it is not.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> lets you configure additional reader features in <code>.cljc</code> files. By default you can only use reader conditionals to generate separate code for <code>:clj</code>, <code>:cljs</code> or <code>:cljr</code>. In many CLJS builds however it is also desirable to select which code is generated based on your <code>:target</code>.</p>
</div>
<div class="paragraph">
<p>Example: Some <code>npm</code> packages only work when targeting the <code>:browser</code>, but you may have a <code>ns</code> that you also want to use in a <code>:node-script</code> build. This might happen frequently when trying to use Server-Side Rendering (SSR) with your React App. <code>codemirror</code> is one such package.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.awesome.component</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">codemirror</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> CodeMirror]))

<span class="comment">;; suppose you create a CodeMirror instance on some React :ref</span>
(<span class="keyword">defn</span> <span class="function">init-cm</span> [dom-node]
  (<span class="keyword">let</span> [cm (CodeMirror/fromTextArea dom-node <span class="error">#</span>js {<span class="keyword">..</span><span class="keyword">.</span>})]
    <span class="keyword">..</span><span class="keyword">.</span>))

<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This namespace will compile fine for both builds (<code>:node-script</code> and <code>:browser</code>) but when trying to run the <code>:node-script</code> it will fail since the <code>codemirror</code> package tries to access the DOM. Since <code>react-dom/server</code> does not use refs the <code>init-cm</code> function will never be called anyways.</p>
</div>
<div class="paragraph">
<p>While you can use <a href="#closure-defines">:closure-defines</a> to conditionally compile away the <code>init-cm</code> fn you can not use it to get rid of the extra <code>:require</code>. Reader conditionals let you do this easily.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.awesome.component</span>
 (<span class="symbol">:require</span>
   [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]
   <span class="comment">;; NOTE: The order here matters. Only the first applicable</span>
   <span class="comment">;; branch is used. If :cljs is used first it will still be</span>
   <span class="comment">;; taken by the :server build</span>
   <span class="error">#</span>?@(<span class="symbol">:node</span> [[]]
       <span class="symbol">:cljs</span> [[<span class="string"><span class="delimiter">&quot;</span><span class="content">codemirror</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> CodeMirror]])))

<span class="error">#</span>?(<span class="symbol">:node</span> <span class="comment">;; node platform override</span>
   (<span class="keyword">defn</span> <span class="function">init-cm</span> [dom-node]
    <span class="symbol">:no-op</span>)
   <span class="symbol">:cljs</span> <span class="comment">;; default impl</span>
   (<span class="keyword">defn</span> <span class="function">init-cm</span> [dom-node]
     <span class="keyword">..</span><span class="keyword">.</span> actual impl <span class="keyword">..</span><span class="keyword">.</span>))

<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>:reader-features</code> config examples</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 <span class="comment">;; app build configured normally, no adjustments required</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>}
  <span class="comment">;; for the server we add the :node reader feature</span>
  <span class="comment">;; it will then be used instead of the default :cljs</span>
  <span class="symbol">:server</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="symbol">:compiler-options</span>
   {<span class="symbol">:reader-features</span> #{<span class="symbol">:node</span>}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:server</code> build will then no longer have the <code>codemirror</code> require and the <code>init-cm</code> function is removed. Becoming only</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.awesome.component</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]))

<span class="comment">;; this will likely be removed as dead code if</span>
<span class="comment">;; its never actually called anywhere</span>

(<span class="keyword">defn</span> <span class="function">init-cm</span> [dom-node] <span class="symbol">:no-op</span>)
<span class="keyword">..</span><span class="keyword">.</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
This feature is only available in <code>.cljc</code> files and will fail in <code>.cljs</code> files.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="config-merge"><a class="anchor" href="#config-merge"></a><a class="link" href="#config-merge">6.9. Overriding from the CLI</a></h3>
<div class="paragraph">
<p>It is sometimes desirable to make small adjustments to the build configuration from the command line with values that can&#8217;t be added statically to the <code>shadow-cljs.edn</code> config or may change depending on the environment you are in.</p>
</div>
<div class="paragraph">
<p>You can pass additional config data via the <code>--config-merge {:some "data"}</code> command line option which will be merged into the build config. Data added from the CLI will override data from the <code>shadow-cljs.edn</code> file.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>shadow-cljs.edn</code> config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Overriding the <code>:output-dir</code> from the CLI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs release app --config-merge '{:output-dir &quot;somewhere/else&quot;}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Overriding the <code>:closure-defines</code> from the CLI</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs release app --config-merge '{:closure-defines {your.app/DEBUG true}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>--config-merge</code> expects one EDN map and can be used multiple times, they will be merged left to right. The data added is also visible to build-hooks. It will also accept a file path like <code>--config-merge a/path.edn</code> or <code>--config-merge classpath:a/resource.edn</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If you specify multiple build ids the data will be merged into all specified builds. <code>shadow-cljs release frontend backend --config-merge '{:hello "world"}'</code> will be applied to both.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="shadow-env"><a class="anchor" href="#shadow-env"></a><a class="link" href="#shadow-env">6.10. Using Environment Variables</a></h3>
<div class="paragraph">
<p>It is possible to use environment variables to set configuration values in <code>shadow-cljs.edn</code> but you should consider using <code>--config-merge</code> instead. If you really must use an environment variable you can do so via the <code>#shadow/env "FOO"</code> reader tag. You can also use the shorter <code>#env</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>shadow-cljs.edn</code> config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:closure-defines</span> {your.app/URL <span class="error">#</span>shadow/env <span class="string"><span class="delimiter">&quot;</span><span class="content">APP_URL</span><span class="delimiter">&quot;</span></span>}
   <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The are also a few more supported forms that you can use <code>#shadow/env</code> with.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="error">#</span>shadow/env <span class="string"><span class="delimiter">&quot;</span><span class="content">APP_URL</span><span class="delimiter">&quot;</span></span>
<span class="error">#</span>shadow/env [<span class="string"><span class="delimiter">&quot;</span><span class="content">APP_URL</span><span class="delimiter">&quot;</span></span>]
<span class="comment">;; with default value, used if env variable is not set</span>
<span class="error">#</span>shadow/env [<span class="string"><span class="delimiter">&quot;</span><span class="content">APP_URL</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">default-value</span><span class="delimiter">&quot;</span></span>]
<span class="error">#</span>shadow/env [<span class="string"><span class="delimiter">&quot;</span><span class="content">APP_URL</span><span class="delimiter">&quot;</span></span> <span class="symbol">:default</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">default-value</span><span class="delimiter">&quot;</span></span>]
<span class="comment">;; turn PORT env into an integer, with default</span>
<span class="error">#</span>shadow/env [<span class="string"><span class="delimiter">&quot;</span><span class="content">PORT</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> <span class="symbol">:int</span> <span class="symbol">:default</span> <span class="integer">8080</span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Supported <code>:as</code> coercions are <code>:int</code>, <code>:bool</code>, <code>:keyword</code>, <code>:symbol</code>. Supplied <code>:default</code> values will not be converted and are expected to be in the correct type already.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The environment variables used when the <code>shadow-cljs</code> process was started are used. If a server process is used its environment variables will be used over those potentially set by other commands. This is mostly relevant during development but may be confusing. <code>--config-merge</code> does not have this limitation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="build-target-defaults"><a class="anchor" href="#build-target-defaults"></a><a class="link" href="#build-target-defaults">6.11. Build and Target defaults</a></h3>
<div class="paragraph">
<p>It is possible to use set defaults that will be used for all builds, or for all targets of a certain type.</p>
</div>
<div class="paragraph">
<p>Configuration merge order is as follows <code>:build-defaults</code> &#8594; <code>:target-defaults</code> &#8594; actual build config &#8594; extra config overrides.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>shadow-cljs.edn</code> config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:build-defaults</span>
 {<span class="symbol">:closure-defines</span>
   {your.app/VERBOSE <span class="predefined-constant">true</span>}}

 <span class="symbol">:target-defaults</span>
 {<span class="symbol">:browser</span>
   {<span class="symbol">:js-options</span>
     {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:global</span>
                         <span class="symbol">:global</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">React</span><span class="delimiter">&quot;</span></span>}}}}}

 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the <code>:app</code> target will inherit both <code>:build-defaults</code> and the <code>:target-defaults</code> for <code>:browser</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Configs later in the merge order can override, but not remove previous configuration items. Once a default is set, the only way to remove it is by overriding it.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="target-browser"><a class="anchor" href="#target-browser"></a><a class="link" href="#target-browser">7. Targeting the Browser</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>:browser</code> target produces output intended to run in a Browser environment. During development it supports live code reloading, REPL, CSS reloading. The <code>release</code> output will be minified by the Closure Compiler with <code>:advanced</code> optimizations.</p>
</div>
<div class="paragraph">
<p>A basic browser configuration looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]

 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/assets/app/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/assets/app/js</span><span class="delimiter">&quot;</span></span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:entries</span> [my.app]}}}}}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_output_settings"><a class="anchor" href="#_output_settings"></a><a class="link" href="#_output_settings">7.1. Output Settings</a></h3>
<div class="paragraph">
<p>The browser target outputs a lot of files, and a directory is needed for them all. You&#8217;ll need to serve
these assets with some kind of server, and the Javascript loading code needs to know the server-centric
path to these assets. The options you need to specify are:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:output-dir</code></dt>
<dd>
<p>The directory to use for all compiler output.</p>
</dd>
<dt><code>:asset-path</code></dt>
<dd>
<p>The relative path from <strong>web server&#8217;s root</strong> to the resources in <code>:output-dir</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Your entry point javascript file and all related JS files will appear in <code>:output-dir</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Each build requires its own :output-dir, you may not put multiple builds into the same directory.
This directory should also be exclusively owned by the build. There should be no other files in there.
While <code>shadow-cljs</code> won&#8217;t delete anything it is safer to leave it alone. Compilation
creates many more files than just the main entry point javascript file during development:
source maps, original sources, and generated sources.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>:asset-path</code> is a prefix that gets added to the paths of module loading code inside of the
generated javascript. It allows you to output your javascript module to a particular subdirectory
of your web server&#8217;s root. The dynamic loading during development (hot code reload) and production
(code splitting) need this to correctly locate files.</p>
</div>
<div class="paragraph">
<p>Locating your generated files in a directory and asset path like this make it so that other assets
(images, css, etc.) can easily co-exist on the same server without accidental collisions.</p>
</div>
<div class="paragraph">
<p>For example: if your web server will serve the folder <code>public/x</code> when asked for the URI <code>/x</code>,
and your <code>output-dir</code> for a module is <code>public/assets/app/js</code> then your asset-path should be <code>/assets/app/js</code>.
You are not required to use an absolute asset path, but it is highly recommended.</p>
</div>
</div>
<div class="sect2">
<h3 id="_modules"><a class="anchor" href="#_modules"></a><a class="link" href="#_modules">7.2. Modules</a></h3>
<div class="paragraph">
<p>Modules configure how the compiled sources are bundled together and how the final <code>.js</code> are generated. Each Module declares a list of Entry Namespace and from that dependency graph is built. When using multiple Modules the code is split so that the maximum amount of code is moved to the outer edges of the graph. The goal is to minimize the amount of code the browser has to load initially and loading the rest on-demand.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Don&#8217;t worry too much about :modules in the beginning. Start with one and split them later.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>:modules</code> section of the config is always a map keyed by module ID. The module ID is also used
to generate the Javascript filename. Module <code>:main</code> will generate <code>main.js</code> in <code>:output-dir</code>.</p>
</div>
<div class="paragraph">
<p>The available options in a module are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:entries</code>
</td>
<td class="hdlist2">
<p>The namespaces that serve as the root nodes of the dependency graph for the output code of this module.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:init-fn</code>
</td>
<td class="hdlist2">
<p>Fully qualified symbol pointing to a function that should be called when the module is loaded initially.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:depends-on</code>
</td>
<td class="hdlist2">
<p>The names of other modules that must be loaded in order for this one to have everything it needs.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:prepend</code>
</td>
<td class="hdlist2">
<p>String content that will be prepended to the js output. Useful for comments, copyright notice, etc.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:append</code>
</td>
<td class="hdlist2">
<p>String content that will be appended to the js output. Useful for comments, copyright notice, etc.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:prepend-js</code>
</td>
<td class="hdlist2">
<p>A string to prepend to the module output containing valid javascript that will be run through Closure optimizer.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:append-js</code>
</td>
<td class="hdlist2">
<p>A string to append to the module output containing valid javascript that will be run through Closure optimizer.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following example shows a minimum module configuration:</p>
</div>
<div class="listingblock">
<div class="title">Example :browser config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:entries</span> [my.app]}}}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example :browser config with :init-fn</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="symbol">:target</span> <span class="symbol">:browser</span>
        <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:init-fn</span> my.app/init}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> will follow the dependency graph from the root set of code entry points in the <code>:entries</code>
to find everything needed to actually compile and include in the output. Namespaces that are not required will not be included.</p>
</div>
<div class="paragraph">
<p>The above config will create a <code>public/js/main.js</code> file. During development there will be an additional <code>public/js/cljs-runtime</code> directory with lots of files. This directory is not required for <code>release</code> builds.</p>
</div>
</div>
<div class="sect2">
<h3 id="CodeSplitting"><a class="anchor" href="#CodeSplitting"></a><a class="link" href="#CodeSplitting">7.3. Code Splitting</a></h3>
<div class="paragraph">
<p>Declaring more than one Module requires a tiny bit of additional static configuration so the Compiler can figure out how the Modules are related to each other and how you will be loading them later.</p>
</div>
<div class="paragraph">
<p>In addition to <code>:entries</code> you&#8217;ll need to declare which module depends on which (via <code>:depends-on</code>). How you structure this is entirely up to your needs and there is no one-size-fits-all solution unfortunately.</p>
</div>
<div class="paragraph">
<p>Say you have a traditional website with actual different pages.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>www.acme.com</code> - serving the homepage</p>
</li>
<li>
<p><code>www.acme.com/login</code> - serving the login form</p>
</li>
<li>
<p><code>www.acme.com/protected</code> - protected section that is only available once the user is logged in</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One possible configuration for this would be to have one common module that is shared between all the pages. Then one for each page.</p>
</div>
<div class="listingblock">
<div class="title">Example config with multiple <code>:modules</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
 <span class="symbol">:modules</span>
 {<span class="symbol">:shared</span>
  {<span class="symbol">:entries</span> [my.app.common]}
  <span class="symbol">:home</span>
  {<span class="symbol">:entries</span> [my.app.home]
   <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}
  <span class="symbol">:login</span>
  {<span class="symbol">:entries</span> [my.app.login]
   <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}
  <span class="symbol">:protected</span>
  {<span class="symbol">:entries</span> [my.app.protected]
   <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
You can leave the <code>:entries</code> of the <code>:shared</code> module empty to let the compiler figure out which namespaces are shared between the other modules.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Generated file structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
└── public
    └── js
        ├── shared.js
        ├── home.js
        ├── login.js
        └── protected.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>In your HTML for the Homepage you&#8217;d then always include the <code>shared.js</code> on each page and the others conditionally depending on which page the user is on.</p>
</div>
<div class="listingblock">
<div class="title">HTML for the <code>/login</code> page</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/js/shared.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/js/login.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The <code>.js</code> files must be included in the correct order. The <a href="#BrowserManifest"><code>manifest.edn</code></a> can help with this.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_loading_code_dynamically"><a class="anchor" href="#_loading_code_dynamically"></a><a class="link" href="#_loading_code_dynamically">7.3.1. Loading code dynamically</a></h4>
<div class="paragraph">
<p>The more dynamic your website gets, the more dynamic your requirements may get. The server may not always know what the client may end up needing. Therefore, it is possible to have the client load code dynamically when needed.</p>
</div>
<div class="paragraph">
<p>There are a couple ways of loading code dynamically. <code>shadow.lazy</code> is the most convenient and easiest.</p>
</div>
<div class="sect4">
<h5 id="_using_shadow_lazy"><a class="anchor" href="#_using_shadow_lazy"></a><a class="link" href="#_using_shadow_lazy">Using shadow.lazy</a></h5>
<div class="paragraph">
<p>As <a href="https://clojureverse.org/t/shadow-lazy-convenience-wrapper-for-shadow-loader-cljs-loader/3841">announced here</a> shadow-cljs provides a convenience method for referring to potentially lazy loaded code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.app</span>
  (<span class="symbol">:require</span>
    [shadow.lazy <span class="symbol">:as</span> lazy]
    [shadow.cljs.modern <span class="symbol">:refer</span> (js-await)]))

(<span class="keyword">def</span> <span class="function">x-lazy</span> (lazy/loadable demo.thing/x))

(<span class="keyword">defn</span> <span class="function">on-event</span> [e]
  (js-await [x (lazy/load x-lazy)]
    (x e)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s assume that the <code>on-event</code> function above is called when something in your app happens, for example when the user clicked a button. The <code>lazy/loadable</code> configured what that thing will be. The <code>lazy/load</code> will actually load it. This may require an async network hop, so it will go async at this point. In the body of the <code>js-await</code> above <code>x</code> will be whatever <code>demo.thing/x</code> was at the time of loading it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.thing</span>)
(<span class="keyword">defn</span> <span class="function">x</span> [e]
  <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case it would be the function, which we can call directly.</p>
</div>
<div class="paragraph">
<p>You do not need to worry about specifying which module this code ended up in. The compiler will figure that out during compilation. The <code>loadable</code> macro also allows more complex references.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">xy</span> (lazy/loadable [demo.thing/x demo.other/y]))

(<span class="keyword">def</span> <span class="function">xym</span> (lazy/loadable {<span class="symbol">:x</span> demo.thing/x
                         <span class="symbol">:y</span> demo.other/y}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you load <code>xy</code> the result will be a vector with two things. If you load <code>xym</code> it&#8217;ll be a map. You may include vars that span multiple modules that way. The loader will ensure all modules are loaded before continuing.</p>
</div>
</div>
<div class="sect4">
<h5 id="_using_shadow_cljss_built_in_loader_support"><a class="anchor" href="#_using_shadow_cljss_built_in_loader_support"></a><a class="link" href="#_using_shadow_cljss_built_in_loader_support">Using shadow-cljs&#8217;s built-in Loader Support</a></h5>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
This is the low level version, which the above is built upoin. Use it if you want to build your own abstraction for async loading. The above is much more convenient to use.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The compiler supports generating the required data for using the <code>shadow.loader</code> utility namespace. It exposes a simple interface to let you load modules on-demand at runtime.</p>
</div>
<div class="paragraph">
<p>You only need to add <code>:module-loader true</code> to your build config. The loader will always be injected into the default module (the one everything else depends on).</p>
</div>
<div class="paragraph">
<p>At runtime you may use the <code>shadow.loader</code> namespace to load modules. You may also still load a module eagerly by just using a <code>&lt;script&gt;</code> tag in your page.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:module-loader</span> <span class="predefined-constant">true</span>
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you had the following for your main entry point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span> [shadow.loader <span class="symbol">:as</span> loader]))

(<span class="keyword">defn</span> <span class="function">fn-to-call-on-load</span> []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">extra loaded</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defn</span> <span class="function">fn-to-call-on-error</span> []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">extra load failed</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the following expressions can be used for loading code:</p>
</div>
<div class="listingblock">
<div class="title">Loading a module</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; load returns a goog.async.Deferred, and can be used like a promise</span>
(<span class="keyword">-&gt;</span> (loader/load <span class="string"><span class="delimiter">&quot;</span><span class="content">extra</span><span class="delimiter">&quot;</span></span>)
    (<span class="keyword">.</span>then fn-to-call-on-load fn-to-call-on-error))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Loading many modules</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; must be a JS array, also returns goog.async.Deferred</span>
(loader/load-many <span class="error">#</span>js [<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Including a callback</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(loader/with-module <span class="string"><span class="delimiter">&quot;</span><span class="content">extra</span><span class="delimiter">&quot;</span></span> fn-to-call-on-load)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check if a module is loaded using <code>(loaded? "module-name")</code>.</p>
</div>
<div class="paragraph">
<p>You can read more about a more practical example in this blog post about <a href="https://code.thheller.com/blog/shadow-cljs/2019/03/03/code-splitting-clojurescript.html"> Code-Splitting ClojureScript</a>. This is only a basic overview.</p>
</div>
<div class="sect5">
<h6 id="_loader_costs"><a class="anchor" href="#_loader_costs"></a><a class="link" href="#_loader_costs">Loader Costs</a></h6>
<div class="paragraph">
<p>Using the loader is very lightweight. It has a few dependencies which you may not be otherwise using. In practice using <code>:module-loader true</code> adds about 8KB gzip&#8217;d to the default module. This will vary depending on how much of <code>goog.net</code> and <code>goog.events</code> you are already using, and what level of optimization you use for your release builds.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_using_the_standard_clojurescript_api"><a class="anchor" href="#_using_the_standard_clojurescript_api"></a><a class="link" href="#_using_the_standard_clojurescript_api">Using the Standard ClojureScript API</a></h5>
<div class="paragraph">
<p>The generated code is capable of using the standard ClojureScript <code>cljs.loader</code> API. See the <a href="https://clojurescript.org/news/2017-07-10-code-splitting">documentation</a> on the ClojureScript website for instructions.</p>
</div>
<div class="paragraph">
<p>The advantage of using the standard API is that your code will play well with others. This may be of particular importance to library authors. The disadvantage is that the dynamic module loading API in the standard distribution is currently somewhat less easy-to-use than the support in <code>shadow-cljs</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="output-wrapper"><a class="anchor" href="#output-wrapper"></a><a class="link" href="#output-wrapper">7.4. Output Wrapper</a></h3>
<div class="paragraph">
<p><strong>Release builds only</strong>: The code generated by the Closure Compiler <code>:advanced</code> compilation will create a lot of global variables which has the potential to create conflicts with other JS running in your page. To isolate the created variables the code can be wrapped in an anonymous function to the variables only apply in that scope.</p>
</div>
<div class="paragraph">
<p><code>release</code> builds for <code>:browser</code> with only one <code>:modules</code> are wrapped in <code>(function(){&lt;the-code&gt;}).call(this);</code> by default. So no global variables are created.</p>
</div>
<div class="paragraph">
<p>When using multiple <code>:modules</code> (a.k.a <a href="#CodeSplitting">code splitting</a>) this is not enabled by default since each module must be able to access the variables created by the modules it depends on. The Closure Compiler supports an additional option to enable the use of an output wrapper in combination with multiple <code>:modules</code> named <code>:rename-prefix-namespace</code>. This will cause the Compiler to scope all "global" variables used by the build into one actual global variable. By default this is set to <code>:rename-prefix-namespace "$APP"</code> when <code>:output-wrapper</code> is set to <code>true</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:target</span> <span class="symbol">:browser</span>
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:compiler-options</span>
  {<span class="symbol">:output-wrapper</span> <span class="predefined-constant">true</span>
   <span class="symbol">:rename-prefix-namespace</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">MY_APP</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will only create the <code>MY_APP</code> global variable. Since every "global" variable will now be prefixed by <code>MY_APP.</code> (e.g. <code>MY_APP.a</code> instead of just <code>a</code>) the code size can go up substantially. It is important to keep this short. Browser compression (e.g. <code>gzip</code>) helps reduce the overhead of the extra code but depending on the amount of global variables in your build this can still produce a noticeable increase.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Note that the created variable isn&#8217;t actually useful directly. It will contain a lot of munged/minified properties. All exported (eg. <code>^:export</code>) variables will still be exported into the global scope and are not affect by this setting. The setting only serves to limit the amount of global variables created, nothing else. Do not use it directly.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_web_workers"><a class="anchor" href="#_web_workers"></a><a class="link" href="#_web_workers">7.5. Web Workers</a></h3>
<div class="paragraph">
<p>The <code>:modules</code> configuration may also be used to generate files intended to be used as a Web Workers.
You may declare any module as a Web Worker by setting <code>:web-worker true</code>. The
generated file will contain some additional bootstrap code which will load its dependencies
automatically. The way <code>:modules</code> work also ensures that code used only by the worker will also only
be in the final file for the worker. Each worker should have a dedicated CLJS namespace.</p>
</div>
<div class="listingblock">
<div class="title">An example of generating a web worker script</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:modules</span>
   {<span class="symbol">:shared</span>
    {<span class="symbol">:entries</span> []}
    <span class="symbol">:main</span>
    {<span class="symbol">:init-fn</span> my.app/init
     <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}}
    <span class="symbol">:worker</span>
    {<span class="symbol">:init-fn</span> my.app.worker/init
     <span class="symbol">:depends-on</span> #{<span class="symbol">:shared</span>}
     <span class="symbol">:web-worker</span> <span class="predefined-constant">true</span>}}
   }}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration will generate <code>worker.js</code> which you can use to start the Web Worker.
It will have all code from the <code>:shared</code> module available (but not <code>:main</code>). The code in the
<code>my.app.worker</code> namespace will only ever execute in the worker. Worker generation happens in
both development and release modes.</p>
</div>
<div class="paragraph">
<p>Note that the empty <code>:entries []</code> in the <code>:shared</code> module will make it collect all the code shared between the <code>:main</code> and <code>:worker</code> modules.</p>
</div>
<div class="listingblock">
<div class="title">Sample echo worker</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app.worker</span>)

(<span class="keyword">defn</span> <span class="function">init</span> []
  (js/self.addEventListener <span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>
    (<span class="keyword">fn</span> [^js e]
      (js/postMessage (<span class="keyword">..</span> e -data)))))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample using the worker</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>)

(<span class="keyword">defn</span> <span class="function">init</span> []
  (<span class="keyword">let</span> [worker (js/Worker. <span class="string"><span class="delimiter">&quot;</span><span class="content">/js/worker.js</span><span class="delimiter">&quot;</span></span>)]
    (<span class="keyword">..</span> worker (addEventListener <span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span> (<span class="keyword">fn</span> [e] (js/console.log e))))
    (<span class="keyword">..</span> worker (postMessage <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>))))</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Since we now have a <code>:shared</code> module you must ensure to load it properly in your HTML. If you just load <code>main.js</code> you will get an error.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">HTML Loading shared.js and main.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">&lt;script src<span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">/js/shared.js</span><span class="delimiter">&quot;</span></span>&gt;&lt;/script&gt;
&lt;script src<span class="keyword">=</span><span class="string"><span class="delimiter">&quot;</span><span class="content">/js/main.js</span><span class="delimiter">&quot;</span></span>&gt;&lt;/script&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cacheable_output"><a class="anchor" href="#_cacheable_output"></a><a class="link" href="#_cacheable_output">7.6. Cacheable Output</a></h3>
<div class="paragraph">
<p>In a web setting it is desirable to cache <code>.js</code> files for a very long time to avoid extra request. It is common
practice the generate a unique name for the <code>.js</code> file for every released version. This changes the URL used to
access it and thereby is safe to cache forever.</p>
</div>
<div class="sect3">
<h4 id="release-version"><a class="anchor" href="#release-version"></a><a class="link" href="#release-version">7.6.1. Release Versions</a></h4>
<div class="paragraph">
<p>Creating unique filenames for each release can be done via the <code>:release-version</code> config setting. Generally you&#8217;ll pass this in from the command line via <a href="#config-merge">--config-merge</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">shadow-cljs release app --config-merge '{<span class="symbol">:release-version</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">v1</span><span class="delimiter">&quot;</span></span>}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example :modules config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
      <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would create the <code>main.v1.js</code> and <code>extra.v1.js</code> files in <code>public/js</code> instead of the usual <code>main.js</code> and <code>extra.js</code>.</p>
</div>
<div class="paragraph">
<p>You can use manual versions or something automated like the <code>git</code> sha at the time of the build. Just make sure that you bump whatever it is once you shipped something out to the user since with caching they won&#8217;t be requesting newer versions of old files.</p>
</div>
</div>
<div class="sect3">
<h4 id="NameHashing"><a class="anchor" href="#NameHashing"></a><a class="link" href="#NameHashing">7.6.2. Filenames with Fingerprint-Hash</a></h4>
<div class="paragraph">
<p>You can add <code>:module-hash-names true</code> to your build config to automatically create a MD5
signature for each generated output module file. That means that a <code>:main</code> module will generate
a <code>main.&lt;md5hash&gt;.js</code> instead of just the default <code>main.js</code>.</p>
</div>
<div class="paragraph">
<p><code>:module-hash-names true</code> will include the full 32-length md5 hash, if you prefer a shorter version you can specify a
number between 1-32 instead (eg. <code>:module-hash-names 8</code>). Be aware that shortening the hash may increase the chances
of generating conflicts. I recommend using the full hash.</p>
</div>
<div class="listingblock">
<div class="title">Example :module-hash-names config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
      <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
      <span class="symbol">:module-hash-names</span> <span class="predefined-constant">true</span>
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of generating <code>main.js</code> it will now generate <code>main.&lt;hash&gt;.js</code> in the <code>:output-dir</code>.</p>
</div>
<div class="paragraph">
<p>Since the filename can change with every release it gets a little bit more complicated to include them
in your HTML. The <a href="#BrowserManifest">Output Manifest</a> can help with that.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="BrowserManifest"><a class="anchor" href="#BrowserManifest"></a><a class="link" href="#BrowserManifest">7.7. Output Manifest</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> generates a <code>manifest.edn</code> file in the configured <code>:output-dir</code>.
This file contains a description of the module config together with an extra <code>:output-name</code> property which
maps the original module name to actual filename (important when using the <code>:module-hash-names</code> feature).</p>
</div>
<div class="listingblock">
<div class="title">Sample output of manifest.edn when using hashed filenames.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[{<span class="symbol">:module-id</span> <span class="symbol">:common</span>,
  <span class="symbol">:name</span> <span class="symbol">:common</span>,
  <span class="symbol">:output-name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">common.15D142F7841E2838B46283EA558634EE.js</span><span class="delimiter">&quot;</span></span>,
  <span class="symbol">:entries</span> [<span class="keyword">..</span><span class="keyword">.</span>],
  <span class="symbol">:depends-on</span> #{},
  <span class="symbol">:sources</span> [<span class="keyword">..</span><span class="keyword">.</span>]}
 {<span class="symbol">:module-id</span> <span class="symbol">:page-a</span>,
  <span class="symbol">:name</span> <span class="symbol">:page-a</span>,
  <span class="symbol">:output-name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">page-a.D8844E305644135CBD5CBCF7E359168A.js</span><span class="delimiter">&quot;</span></span>,
  <span class="symbol">:entries</span> [<span class="keyword">..</span><span class="keyword">.</span>],
  <span class="symbol">:depends-on</span> #{<span class="symbol">:common</span>},
  <span class="symbol">:sources</span> [<span class="keyword">..</span><span class="keyword">.</span>]}
 <span class="keyword">..</span><span class="keyword">.</span>]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The manifest contains all <code>:modules</code> sorted in dependency order. You can use it to map the <code>:module-id</code> back to the
actual generated filename.</p>
</div>
<div class="paragraph">
<p>Development builds also produce this file and you may check if for modifications to
know when a new build completed. <code>:module-hash-names</code> does not apply during development so you&#8217;ll get the usual
filenames.</p>
</div>
<div class="paragraph">
<p>You can configure the name of the generated manifest file via the <code>:build-options :manifest-name</code> entry. It defaults to
<code>manifest.edn</code>. If you configure a filename with <code>.json</code> ending the output will be JSON instead of EDN. The file will
be relative to the configured <code>:output-dir</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example manifest.json config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   {<span class="symbol">:app</span>
     {<span class="symbol">:target</span> <span class="symbol">:browser</span>
      <span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:build-options</span> {<span class="symbol">:manifest-name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">manifest.json</span><span class="delimiter">&quot;</span></span>}
      <span class="symbol">:modules</span> {<span class="symbol">:main</span>  {<span class="symbol">:entries</span> [my.app]}
                <span class="symbol">:extra</span> {<span class="symbol">:entries</span> [my.app.extra]
                        <span class="symbol">:depends-on</span> #{<span class="symbol">:main</span>}}}}}}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_development_support"><a class="anchor" href="#_development_support"></a><a class="link" href="#_development_support">7.8. Development Support</a></h3>
<div class="paragraph">
<p>The <code>:devtools</code> section of the configuration for <code>:browser</code> supports a few additional
options for configuring an optional dev-time HTTP server for a build and CSS reloading.</p>
</div>
<div class="sect3">
<h4 id="hud"><a class="anchor" href="#hud"></a><a class="link" href="#hud">7.8.1. Heads-Up Display (HUD)</a></h4>
<div class="paragraph">
<p>The <code>:browser</code> target now uses a HUD to display a loading indicator when a build is started. It will also display warnings and errors if there are any.</p>
</div>
<div class="paragraph">
<p>You can disable it completely by setting <code>:hud false</code> in the <code>:devtools</code> section.</p>
</div>
<div class="paragraph">
<p>You may also toggle certain features by specifying which features you care about via setting <code>:hud #{:errors :warnings}</code>. This will show errors/warnings but no progress indicator. Available options are <code>:errors</code>, <code>:warnings</code>, <code>:progress</code>. Only options included will be enabled, all other will be disabled.</p>
</div>
<div class="sect4">
<h5 id="open-file-command"><a class="anchor" href="#open-file-command"></a><a class="link" href="#open-file-command">Opening Files</a></h5>
<div class="paragraph">
<p>Warnings include a link to source location which can be clicked to open the file in your editor. For this a little bit of config is required.</p>
</div>
<div class="paragraph">
<p>You can either configure this in your <code>shadow-cljs.edn</code> config for the project or globally in your home directory under <code>~/.shadow-cljs/config.edn</code>.</p>
</div>
<div class="listingblock">
<div class="title"><code>:open-file-command</code> configuration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:open-file-command</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">idea</span><span class="delimiter">&quot;</span></span> <span class="symbol">:pwd</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">--line</span><span class="delimiter">&quot;</span></span> <span class="symbol">:line</span> <span class="symbol">:file</span>]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:open-file-command</code> expects a vector representing a very simple DSL. Strings are kept as they are and keyword are replaced by their respective values. A nested vector can be used in case you need to combine multiple params, using <code>clojure.core/format</code> style pattern.</p>
</div>
<div class="paragraph">
<p>The above example would execute</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ idea /path/to/project-root --line 3 /path/to/project-root/src/main/demo/foo.cljs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>emacsclient</code> example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:open-file-command</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">emacsclient</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-n</span><span class="delimiter">&quot;</span></span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">+%s:%s</span><span class="delimiter">&quot;</span></span> <span class="symbol">:line</span> <span class="symbol">:column</span>] <span class="symbol">:file</span>]}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ emacsclient -n +3:1 /path/to/project-root/src/main/demo/foo.cljs</code></pre>
</div>
</div>
<div class="paragraph">
<p>The available replacement variables are:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:pwd</code></dt>
<dd>
<p>Process Working Directory (aka project root)</p>
</dd>
<dt><code>:file</code></dt>
<dd>
<p>Absolute File Path</p>
</dd>
<dt><code>:line</code></dt>
<dd>
<p>Line Number of Warning/Error</p>
</dd>
<dt><code>:column</code></dt>
<dd>
<p>Column Number</p>
</dd>
<dt><code>:wsl-file</code></dt>
<dd>
<p>Translated WSL file path. Useful when running <code>shadow-cljs</code> via WSL Bash. Translates a <code>/mnt/c/Users/someone/code/project/src/main/demo/foo.cljs</code> path into <code>C:\Users...</code></p>
</dd>
<dt><code>:wsl-pwd</code></dt>
<dd>
<p>Translated <code>:pwd</code></p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_css_reloading"><a class="anchor" href="#_css_reloading"></a><a class="link" href="#_css_reloading">7.8.2. CSS Reloading</a></h4>
<div class="paragraph">
<p>The Browser devtools can also reload CSS for you. This is enabled by default and in most cases requires no additional
configuration when you are using the built-in <a href="#dev-http">development HTTP servers</a>.</p>
</div>
<div class="paragraph">
<p>Any stylesheet included in a page will be reloaded if modified on the filesystem. Prefer using absolute paths but relative paths should work as well.</p>
</div>
<div class="listingblock">
<div class="title">Example HTML snippet</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;link</span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/css/main.css</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Hiccup since we aren&#8217;t savages</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">[<span class="symbol">:link</span> {<span class="symbol">:rel</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="symbol">:href</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/css/main.css</span><span class="delimiter">&quot;</span></span>}]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Using the built-in dev HTTP server</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will cause the browser to reload <code>/css/main.css</code> when <code>public/css/main.css</code> is changed.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> currently provides no support for directly compiling CSS but the usual tools will work and should
be run separately. Just make sure the output is generated into the correct places.</p>
</div>
<div class="paragraph">
<p>When you are not using the built-in HTTP Server you can specify <code>:watch-dir</code> instead which should be a path to the
document root used to serve your content.</p>
</div>
<div class="listingblock">
<div class="title">Example :watch-dir config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
    {<span class="symbol">:builds</span>
      {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
             <span class="symbol">:devtools</span> {<span class="symbol">:watch-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When your HTTP Server is serving the files from a virtual directory and the filesystem paths don&#8217;t exactly match the path used in the HTML you may adjust the path by setting <code>:watch-path</code> which will be used as a prefix.</p>
</div>
<div class="listingblock">
<div class="title">Example <code>public/css/main.css</code> being served under <code>/foo/css/main.css</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 {<span class="symbol">:builds</span>
  {<span class="symbol">:app</span>
   {<span class="keyword">..</span><span class="keyword">.</span>
    <span class="symbol">:devtools</span> {<span class="symbol">:watch-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>
               <span class="symbol">:watch-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/foo</span><span class="delimiter">&quot;</span></span>}}}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="proxy-support"><a class="anchor" href="#proxy-support"></a><a class="link" href="#proxy-support">7.8.3. Proxy Support</a></h4>
<div class="paragraph">
<p>By default the devtools client will attempt to connect to the <code>shadow-cljs</code> process via the configured <a href="#http">HTTP server</a> (usually <code>localhost</code>). If you are using a reverse proxy to serve your HTML that might not be possible. You can set <code>:devtools-url</code> to configure which URL to use.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span> {<span class="keyword">..</span><span class="keyword">.</span>
        <span class="symbol">:devtools</span> {<span class="symbol">:before-load</span>  my.app/stop
                   <span class="symbol">:after-load</span>   my.app/start
                   <span class="symbol">:devtools-url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://some.host/shadow-cljs</span><span class="delimiter">&quot;</span></span>
                   <span class="keyword">..</span><span class="keyword">.</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> will then use the <code>:devtools-url</code> as the base when making requests. It is not the final URL so you must ensure that all requests starting with the path you configured (eg. <code>/shadow-cljs/*</code>) are forwarded to the host <code>shadow-cljs</code> is running on.</p>
</div>
<div class="listingblock">
<div class="title">Incoming Request to Proxy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">https://some.host/shadow-cljs/ws/foo/bar?asdf</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">must forward to</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">http<span class="symbol">://localhost</span><span class="error">:</span><span class="integer">9630</span>/foo/bar?asdf</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client will make WebSocket request as well as normal XHR requests to load files. Ensure that your proxy properly upgrades WebSockets.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The requests must be forwarded to the main <a href="#http">HTTP server</a>, not the one configured in the build itself.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="js-provider-external"><a class="anchor" href="#js-provider-external"></a><a class="link" href="#js-provider-external">7.9. Using External JS Bundlers</a></h3>
<div class="paragraph">
<p>Sometimes npm packages you may wish to use may use features that <code>shadow-cljs</code> itself does not support. Some packages are even written with the explicit expectation to be processed by <code>webpack</code>. In these cases it might be simpler to just use <code>webpack</code> (or similar), instead of letting <code>shadow-cljs</code> try to bundle those packages and working arround the issues that may occur.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> supports an option to let it focus on compiling CLJS code, but let something else process the npm/JS requires. You can do so via <code>:js-provider :external</code>. I wrote more on this subject <a href="https://code.thheller.com/blog/shadow-cljs/2020/05/08/how-about-webpack-now.html#option-2-js-provider-external:">in this blogpost</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
This will limit certain dynamic interaction. Adding new npm requires will require reloading the page, since they can no longer be hot-loaded in by shadow-cljs. Requiring npm packages at the REPL will also be limited to those already provided by the external JS file. Which often is not a big deal, but something to be aware of.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In your build config you add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="keyword">..</span><span class="keyword">.</span>}}
   <span class="symbol">:js-options</span>
   {<span class="symbol">:js-provider</span> <span class="symbol">:external</span>
    <span class="symbol">:external-index</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">target/index.js</span><span class="delimiter">&quot;</span></span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> will then just output all required <code>npm</code> package requires in a format that regular JS tools can understand. You&#8217;ll then need to run <code>webpack</code> (or similar) manually, and include the output of that build separately from the <code>shadow-cljs</code> output.</p>
</div>
<div class="paragraph">
<p>So, instead of just including one <code>script</code> tag in your HTML, you include two.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">defer</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/js/libs.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">defer</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/js/main.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>libs.js</code> here presuming to be the output of <code>webpack</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Note that <code>webpack</code> (or similar) sometimes output more than one file, so which exactly you need to include may depend on how you built everything. Please consult their documentation for more details. The only important part as far as shadow-cljs is concerned that the external output is loaded before the <code>shadow-cljs</code> output.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_js_tree_shaking"><a class="anchor" href="#_js_tree_shaking"></a><a class="link" href="#_js_tree_shaking">7.9.1. JS Tree Shaking</a></h4>
<div class="paragraph">
<p>Tools like <code>webpack</code> can potentially tree-shake npm dependencies to make their build output smaller. For this the <code>:external-index</code> file needs to generate ESM code, instead of the current default CommonJS, i.e. <code>require()</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="keyword">..</span><span class="keyword">.</span>}}
   <span class="symbol">:js-options</span>
   {<span class="symbol">:js-provider</span> <span class="symbol">:external</span>
    <span class="symbol">:external-index</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">target/index.js</span><span class="delimiter">&quot;</span></span>
    <span class="symbol">:external-index-format</span> <span class="symbol">:esm</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will only use <code>import</code> in the <code>:external-index</code> file. For <code>release</code> builds this file will list all the referenced imports, for watch/compile it&#8217;ll still reference everything.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="target-esm"><a class="anchor" href="#target-esm"></a><a class="link" href="#target-esm">8. Targeting JavaScript Modules</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>:target :esm</code> emits files that can be used in any ESM environment.</p>
</div>
<div class="paragraph">
<p>ESM, short for ECMAscript Modules, or just <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">JavaScript Modules</a>, is the modernized standard for JavaScript files. Most modern platforms support this out of the box, and more and more of the JS ecosystem is moving this way. Each Module generated this way can specify "exports" which other files importing this can reference.</p>
</div>
<div class="paragraph">
<p>ESM much like the <a href="#target-browser">:target :browser</a> is driven by the <code>:modules</code> config option. Each module can declare its <code>:exports</code> for others to access.</p>
</div>
<div class="paragraph">
<p>As with other modes the <a href="#config">main configuration options</a> apply and can be set.
The additional target-specific options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>(optional, default <code>"public/js"</code>). The path where all <code>:modules</code> are written to.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:runtime</code>
</td>
<td class="hdlist2">
<p>(optional , default <code>:browser</code>) Controls which development extensions for REPL/hot-reload are injected. Currently only supports <code>:browser</code>. Set to any other value to disable.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:modules</code>
</td>
<td class="hdlist2">
<p>required, a map of keyword to module configuration</p>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_module_configuration"><a class="anchor" href="#_module_configuration"></a><a class="link" href="#_module_configuration">8.1. Module Configuration</a></h3>
<div class="paragraph">
<p>Each module has its own set of options that control how the module is constructed. Specifying multiple modules will mean that the code is split between them.</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:init-fn</code>
</td>
<td class="hdlist2">
<p>optional, a <code>defn</code> to run when the module loads.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:entries</code>
</td>
<td class="hdlist2">
<p>optional, a vector of namespace symbols to load in this module</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:exports</code>
</td>
<td class="hdlist2">
<p>required, a map of symbol to fully qualified symbols</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:depends-on</code>
</td>
<td class="hdlist2">
<p>required when using multiple <code>:modules</code>. specifing a set of other modules this module depends on.</p>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_module_exports"><a class="anchor" href="#_module_exports"></a><a class="link" href="#_module_exports">8.1.1. Module Exports</a></h4>
<div class="paragraph">
<p>Controlling what code is actually exported is done via <code>:exports</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example Build Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:esm</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span> {<span class="symbol">:demo</span> {<span class="symbol">:exports</span> {hello demo.lib/hello}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will generate the <code>public/js/demo.js</code> file. The name is decided by taking the <code>:output-dir</code> and combining it with the key <code>:demo</code> in the <code>:modules</code> map.</p>
</div>
<div class="listingblock">
<div class="title">Example CLJS Code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.lib</span>)

(<span class="keyword">defn</span> <span class="function">hello</span> []
  (js/console.og <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>))

(<span class="keyword">defn</span> <span class="function">not-exported</span> []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will be loadable directly in any ESM environment. For example the Browser. Putting this into a <code>public/index.html</code> and loading it via <a href="http://localhost:8000" class="bare">http://localhost:8000</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">module</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="inline">  <span class="reserved">import</span> { hello } from <span class="string"><span class="delimiter">&quot;</span><span class="content">/js/demo.js</span><span class="delimiter">&quot;</span></span>;
  hello();</span>
<span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>npx shadow-cljs watch app</code> you should see the <code>hello world</code> logged to the browser console when loading the page.</p>
</div>
<div class="paragraph">
<p>Note that only <code>hello</code> is accessible here since it was declared in the <code>:exports</code>. The <code>(defn not-exported [] &#8230;&#8203;)</code> will not be accessible and will most likely be removed entirely in <code>:advanced</code> release builds.</p>
</div>
<div class="sect4">
<h5 id="_module_default_exports"><a class="anchor" href="#_module_default_exports"></a><a class="link" href="#_module_default_exports">Module Default Exports</a></h5>
<div class="paragraph">
<p>ES Module have this one "special" <code>default</code> export, which you&#8217;ll often see used in JS examples. This can be expressed by defining the <code>default</code> exports like any other.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:esm</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span> {<span class="symbol">:demo</span> {<span class="symbol">:exports</span> {default demo.lib/hello}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the import side changing to</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">module</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="inline">  <span class="reserved">import</span> hello from <span class="string"><span class="delimiter">&quot;</span><span class="content">/js/demo.js</span><span class="delimiter">&quot;</span></span>;
  hello();</span>
<span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Many platforms or systems apply special meaning to this <code>default</code> export, but it is declared like any other in the build config.</p>
</div>
</div>
<div class="sect4">
<h5 id="_module_init_fn"><a class="anchor" href="#_module_init_fn"></a><a class="link" href="#_module_init_fn">Module :init-fn</a></h5>
<div class="paragraph">
<p>Sometimes you may not require any <code>:exports</code> and instead just want the code to run automatically when the module is loaded. This can be done via <code>:init-fn</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:esm</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span> {<span class="symbol">:demo</span> {<span class="symbol">:init-fn</span> demo.lib/hello}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the HTML</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">module</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">js/demo.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In can also be combined with <code>:exports</code> to run a function and still provide <code>:exports</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:esm</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span>
   {<span class="symbol">:demo</span>
    {<span class="symbol">:init-fn</span> demo.lib/hello
     <span class="symbol">:exports</span> {hello demo.lib/hello}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Keeping this HTML will essentially just log twice on page load.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">module</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="inline">  <span class="reserved">import</span> hello from <span class="string"><span class="delimiter">&quot;</span><span class="content">/js/demo.js</span><span class="delimiter">&quot;</span></span>;
  hello();</span>
<span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_module_splitting"><a class="anchor" href="#_module_splitting"></a><a class="link" href="#_module_splitting">8.2. Module Splitting</a></h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:esm</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span>
   {<span class="symbol">:base</span>
    {<span class="symbol">:entries</span> []}
    <span class="symbol">:hello</span>
    {<span class="symbol">:exports</span> {hello demo.lib/hello}
     <span class="symbol">:depends-on</span> #{<span class="symbol">:base</span>}}
    <span class="symbol">:other</span>
    {<span class="symbol">:exports</span> {foo demo.foo/foo}
     <span class="symbol">:depends-on</span> #{<span class="symbol">:base</span>}}
    }}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And adding</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.foo</span>)

(<span class="keyword">defn</span> <span class="function">foo</span> []
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we declare 3 modules with one <code>:base</code> module and two other modules which both depend on the <code>:base</code> module. The <code>:base</code> module declared an empty <code>:entries []</code> vector which is a convenience to say that it should extract all the namespaces that both of the other modules share (eg. <code>cljs.core</code> in this case).</p>
</div>
<div class="paragraph">
<p>You may now load each <code>:module</code> independently in the HTML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">module</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="inline">  <span class="reserved">import</span> hello from <span class="string"><span class="delimiter">&quot;</span><span class="content">/js/hello.js</span><span class="delimiter">&quot;</span></span>;
  hello();</span>
<span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The browser will automatically load the <code>/js/base.js</code> as well, but not the <code>/js/other.js</code> as the code above doesn&#8217;t need it. You can use <code>:modules</code> to split code for separate sections of your website for example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dynamic_module_import"><a class="anchor" href="#_dynamic_module_import"></a><a class="link" href="#_dynamic_module_import">8.3. Dynamic Module Import</a></h3>
<div class="paragraph">
<p>Modules can also be loaded dynamically at runtime via the provided <code>shadow.esm/dynamic-import</code> helper.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span>
    [shadow.esm <span class="symbol">:refer</span> (dynamic-import)]
    [shadow.cljs.modern <span class="symbol">:refer</span> (js-await)]))

(<span class="keyword">defn</span> <span class="function">foo</span> []
  (js-await [<span class="keyword">mod</span> (dynamic-import <span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdn.pika.dev/preact@^10.0.0</span><span class="delimiter">&quot;</span></span>)]
    (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">loaded module</span><span class="delimiter">&quot;</span></span> <span class="keyword">mod</span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would load an external ESM module dynamically at runtime without it ever being part of the build. You can of course also load your own <code>:modules</code> dynamically this way too.</p>
</div>
</div>
<div class="sect2">
<h3 id="_third_party_tool_integration"><a class="anchor" href="#_third_party_tool_integration"></a><a class="link" href="#_third_party_tool_integration">8.4. Third Party Tool Integration</a></h3>
<div class="paragraph">
<p>In the default <code>:runtime :browser</code> setup all dependencies are bundled and provided by <code>shadow-cljs</code>. This is done so the output is directly loadable in the Browser. When importing the <code>:target :esm</code> output into another build tool environment (eg. webpack) that may lead to duplicated dependencies.</p>
</div>
<div class="paragraph">
<p>Instead, you can configure shadow-cljs to not bundle any JS dependencies and instead leave that to the other tool.</p>
</div>
<div class="paragraph">
<p>This is done by setting <code>:js-provider</code> in your build config.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dev-http</span> {<span class="integer">8000</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:esm</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:js-options</span> {<span class="symbol">:js-provider</span> <span class="symbol">:import</span>}
   <span class="symbol">:modules</span> {<span class="symbol">:demo</span> {<span class="symbol">:exports</span> {default demo.lib/hello}}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this build shadow-cljs will only compile and bundle CLJS code, but leave all other JS code to be provided by some other tool later. Note that if you have <code>(:require ["react"])</code> or any other <code>npm</code> dependency in your build the output from <code>shadow-cljs</code> MUST be processed by another tool first before it becomes loadable in the Browser. Only set this if some other tool is actually going to provide the required dependencies.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="target-react-native"><a class="anchor" href="#target-react-native"></a><a class="link" href="#target-react-native">9. Targeting React Native</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>:target :react-native</code> produces code that is meant to integrate into the default <code>react-native</code> tooling (eg. <code>metro</code>). Tools like <code>expo</code> which wrap those tools should automatically work and require no additional setup.</p>
</div>
<div class="paragraph">
<p>You will need the same basic <a href="#config">main configuration</a> as in other targets (like
<code>:source-paths</code>), the build specific config is very minimal and requires at least 2 options (besides <code>:target</code> itself)</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:init-fn</code>
</td>
<td class="hdlist2">
<p>(required). The namespace-qualified symbol of your apps init function. This function will be called once on startup and should probably render something.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>(required). The directory used to write output files.</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Sample :react-native config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="symbol">:dependencies</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:react-native</span>
   <span class="symbol">:init-fn</span> demo.app/init
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">app</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When compiled this results in a <code>app/index.js</code> file intended to be used as an entry point for the <code>react-native</code> tools. During development the <code>:output-dir</code> will contain many more files but you should only reference the generated <code>app/index.js</code> directly. A <code>release</code> build will only generate the optimized <code>app/index.js</code> and requires no additional files.</p>
</div>
<div class="sect2">
<h3 id="_react_native"><a class="anchor" href="#_react_native"></a><a class="link" href="#_react_native">9.1. React Native</a></h3>
<div class="paragraph">
<p>There are two ways to use <code>react-native</code>, "plain" <code>react-native</code>, which allows you to use native code and libraries and the one "wrapped" in <a href="https://expo.io/">expo</a> (described below). All the steps described above are sufficient to start using shadow-cljs with the plain <code>react-native</code>. See this example repo:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/thheller/reagent-react-native" class="bare">https://github.com/thheller/reagent-react-native</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_expo"><a class="anchor" href="#_expo"></a><a class="link" href="#_expo">9.2. Expo</a></h3>
<div class="paragraph">
<p><a href="https://expo.io/">expo</a> makes working with <code>react-native</code> quite easy. There are two provided example setups.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/thheller/fulcro-expo" class="bare">https://github.com/thheller/fulcro-expo</a></p>
</li>
<li>
<p><a href="https://github.com/thheller/reagent-expo" class="bare">https://github.com/thheller/reagent-expo</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both examples were generated using <code>expo init &#8230;&#8203;</code> and the only adjusted change in the config was adding the proper <code>entryPoint</code> to the generated <code>app.json</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{
  <span class="string"><span class="delimiter">&quot;</span><span class="content">expo</span><span class="delimiter">&quot;</span></span><span class="error">:</span> {
    <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span><span class="error">:</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello-world</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">slug</span><span class="delimiter">&quot;</span></span><span class="error">:</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">reagent-expo</span><span class="delimiter">&quot;</span></span>,
    <span class="keyword">..</span><span class="keyword">.</span>
    <span class="string"><span class="delimiter">&quot;</span><span class="content">entryPoint</span><span class="delimiter">&quot;</span></span><span class="error">:</span><span class="string"><span class="delimiter">&quot;</span><span class="content">./app/index.js</span><span class="delimiter">&quot;</span></span>,
    <span class="keyword">..</span><span class="keyword">.</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>expo</code> requires that a React Component is registered on startup which can be done manually or by using the <code>shadow.expo/render-root</code> function which takes care of creating the Component and instead directly expects a React Element instance to start rendering.</p>
</div>
<div class="listingblock">
<div class="title">From the Reagent <a href="https://github.com/thheller/reagent-expo/blob/2c73ed0513a8f5050b250c0c7e53b9ae7543cee9/src/main/test/app.cljs#L34-L40">example</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">start</span>
  {<span class="symbol">:dev/after-load</span> <span class="predefined-constant">true</span>}
  []
  (expo/render-root (r/as-element [root])))

(<span class="keyword">defn</span> <span class="function">init</span> []
  (start))</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>init</code> is called once on startup. Since the example doesn&#8217;t need to do any special setup it just calls <code>start</code> directly. <code>start</code> will be called repeatedly when <code>watch</code> is running each time after the code changes were reloaded. The <code>reagent.core/as-element</code> function can be used to generate the required React Element from the reagent hiccup markup.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hot_code_reload_2"><a class="anchor" href="#_hot_code_reload_2"></a><a class="link" href="#_hot_code_reload_2">9.3. Hot Code Reload</a></h3>
<div class="paragraph">
<p>React native requires to reload not only compiled files and files explicitly requiring those, but also their transitive dependents, for changes to take effect. To accomplish this, use <code>:reload-strategy</code> option as in <a href="#reload-strategy">Hot Reload of Transitive Dependents</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="target-node"><a class="anchor" href="#target-node"></a><a class="link" href="#target-node">10. Targeting node.js</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is built-in support for generating code that is intended to be used as a stand-alone
script, and also for code that is intended to be used as a library. See the
section on <a href="#config">common configuration</a> for the base settings needed in
a configuration file.</p>
</div>
<div class="sect2">
<h3 id="target-node-script"><a class="anchor" href="#target-node-script"></a><a class="link" href="#target-node-script">10.1. node.js Scripts</a></h3>
<div class="paragraph">
<p>The <code>:target :node-script</code> produces single-file stand-alone output that can be run using <code>node.js</code>.
The code is just ClojureScript, and an entry point is easy to define:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.script</span>)

(<span class="keyword">defn</span> <span class="function">main</span> [&amp; cli-args]
  (<span class="keyword">prn</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>))</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_build_options"><a class="anchor" href="#_build_options"></a><a class="link" href="#_build_options">10.1.1. Build Options</a></h4>
<div class="paragraph">
<p>You will need the same basic <a href="#config">main configuration</a> as in other targets (like
<code>:source-paths</code>), but you&#8217;ll need some node-specific build target options:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:main</code>
</td>
<td class="hdlist2">
<p>(required). The namespace-qualified symbol of your script&#8217;s entry point function.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>(required). The path and filename for the generated script.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>(optional). The path for supporting files in development mode. Defaults to a cache directory.</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Sample node script build</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="keyword">..</span><span class="keyword">.</span>]
 <span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:script</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="symbol">:main</span> demo.script/main
   <span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out/demo-script/script.js</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When compiled this results in a standalone <code>out/demo-script/script.js</code> file intended to be called
via <code>node script.js &lt;command line args&gt;</code>. When run it will call <code>(demo.script/main &lt;command line args&gt;)</code>
function on startup. This only ever produces the file specified in <code>:output-to</code>. Any other support files
(e.g. for development mode) are written to a temporary support directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="NodeHotCodeReload"><a class="anchor" href="#NodeHotCodeReload"></a><a class="link" href="#NodeHotCodeReload">10.1.2. Hot Code Reload</a></h4>
<div class="paragraph">
<p>You will often write scripts that run as servers or some other long-running process. Hot code reload can
be quite useful when working with these, and it is simple to set up:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add start/stop callback functions.</p>
</li>
<li>
<p>Configure the build use those hooks.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here is an example http server in node:</p>
</div>
<div class="listingblock">
<div class="title">Sample node script with start/stop hooks for hot code reload.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.script</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> http]))

(<span class="keyword">defn</span> <span class="function">request-handler</span> [req res]
  (<span class="keyword">.</span>end res <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>))

<span class="comment">; a place to hang onto the server so we can stop/start it</span>
(<span class="keyword">defonce</span> <span class="function">server-ref</span>
  (volatile! <span class="predefined-constant">nil</span>))

(<span class="keyword">defn</span> <span class="function">main</span> [&amp; args]
  (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">starting server</span><span class="delimiter">&quot;</span></span>)
  (<span class="keyword">let</span> [server (http/createServer #(request-handler %1 %2))]

    (<span class="keyword">.</span>listen server <span class="integer">3000</span>
      (<span class="keyword">fn</span> [err]
        (<span class="keyword">if</span> err
          (js/console.error <span class="string"><span class="delimiter">&quot;</span><span class="content">server start failed</span><span class="delimiter">&quot;</span></span>)
          (js/console.info <span class="string"><span class="delimiter">&quot;</span><span class="content">http server running</span><span class="delimiter">&quot;</span></span>))
        ))

    (vreset! server-ref server)))

(<span class="keyword">defn</span> <span class="function">start</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Hook to start. Also used as a hook for hot code reload.</span><span class="delimiter">&quot;</span></span>
  []
  (js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">start called</span><span class="delimiter">&quot;</span></span>)
  (main))

(<span class="keyword">defn</span> <span class="function">stop</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Hot code reload hook to shut down resources so hot code reload can work</span><span class="delimiter">&quot;</span></span>
  [done]
  (js/console.warn <span class="string"><span class="delimiter">&quot;</span><span class="content">stop called</span><span class="delimiter">&quot;</span></span>)
  (when-some [srv @server-ref]
    (<span class="keyword">.</span>close srv
      (<span class="keyword">fn</span> [err]
        (js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">stop completed</span><span class="delimiter">&quot;</span></span> err)
        (done)))))

(js/console.log <span class="string"><span class="delimiter">&quot;</span><span class="content">__filename</span><span class="delimiter">&quot;</span></span> js/__filename)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The associated configuration is (<code>shadow-cljs.edn</code>):</p>
</div>
<div class="listingblock">
<div class="title">Adding hooks for hot code reload.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
   { <span class="symbol">:script</span> {<span class="keyword">..</span><span class="keyword">.</span> as before

              <span class="comment">; add in reload hooks</span>
              <span class="symbol">:devtools</span> {<span class="symbol">:before-load-async</span> demo.script/stop
                         <span class="symbol">:after-load</span> demo.script/start}}}}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Many libraries hide state or do actions that prevent hot code reloading from working well. There
is nothing the compiler can do to improve this since it has no idea what those libraries are doing.
Hot code reload will only work well in situations where you can cleanly "stop" and "restart" the
artifacts used.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="target-node-library"><a class="anchor" href="#target-node-library"></a><a class="link" href="#target-node-library">10.2. node.js Libraries</a></h3>
<div class="paragraph">
<p>The <code>:target :node-library</code> emits code that can be used (via <code>require</code>) as a standard node library, and is
useful for publishing your code for re-use as a compiled Javascript artifact.</p>
</div>
<div class="paragraph">
<p>As with other modes the <a href="#config">main configuration options</a> apply and must be set.
The target-specific options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p>Use :node-library</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>(required). The path and filename for the generated library.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>(optional). The path for supporting files in development mode. Defaults to a cache directory.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The hot code reload story is similar to <a href="#NodeHotCodeReload">the script target</a>, but may not work as well
since it cannot as easily control all of the code that is loaded.</p>
</div>
<div class="paragraph">
<p>Controlling what code is actually exported is done via one of the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>:exports</code> -  a map of keyword to fully qualified symbols</p>
</li>
<li>
<p><code>:exports-var</code> - a fully qualified symbol</p>
</li>
<li>
<p><code>:exports-fn</code> - a fully qualified symbol</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_single_static_default_export"><a class="anchor" href="#_single_static_default_export"></a><a class="link" href="#_single_static_default_export">10.2.1. Single static "default" export</a></h4>
<div class="paragraph">
<p><code>:exports-var</code> will just return whatever is declared under that var. It can point to a <code>defn</code> or normal <code>def</code>.</p>
</div>
<div class="listingblock">
<div class="title">Build config using <code>:exports-var</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:lib</span> {<span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">lib.js</span><span class="delimiter">&quot;</span></span>
                <span class="symbol">:exports-var</span> demo.ns/f
                <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example CLJS</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.ns</span>)

(<span class="keyword">defn</span> <span class="function">f</span> [<span class="keyword">..</span><span class="keyword">.</span>] <span class="keyword">..</span><span class="keyword">.</span>)
<span class="comment">;; OR</span>
(<span class="keyword">def</span> <span class="function">f</span> <span class="error">#</span>js {<span class="symbol">:foo</span> <span class="keyword">..</span><span class="keyword">.</span>})</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Consuming the generated code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ node
&gt; var f = require('./lib.js');
f(); // the actual demo.ns/f function</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is effectively generating <code>module.exports = demo.ns.f;</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_multiple_static_named_exports"><a class="anchor" href="#_multiple_static_named_exports"></a><a class="link" href="#_multiple_static_named_exports">10.2.2. Multiple static named exports</a></h4>
<div class="listingblock">
<div class="title">Build configuration with multiple exports</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:lib</span> {<span class="symbol">:exports</span> {<span class="symbol">:g</span>       demo.ns/f
                          <span class="symbol">:h</span>       other.ns/thing
                          <span class="symbol">:ns/ok?</span>  another.ns/ok?}
                <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The keyword is used as the name of the entry in the exported object. <strong>No munging is done</strong> to this keyword name
(but namespaces are dropped). So, the above example maps cljs <code>f</code> to <code>g</code>, etc.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ node
&gt; var lib = require('./lib.js');
lib.g(); // call demo-ns/f
lib[&quot;ok?&quot;](); // call another-ns/ok?</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can achieve the exact same thing by using <code>:exports-var</code> pointing to a <code>def</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">def</span> <span class="function">exports</span> <span class="error">#</span>js {<span class="symbol">:g</span> f
                  <span class="keyword">..</span><span class="keyword">.</span>})</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_exports"><a class="anchor" href="#_dynamic_exports"></a><a class="link" href="#_dynamic_exports">10.2.3. "Dynamic" exports</a></h4>
<div class="paragraph">
<p>In addition you may specify <code>:exports-fn</code> as a fully qualified symbol. This should point to a function with no arguments which should return a JS object (or function). This function will only ever be called ONCE as <code>node</code> caches the return value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.ns</span>
  (<span class="symbol">:require</span> [demo.other <span class="symbol">:as</span> other]))

(<span class="keyword">defn</span> <span class="function">generate-exports</span> []
  <span class="error">#</span>js {<span class="symbol">:hello</span> hello
       <span class="symbol">:foo</span> other/foo})</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:lib</span> {<span class="symbol">:exports-fn</span> demo.ns/generate-exports
                <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The exports config automatically tracks exported symbols and passes them on to the optimization stage. This means that anything listed in <code>:exports</code> will not be renamed by Google Closure optimizations.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_full_example"><a class="anchor" href="#_full_example"></a><a class="link" href="#_full_example">10.2.4. Full Example</a></h4>
<div class="paragraph">
<p>The example below creates a <code>lib.js</code> file intended to be consumed via the normal Node <code>require</code> mechanism.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.lib</span>)

(<span class="keyword">defn</span> <span class="function">hello</span> []
  (<span class="keyword">prn</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)
  <span class="string"><span class="delimiter">&quot;</span><span class="content">hello</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The build configuration would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span> {<span class="symbol">:library</span> {<span class="symbol">:target</span>    <span class="symbol">:node-library</span>
                    <span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out/demo-library/lib.js</span><span class="delimiter">&quot;</span></span>
                    <span class="symbol">:exports</span>   {<span class="symbol">:hello</span> demo.lib/hello}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the runtime use is as you would expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ cd out/demo-library
$ node
<span class="keyword">&gt;</span> <span class="keyword">var</span> x <span class="keyword">=</span> <span class="keyword">require</span>('<span class="keyword">.</span>/lib')<span class="comment">;</span>
undefined
<span class="keyword">&gt;</span> x.hello()
hello
'hello'</code></pre>
</div>
</div>
<div class="paragraph">
<p>As <code>:node-script</code> this will only create the file specified in <code>:output-to</code>. The <code>:exports</code> map maps CLJS vars to the name they should be exported to.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Development mode has the <a href="#NodeModes">same setup</a> as for node scripts (extra dependencies).
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_npm_packages"><a class="anchor" href="#_creating_npm_packages"></a><a class="link" href="#_creating_npm_packages">10.3. Creating <code>npm</code> packages</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="target-npm-module"><a class="anchor" href="#target-npm-module"></a><a class="link" href="#target-npm-module">11. Embedding in the JS Ecosystem&#8201;&#8212;&#8201;The <code>:npm-module</code> Target</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is an additional target that is intended to integrate CLJS into an existing JS project. The output can seamlessly integrate with existing JS tools (eg. webpack, browserify, babel,
create-react-app, &#8230;&#8203;) with little configuration.</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:output-dir</code>
</td>
<td class="hdlist2">
<p>(required) The path for the output files are written to</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:entries</code>
</td>
<td class="hdlist2">
<p>(required) A vector of namespace symbols that should be compiled</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:ns-regexp</code>
</td>
<td class="hdlist2">
<p>(optional) A regular expression matching namespaces against project files. This only scans files, and will not scan jars.</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example <code>shadow-cljs.edn</code> config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:code</span>
  {<span class="symbol">:target</span> <span class="symbol">:npm-module</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:entries</span> [demo.foo]}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With a JS file sitting in your project root, you may <code>require("./out/demo.foo")</code> to load the CLJS namespace and access it from JS. The JS requires must be the relative path from the JS file location to the CLJS output.</p>
</div>
<div class="paragraph">
<p>If you plan to distribute code on NPM, then you may want to use the <a href="#target-node-library"><code>:node-library</code> target</a> instead since it allows for a finer level of control over exports and optimization.</p>
</div>
<div class="sect2">
<h3 id="_working_with_optimizations"><a class="anchor" href="#_working_with_optimizations"></a><a class="link" href="#_working_with_optimizations">11.1. Working with Optimizations</a></h3>
<div class="paragraph">
<p>Unlike the <code>:node-library</code> target, the module target does not know what you want to call the
symbols you&#8217;re exporting, so it just exports them as-is. If you use advanced compilation, then everything
will get a minified munged name!</p>
</div>
<div class="paragraph">
<p>This is easy to remedy, simply add <code>:export</code> metadata on any symbols that you want to preserve:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.foo</span>)

(<span class="keyword">def</span> ^<span class="symbol">:export</span> foo <span class="float">5.662</span>)

(<span class="keyword">defn</span> ^<span class="symbol">:export</span> bar [] <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a standard annotation that is understood by ClojureScript and prevents Google Closure from
renaming an artifact. JS code will still be able to access them after optimizations. Without the <code>^:export</code> hint the closure-compiler will likely have removed or renamed them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">var</span> <span class="keyword">ns</span> <span class="namespace">=</span> <span class="keyword">require</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">shadow-cljs/demo.foo</span><span class="delimiter">&quot;</span></span>)<span class="comment">;</span>

ns.foo<span class="comment">;</span>
ns.bar()<span class="comment">;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing"><a class="anchor" href="#_testing"></a><a class="link" href="#_testing">12. Testing</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>shadow-cljs</code> provides a few utility targets to make building tests a little easier.</p>
</div>
<div class="paragraph">
<p>All test targets generate a test runner and automatically add all namespaces matching the configurable <code>:ns-regexp</code>. The default test runners were built for <code>cljs.test</code> but you can create custom runners if you prefer to use other test frameworks.</p>
</div>
<div class="paragraph">
<p>The default <code>:ns-regexp</code> is <code>"-test$"</code>, so your first test could look like:</p>
</div>
<div class="listingblock">
<div class="title">File: <code>src/test/demo/app_test.cljs</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.app-test</span>
  (<span class="symbol">:require</span> [cljs.test <span class="symbol">:refer</span> (deftest is)]))

(deftest a-failing-test
  (is (<span class="keyword">=</span> <span class="integer">1</span> <span class="integer">2</span>)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the Clojure world it is common to keep test files in their own source paths so the above example assumes you have configured <code>:source-paths ["src/main" "src/test"]</code> in your <code>shadow-cljs.edn</code> config. Your usual app code goes into <code>src/main</code> and the tests go into <code>src/test</code>. This however is optional and it is totally fine to keep everything in <code>src</code> and just use <code>:source-paths ["src"]</code>.</p>
</div>
<div class="sect2">
<h3 id="target-node-test"><a class="anchor" href="#target-node-test"></a><a class="link" href="#target-node-test">12.1. Testing in node.js</a></h3>
<div class="paragraph">
<p>This target will create a test runner including all test namespaces matching the given regular expression.</p>
</div>
<div class="paragraph">
<p>The relevant configuration options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p><code>:node-test</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>The final output file that will be used to run tests.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:ns-regexp</code>
</td>
<td class="hdlist2">
<p>(optional) A regular expression matching namespaces against project files. This only scans files, and will not scan jars. Defaults to <code>"-test$"</code>.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:autorun</code>
</td>
<td class="hdlist2">
<p>(boolean, optional) Run the tests via <code>node</code> when a build completes. This is mostly meant to be used in combination with <code>watch</code>. The <code>node</code> process exit code will not be returned as that would have to forcefully kill the running JVM.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:main</code>
</td>
<td class="hdlist2">
<p>(qualified symbol, optional) Function called on startup to run the tests, defaults to <code>shadow.test.node/main</code> which runs tests using <code>cljs.test</code>.</p>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Test config matching all <code>*-spec</code> namespaces</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:test</span>
  {<span class="symbol">:target</span>    <span class="symbol">:node-test</span>
   <span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out/node-tests.js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:ns-regexp</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">-spec$</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:autorun</span>   <span class="predefined-constant">true</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:node-test</code> target only generates the test file. You can run it via <code>node</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs compile test
# or
$ shadow-cljs release test

# run tests manually, :autorun will do this automatically
$ node out/node-tests.js

# compile &amp; test combined
$ shadow-cljs compile test &amp;&amp; node out/node-tests.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>node</code> process exit code will be set to <code>0</code> when successful and <code>1</code> on any failures. (The <code>node</code> process exit code will not be returned when using <code>:autorun</code>.)</p>
</div>
</div>
<div class="sect2">
<h3 id="target-browser-test"><a class="anchor" href="#target-browser-test"></a><a class="link" href="#target-browser-test">12.2. Testing in the Browser</a></h3>
<div class="paragraph">
<p>This target is meant for gathering up namespaces that contain tests (based on a filename pattern match),
and triggering a test runner. It contains a built-in runner that will automatically scan for <code>cljs.test</code>
tests and run them.</p>
</div>
<div class="paragraph">
<p>The relevant configuration options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p><code>:browser-test</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:test-dir</code>
</td>
<td class="hdlist2">
<p>A folder in which to output files. See below.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:ns-regexp</code>
</td>
<td class="hdlist2">
<p>(optional) A regular expression matching namespaces against project files. This only scans files, and
will not scan jars. Defaults to "-test$".</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:runner-ns</code>
</td>
<td class="hdlist2">
<p>(optional) A namespace that can contain a start, stop, and init function. Defaults to
<code>shadow.test.browser</code>.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The normal <code>:devtools</code> options are supported, so you will usually create an http server to serve the files.
In general you will need a config that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="comment">;; tests are served via http://localhost:8021</span>
 <span class="symbol">:dev-http</span> {<span class="integer">8021</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">out/test</span><span class="delimiter">&quot;</span></span>}
 <span class="symbol">:builds</span>
 {<span class="symbol">:test</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser-test</span>
   <span class="symbol">:test-dir</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">out/test</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you choose to supply a custom <code>:runner-ns</code>, it might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">tests.client-test-main</span>
  {<span class="symbol">:dev/always</span> <span class="predefined-constant">true</span>}
  (<span class="symbol">:require</span> [shadow.test <span class="symbol">:as</span> st]
            [shadow.test.env <span class="symbol">:as</span> env]
            [cljs-test-display.core <span class="symbol">:as</span> ctd]
            [shadow.dom <span class="symbol">:as</span> dom]))

(<span class="keyword">defn</span> <span class="function">start</span> []
  (<span class="keyword">-&gt;</span> (env/get-test-data)
      (env/reset-test-data!))

  (st/run-all-tests (ctd/init! <span class="string"><span class="delimiter">&quot;</span><span class="content">test-root</span><span class="delimiter">&quot;</span></span>)))

(<span class="keyword">defn</span> <span class="function">stop</span> [done]
  <span class="comment">; tests can be async. You must call done so that the runner knows you actually finished</span>
  (done))

(<span class="keyword">defn</span> ^<span class="symbol">:export</span> init []
  (dom/append [<span class="symbol">:div#test-root</span>])
  (start))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then in the build config add <code>:runner-ns tests.client-test-main</code>.</p>
</div>
<div class="paragraph">
<p>It just has <code>init</code>, <code>start</code>, <code>stop</code> methods. <code>init</code> will be called once on startup, <code>stop</code> will be called before any code is reloaded and <code>start</code> will be called after all code was reloaded.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<code>:runner-ns</code> is optional, just leave it out to use the default.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_generated_output_in_test_dir"><a class="anchor" href="#_generated_output_in_test_dir"></a><a class="link" href="#_generated_output_in_test_dir">12.2.1. Generated output in <code>:test-dir</code></a></h4>
<div class="paragraph">
<p>The output includes two primary artifacts in your <code>test-dir</code> folder:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>index.html</code> - If and only if there was not already an <code>index.html</code> file present. By default the generated
file loads the tests and runs <code>init</code> in the <code>:runner-ns</code>. You may edit or add a custom version that will
not be overwritten.</p>
</li>
<li>
<p><code>js/test.js</code> - The Javascript tests. The tests will always have this name. The entries for the module are
auto-generated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any webserver is fine, <a href="#dev-http">:dev-http</a> is just a convenient option.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="target-karma"><a class="anchor" href="#target-karma"></a><a class="link" href="#target-karma">12.3. Targeting Tests to Karma for Continuous Integration</a></h3>
<div class="paragraph">
<p>When you want to run your CLJS tests against a browser on some kind of CI server you&#8217;ll need to
be able to run the tests from a command line and get back a status code. Karma is a well-known
and supported test runner that can do this for you, and <code>shadow-cljs</code> includes a target that
can add the appropriate wrappers around your tests so they will work in it.</p>
</div>
<div class="sect3">
<h4 id="_installing_karma"><a class="anchor" href="#_installing_karma"></a><a class="link" href="#_installing_karma">12.3.1. Installing Karma</a></h4>
<div class="paragraph">
<p>See their <a href="http://karma-runner.github.io">website</a> for full instructions. You&#8217;ll typically need
something like this in your <code>package.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">CITests</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Testing</span><span class="delimiter">&quot;</span></span>,
  <span class="error">.</span><span class="error">.</span><span class="error">.</span>
  <span class="key"><span class="delimiter">&quot;</span><span class="content">devDependencies</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">karma</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^2.0.0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">karma-chrome-launcher</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^2.2.0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">karma-cljs-test</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^0.1.0</span><span class="delimiter">&quot;</span></span>,
    <span class="error">.</span><span class="error">.</span><span class="error">.</span>
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">license</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">MIT</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, you need Karma, a browser launcher, and the cljs-test integration.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_build"><a class="anchor" href="#_the_build"></a><a class="link" href="#_the_build">12.3.2. The Build</a></h4>
<div class="paragraph">
<p>The build options are:</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code>:target</code>
</td>
<td class="hdlist2">
<p><code>:karma</code></p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:output-to</code>
</td>
<td class="hdlist2">
<p>A path/filename for the js file.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code>:ns-regexp</code>
</td>
<td class="hdlist2">
<p>(optional) A regex to match the test namespaces, defaults to "-test$</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So you might have something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:ci</span>
  {<span class="symbol">:target</span> <span class="symbol">:karma</span>
   <span class="symbol">:output-to</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">target/ci.js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:ns-regexp</span>  <span class="string"><span class="delimiter">&quot;</span><span class="content">-spec$</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You also need a <code>karma.conf.js</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">module.<span class="function">exports</span> = <span class="keyword">function</span> (config) {
    config.set({
        <span class="key">browsers</span>: [<span class="string"><span class="delimiter">'</span><span class="content">ChromeHeadless</span><span class="delimiter">'</span></span>],
        <span class="comment">// The directory where the output file lives</span>
        <span class="key">basePath</span>: <span class="string"><span class="delimiter">'</span><span class="content">target</span><span class="delimiter">'</span></span>,
        <span class="comment">// The file itself</span>
        <span class="key">files</span>: [<span class="string"><span class="delimiter">'</span><span class="content">ci.js</span><span class="delimiter">'</span></span>],
        <span class="key">frameworks</span>: [<span class="string"><span class="delimiter">'</span><span class="content">cljs-test</span><span class="delimiter">'</span></span>],
        <span class="key">plugins</span>: [<span class="string"><span class="delimiter">'</span><span class="content">karma-cljs-test</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">karma-chrome-launcher</span><span class="delimiter">'</span></span>],
        <span class="key">colors</span>: <span class="predefined-constant">true</span>,
        <span class="key">logLevel</span>: config.LOG_INFO,
        <span class="key">client</span>: {
            <span class="key">args</span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">shadow.test.karma.init</span><span class="delimiter">&quot;</span></span>],
            <span class="key">singleRun</span>: <span class="predefined-constant">true</span>
        }
    })
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>then you can run the tests as follows (assuming you&#8217;ve installed global executables of the tools):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ shadow-cljs compile ci
$ karma start --single-run
12 01 2018 01:19:24.222:INFO [karma]: Karma v2.0.0 server started at http://0.0.0.0:9876/
12 01 2018 01:19:24.224:INFO [launcher]: Launching browser ChromeHeadless with unlimited concurrency
12 01 2018 01:19:24.231:INFO [launcher]: Starting browser ChromeHeadless
12 01 2018 01:19:24.478:INFO [HeadlessChrome 0.0.0 (Mac OS X 10.12.6)]: Connected on socket TcfrjxVKmx7xN6enAAAA with id 85554456
LOG: 'Testing boo.sample-spec'
HeadlessChrome 0.0.0 (Mac OS X 10.12.6): Executed 1 of 1 SUCCESS (0.007 secs / 0.002 secs)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="js-deps"><a class="anchor" href="#js-deps"></a><a class="link" href="#js-deps">13. JavaScript Integration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="npm"><a class="anchor" href="#npm"></a><a class="link" href="#npm">13.1. NPM</a></h3>
<div class="paragraph">
<p><a href="https://www.npmjs.com/">npm</a> has become the de-facto standard package manager for JavaScript. Almost all JS libraries can be found there and shadow-cljs provides seamless integration for accessing those packages.</p>
</div>
<div class="sect3">
<h4 id="_using_npm_packages"><a class="anchor" href="#_using_npm_packages"></a><a class="link" href="#_using_npm_packages">13.1.1. Using npm packages</a></h4>
<div class="paragraph">
<p>Most npm packages will also include some instructions on how to use the actual code. The “old” CommonJS style just has <code>require</code> calls which translate directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="keyword">var</span> react = require(<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whatever "string" parameter is used when calling require we transfer to the <code>:require</code> as-is. The <code>:as</code> alias is up to you. Once we have that we can use the code like any other CLJS namespace!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(react/createElement <span class="string"><span class="delimiter">&quot;</span><span class="content">div</span><span class="delimiter">&quot;</span></span> <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>shadow-cljs</code>: <strong>always use the <code>ns</code> form and whatever <code>:as</code> alias you provided.</strong> You may also use <code>:refer</code> and <code>:rename</code>. This is different than what <code>:foreign-libs</code>/CLJSJS does where you include the thing in the namespace but then used a global <code>js/Thing</code> in your code.</p>
</div>
<div class="paragraph">
<p>Some packages just export a single function which you can call directly by
using <code>(:require ["thing" :as thing])</code> and then <code>(thing)</code>.</p>
</div>
<div class="paragraph">
<p>More recently some packages started using ES6 <code>import</code> statements in their examples. Those also translate pretty much 1:1 with one slight difference related to default exports.</p>
</div>
<div class="paragraph">
<p>The following examples can be used for translation:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
This table only applies if the code you are consuming is packaged as actual ES6+ code. If the code is packaged as CommonJS instead the <code>$default</code> may not apply. See the section below for more info.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The names <code>defaultExport</code> or <code>export</code> here are chosen to show what they represent. In case of <code>defaultExport</code>, or any other <code>:as</code> alias, you can substitute it with any name you like. In case of <code>:refer</code> you must use the name chosen by the library or use <code>:rename</code> to change it. The important new thing is the introduction of Default Exports and what they mean in terms of requiring them.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example Default Export</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="reserved">import</span> defaultExport from <span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name$default</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> defaultExport])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Module Alias</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="reserved">import</span> * as name from <span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> <span class="keyword">name</span>])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Module Refer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="reserved">import</span> { <span class="reserved">export</span> } from <span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span> <span class="symbol">:refer</span> (export)])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Module Multiple Refer</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="reserved">import</span> { export1 , export2 } from <span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span> <span class="symbol">:refer</span> (export1 export2)])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Module Refer Rename</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="reserved">import</span> { <span class="reserved">export</span> as alias } from <span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span> <span class="symbol">:rename</span> {export <span class="keyword">alias</span>}])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Module Refer and Rename</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="reserved">import</span> { export1 , export2 as alias2  } from <span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span> <span class="symbol">:refer</span> (export1) <span class="symbol">:rename</span> {export2 alias2}])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Module Refer and Default Export</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="reserved">import</span> defaultExport, { <span class="reserved">export</span> } from <span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:require</span>
  [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span> <span class="symbol">:refer</span> (export)]
  [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name$default</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> defaultExport])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Module Alias and Default Export</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="reserved">import</span> defaultExport, * as name from <span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:require</span>
  [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> <span class="keyword">name</span>]
  [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name$default</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> defaultExport])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Module Import without use (including a Module for side-effects only)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="reserved">import</span> from <span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">module-name</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that previously we were stuck using bundled code which included a lot of code we didn’t actually need. Now we&#8217;re in a better situation:
Some libraries are also packaged in ways that allow you to include only the parts you need, leading to much less code in your final build.</p>
</div>
<div class="paragraph">
<p><code>react-virtualized</code> is a great example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="comment">// You can import any component you want as a named export from 'react-virtualized', eg</span>
<span class="reserved">import</span> { Column, Table } from <span class="string"><span class="delimiter">'</span><span class="content">react-virtualized</span><span class="delimiter">'</span></span>

<span class="comment">// But if you only use a few react-virtualized components,</span>
<span class="comment">// And you're concerned about increasing your application's bundle size,</span>
<span class="comment">// You can directly import only the components you need, like so:</span>
<span class="reserved">import</span> AutoSizer from <span class="string"><span class="delimiter">'</span><span class="content">react-virtualized/dist/commonjs/AutoSizer</span><span class="delimiter">'</span></span>
<span class="reserved">import</span> List from <span class="string"><span class="delimiter">'</span><span class="content">react-virtualized/dist/commonjs/List</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With our improved support we we can easily translate this to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my-ns</span>
  <span class="comment">;; all</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-virtualized</span><span class="delimiter">&quot;</span></span> <span class="symbol">:refer</span> (Column Table)])
  <span class="comment">;; OR one by one</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-virtualized/dist/commonjs/AutoSizer$default</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> virtual-auto-sizer]
            [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-virtualized/dist/commonjs/List$default</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> virtual-list]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a <code>:require</code> does not seem to work properly it is recommended to try looking at it in the REPL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs browser-repl (<span class="keyword">or</span> node-repl)
<span class="keyword">..</span><span class="keyword">.</span>
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; (<span class="keyword">require</span> '[<span class="string"><span class="delimiter">&quot;</span><span class="content">react-tooltip</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> x])
<span class="predefined-constant">nil</span>
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; x
<span class="error">#</span>object[e]
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; (goog/typeOf x)
<span class="string"><span class="delimiter">&quot;</span><span class="content">function</span><span class="delimiter">&quot;</span></span>
[<span class="integer">1</span><span class="error">:</span><span class="integer">1</span>]~cljs.user=&gt; (js/console.dir x)
<span class="predefined-constant">nil</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Since printing arbitrary JS objects is not always useful (as seen above) you can use <code>(js/console.dir x)</code> instead to get a more useful representation in the browser console. <code>goog/typeOf</code> may also be useful at times.</p>
</div>
</div>
<div class="sect3">
<h4 id="js-provider"><a class="anchor" href="#js-provider"></a><a class="link" href="#js-provider">13.1.2. Package Provider</a></h4>
<div class="paragraph">
<p><code>shadow-cljs</code> supports several different ways to include <code>npm</code> packages into your build. They are configurable via the <code>:js-options :js-provider</code> setting. Each <code>:target</code> usually sets the one appropriate for your build most often you won&#8217;t need to touch this setting.</p>
</div>
<div class="paragraph">
<p>Currently there are 3 supported JS Providers:</p>
</div>
<div class="dlist Horizontal">
<dl>
<dt><code>:require</code></dt>
<dd>
<p>Maps directly to the JS <code>require("thing")</code> function call. It is the default for all <code>node.js</code> targets since it can resolve <code>require</code> natively at runtime. The included JS is not processed in any way.</p>
</dd>
<dt><code>:shadow</code></dt>
<dd>
<p>Resolves the JS via <code>node_modules</code> and includes a minified version of each referenced file in the build. It is the default for the <code>:browser</code> target. <code>node_modules</code> sources do not go through <code>:advanced</code> compilation.</p>
</dd>
<dt><code>:closure</code></dt>
<dd>
<p>Resolves similarly to <code>:shadow</code> but attempts to process all included files via the Closure Compiler CommonJS/ES6 rewrite facilities. They will also be processed via <code>:advanced</code> compilation.</p>
</dd>
<dt><code>:external</code></dt>
<dd>
<p>Only collects JS requires and emits an index file (configured via <code>:external-index "foo/bar.js"</code>) that is meant to be processed by any other JS build tool and will actually provide the JS dependencies. The emitted index file contains a bit of glue code so that the CLJS output can access the JS dependencies. The output of the external index file should be loaded before the CLJS output.</p>
</dd>
</dl>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title"><code>:shadow</code> vs <code>:closure</code></div>
<div class="paragraph">
<p>Ideally we want to use <code>:closure</code> as our primary JS Provider since that will run the entire application through <code>:advanced</code> giving us the most optimized output. In practice however lots of code available via <code>npm</code> is not compatible with the aggressive optimizations that <code>:advanced</code> compilation does. They either fail to compile at all or expose subtle bugs at runtime that are very hard to identify.</p>
</div>
<div class="paragraph">
<p><code>:shadow</code> is sort of a stopgap solution that only processes code via <code>:simple</code> and achieves much more reliable support while still getting reasonably optimized code. The output is comparable (or often better) to what other tools like <code>webpack</code> generate.</p>
</div>
<div class="paragraph">
<p>Until support in Closure gets more reliable <code>:shadow</code> is the recommend JS Provider for <code>:browser</code> builds.</p>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">Example config for using <code>:closure</code> in a <code>:browser</code> build.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span> {<span class="symbol">:js-provider</span> <span class="symbol">:closure</span>}
   }}}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="js-entry-keys"><a class="anchor" href="#js-entry-keys"></a><a class="link" href="#js-entry-keys">13.1.3. CommonJS vs ESM</a></h4>
<div class="paragraph">
<p>Nowadays many <code>npm</code> packages ship multiple build variants. <code>shadow-cljs</code> will by default pick the variant linked under the <code>main</code> or <code>browser</code> key in <code>package.json</code>. This most commonly refers to CommonJS code. Some modern packages also provide a <code>module</code> entry which usually refers to ECMAScript code (meaning "modern" JS). Interop between CommonJS and ESM can be tricky so <code>shadow-cljs</code> defaults to using CommonJS but it can be beneficial to use ESM.</p>
</div>
<div class="paragraph">
<p>It is largely dependent on the packages you use whether this will work or not. You can configure <code>shadow-cljs</code>  to prefer the <code>module</code> entry via the <code>:entry-keys</code> JS option. It takes a vector of string keys found in <code>package.json</code> which will be tried in order. The default is <code>"["browser" "main" "module"]</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example config for using <code>:closure</code> in a <code>:browser</code> build.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span> {<span class="symbol">:entry-keys</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">module</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">browser</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">main</span><span class="delimiter">&quot;</span></span>]} <span class="comment">;; try &quot;module&quot; first</span>
   }}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure to test thoroughly and compare the <a href="#build-report">build report</a> output to check size differences when switching this. Results may vary greatly in positive or negative ways.</p>
</div>
</div>
<div class="sect3">
<h4 id="js-resolve"><a class="anchor" href="#js-resolve"></a><a class="link" href="#js-resolve">13.1.4. Resolving Packages</a></h4>
<div class="paragraph">
<p>By default <code>shadow-cljs</code> will resolve all <code>(:require ["thing" :as x])</code> requires following the <code>npm</code> convention. This means it will look at <code>&lt;project&gt;/node_modules/thing/package.json</code> and follow the code from there. To customize how this works <code>shadow-cljs</code> exposes a <code>:resolve</code> config option that lets you override how things are resolved.</p>
</div>
<div class="sect4">
<h5 id="js-resolve-global"><a class="anchor" href="#js-resolve-global"></a><a class="link" href="#js-resolve-global">Using a CDN</a></h5>
<div class="paragraph">
<p>Say you already have React included in your page via a CDN. You could just start using <code>js/React</code> again but we stopped doing that for a good reason. Instead you can continue to use <code>(:require ["react" :as react])</code> but configure how "react" resolves!</p>
</div>
<div class="paragraph">
<p>Here is a sample <code>shadow-cljs.edn</code> config for such a build:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span>
   {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:global</span>
                       <span class="symbol">:global</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">React</span><span class="delimiter">&quot;</span></span>}}}}

  <span class="symbol">:server</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="keyword">..</span><span class="keyword">.</span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>:app</code> build will now use the global <code>React</code> instance while the <code>:server</code> build continues using the "react" npm package! No need to fiddle with the code to make this work.</p>
</div>
</div>
<div class="sect4">
<h5 id="js-resolve-npm"><a class="anchor" href="#js-resolve-npm"></a><a class="link" href="#js-resolve-npm">Redirecting “require”</a></h5>
<div class="paragraph">
<p>Sometimes you want more control over which <code>npm</code> package is actually used depending on your build. You can "redirect" certain requires from your build config without changing the code. This is often useful if you either don&#8217;t have access to the sources using such packages or you just want to change it for one build.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span>
   {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:npm</span>
                       <span class="symbol">:require</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">preact-compat</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use a file to override the dependency, the path is relative to the project root.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span>
   {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:file</span>
                       <span class="symbol">:file</span>   <span class="string"><span class="delimiter">&quot;</span><span class="content">src/main/override-react.js</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="js-resolve-limitations"><a class="anchor" href="#js-resolve-limitations"></a><a class="link" href="#js-resolve-limitations">Limitations</a></h5>
<div class="paragraph">
<p>The <code>:shadow-js</code> and <code>:closure</code> have full control over <code>:resolve</code> and everything mentioned above works without any downsides. The <code>:js-provider :require</code> however is more limited. Only the initial require can be influenced since the standard <code>require</code> is in control after that. This means it is not possible to influence what a package might <code>require</code> internally. It is therefore not recommended to be used with targets that use <code>require</code> directly (eg. <code>:node-script</code>).</p>
</div>
<div class="listingblock">
<div class="title">Redirecting "react" to "preact"</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:node-script</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span>
   {<span class="symbol">:resolve</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:target</span> <span class="symbol">:npm</span>
                       <span class="symbol">:require</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">preact-compat</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example use of react-table</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">react-table</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> rt]))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above works fine in the Browser since every <code>"react"</code> require will be replaced, including the <code>"react"</code> require <code>"react-table"</code> has internally. For <code>:js-provider :require</code> however a <code>require("react-table")</code> will be emitted and <code>node</code> will be in control how that is resolved. Meaning that it will resolve it to the standard <code>"react"</code> and not the <code>"preact"</code> we had configured.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="alt-node-modules"><a class="anchor" href="#alt-node-modules"></a><a class="link" href="#alt-node-modules">13.1.5. Alternate Modules Directories</a></h4>
<div class="paragraph">
<p>By default <code>shadow-cljs</code> will only look at the <code>&lt;project-dir&gt;/node_modules</code> directory when resolving JS packages. This can be configured via the <code>:js-package-dirs</code> option in <code>:js-options</code>. This can be applied globally or per build.</p>
</div>
<div class="paragraph">
<p>Relative paths will be resolved relative to the project root directory. Paths will be tried from left to right and the first matching package will be used.</p>
</div>
<div class="listingblock">
<div class="title">Global config in <code>shadow-cljs.edn</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:js-options</span> {<span class="symbol">:js-package-dirs</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">node_modules</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">../node_modules</span><span class="delimiter">&quot;</span></span>]}
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Config applied to single build</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:js-options</span> {<span class="symbol">:js-package-dirs</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">node_modules</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">../node_modules</span><span class="delimiter">&quot;</span></span>]}}}}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="classpath-js"><a class="anchor" href="#classpath-js"></a><a class="link" href="#classpath-js">13.2. Dealing with .js Files</a></h3>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>DANGER: This feature is an experiment!</strong> It is currently only supported in <code>shadow-cljs</code> and other CLJS tools will yell at you if you attempt to use it. Use at your own risk. The feature was initially rejected from CLJS core but I think it is useful and should not have been <a href="https://dev.clojure.org/jira/browse/CLJS-2061?focusedCommentId=46191&amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-46191">dismissed</a> without further discussion.</p>
</div>
<div class="paragraph">
<p>CLJS has an alternate <a href="https://clojurescript.org/guides/javascript-modules">implementation</a> which in turn is not supported by <code>shadow-cljs</code>. I found this implementation to be lacking in certain aspects so I opted for the different solution. Happy to discuss the pros/cons of both approaches though.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We covered how <a href="#npm">npm</a> packages are used but you may be working on a codebase that already has lots of plain JavaScript and you don&#8217;t want to rewrite everything in ClojureScript just yet. <code>shadow-cljs</code> provides 100% full interop between JavaScript and ClojureScript. Which means your JS can use your CLJS and CLJS can use your JS.</p>
</div>
<div class="paragraph">
<p>There are only a few conventions you need to follow in order for this to work reliably but chances are that you are already doing that anyways.</p>
</div>
<div class="sect3">
<h4 id="_requiring_js"><a class="anchor" href="#_requiring_js"></a><a class="link" href="#_requiring_js">13.2.1. Requiring JS</a></h4>
<div class="paragraph">
<p>We already covered how <code>npm</code> packages are accessed by their name but on the classpath we access <code>.js</code> files by either a full path or relative to the current namespace.</p>
</div>
<div class="listingblock">
<div class="title">Loading JS from the classpath</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">demo.app</span>
  (<span class="symbol">:require</span>
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">/some-library/components/foo</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> foo]
    [<span class="string"><span class="delimiter">&quot;</span><span class="content">./bar</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> bar <span class="symbol">:refer</span> (myComponent)]))</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
For string requires the extension <code>.js</code> will be added automatically but you can specify the extension if you prefer. Note that currently only <code>.js</code> is supported though.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Absolute requires like <code>/some-library/components/foo</code> mean that the compiler will look for a <code>some-library/components/foo.js</code> on the classpath; unlike <code>node</code> which would attempt to load the file from the local filesystem. The same classpath rules apply so the file may either be in your <code>:source-paths</code> or in some third-party <code>.jar</code> library you are using.</p>
</div>
<div class="paragraph">
<p>Relative requires are resolved by first looking at the current namespace and then resolving a relative path from that name. In the above example we are in <code>demo/app.cljs</code> to the <code>./bar</code> require resolves to <code>demo/bar.js</code>, so it is identical to <code>(:require ["/demo/bar"])</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The files must not be physically located in the same directory. The lookup for the file appears on the classpath instead. This is unlike node which expects relative requires to always resolve to physical files.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Example File Structure with Separate Paths</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── main
        └── demo
            └── app.cljs
    └── js
        └── demo
            └── bar.js</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_language_support"><a class="anchor" href="#_language_support"></a><a class="link" href="#_language_support">13.2.2. Language Support</a></h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
It is expected that the classpath only contains JavaScript that can be consumed without any pre-processing by the Compiler. <code>npm</code> has a very similar convention.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Closure Compiler is used for processing all JavaScript found on the classpath using its <code>ECMASCRIPT_NEXT</code> language setting. What exactly this setting means is not well documented but it mostly represents the next generation JavaScript code which might not even be supported by most browsers yet. ES6 is very well supported as well as most ES8 features. Similarly to standard CLJS this will be compiled down to ES5 with polyfills when required.</p>
</div>
<div class="paragraph">
<p>Since the Closure Compiler is getting constant updates newer features will be available over time. Just don&#8217;t expect to use the latest cutting edge preview features to be available immediately. Somewhat recent additions like <code>async/await</code> already work quite well.</p>
</div>
<div class="paragraph">
<p>The JS should be written using ES Module Syntax using <code>import</code> and <code>export</code>. JS files can include other JS files and reference CLJS code directly. They may also access <code>npm</code> packages directly with one caveat.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="comment">// regular JS require</span>
<span class="reserved">import</span> Foo, { something } from <span class="string"><span class="delimiter">&quot;</span><span class="content">./other.js</span><span class="delimiter">&quot;</span></span>;

<span class="comment">// npm require</span>
<span class="reserved">import</span> React from <span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span>;

<span class="comment">// require CLJS or Closure Library JS</span>
<span class="reserved">import</span> cljs from <span class="string"><span class="delimiter">&quot;</span><span class="content">goog:cljs.core</span><span class="delimiter">&quot;</span></span>;

<span class="reserved">export</span> <span class="keyword">function</span> <span class="function">inc</span>(num) {
  <span class="keyword">return</span> cljs.inc(<span class="integer">1</span>);
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Due to strict checking of the Closure Compiler it is not possible to use the <code>import * as X from "npm";</code> syntax when requiring CLJS or npm code. It is fine to use when requiring other JS files.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_javascript_dialects"><a class="anchor" href="#_javascript_dialects"></a><a class="link" href="#_javascript_dialects">13.2.3. JavaScript Dialects</a></h4>
<div class="paragraph">
<p>Since there are many popular JavaScript dialects (JSX, CoffeeScript, etc) that are not directly parsable by the Closure Compiler we need to pre-process them before putting them onto the classpath. <a href="https://babeljs.io/">babel</a> is commonly used in the JavaScript world so we are going to use <code>babel</code> to process <code>.jsx</code> files as an example here.</p>
</div>
<div class="listingblock">
<div class="title">Example shadow-cljs.edn Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">src/gen</span><span class="delimiter">&quot;</span></span>]
 <span class="keyword">..</span><span class="keyword">.</span>}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example File Structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.
├── package.json
├── shadow-cljs.edn
└── src
    └── main
        └── demo
            └── app.cljs
    └── js
        ├── .babelrc
        └── demo
            └── bar.jsx</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Notice how <code>src/js</code> is not added to <code>:source-paths</code> which means it will not be on the classpath.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">src/js/demo/bar.jsx</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="jsx">import React from &quot;react&quot;;

function myComponent() {
  return &lt;h1&gt;JSX!&lt;/h1&gt;;
}

export { myComponent };</code></pre>
</div>
</div>
<div class="paragraph">
<p>We run <a href="https://babeljs.io/docs/usage/cli/">babel</a> to convert the files and write them to the configured <code>src/gen</code> directory. Which directory you use is up to you. I prefer <code>src/gen</code> for generated files.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ babel src/js --out-dir src/gen
# or during development
$ babel src/js --out-dir src/gen --watch</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>babel</code> itself is configured via the <code>src/js/.babelrc</code>. See the official <a href="https://babeljs.io/docs/plugins/transform-react-jsx/">example for JSX</a> and more about <a href="https://babeljs.io/docs/config-files">configuration files</a>.</p>
</div>
<div class="listingblock">
<div class="title">JSX minimal .babelrc</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">plugins</span><span class="delimiter">&quot;</span></span>: [<span class="string"><span class="delimiter">&quot;</span><span class="content">@babel/plugin-transform-react-jsx</span><span class="delimiter">&quot;</span></span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once <code>babel</code> writes the <code>src/gen/demo/bar.js</code> it will be available to use via ClojureScript and will even be hot loaded just like your ClojureScript sources.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>shadow-cljs</code> currently does not provide any support for running those transformation steps. Please use the standard tools (eg. <code>babel</code>, <code>coffeescript</code>, etc.) directly until it does.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_access_cljs_from_js"><a class="anchor" href="#_access_cljs_from_js"></a><a class="link" href="#_access_cljs_from_js">13.2.4. Access CLJS from JS</a></h4>
<div class="paragraph">
<p>The JS sources can access all your ClojureScript (and the Closure Library) directly by importing their namespaces with a <code>goog:</code> prefix which the Compiler will rewrite to expose the namespace as the default ES6 export.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="keyword">import</span> cljs, { <span class="keyword">keyword</span> } from <span class="string"><span class="delimiter">&quot;</span><span class="content">goog:cljs.core</span><span class="delimiter">&quot;</span></span><span class="comment">;</span>

// construct {<span class="symbol">:foo</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>} in JS
cljs.array_map(<span class="keyword">keyword</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)<span class="comment">;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The <code>goog:</code> prefix currently only works for ES6 file. <code>require("goog:cljs.core")</code> does not work.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cljsjs"><a class="anchor" href="#cljsjs"></a><a class="link" href="#cljsjs">13.3. Migrating cljsjs.*</a></h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>CLJSJS is an effort to package Javascript libraries to be able to use them from within ClojureScript.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Since <code>shadow-cljs</code> can access <a href="#npm">npm packages</a> directly we do not need to rely on re-packaged <a href="https://github.com/cljsjs/packages">CLJSJS</a> packages.</p>
</div>
<div class="paragraph">
<p>However many CLJS libraries are still using CLJSJS packages and they would break with <code>shadow-cljs</code> since it doesn&#8217;t support those anymore. It is however very easy to mimick those <code>cljsjs</code> namespaces since they are mostly build from <code>npm</code> packages anyways. It just requires one shim file that maps the <code>cljsjs.thing</code> back to its original <code>npm</code> package and exposes the expected global variable.</p>
</div>
<div class="paragraph">
<p>For React this requires a file like <code>src/cljsjs/react.cljs</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">cljsjs.react</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react]
            [<span class="string"><span class="delimiter">&quot;</span><span class="content">create-react-class</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> crc]))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(js/goog.object.set react <span class="string"><span class="delimiter">&quot;</span><span class="content">createClass</span><span class="delimiter">&quot;</span></span> crc)
(js/goog.exportSymbol <span class="string"><span class="delimiter">&quot;</span><span class="content">React</span><span class="delimiter">&quot;</span></span> react)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since this would be tedious for everyone to do manually I created the <a href="https://github.com/thheller/shadow-cljsjs"><code>shadow-cljsjs</code></a>
library which provides just that. It does not include every package but I’ll keep adding
them and contributions are very welcome as well.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>shadow-cljsjs</code> library only provides the shim files. You’ll still need to
<code>npm install</code> the actual packages yourself.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_why_not_use_cljsjs"><a class="anchor" href="#_why_not_use_cljsjs"></a><a class="link" href="#_why_not_use_cljsjs">13.3.1. Why not use CLJSJS?</a></h4>
<div class="paragraph">
<p>CLJSJS packages basically just take the package from <code>npm</code> and put them into a <code>.jar</code> and re-publish them via <a href="https://clojars.org">clojars</a>. As a bonus they often bundle Externs. The compiler otherwise does nothing with these files and only prepends them to the generated output.</p>
</div>
<div class="paragraph">
<p>This was very useful when we had no access to <code>npm</code> directly but has certain issues since not all packages are easily combined with others. A package might rely on <code>react</code> but instead of expressing this via <code>npm</code> <a href="https://github.com/cljsjs/packages/tree/master/material-ui">they</a> bundle their own <code>react</code>. If you are not careful you could end up including 2 different <code>react</code> versions in your build which may lead to very confusing errors or at the very least increase the build size substantially.</p>
</div>
<div class="paragraph">
<p>Apart from that not every <code>npm</code> package is available via CLJSJS and keeping the package versions in sync requires manual work, which means packages are often out of date.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> does not support CLJSJS at all to avoid conflicts in your code. One library might attempt to use the "old" <code>cljsjs.react</code> while another uses the newer <code>(:require ["react"])</code> directly. This would again lead to 2 versions of <code>react</code> on your page again.</p>
</div>
<div class="paragraph">
<p>So the only thing we are missing are the bundled Externs. In many instances these are not required due to improved <a href="#infer-externs">externs inference</a>. Often those Externs are generated using third-party tools which means they are not totally accurate anyways.</p>
</div>
<div class="paragraph">
<p>Conclusion: Use <a href="#npm">npm</a> directly. Use <a href="#infer-externs">:infer-externs auto</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="release"><a class="anchor" href="#release"></a><a class="link" href="#release">14. Generating Production Code&#8201;&#8212;&#8201;All Targets</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Development mode always outputs individual files for each namespace so that they can be hot loaded
in isolation. When you&#8217;re ready to deploy code to a real server you want to run the Closure Compiler
on it to generate a single minified result for each <a href="#_modules">module</a>.</p>
</div>
<div class="paragraph">
<p>By default the release mode output file should just be a drop-in replacements for the
development mode file: there is no difference in the way you include them in your HTML. You
may use <a href="#NameHashing">filename hashing</a> to improve caching characteristics on browser targets.</p>
</div>
<div class="listingblock">
<div class="title">Generating Minified Output</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs release build-id</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_release_configuration"><a class="anchor" href="#_release_configuration"></a><a class="link" href="#_release_configuration">14.1. Release Configuration</a></h3>
<div class="paragraph">
<p>Usually you won&#8217;t need to add any extra configuration to create a release version for your build. The default config already captures everything necessary and should only require extra configuration if you want to override the defaults.</p>
</div>
<div class="paragraph">
<p>Each <code>:target</code> already provides good defaults optimized for each platform so you&#8217;ll have less to worry about.</p>
</div>
<div class="sect3">
<h4 id="Optimization"><a class="anchor" href="#Optimization"></a><a class="link" href="#Optimization">14.1.1. Optimizations</a></h4>
<div class="paragraph">
<p>You can choose the optimization level using the <code>:compiler-options</code> section of the configuration:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You do not usually need to set <code>:optimizations</code> since the <code>:target</code> already sets it to an appropriate level.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<code>:optimizations</code> only apply when using the <code>release</code> command. Development builds are never optimized by the Closure Compiler. Development builds are always set to <code>:none</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:build</span>
   {<span class="symbol">:build-id</span>
     {<span class="keyword">..</span><span class="keyword">.</span>
      <span class="symbol">:compiler-options</span> {<span class="symbol">:optimizations</span> <span class="symbol">:simple</span>}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://developers.google.com/closure/compiler/docs/compilation_levels">the Closure compiler&#8217;s documentation</a>
for more information on available optimization levels.</p>
</div>
</div>
<div class="sect3">
<h4 id="_release_specific_vs_development_configuration"><a class="anchor" href="#_release_specific_vs_development_configuration"></a><a class="link" href="#_release_specific_vs_development_configuration">14.1.2. Release-Specific vs. Development Configuration</a></h4>
<div class="paragraph">
<p>If you wish to have separate configuration values in a build when running a release build then you
can override settings by including a <code>:dev</code> and/or <code>:release</code> section in the build section:</p>
</div>
<div class="listingblock">
<div class="title">Example <code>shadow-cljs.edn</code> build config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:source-paths</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>]
 <span class="symbol">:dependencies</span> []
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:asset-path</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span> {<span class="symbol">:base</span> {<span class="symbol">:entries</span> [my.app.core]}}

   <span class="comment">;; Here is some dev-specific config</span>
   <span class="symbol">:dev</span> {<span class="symbol">:compiler-options</span> {<span class="symbol">:devcards</span> <span class="predefined-constant">true</span>}}

   <span class="comment">;; Here is some production config</span>
   <span class="symbol">:release</span> {<span class="symbol">:compiler-options</span> {<span class="symbol">:optimizations</span> <span class="symbol">:simple</span>}}}}}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="externs"><a class="anchor" href="#externs"></a><a class="link" href="#externs">14.2. Externs</a></h3>
<div class="paragraph">
<p>Since we want builds to be fully optimized by the Closure Compiler <code>:advanced</code> compilation we need to deal with <a href="https://developers.google.com/closure/compiler/docs/api-tutorial3">Externs</a>. Externs represent pieces of code that are not included when doing <code>:advanced</code> compilation. <code>:advanced</code> works by doing whole program optimizations but some code we just won&#8217;t be able to include so Externs inform the Compiler about this code. Without Externs the Compiler may rename or remove some code that it shouldn&#8217;t.</p>
</div>
<div class="paragraph">
<p>Typically all JS Dependencies are foreign and won&#8217;t be passed through <code>:advanced</code> and thus require Externs.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Externs are only required for <code>:advanced</code>, they are not required in <code>:simple</code> mode.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="infer-externs"><a class="anchor" href="#infer-externs"></a><a class="link" href="#infer-externs">14.2.1. Externs Inference</a></h4>
<div class="paragraph">
<p>To help deal with Externs the <code>shadow-cljs</code> compiler provides enhanced externs inference, which is enabled by default. The compiler will perform additional checks at compile time for your files only. It won&#8217;t warn you about possible externs issues in library code.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll get warnings whenever the Compiler cannot figure out whether you are working with JS or CLJS code. If you don&#8217;t get any warnings you should be OK.</p>
</div>
<div class="listingblock">
<div class="title">Example Code</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [x]
  (<span class="keyword">.</span>baz x))</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Warning</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">------ WARNING #1 --------------------------------------------------------------
 File: ~/project/src/demo/thing.cljs:23:3
--------------------------------------------------------------------------------
  21 |
  22 | (defn wrap-baz [x]
  23 |   (.baz x))
---------^----------------------------------------------------------------------
 Cannot infer target type in expression (. x baz)
--------------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>:advanced</code> the compiler might be renaming <code>.baz</code> to something "shorter" and Externs inform the Compiler that this is an external property that should not be renamed.</p>
</div>
<div class="paragraph">
<p>The warning tells you that the compiler did not recognize the property <code>baz</code> in the <code>x</code> binding. <code>shadow-cljs</code> can generate the appropriate externs if you add a typehint to the object you are performing native interop on.</p>
</div>
<div class="listingblock">
<div class="title">Type-hint to help externs generation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [x]
  (<span class="keyword">.</span>baz ^js x))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>^js</code> typehint will cause the compiler to generate proper externs and the warning will go away. The property is now safe from renaming. You may either directly tag the interop form, or you may tag the variable name where it is first bound.</p>
</div>
<div class="listingblock">
<div class="title">Multiple interop calls</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [x]
  (<span class="keyword">.</span>foo ^js x)
  (<span class="keyword">.</span>baz ^js x))</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can get tedious to annotate every single interop call, so you can annotate the variable binding itself. It will be used in the entire scope for this variable. Externs for both calls will still be generated. So, instead you do:</p>
</div>
<div class="listingblock">
<div class="title">Annotate <code>x</code> directly</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">defn</span> <span class="function">wrap-baz</span> [^js x]
  (<span class="keyword">.</span>foo x)
  (<span class="keyword">.</span>baz x))</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Don&#8217;t annotate everything with <code>^js</code>. Sometimes you may be doing interop on CLJS or ClosureJS objects. Those do not require externs. If you are certain you are working with a CLJS object use the <code>^clj</code> hint instead.
 It is not the end of the world to use <code>^js</code> incorrectly, but it may affect some optimizations when a variable is not renamed when it could be.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Calling a global using <code>js/</code> does not require a typehint.</p>
</div>
<div class="listingblock">
<div class="title">No hint required, externs inferred automatically</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(js/Some.Thing.coolFunction)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Calls on <code>:require</code> bindings are also inferred automatically.</p>
</div>
<div class="listingblock">
<div class="title">No hint required for <code>:as</code> and <code>:refer</code> bindings</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">my.app</span>
  (<span class="symbol">:require</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span> <span class="symbol">:as</span> react <span class="symbol">:refer</span> (createElement)]))

(react/createElement <span class="string"><span class="delimiter">&quot;</span><span class="content">div</span><span class="delimiter">&quot;</span></span> <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)
(createElement <span class="string"><span class="delimiter">&quot;</span><span class="content">div</span><span class="delimiter">&quot;</span></span> <span class="predefined-constant">nil</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">hello world</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_manual_externs"><a class="anchor" href="#_manual_externs"></a><a class="link" href="#_manual_externs">14.2.2. Manual Externs</a></h4>
<div class="paragraph">
<p>Some libraries provide Externs as separate <code>.js</code> files. You can include them into your build via the <code>:externs</code> compiler options.</p>
</div>
<div class="listingblock">
<div class="title">Manual Externs Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:compiler-options</span> {<span class="symbol">:externs</span> [<span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/externs.js</span><span class="delimiter">&quot;</span></span> <span class="keyword">..</span><span class="keyword">.</span>]}
   }}}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The compiler looks for files relative to the project root first. It will also attempt to load them from the classpath if no file is found.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_simplified_externs"><a class="anchor" href="#_simplified_externs"></a><a class="link" href="#_simplified_externs">14.2.3. Simplified Externs</a></h4>
<div class="paragraph">
<p>Writing Externs by hand can be challenging and <code>shadow-cljs</code> provides a way to write a more convenient way to write them. In combination with <code>shadow-cljs check &lt;your-build&gt;</code> you can quickly add the missing Externs.</p>
</div>
<div class="paragraph">
<p>Start by creating a <code>externs/&lt;your-build&gt;.txt</code>, so build <code>:app</code> would be <code>externs/app.txt</code>. In that file each line should be one word specifying a JS property that should not be renamed. Global variables should be prefixed by <code>global:</code></p>
</div>
<div class="listingblock">
<div class="title">Example externs/app.txt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="error">#</span> this is a <span class="keyword">comment</span>
foo
bar
global<span class="symbol">:SomeGlobalVariable</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the compiler will stop renaming <code>something.foo()</code>, <code>something.bar()</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="build-report"><a class="anchor" href="#build-report"></a><a class="link" href="#build-report">14.3. Build Report</a></h3>
<div class="paragraph">
<p><code>shadow-cljs</code> can generate a detailed report for your <code>release</code> builds which includes a detailed breakdown of the included sources and how much they each contributed to the overall size.</p>
</div>
<div class="paragraph">
<p>A sample report can be found <a href="https://code.thheller.com/demos/build-report/ui-report.html">here</a>.</p>
</div>
<div class="paragraph">
<p>The report can either be generated by running a separate command or by configuring a <a href="#build-hooks">build hook</a> for your build.</p>
</div>
<div class="listingblock">
<div class="title">Command Example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ npx shadow-cljs run shadow.cljs.build-report &lt;build-id&gt; &lt;path/to/output.html&gt;
# example
$ npx shadow-cljs run shadow.cljs.build-report app report.html</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will generate a <code>report.html</code> in the project directory for the <code>:app</code> build.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The generated HTML file is entirely self-contained and includes all the required data/js/css. No other external sources are required.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Build Hook Example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span> <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:build-hooks</span>
   [(shadow.cljs.build-report/hook)]
   }}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will generate a <code>report.html</code> in the configured <code>public/js</code> output directory for every <code>release</code> build automatically. This can be configured where this is written to by supplying an extra <code>:output-to</code> option. This path is then treated as relative to the project directory, not the <code>:output-dir</code>.</p>
</div>
<div class="listingblock">
<div class="title">Build Hook with :output-to</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="keyword">..</span><span class="keyword">.</span>
 <span class="symbol">:builds</span>
 {<span class="symbol">:app</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:output-dir</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public/js</span><span class="delimiter">&quot;</span></span>
   <span class="symbol">:modules</span> <span class="keyword">..</span><span class="keyword">.</span>
   <span class="symbol">:build-hooks</span>
   [(shadow.cljs.build-report/hook
      {<span class="symbol">:output-to</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">tmp/report.html</span><span class="delimiter">&quot;</span></span>})]
   }}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Only <code>release</code> builds will produce a report when using the hook, it does not affect <code>watch</code> or <code>compile</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
The build report is generated by parsing the source maps, so the hook will automatically force the generation of source maps. The files won&#8217;t be linked from the <code>.js</code> files directly, unless you actually enabled them via <code>:compiler-options {:source-map true}</code> yourself.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The dedicated build report command runs separately from watches you may have running. You do not need to stop any of them nor do you need to stop the shadow-cljs server before building the report.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_editor_integration"><a class="anchor" href="#_editor_integration"></a><a class="link" href="#_editor_integration">15. Editor Integration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_cursive"><a class="anchor" href="#_cursive"></a><a class="link" href="#_cursive">15.1. Cursive</a></h3>
<div class="paragraph">
<p>Cursive does not currently support resolving dependencies via <code>shadow-cljs.edn</code>. You can run <code>shadow-cljs pom</code> to generate a <code>pom.xml</code> and import that using the IntelliJ.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs pom</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then in Cursive <strong>File &#8594; New &#8594; Project from Existing Sources</strong> then select the generated <code>pom.xml</code> in the project directory.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You need to have the "Build Tools" &#8594; "Maven" Plugin enabled for this. It might not be enabled by default.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively you can create a dummy <code>project.clj</code> or use the full <a href="#Leiningen">Leiningen integration</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject your/project <span class="string"><span class="delimiter">&quot;</span><span class="content">0.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="symbol">:dependencies</span>
  [[thheller/shadow-cljs <span class="string"><span class="delimiter">&quot;</span><span class="content">X.Y.Z</span><span class="delimiter">&quot;</span></span>]]

  <span class="symbol">:source-paths</span>
  [<span class="string"><span class="delimiter">&quot;</span><span class="content">src</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can run <code>npx shadow-cljs server</code> inside the Terminal provided by IntelliJ and use <code>Clojure REPL &#8594; Remote</code> Run Configuration to connect to the provided <a href="#nREPL">nREPL server</a>. Just select the "Use port from nREPL file" option in Cursive Clojure REPL &#8594; Remote or configure a fixed nREPL port if you prefer.</p>
</div>
<div class="paragraph">
<p>Note that the Cursive REPL when first connected always starts out as a CLJ REPL. You can switch it to CLJS by calling <code>(shadow/repl :your-build-id)</code>. This will automatically switch the Cursive option as well. You can type <code>:cljs/quit</code> to drop back down to the CLJ REPL.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You cannot switch from CLJ&#8594;CLJS via the Cursive select box. Make sure you use the call above to switch.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cider"><a class="anchor" href="#cider"></a><a class="link" href="#cider">15.2. Emacs / CIDER</a></h3>
<div class="paragraph">
<p>This section is written for CIDER version 0.20.0 and above. Ensure your Emacs environment has this version of the <code>cider</code> package or later. Refer to the <a href="https://docs.cider.mx">CIDER documentation</a> for full installation details.</p>
</div>
<div class="sect3">
<h4 id="_launch_the_clojurescript_repl"><a class="anchor" href="#_launch_the_clojurescript_repl"></a><a class="link" href="#_launch_the_clojurescript_repl">15.2.1. Launch the ClojureScript REPL</a></h4>
<div class="paragraph">
<p>Launch the nREPL and a ClojureScript REPL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">M-x cider-jack-in-cljs</code></pre>
</div>
</div>
<div class="paragraph">
<p>CIDER will prompt you for the type of ClojureScript REPL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">Select ClojureScript REPL type:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter <code>shadow</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">Select shadow-cljs build:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enter the name of your build target, for example, <code>app</code>.</p>
</div>
<div class="paragraph">
<p>Emacs should now open a new nREPL connection to the <code>shadow-cljs</code> server of its sibling, bootstrapping into a ClojureScript REPL environment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">shadow.user&gt; To quit, type: :cljs/quit
[:selected :app]
cljs.repl&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now be able to eval ClojureScript, jump to the definitions of vars (with <code>cider-find-var</code>) and much more.</p>
</div>
<div class="paragraph">
<p>For example, to display an alert in the browser:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">cljs.repl&gt; (js/alert &quot;Jurassic Park!&quot;)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_simplify_startup_with_dir_local"><a class="anchor" href="#_simplify_startup_with_dir_local"></a><a class="link" href="#_simplify_startup_with_dir_local">15.2.2. Simplify startup with dir-local</a></h4>
<div class="paragraph">
<p>You can simplify startup flow by a creating a <code>.dir-locals.el</code> file at project root.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="elisp">((nil . ((cider-default-cljs-repl . shadow)
         (cider-shadow-default-options . &quot;&lt;your-build-name-here&gt;&quot;))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, when watching several builds:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="elisp">((nil . ((cider-default-cljs-repl . shadow)
         (cider-shadow-default-options . &quot;&lt;your-build-name-here&gt;&quot;)
         (cider-shadow-watched-builds . (&quot;&lt;first-build&gt;&quot; &quot;&lt;other-build&gt;&quot;)))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Read about Emacs and shadow-cljs, using the <code>.dir-locals.el</code> file at the <a href="https://docs.cider.mx/cider/1.1/cljs/shadow-cljs.html">Cider docs</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_using_deps_edn_with_custom_repl_intialization"><a class="anchor" href="#_using_deps_edn_with_custom_repl_intialization"></a><a class="link" href="#_using_deps_edn_with_custom_repl_intialization">15.2.3. Using deps.edn with custom repl intialization.</a></h4>
<div class="paragraph">
<p>In case you want to manage your dependencies via <a href="https://clojure.org/guides/deps_and_cli">deps.edn</a>, you can use
custom cljs-repl init form. Create a <code>:dev</code> alias with an extra source path of "dev" and add the following
namespace</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clj">(ns user
  (:require [shadow.cljs.devtools.api :as shadow]
            [shadow.cljs.devtools.server :as server]))

(defn cljs-repl
  &quot;Connects to a given build-id. Defaults to `:app`.&quot;
  ([]
   (cljs-repl :app))
  ([build-id]
   (server/start!)
   (shadow/watch build-id)
   (shadow/nrepl-select build-id)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Supposing your build-id is <code>:app</code>, add the following to your <code>.dir-locals.el</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="elisp">((nil . ((cider-clojure-cli-global-options . &quot;-A:dev&quot;)
         (cider-preferred-build-tool       . clojure-cli)
         (cider-default-cljs-repl          . custom)
         (cider-custom-cljs-repl-init-form . &quot;(do (user/cljs-repl))&quot;)
         (eval . (progn
                   (make-variable-buffer-local 'cider-jack-in-nrepl-middlewares)
                   (add-to-list 'cider-jack-in-nrepl-middlewares &quot;shadow.cljs.devtools.server.nrepl/middleware&quot;))))))</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>cider-jack-in-cljs</code> should then work out of the box.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_proto_repl_atom"><a class="anchor" href="#_proto_repl_atom"></a><a class="link" href="#_proto_repl_atom">15.3. Proto REPL (Atom)</a></h3>
<div class="paragraph">
<p>Proto REPL is mostly intended for Clojure development so most features do not work for ClojureScript. It is however possible to use it for simple evals.</p>
</div>
<div class="paragraph">
<p>You need to setup a couple of things to get it working.</p>
</div>
<div class="paragraph">
<p>1)  Create a <code>user.clj</code> in on of your <code>:source-paths</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"> (<span class="keyword">ns</span> <span class="namespace">user</span>)

 (<span class="keyword">defn</span> <span class="function">reset</span> [])</code></pre>
</div>
</div>
<div class="paragraph">
<p>The file must define the <code>user/reset</code> fn since Proto REPL will call that when connecting. If <code>user/reset</code> is not found it will call <code>tools.namespace</code> which destroys the running <code>shadow-cljs</code> server. We don&#8217;t want that. You could do something here but we don&#8217;t need to do anything for CLJS.</p>
</div>
<div class="paragraph">
<p>2) add <code>[proto-repl "0.3.1"]</code> to your <code>:dependencies</code> in <a href="#user-config">~/.shadow-cljs/config.edn</a> or <code>shadow-cljs.edn</code>.</p>
</div>
<div class="paragraph">
<p>3) Configure a fixed <a href="#nREPL">nREPL port</a></p>
</div>
<div class="paragraph">
<p>4) Start <code>shadow-cljs server</code> or <code>shadow-cljs watch your-build</code>.</p>
</div>
<div class="paragraph">
<p>5) Run the Atom Command <code>Proto Repl: Remote Nrepl Connection</code> connect to <code>localhost</code> and the port you configured</p>
</div>
<div class="paragraph">
<p>6) Eval <code>(shadow.cljs.devtools.api/watch :your-build)</code> (if you used <code>server</code> in 4)</p>
</div>
<div class="paragraph">
<p>7) Eval <code>(shadow.cljs.devtools.api/nrepl-select :your-build)</code>. The REPL connection is now in CLJS mode, meaning that everything you eval will be eval&#8217;d in JS. You can eval <code>:repl/quit</code> to get back to Clojure Mode. If you get <code>[:no-worker :browser]</code> you need to start the <code>watch</code> first.</p>
</div>
<div class="paragraph">
<p>8) Before you can eval CLJS you need to connect your client (eg. your Browser when building a <code>:browser</code> App).</p>
</div>
<div class="paragraph">
<p>9) Eval some JS, eg. <code>(js/alert "foo")</code>. If you get <code>There is no connected JS runtime</code> the client is not connected properly. Otherwise the Browser should show an alert.</p>
</div>
</div>
<div class="sect2">
<h3 id="_chlorine_atom"><a class="anchor" href="#_chlorine_atom"></a><a class="link" href="#_chlorine_atom">15.4. Chlorine (Atom)</a></h3>
<div class="paragraph">
<p>Chlorine connects Atom to a Socket REPL, but also tries to refresh namespace. So first, open up Chlorine package config and check if configuration <code>Should we use clojure.tools.namespace to refresh</code> is set to <code>simple</code>, otherwise it&#8217;ll destroy the running <code>shadow-cljs</code> server.</p>
</div>
<div class="paragraph">
<p>Once you checked that the configuration is right, you can start your shadow app (replace <code>app</code> with whatever build):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">$ shadow-cljs watch app</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, all you have to do is to run the atom command <code>Chlorine: Connect Clojure Socket Repl</code>. This will connect a REPL to evaluate Clojure code. Next you need to run <code>Chlorine: Connect Embeded</code>, and it&#8217;ll connect the ClojureScript REPL too.</p>
</div>
<div class="paragraph">
<p>Now, you can use the <code>Chlorine: Evaluate&#8230;&#8203;</code> commands to evaluate any Clojure or ClojureScript REPL. It&#8217;ll evaluate <code>.clj</code> files as Clojure, and <code>cljc</code> files as ClojureScript.</p>
</div>
</div>
<div class="sect2">
<h3 id="_calva_vs_code"><a class="anchor" href="#_calva_vs_code"></a><a class="link" href="#_calva_vs_code">15.5. Calva (VS Code)</a></h3>
<div class="paragraph">
<p>Calva has built-in support for <strong>shadow-cljs</strong>.</p>
</div>
<div class="sect3">
<h4 id="_dependencies_2"><a class="anchor" href="#_dependencies_2"></a><a class="link" href="#_dependencies_2">15.5.1. Dependencies</a></h4>
<div class="paragraph">
<p>You need VS Code and the <a href="https://marketplace.visualstudio.com/items?itemName=betterthantomorrow.calva#overview">Calva</a> extension.</p>
</div>
</div>
<div class="sect3">
<h4 id="_start_the_repl"><a class="anchor" href="#_start_the_repl"></a><a class="link" href="#_start_the_repl">15.5.2. Start the REPL</a></h4>
<div class="paragraph">
<p>The easiest way to start the REPL is to use Calva&#8217;s <strong>Jack-in</strong> command and then select the <code>shadow-cljs</code> <strong>Project Type</strong>. This will start the shadow-cljs watcher and inject the necessary <strong>cider-nrepl</strong> dependencies.</p>
</div>
<div class="paragraph">
<p>If you want to start the REPL yourself you can:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use the Calva command <strong>Copy Jack-in Command to Clipboard</strong></p>
</li>
<li>
<p>Start the REPL from the terminal (VS Code&#8217;s built-in terminal works great for this)</p>
</li>
<li>
<p>Use the Calva command <strong>Connect to a Running REPL</strong></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_calva_to_the_build"><a class="anchor" href="#_connecting_calva_to_the_build"></a><a class="link" href="#_connecting_calva_to_the_build">15.5.3. Connecting Calva to the build</a></h4>
<div class="paragraph">
<p>Once shadow is done with its initial compile, start the app (in the browser, or node, or whatever, depending on your app).</p>
</div>
<div class="paragraph">
<p>Calva will prompt you for witch build to attach the REPL connection to. Calva has a command (and a statusbar button) for switching witch build is attached.</p>
</div>
<div class="paragraph">
<p>Hack away!</p>
</div>
<div class="paragraph">
<p>See <a href="https://calva.io">calva.io</a> for information about how to use Calva.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_fireplace_vim_vimneovim"><a class="anchor" href="#_fireplace_vim_vimneovim"></a><a class="link" href="#_fireplace_vim_vimneovim">15.6. Fireplace.vim (Vim/Neovim)</a></h3>
<div class="paragraph">
<p><a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> is a Vim/Neovim plug-in which provides Clojure REPL integration by acting as an <a href="https://nrepl.org/">nREPL</a> client. When combined with Shadow-CLJS, it also provides ClojureScript REPL integration.</p>
</div>
<div class="paragraph">
<p>This guide uses as an example the app created in the official <a href="https://github.com/thheller/shadow-cljs#quick-start">Shadow-CLJS Quick Start</a> guide therefore refers to a few configuration items in the app&#8217;s <code>shadow-cljs.edn</code>. That being said, these configuration items are fairly generic so should be applicable to other apps with minor modifications.</p>
</div>
<div class="sect3">
<h4 id="_dependencies_3"><a class="anchor" href="#_dependencies_3"></a><a class="link" href="#_dependencies_3">15.6.1. Dependencies</a></h4>
<div class="paragraph">
<p>Install <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> using your favorite method of installing plug-ins in Vim/Neovim.</p>
</div>
<div class="paragraph">
<p>As an <a href="https://nrepl.org/">nREPL</a> client, <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> depends on <a href="https://docs.cider.mx/cider-nrepl/">CIDER-nREPL</a> (which is nREPL middleware that provides common, editor-agnostic REPL operations) therefore you need to include this dependency in <a href="#user-config">~/.shadow-cljs/config.edn</a> or <code>shadow-cljs.edn</code> (as shown in the next sub-section.) Shadow-CLJS will inject the required CIDER-nREPL middleware once it sees this dependency.</p>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_the_app"><a class="anchor" href="#_preparing_the_app"></a><a class="link" href="#_preparing_the_app">15.6.2. Preparing the app</a></h4>
<div class="paragraph">
<p>Create the example app by following the official <a href="https://github.com/thheller/shadow-cljs#quick-start">Shadow-CLJS Quick Start</a> guide and modify its <code>shadow-cljs.edn</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; shadow-cljs configuration</span>
{<span class="symbol">:source-paths</span>
 [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/dev</span><span class="delimiter">&quot;</span></span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">src/test</span><span class="delimiter">&quot;</span></span>]

 <span class="comment">;; ADD - CIDER-nREPL middleware required by Fireplace.vim</span>
 <span class="symbol">:dependencies</span>
 [[cider/cider-nrepl <span class="string"><span class="delimiter">&quot;</span><span class="content">0.22.4</span><span class="delimiter">&quot;</span></span>]]

 <span class="comment">;; ADD - a port (e.g., 3333) for the REPL server to which Fireplace.vim connects</span>
 <span class="symbol">:nrepl</span>
 {<span class="symbol">:port</span> <span class="integer">3333</span>}

 <span class="comment">;; ADD - a port (e.g., 8080) for the development-time HTTP server that serves the app</span>
 <span class="symbol">:dev-http</span>
 {<span class="integer">8080</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>}

 <span class="symbol">:builds</span>
 {<span class="symbol">:frontend</span>  <span class="comment">; NOTE - This is the build ID referenced at various places below.</span>
  {<span class="symbol">:target</span> <span class="symbol">:browser</span>
   <span class="symbol">:modules</span> {<span class="symbol">:main</span> {<span class="symbol">:init-fn</span> acme.frontend.app/init}}}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once that is done, start the app (note the Shadow-CLJS build ID, <code>frontend</code>, specified in <code>shadow-cljs.edn</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">npx shadow-cljs watch frontend</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open the app in a browser at <a href="http://localhost:8080/" class="bare">http://localhost:8080/</a>. Without this step, you would get the following error message from <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> if you attempt to connect to the REPL server from within Vim/Neovim:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">No application has connected to the REPL server.
Make sure your JS environment has loaded your compiled ClojureScript code.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_fireplace_vim_to_repl_server"><a class="anchor" href="#_connecting_fireplace_vim_to_repl_server"></a><a class="link" href="#_connecting_fireplace_vim_to_repl_server">15.6.3. Connecting Fireplace.vim to REPL Server</a></h4>
<div class="paragraph">
<p>Open a ClojureScript source file in Vim/Neovim and execute the following command to connect <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> to the REPL server (note the port for the REPL server, <code>3333</code>, specified in <code>shadow-cljs.edn</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:Connect</span> <span class="integer">3333</span>
=&gt;
Connected to nrepl<span class="symbol">://localhost</span><span class="error">:</span><span class="integer">3333</span><span class="keyword">/</span>
Scope connection to<span class="error">:</span> ~/code/clojurescript/acme-app (ENTER)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a Clojure (instead of ClojureScript) REPL session. Execute the following command to add ClojureScript support to the session (note the Shadow-CLJS build ID, <code>frontend</code>, specified in <code>shadow-cljs.edn</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="symbol">:CljEval</span> (shadow/repl <span class="symbol">:frontend</span>)
=&gt;
To quit, <span class="keyword">type</span><span class="error">:</span> <span class="symbol">:cljs/quit</span>
[<span class="symbol">:selected</span> <span class="symbol">:frontend</span>]
Press ENTER <span class="keyword">or</span> <span class="keyword">type</span> command to continue</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should now be able to execute <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> commands against the REPL server. Please refer to the <a href="https://www.vim.org/scripts/script.php?script_id=4978">Fireplace.vim</a> documentation for the full list of commands you can execute.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_troubleshooting"><a class="anchor" href="#_troubleshooting"></a><a class="link" href="#_troubleshooting">16. Troubleshooting</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="failed-to-load"><a class="anchor" href="#failed-to-load"></a><a class="link" href="#failed-to-load">16.1. Startup Errors</a></h3>
<div class="paragraph">
<p>Sometimes <code>shadow-cljs</code> can fail to start properly. The errors are often very confusing and hard to identify. Most commonly this is caused by a few dependency conflicts on some of the important dependencies. When using just <code>shadow-cljs.edn</code> to manage your <code>:dependencies</code> it will provide a few extra checks to protect against these kinds of errors but when using <code>deps.edn</code> or <code>project.clj</code> these protections cannot be done so these errors happen more often when using those tools.</p>
</div>
<div class="paragraph">
<p>Generally the important dependencies to watch out for are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>org.clojure/clojure</p>
</li>
<li>
<p>org.clojure/clojurescript</p>
</li>
<li>
<p>org.clojure/core.async</p>
</li>
<li>
<p>com.google.javascript/closure-compiler-unshaded</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each <code>shadow-cljs</code> version is only tested with one particular combination of versions and it is recommended to stick with that version set for best compatibility. It might work when using different versions but if you encounter any kind of weird issues consider fixing your dependency versions first.</p>
</div>
<div class="paragraph">
<p>You can find the required dependencies for each version on clojars:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://clojars.org/thheller/shadow-cljs" class="bare">https://clojars.org/thheller/shadow-cljs</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The way to diagnose these issues vary by tool, so please refer to the appropriate section for further info.</p>
</div>
<div class="paragraph">
<p>Generally if you want to be sure you can just declare the matching dependency versions directly together with your chosen <code>shadow-cljs</code> version but that means you must also update those versions whenever you upgrade <code>shadow-cljs</code>. Correctly identifying where unwanted dependencies may be more work but will make future upgrades easier.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> will likely always be on the very latest version for all the listed dependencies above so if you need to stick with an older dependency you might need to stick with an older shadow-cljs version as well.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> is very often several versions ahead on the <code>com.google.javascript/closure-compiler-unshaded</code> version it uses, so if you are depending on the version <code>org.clojure/clojurescript</code> normally supplies that might cause issues. Make sure the <code>thheller/shadow-cljs</code> version is picked over the version preferred by <code>org.clojure/clojurescript</code>.</p>
</div>
<div class="paragraph">
<p>If you want to make your life easier just use <code>shadow-cljs.edn</code> to manage your dependencies if you can. It is much less likely to have these problems or will at least warn you directly.</p>
</div>
<div class="paragraph">
<p>If you have ensured that you are getting all the correct versions but things still go wrong please open a <a href="https://github.com/thheller/shadow-cljs/issues">Github Issue</a> with a full problem description including your full dependency list.</p>
</div>
<div class="sect3">
<h4 id="_deps_edn_tools_deps"><a class="anchor" href="#_deps_edn_tools_deps"></a><a class="link" href="#_deps_edn_tools_deps">16.1.1. deps.edn / tools.deps</a></h4>
<div class="paragraph">
<p>When using <code>deps.edn</code> to manage your dependencies via the <a href="#tools-deps">:deps</a> key in <code>shadow-cljs.edn</code> it is recommended to use the <code>clj</code> tool directly for further diagnosis. First you need to check which aliases you are applying via <code>shadow-cljs.edn</code>. So if you are setting <code>:deps {:aliases [:dev :cljs]}</code> you&#8217;ll need to specify these aliases when running further commands.</p>
</div>
<div class="paragraph">
<p>First of all you should ensure that all dependencies directly declared in <code>deps.edn</code> have the expected version. Sometimes transitive dependencies can cause the inclusion of problematic versions. You can list all dependencies via:</p>
</div>
<div class="listingblock">
<div class="title">Listing all active dependencies</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ clj -A:dev:cljs -Stree</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will list all the dependencies. Tracking this down is a bit manual but you&#8217;ll need to verify that you get the correct versions for the dependencies mentioned above.</p>
</div>
<div class="paragraph">
<p>Please refer to the official <a href="https://clojure.org/reference/deps_and_cli">tools.deps</a> documentation for further information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_project_clj_leiningen"><a class="anchor" href="#_project_clj_leiningen"></a><a class="link" href="#_project_clj_leiningen">16.1.2. project.clj / Leiningen</a></h4>
<div class="paragraph">
<p>When using <code>project.clj</code> to manage you dependencies you&#8217;ll need to specify your configured <code>:lein</code> profiles from <code>shadow-cljs.edn</code> when using <code>lein</code> directly to diagnose the problem. For example <code>:lein {:profile "+cljs"}</code> would require <code>lein with-profile +cljs</code> for every command.</p>
</div>
<div class="listingblock">
<div class="title">Example listing of deps</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="error">#</span> no profile
$ lein deps <span class="symbol">:tree</span>

<span class="error">#</span> with profile
$ lein with-profile +cljs deps <span class="symbol">:tree</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will usually list all the current conflicts at the top and provide suggestions with the dependency tree at the bottom. The suggestions aren&#8217;t always fully accurate so don&#8217;t get mislead and don&#8217;t add exclusions to the <code>thheller/shadow-cljs</code> artifact.</p>
</div>
<div class="paragraph">
<p>Please refer to the <a href="https://leiningen.org/">Leiningen</a> documentation for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repl-troubleshooting"><a class="anchor" href="#repl-troubleshooting"></a><a class="link" href="#repl-troubleshooting">16.2. REPL</a></h3>
<div class="paragraph">
<p>Getting a CLJS REPL working can sometimes be tricky and a lot can go wrong since all the moving parts can be quite complicated. This guide hopes to address the most common issues that people run into and how to fix them.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="assets/img/shadow-cljs-repl.png" alt="shadow cljs repl">
</div>
</div>
<div class="sect3">
<h4 id="cljs-repl-anatomy"><a class="anchor" href="#cljs-repl-anatomy"></a><a class="link" href="#cljs-repl-anatomy">16.2.1. Anatomy of the CLJS REPL</a></h4>
<div class="paragraph">
<p>A REPL in Clojure does exactly what the name implies: Read one form, Eval it, Print the result, Loop to do it again.</p>
</div>
<div class="paragraph">
<p>In ClojureScript however things are a bit more complicated since compilation happens on the JVM but the results are eval&#8217;d in a JavaScript runtime. There are a couple more steps that need to be done due in order to "emulate" the plain REPL experience. Although things are implemented a bit differently in <code>shadow-cljs</code> over regular CLJS the basic principles remain the same.</p>
</div>
<div class="paragraph">
<p>First you&#8217;ll need a REPL client. This could just be the CLI (eg. <code>shadow-cljs cljs-repl app</code>) or your Editor connected via <code>nREPL</code>. The Client will always talk directly to the <code>shadow-cljs</code> server and it&#8217;ll handle the rest. From the Client side it still looks like a regular REPL but there are a few more steps happening in the background.</p>
</div>
<div class="paragraph">
<p>1) Read: It all starts with reading a singular CLJS form from a given InputStream. That is either a blocking read directly from <code>stdin</code> or read from a string in case of <code>nREPL</code>. A Stream of characters are turned into actual datastructures, <code>"(+ 1 2)"</code> (a string) becomes <code>(+ 1 2)</code> (a list).</p>
</div>
<div class="paragraph">
<p>2) Compile: That form is then compiled on the <code>shadow-cljs</code> JVM side and transformed to a set of instructions.</p>
</div>
<div class="paragraph">
<p>3) Transfer Out: Those instructions are transferred to a connected JavaScript runtime. This could be a Browser or a <code>node</code> process.</p>
</div>
<div class="paragraph">
<p>4) Eval: The connected runtime will take the received instructions and <code>eval</code> them.</p>
</div>
<div class="paragraph">
<p>5) Print: The <code>eval</code> result is printed as a String in the JS runtime.</p>
</div>
<div class="paragraph">
<p>6) Transfer Back: The printed result is transferred back to the <code>shadow-cljs</code> JVM side.</p>
</div>
<div class="paragraph">
<p>7) Reply: The JVM side will forward the received results back to initial caller and the result is printed to the proper OutputStream (or sent as a nREPL message).</p>
</div>
<div class="paragraph">
<p>8) Loop: Repeat from 1).</p>
</div>
</div>
<div class="sect3">
<h4 id="_javascript_runtimes"><a class="anchor" href="#_javascript_runtimes"></a><a class="link" href="#_javascript_runtimes">16.2.2. JavaScript Runtimes</a></h4>
<div class="paragraph">
<p>The <code>shadow-cljs</code> JVM side of things will require one running <code>watch</code> for a given build which will handle all the related REPL commands as well. It uses a dedicated thread and manages all the given events that can happen during development (eg. REPL input, changing files, etc).</p>
</div>
<div class="paragraph">
<p>The compiled JS code however must also be loaded by a JS runtime (eg. Browser or <code>node</code> process) and that JS runtime must connect back to the running <code>shadow-cljs</code> process. Most <code>:target</code> configurations will have the necessary code added by default and should just connect automatically. How that connect is happening is dependent on the runtime but usually it is using a WebSocket to connect to the running <code>shadow-cljs</code> <a href="#http">HTTP server</a>.</p>
</div>
<div class="paragraph">
<p>Once connected the REPL is ready to use. Note that reloading the JS runtime (eg. manual browser page reload) will wipe out all REPL state of the runtime but some of the compiler side state will remain until the <code>watch</code> is also restarted.</p>
</div>
<div class="paragraph">
<p>It is possible for more than one JS runtime to connect to the <code>watch</code> process. <code>shadow-cljs</code> by default picks the first JS runtime that connected as the <code>eval</code> target. If you open a given <code>:browser</code> build in multiple Browsers only the first one will be used to <code>eval</code> code. Or you could be opening a <code>:react-native</code> app in iOS and Android next to each other during development. Only one runtime can eval and if that disconnects the next one takes over based on the time it connected.</p>
</div>
</div>
<div class="sect3">
<h4 id="missing-js-runtime"><a class="anchor" href="#missing-js-runtime"></a><a class="link" href="#missing-js-runtime">16.2.3. Missing JS runtime</a></h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>No application has connected to the REPL server. Make sure your JS environment has loaded your compiled ClojureScript code.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This error message just means that no JS runtime (eg. Browser) has connected to the <code>shadow-cljs</code> server. Your REPL client has successfully connected to the <code>shadow-cljs</code> server but as explained above we still need a JS runtime to actually <code>eval</code> anything.</p>
</div>
<div class="paragraph">
<p>Regular <code>shadow-cljs</code> builds do not manage any JS runtime of their own so you are responsible for running them.</p>
</div>
<div class="sect4">
<h5 id="repl-trouble-browser"><a class="anchor" href="#repl-trouble-browser"></a><a class="link" href="#repl-trouble-browser">:target :browser</a></h5>
<div class="paragraph">
<p>For <a href="#target-browser"><code>:target :browser</code></a> builds the <code>watch</code> process will have compiled the given code to a configured <code>:output-dir</code> (defaults to <code>public/js</code>). The generated <code>.js</code> must be loaded in a browser. Once loaded the Browser Console should show a <code>WebSocket connected</code> message. If you are using any kind of custom HTTP servers or have over-eager firewalls blocking the connections you might need to set some additional configuration (eg. via <a href="#proxy-support">:devtools-url</a>). The goal is to be able to connect to the <a href="#http">primary HTTP server</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="repl-trouble-node"><a class="anchor" href="#repl-trouble-node"></a><a class="link" href="#repl-trouble-node">:target :node-script, :node-library</a></h5>
<div class="paragraph">
<p>These targets will have produced a <code>.js</code> file that are intended to run in a <code>node</code> process. Given the variety of options however you&#8217;ll need to run them yourself. For example a <code>:node-script</code> you&#8217;d run via <code>node the-script.js</code> and on startup it&#8217;ll try to connect to the <code>shadow-cljs</code> server. You should see a <code>WebSocket connected</code> message on startup. The output is designed to only run on the machine they were compiled on, don&#8217;t copy <code>watch</code> output to other machines.</p>
</div>
</div>
<div class="sect4">
<h5 id="repl-trouble-react-native"><a class="anchor" href="#repl-trouble-react-native"></a><a class="link" href="#repl-trouble-react-native">:target :react-native</a></h5>
<div class="paragraph">
<p>The generated <code>&lt;:output-dir&gt;/index.js</code> file needs to be added to your <code>react-native</code> app and then loaded on an actual device or emulator. On startup it will also attempt to connect to the <code>shadow-cljs</code> server. You can check the log output via <code>react-native log-android|log-ios</code> and should show a <code>WebSocket connected</code> message once the app is running. If you see a websocket related error on startup instead it may have failed to connect to the shadow-cljs process. This can happen when the IP detection picked an incorrect IP. You can check which IP was used via <code>shadow-cljs watch app --verbose</code> and override it via <code>shadow-cljs watch app --config-merge '{:local-ip "1.2.3.4"}'</code>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="publish"><a class="anchor" href="#publish"></a><a class="link" href="#publish">17. Publishing Libraries</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>ClojureScript libraries are published to <code>maven</code> repositories just like Clojure. Most commonly they are published to <a href="https://clojars.org/">Clojars</a> but all other standard maven repositories work too.</p>
</div>
<div class="paragraph">
<p><code>shadow-cljs</code> itself does not have direct support for publishing but since ClojureScript libraries are just uncompiled source files published in a JAR (basically just a ZIP compressed file) any common tool that is able to publish to maven will work. (eg. <code>mvn</code>, <code>gradle</code>, <code>lein</code>, etc). No extra compilation or other steps are required to publish. The ClojureScript compiler and therefore shadow-cljs is not involved at all.</p>
</div>
<div class="sect2">
<h3 id="publish-lein"><a class="anchor" href="#publish-lein"></a><a class="link" href="#publish-lein">17.1. Leiningen</a></h3>
<div class="paragraph">
<p>There are a variety of options to publish libraries and I currently recommend <a href="https://leiningen.org/">Leiningen</a>. The setup is very straightforward and doesn&#8217;t require much configuration at all.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
This does not mean that you have to use Leiningen during development of the library itself. It is recommended to just use Leiningen for publishing but use <code>shadow-cljs</code> normally otherwise. You&#8217;ll only need to copy the actual <code>:dependencies</code> definition once you publish. Remember to keep development related dependencies out though.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assuming you are already using the recommended project structure where all your primary sources are located in <code>src/main</code> you can publish with a very simple <code>project.clj</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject your.cool/library <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="symbol">:description</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Does cool stuff</span><span class="delimiter">&quot;</span></span>
  <span class="symbol">:url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://the.inter.net/wherever</span><span class="delimiter">&quot;</span></span>

  <span class="comment">;; this is optional, add what you want or remove it</span>
  <span class="symbol">:license</span> {<span class="symbol">:name</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Eclipse Public License</span><span class="delimiter">&quot;</span></span>
            <span class="symbol">:url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.eclipse.org/legal/epl-v10.html</span><span class="delimiter">&quot;</span></span>}

  <span class="symbol">:dependencies</span>
  <span class="comment">;; always use &quot;provided&quot; for Clojure(Script)</span>
  [[org.clojure/clojurescript <span class="string"><span class="delimiter">&quot;</span><span class="content">1.10.520</span><span class="delimiter">&quot;</span></span> <span class="symbol">:scope</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">provided</span><span class="delimiter">&quot;</span></span>]
   [some.other/library <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>]]

  <span class="symbol">:source-paths</span>
  [<span class="string"><span class="delimiter">&quot;</span><span class="content">src/main</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will generate the required <code>pom.xml</code> and put all sources from <code>src/main</code> into the published <code>.jar</code> file. All you need to run is <code>lein deploy clojars</code> to publish it. When doing this for the first time you&#8217;ll first need to setup proper authentication. Please refer to the official  <a href="https://github.com/technomancy/leiningen/blob/stable/doc/DEPLOY.md">Leiningen</a> and <a href="https://github.com/clojars/clojars-web/wiki/Tutorial">Clojars</a> documentation on how to set that up.</p>
</div>
<div class="sect3">
<h4 id="_disable_jar_signing"><a class="anchor" href="#_disable_jar_signing"></a><a class="link" href="#_disable_jar_signing">17.1.1. Disable JAR Signing</a></h4>
<div class="paragraph">
<p>Leiningen defaults to signing libraries via GPG before publishing which is a good default but given that this can be a hassle to setup and not many people are actually verifying the signatures you can disable that step via adding a simple <code>:repositories</code> config to the <code>project.clj</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(defproject your.cool/library <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">..</span><span class="keyword">.</span>
  <span class="symbol">:repositories</span>
  {<span class="string"><span class="delimiter">&quot;</span><span class="content">clojars</span><span class="delimiter">&quot;</span></span> {<span class="symbol">:url</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">https://clojars.org/repo</span><span class="delimiter">&quot;</span></span>
              <span class="symbol">:sign-releases</span> <span class="predefined-constant">false</span>}}
  <span class="keyword">..</span><span class="keyword">.</span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_keep_your_jar_clean"><a class="anchor" href="#_keep_your_jar_clean"></a><a class="link" href="#_keep_your_jar_clean">17.1.2. Keep your JAR clean</a></h4>
<div class="paragraph">
<p>If you write tests or user other development related code for your library make sure to keep them in <code>src/dev</code> or <code>src/test</code> to avoid publishing them together with the library.</p>
</div>
<div class="paragraph">
<p>Also avoid generating output to <code>resources/*</code> since Leiningen and other tools may include those files into the <code>.jar</code> which may cause problems for downstream users. Your <code>.jar</code> should ONLY contains the actual source files, no compiled code at all.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
You can and should verify that everything is clean by running <code>lein jar</code> and inspecting the files that end up in it via <code>jar -tvf target/library-1.0.0.jar</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="publish-deps-cljs"><a class="anchor" href="#publish-deps-cljs"></a><a class="link" href="#publish-deps-cljs">17.2. Declaring JS dependencies</a></h3>
<div class="paragraph">
<p>Please note that currently only <code>shadow-cljs</code> has a clean automatic interop story with <code>npm</code>. That may represent a problem for users of your libraries using other tools. You may want to consider providing a CLJSJS fallback and/or publishing extra documentation for <code>webpack</code> related workflows.</p>
</div>
<div class="paragraph">
<p>You can declare <code>npm</code> dependencies directly by including a <code>deps.cljs</code> with <code>:npm-deps</code> in your project (eg. <code>src/main/deps.cljs</code>).</p>
</div>
<div class="listingblock">
<div class="title">Example src/main/deps.cljs</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">{<span class="symbol">:npm-deps</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">the-thing</span><span class="delimiter">&quot;</span></span> <span class="string"><span class="delimiter">&quot;</span><span class="content">1.0.0</span><span class="delimiter">&quot;</span></span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also provide extra <code>:foreign-libs</code> definitions here. They won&#8217;t affect <code>shadow-cljs</code> but might help other tools.</p>
</div>
<div class="paragraph">
<p>See <a href="https://clojurescript.org/reference/packaging-foreign-deps" class="bare">https://clojurescript.org/reference/packaging-foreign-deps</a> for more info.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_to_do_when_things_dont_work"><a class="anchor" href="#_what_to_do_when_things_dont_work"></a><a class="link" href="#_what_to_do_when_things_dont_work">18. What to do when things don’t work?</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since the JS world is still evolving rapidly and not everyone is using the same way to write and
distribute code there are some things <code>shadow-cljs</code> cannot work around automatically. These
can usually be solved with custom <code>:resolve</code> configs, but there may also be bugs or oversights.</p>
</div>
<div class="paragraph">
<p>If you cannot resolve such an issue with the instructions in this chapter, then try asking on the
<a href="https://clojurians.slack.com/messages/C6N245JGG"><code>#shadow-cljs</code> Slack channel</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hacking"><a class="anchor" href="#_hacking"></a><a class="link" href="#_hacking">19. Hacking</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_patching_libraries"><a class="anchor" href="#_patching_libraries"></a><a class="link" href="#_patching_libraries">19.1. Patching Libraries</a></h3>
<div class="paragraph">
<p>The <code>shadow-cljs</code> compiler ensures that things on your source paths are compiled first, overriding files from JARs. This means that you can copy a source file from a library, patch it, and include it in your own source directory.</p>
</div>
<div class="paragraph">
<p>This is a convenient way to test out fixes (even to <code>shadow-cljs</code> itself!) without having to clone
that project and understand its setup, build, etc.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2023-06-05 10:05:50 UTC
</div>
</div>
</body>
</html>